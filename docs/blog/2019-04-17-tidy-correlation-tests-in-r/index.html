<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.39">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<meta name="author" content="Dominic Royé">
<meta name="dcterms.date" content="2019-04-17">
<title>Tidy correlation tests in R – Dr Dominic Royé</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>

<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<link href="../../assets/img/logo.svg" rel="icon" type="image/svg+xml">
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-b1a009cd478e574395e6b462a577de8f.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap-2d5219dc4efcf797a71b2753c0e331aa.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<link href="../../site_libs/quarto-contrib/fontawesome6-1.2.0/all.min.css" rel="stylesheet">
<link href="../../site_libs/quarto-contrib/fontawesome6-1.2.0/latex-fontsize.css" rel="stylesheet">
<link href="../../site_libs/quarto-contrib/academicons-1.9.2/all.css" rel="stylesheet">
<link href="../../site_libs/quarto-contrib/academicons-1.9.2/size.css" rel="stylesheet">
<script src="../../site_libs/quarto-contrib/glightbox/glightbox.min.js"></script>
<link href="../../site_libs/quarto-contrib/glightbox/glightbox.min.css" rel="stylesheet">
<link href="../../site_libs/quarto-contrib/glightbox/lightbox.css" rel="stylesheet"><script id="quarto-search-options" type="application/json">{
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script><script type="text/javascript">

(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
ga('create', 'UA-27463794-2', 'auto');

ga('send', {
  hitType: 'pageview',
  'anonymizeIp': true,
});
</script><style>html{ scroll-behavior: smooth; }</style>
</head>
<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner"><nav class="navbar navbar-expand-lg " data-bs-theme="dark"><div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a href="../../index.html" class="navbar-brand navbar-brand-logo">
    <img src="../../assets/img/logo.svg" alt="" class="navbar-logo"></a>
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Dr Dominic Royé</span>
    </a>
  </div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
<li class="nav-item">
    <a class="nav-link" href="../../about/index.html"> 
<span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../blog/index.html"> 
<span class="menu-text">Blog</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../publication/index.html"> 
<span class="menu-text">Publications</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../project/index.html"> 
<span class="menu-text">Data Viz</span></a>
  </li>  
</ul>
</div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav></header><!-- content --><header id="title-block-header" class="quarto-title-block default page-columns page-full"><div id="title-block-header-title" class="quarto-title page-columns page-full page-layout-full featured-image p-4">

<h1 class="title">Tidy correlation tests in R</h1>

<div class="no-row-height column-margin column-container">
  
  <img src="featured.png" class="img-fluid" style="max-width: 125%;height: auto;">
</div>

    <div class="quarto-categories">
        <div class="quarto-category">statistics</div>
        <div class="quarto-category">R</div>
        <div class="quarto-category">R:advanced</div>
        <div class="quarto-category">correlation</div>
        <div class="quarto-category">tests</div>
      </div>
  </div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Dominic Royé </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">April 17, 2019</p>
    </div>
  </div>
  
    <div>
    <div class="quarto-title-meta-heading">Modified</div>
    <div class="quarto-title-meta-contents">
      <p class="date-modified">December 30, 2024</p>
    </div>
  </div>
    
  </div>
  



</header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active"><h2 id="toc-title">On this page</h2>
   
  <ul>
<li><a href="#packages" id="toc-packages" class="nav-link active" data-scroll-target="#packages">Packages</a></li>
  <li><a href="#import-data" id="toc-import-data" class="nav-link" data-scroll-target="#import-data">Import data</a></li>
  <li><a href="#correlation-test" id="toc-correlation-test" class="nav-link" data-scroll-target="#correlation-test">Correlation test</a></li>
  <li><a href="#apply-the-correlation-test-to-multiple-variables" id="toc-apply-the-correlation-test-to-multiple-variables" class="nav-link" data-scroll-target="#apply-the-correlation-test-to-multiple-variables">Apply the correlation test to multiple variables</a></li>
  <li><a href="#heatmap-of-the-results" id="toc-heatmap-of-the-results" class="nav-link" data-scroll-target="#heatmap-of-the-results">Heatmap of the results</a></li>
  </ul></nav>
    </div>
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content"><!-- source: https://github.com/gadenbuie/garrickadenbuie-com/blob/main/_partials/title-block-link-buttons/title-block.html --><!-- 
<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title"> 
--><!-- <header id="title-block-header" class="quarto-title-block default page-columns"> --><!-- <div class="quarto-title page-columns page-full featured-image p-4" style="background-image: url(featured.png), url(featured.jpg), url(../featured.jpg);"> --><style type="text/css">

#toc-title {
  
  display:none;

}

#quarto-toc-toggle {
  
    display:none;
    
}
  
</style>
<p>When we try to estimate the correlation coefficient between multiple variables, the task is more complicated in order to obtain a simple and tidy result. A simple solution is to use the <code><a href="https://generics.r-lib.org/reference/tidy.html">tidy()</a></code> function from the <em>{broom}</em> package. In this post we are going to estimate the correlation coefficients between the annual precipitation of several Spanish cities and climate teleconnections indices: <a href="../..\files/teleconnections_indices.zip">download</a>. The data of the teleconnections are preprocessed, but can be downloaded directly from <a href="https://crudata.uea.ac.uk/cru/data/pci.htm">crudata.uea.ac.uk</a>. The daily precipitation data comes from <a href="https://www.ecad.eu//dailydata/index.php">ECA&amp;D</a>.</p>
<section id="packages" class="level2"><h2 class="anchored" data-anchor-id="packages">Packages</h2>
<p>In this post we will use the following packages:</p>
<div class="cell">
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<colgroup>
<col style="width: 10%">
<col style="width: 89%">
</colgroup>
<thead><tr class="header">
<th style="text-align: left;">Package</th>
<th style="text-align: left;">Description</th>
</tr></thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">tidyverse</td>
<td style="text-align: left;">Collection of packages (visualization, manipulation): ggplot2, dplyr, purrr, etc.</td>
</tr>
<tr class="even">
<td style="text-align: left;">broom</td>
<td style="text-align: left;">Convert results of statistical functions (lm, t.test, cor.test, etc.) into tidy tables</td>
</tr>
<tr class="odd">
<td style="text-align: left;">fs</td>
<td style="text-align: left;">Provides a cross-platform, uniform interface to file system operations</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="cell">
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># install the packages if necessary</span></span>
<span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="kw"><a href="https://rdrr.io/r/base/library.html">require</a></span><span class="op">(</span><span class="st"><a href="https://tidyverse.tidyverse.org">"tidyverse"</a></span><span class="op">)</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html">install.packages</a></span><span class="op">(</span><span class="st">"tidyverse"</span><span class="op">)</span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="kw"><a href="https://rdrr.io/r/base/library.html">require</a></span><span class="op">(</span><span class="st"><a href="https://broom.tidymodels.org/">"broom"</a></span><span class="op">)</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html">install.packages</a></span><span class="op">(</span><span class="st">"broom"</span><span class="op">)</span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="kw"><a href="https://rdrr.io/r/base/library.html">require</a></span><span class="op">(</span><span class="st"><a href="https://fs.r-lib.org">"fs"</a></span><span class="op">)</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html">install.packages</a></span><span class="op">(</span><span class="st">"fs"</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co"># load packages</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://broom.tidymodels.org/">broom</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://fs.r-lib.org">fs</a></span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="import-data" class="level2"><h2 class="anchored" data-anchor-id="import-data">Import data</h2>
<p>First we have to import the daily precipitation of the selected weather stations.</p>
<ol type="1">
<li>Create a vector with all precipitation files using the function <code><a href="https://fs.r-lib.org/reference/dir_ls.html">dir_ls()</a></code> of the <em>{fs}</em> package.</li>
<li>Import the data using the <code><a href="https://purrr.tidyverse.org/reference/map_dfr.html">map_df()</a></code> function of the <em>{purrr}</em> package that applies another function to a vector or list, and joins them together in a single <em>data.frame</em>.</li>
<li><ol type="a">
<li>Select the columns that interest us, b) Convert the date string into a date object using the <code><a href="https://lubridate.tidyverse.org/reference/ymd.html">ymd()</a></code> function of the <em>{lubridate}</em> package, c) Create a new column <em>yr</em> with the years, d) Divide the precipitation values by 10 and reclassify absent values -9999 by NA, e) Finally, reclassify the ID of each weather station creating a factor with new labels.</li>
</ol></li>
</ol>
<p>More details about the use of the <code><a href="https://fs.r-lib.org/reference/dir_ls.html">dir_ls()</a></code> and <code><a href="https://purrr.tidyverse.org/reference/list_c.html">list_rbind()</a></code> functions can be found in this previous <a href="https://dominicroye.github.io/en/2019/import-excel-sheets-%20with-r/">post</a>.</p>
<div class="cell">
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># precipitation files</span></span>
<span><span class="va">files</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://fs.r-lib.org/reference/dir_ls.html">dir_ls</a></span><span class="op">(</span>regexp <span class="op">=</span> <span class="st">"txt"</span><span class="op">)</span></span>
<span><span class="va">files</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>RR_STAID001393.txt RR_STAID001394.txt RR_STAID002969.txt RR_STAID003946.txt 
RR_STAID003969.txt </code></pre>
</div>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># import all files and join them together</span></span>
<span><span class="va">pr</span> <span class="op">&lt;-</span> <span class="va">files</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span><span class="op">(</span><span class="va">read_csv</span>, skip <span class="op">=</span> <span class="fl">20</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/list_c.html">list_rbind</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Rows: 26329 Columns: 5
── Column specification ────────────────────────────────────────────────────────
Delimiter: ","
dbl (5): STAID, SOUID, DATE, RR, Q_RR

ℹ Use `spec()` to retrieve the full column specification for this data.
ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.
Rows: 27545 Columns: 5
── Column specification ────────────────────────────────────────────────────────
Delimiter: ","
dbl (5): STAID, SOUID, DATE, RR, Q_RR

ℹ Use `spec()` to retrieve the full column specification for this data.
ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.
Rows: 34729 Columns: 5
── Column specification ────────────────────────────────────────────────────────
Delimiter: ","
dbl (5): STAID, SOUID, DATE, RR, Q_RR

ℹ Use `spec()` to retrieve the full column specification for this data.
ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.
Rows: 24927 Columns: 5
── Column specification ────────────────────────────────────────────────────────
Delimiter: ","
dbl (5): STAID, SOUID, DATE, RR, Q_RR

ℹ Use `spec()` to retrieve the full column specification for this data.
ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.
Rows: 19813 Columns: 5
── Column specification ────────────────────────────────────────────────────────
Delimiter: ","
dbl (5): STAID, SOUID, DATE, RR, Q_RR

ℹ Use `spec()` to retrieve the full column specification for this data.
ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.</code></pre>
</div>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">pr</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 133,343 × 5
   STAID SOUID     DATE    RR  Q_RR
   &lt;dbl&gt; &lt;dbl&gt;    &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
 1  1393 20611 19470301     0     0
 2  1393 20611 19470302     5     0
 3  1393 20611 19470303     0     0
 4  1393 20611 19470304    33     0
 5  1393 20611 19470305    15     0
 6  1393 20611 19470306     0     0
 7  1393 20611 19470307    85     0
 8  1393 20611 19470308     3     0
 9  1393 20611 19470309     0     0
10  1393 20611 19470310     0     0
# ℹ 133,333 more rows</code></pre>
</div>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># create levels for the factor</span></span>
<span><span class="va">id</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">pr</span><span class="op">$</span><span class="va">STAID</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># the corresponding labels</span></span>
<span><span class="va">lab</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Bilbao"</span>, <span class="st">"Santiago"</span>, <span class="st">"Barcelona"</span>, <span class="st">"Madrid"</span>, <span class="st">"Valencia"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># first changes</span></span>
<span><span class="va">pr</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">pr</span>, <span class="va">STAID</span>, <span class="va">DATE</span>, <span class="va">RR</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span></span>
<span>    DATE <span class="op">=</span> <span class="fu"><a href="https://lubridate.tidyverse.org/reference/ymd.html">ymd</a></span><span class="op">(</span><span class="va">DATE</span><span class="op">)</span>,</span>
<span>    RR <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">RR</span> <span class="op">==</span> <span class="op">-</span><span class="fl">9999</span>, <span class="cn">NA</span>, <span class="va">RR</span> <span class="op">/</span> <span class="fl">10</span><span class="op">)</span>,</span>
<span>    STAID <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">STAID</span>, <span class="va">id</span>, <span class="va">lab</span><span class="op">)</span>,</span>
<span>    yr <span class="op">=</span> <span class="fu"><a href="https://lubridate.tidyverse.org/reference/year.html">year</a></span><span class="op">(</span><span class="va">DATE</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="va">pr</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 133,343 × 4
   STAID  DATE          RR    yr
   &lt;fct&gt;  &lt;date&gt;     &lt;dbl&gt; &lt;dbl&gt;
 1 Bilbao 1947-03-01   0    1947
 2 Bilbao 1947-03-02   0.5  1947
 3 Bilbao 1947-03-03   0    1947
 4 Bilbao 1947-03-04   3.3  1947
 5 Bilbao 1947-03-05   1.5  1947
 6 Bilbao 1947-03-06   0    1947
 7 Bilbao 1947-03-07   8.5  1947
 8 Bilbao 1947-03-08   0.3  1947
 9 Bilbao 1947-03-09   0    1947
10 Bilbao 1947-03-10   0    1947
# ℹ 133,333 more rows</code></pre>
</div>
</div>
<p>We still need to filter and calculate the annual amount of precipitation. Actually, it is not correct to sum up precipitation without taking into account that there are missing values, but it should be enough for this practice. Then, we change the table format with the <code><a href="https://tidyr.tidyverse.org/reference/spread.html">spread()</a></code> function, passing from a long to a wide table, that is, we want to obtain one column per weather station.</p>
<div class="cell">
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">pr_yr</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">pr</span>, <span class="va">DATE</span> <span class="op">&gt;=</span> <span class="st">"1950-01-01"</span>, </span>
<span>                <span class="va">DATE</span> <span class="op">&lt;</span> <span class="st">"2018-01-01"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>          <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">STAID</span>, <span class="va">yr</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>          <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span>pr <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">RR</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>`summarise()` has grouped output by 'STAID'. You can override using the
`.groups` argument.</code></pre>
</div>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">pr_yr</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 324 × 3
# Groups:   STAID [5]
   STAID     yr    pr
   &lt;fct&gt;  &lt;dbl&gt; &lt;dbl&gt;
 1 Bilbao  1950 1342 
 2 Bilbao  1951 1306.
 3 Bilbao  1952 1355.
 4 Bilbao  1953 1372.
 5 Bilbao  1954 1428.
 6 Bilbao  1955 1062.
 7 Bilbao  1956 1254.
 8 Bilbao  1957  968.
 9 Bilbao  1958 1272.
10 Bilbao  1959 1450.
# ℹ 314 more rows</code></pre>
</div>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">pr_yr</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tidyr.tidyverse.org/reference/spread.html">spread</a></span><span class="op">(</span><span class="va">pr_yr</span>, <span class="va">STAID</span>, <span class="va">pr</span><span class="op">)</span></span>
<span><span class="va">pr_yr</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 68 × 6
      yr Bilbao Santiago Barcelona Madrid Valencia
   &lt;dbl&gt;  &lt;dbl&gt;    &lt;dbl&gt;     &lt;dbl&gt;  &lt;dbl&gt;    &lt;dbl&gt;
 1  1950  1342     1800.      345     NA        NA
 2  1951  1306.    2344.     1072.   798.       NA
 3  1952  1355.    1973.      415.   524.       NA
 4  1953  1372.     973.      683.   365.       NA
 5  1954  1428.    1348.      581.   246.       NA
 6  1955  1062.    1769.      530.   473.       NA
 7  1956  1254.    1533.      695.   480.       NA
 8  1957   968.    1599.      635.   424.       NA
 9  1958  1272.    2658.      479.   482.       NA
10  1959  1450.    2847.     1006    665.       NA
# ℹ 58 more rows</code></pre>
</div>
</div>
<p>The next step is to import the climate teleconnection indices.</p>
<div class="cell">
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># teleconnections</span></span>
<span><span class="va">telecon</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://readr.tidyverse.org/reference/read_delim.html">read_csv</a></span><span class="op">(</span><span class="st">"teleconnections_indices.csv"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Rows: 68 Columns: 9
── Column specification ────────────────────────────────────────────────────────
Delimiter: ","
dbl (9): yr, NAO, WeMO, EA, POL-EUAS, EATL/WRUS, MO, SCAND, AO

ℹ Use `spec()` to retrieve the full column specification for this data.
ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.</code></pre>
</div>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">telecon</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 68 × 9
      yr   NAO   WeMO     EA `POL-EUAS` `EATL/WRUS`    MO    SCAND        AO
   &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;      &lt;dbl&gt;       &lt;dbl&gt; &lt;dbl&gt;    &lt;dbl&gt;     &lt;dbl&gt;
 1  1950  0.49  0.555 -0.332     0.0217     -0.0567 0.335  0.301   -0.199   
 2  1951 -0.07  0.379 -0.372     0.402      -0.419  0.149 -0.00667 -0.365   
 3  1952 -0.37  0.693 -0.688    -0.0117     -0.711  0.282  0.0642  -0.675   
 4  1953  0.4  -0.213 -0.727    -0.0567     -0.0508 0.216  0.0233  -0.0164  
 5  1954  0.51  1.20  -0.912     0.142      -0.318  0.386  0.458   -0.000583
 6  1955 -0.64  0.138 -0.824    -0.0267      0.154  0.134  0.0392  -0.362   
 7  1956  0.17  0.617 -1.29     -0.197       0.0617 0.256  0.302   -0.163   
 8  1957 -0.02  0.321 -0.952    -0.638      -0.167  0.322 -0.134   -0.342   
 9  1958  0.12  0.941 -0.243     0.138       0.661  0.296  0.279   -0.868   
10  1959  0.49 -0.055 -0.23     -0.0142      0.631  0.316  0.725   -0.0762  
# ℹ 58 more rows</code></pre>
</div>
</div>
<p>Finally we need to join both tables by year.</p>
<div class="cell">
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">data_all</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">pr_yr</span>, <span class="va">telecon</span>, by <span class="op">=</span> <span class="st">"yr"</span><span class="op">)</span></span>
<span><span class="va">data_all</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 68 × 14
      yr Bilbao Santiago Barcelona Madrid Valencia   NAO   WeMO     EA
   &lt;dbl&gt;  &lt;dbl&gt;    &lt;dbl&gt;     &lt;dbl&gt;  &lt;dbl&gt;    &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;
 1  1950  1342     1800.      345     NA        NA  0.49  0.555 -0.332
 2  1951  1306.    2344.     1072.   798.       NA -0.07  0.379 -0.372
 3  1952  1355.    1973.      415.   524.       NA -0.37  0.693 -0.688
 4  1953  1372.     973.      683.   365.       NA  0.4  -0.213 -0.727
 5  1954  1428.    1348.      581.   246.       NA  0.51  1.20  -0.912
 6  1955  1062.    1769.      530.   473.       NA -0.64  0.138 -0.824
 7  1956  1254.    1533.      695.   480.       NA  0.17  0.617 -1.29 
 8  1957   968.    1599.      635.   424.       NA -0.02  0.321 -0.952
 9  1958  1272.    2658.      479.   482.       NA  0.12  0.941 -0.243
10  1959  1450.    2847.     1006    665.       NA  0.49 -0.055 -0.23 
# ℹ 58 more rows
# ℹ 5 more variables: `POL-EUAS` &lt;dbl&gt;, `EATL/WRUS` &lt;dbl&gt;, MO &lt;dbl&gt;,
#   SCAND &lt;dbl&gt;, AO &lt;dbl&gt;</code></pre>
</div>
</div>
</section><section id="correlation-test" class="level2"><h2 class="anchored" data-anchor-id="correlation-test">Correlation test</h2>
<p>A correlation test between paired samples can be done with the <code><a href="https://rdrr.io/r/stats/cor.test.html">cor.test()</a></code> function of R Base. In this case between the annual precipitation of Bilbao and the NAO index.</p>
<div class="cell">
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">cor_nao_bil</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/cor.test.html">cor.test</a></span><span class="op">(</span><span class="va">data_all</span><span class="op">$</span><span class="va">Bilbao</span>, </span>
<span>                        <span class="va">data_all</span><span class="op">$</span><span class="va">NAO</span>,</span>
<span>                         method <span class="op">=</span> <span class="st">"spearman"</span></span>
<span>                <span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in cor.test.default(data_all$Bilbao, data_all$NAO, method =
"spearman"): Cannot compute exact p-value with ties</code></pre>
</div>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">cor_nao_bil</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
    Spearman's rank correlation rho

data:  data_all$Bilbao and data_all$NAO
S = 44372, p-value = 0.2126
alternative hypothesis: true rho is not equal to 0
sample estimates:
      rho 
0.1531149 </code></pre>
</div>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/str.html">str</a></span><span class="op">(</span><span class="va">cor_nao_bil</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>List of 8
 $ statistic  : Named num 44372
  ..- attr(*, "names")= chr "S"
 $ parameter  : NULL
 $ p.value    : num 0.213
 $ estimate   : Named num 0.153
  ..- attr(*, "names")= chr "rho"
 $ null.value : Named num 0
  ..- attr(*, "names")= chr "rho"
 $ alternative: chr "two.sided"
 $ method     : chr "Spearman's rank correlation rho"
 $ data.name  : chr "data_all$Bilbao and data_all$NAO"
 - attr(*, "class")= chr "htest"</code></pre>
</div>
</div>
<p>We see that the result is in an unmanageable and untidy format. It is a console summary of the correlation with all the statistical parameters necessary to get a conclusion about the relationship. The orginal structure is a list of vectors. However, the <code><a href="https://generics.r-lib.org/reference/tidy.html">tidy()</a></code> function of the <em>{broom}</em> package allows us to convert the result into a table format.</p>
<div class="cell">
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://generics.r-lib.org/reference/tidy.html">tidy</a></span><span class="op">(</span><span class="va">cor_nao_bil</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 5
  estimate statistic p.value method                          alternative
     &lt;dbl&gt;     &lt;dbl&gt;   &lt;dbl&gt; &lt;chr&gt;                           &lt;chr&gt;      
1    0.153    44372.   0.213 Spearman's rank correlation rho two.sided  </code></pre>
</div>
</div>
</section><section id="apply-the-correlation-test-to-multiple-variables" class="level2"><h2 class="anchored" data-anchor-id="apply-the-correlation-test-to-multiple-variables">Apply the correlation test to multiple variables</h2>
<p>The objective is to apply the correlation test to all weather stations and climate teleconnection indices.</p>
<p>First, we must pass the table to the long format, that is, create a column/variable for the city and for the value of the corresponding precipitation. Then we repeat the same for the teleconnections indices.</p>
<div class="cell">
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">pivot_longer</a></span><span class="op">(</span><span class="va">data_all</span>, <span class="va">Bilbao</span><span class="op">:</span><span class="va">Valencia</span>, names_to <span class="op">=</span> <span class="st">"city"</span>, values_to <span class="op">=</span> <span class="st">"pr"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>             <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">pivot_longer</a></span><span class="op">(</span><span class="va">NAO</span><span class="op">:</span><span class="va">AO</span>, names_to <span class="op">=</span> <span class="st">"telecon"</span>, values_to <span class="op">=</span> <span class="st">"index"</span><span class="op">)</span></span>
<span><span class="va">data</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2,720 × 5
      yr city        pr telecon     index
   &lt;dbl&gt; &lt;chr&gt;    &lt;dbl&gt; &lt;chr&gt;       &lt;dbl&gt;
 1  1950 Bilbao   1342  NAO        0.49  
 2  1950 Bilbao   1342  WeMO       0.555 
 3  1950 Bilbao   1342  EA        -0.332 
 4  1950 Bilbao   1342  POL-EUAS   0.0217
 5  1950 Bilbao   1342  EATL/WRUS -0.0567
 6  1950 Bilbao   1342  MO         0.335 
 7  1950 Bilbao   1342  SCAND      0.301 
 8  1950 Bilbao   1342  AO        -0.199 
 9  1950 Santiago 1800. NAO        0.49  
10  1950 Santiago 1800. WeMO       0.555 
# ℹ 2,710 more rows</code></pre>
</div>
</div>
<p>To apply the test to all cities, we need the corresponding groupings. Therefore, we use the <code><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by()</a></code> function for indicating the two groups: <em>city</em> and <em>telecon</em>. In addition, we apply the <code><a href="https://tidyr.tidyverse.org/reference/nest.html">nest()</a></code> function of the <em>{tidyr}</em> package (<em>{tidyverse}</em> collection) with the aim of creating lists of tables nested per row. In other words, in each row of each city and teleconnection index we will have a new table that contains the year, the precipitation value and the value of each teleconection, correspondingly.</p>
<div class="cell">
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">data_nest</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">data</span>, <span class="va">city</span>, <span class="va">telecon</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://tidyr.tidyverse.org/reference/nest.html">nest</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">data_nest</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 3
# Groups:   city, telecon [6]
  city   telecon   data             
  &lt;chr&gt;  &lt;chr&gt;     &lt;list&gt;           
1 Bilbao NAO       &lt;tibble [68 × 3]&gt;
2 Bilbao WeMO      &lt;tibble [68 × 3]&gt;
3 Bilbao EA        &lt;tibble [68 × 3]&gt;
4 Bilbao POL-EUAS  &lt;tibble [68 × 3]&gt;
5 Bilbao EATL/WRUS &lt;tibble [68 × 3]&gt;
6 Bilbao MO        &lt;tibble [68 × 3]&gt;</code></pre>
</div>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/str.html">str</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html">slice</a></span><span class="op">(</span><span class="va">data_nest</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>gropd_df [6 × 3] (S3: grouped_df/tbl_df/tbl/data.frame)
 $ city   : chr [1:6] "Barcelona" "Barcelona" "Barcelona" "Barcelona" ...
 $ telecon: chr [1:6] "AO" "EA" "EATL/WRUS" "MO" ...
 $ data   :List of 6
  ..$ : tibble [68 × 3] (S3: tbl_df/tbl/data.frame)
  .. ..$ yr   : num [1:68] 1950 1951 1952 1953 1954 ...
  .. ..$ pr   : num [1:68] 345 1072 415 683 581 ...
  .. ..$ index: num [1:68] -0.199333 -0.364667 -0.674917 -0.016417 -0.000583 ...
  ..$ : tibble [68 × 3] (S3: tbl_df/tbl/data.frame)
  .. ..$ yr   : num [1:68] 1950 1951 1952 1953 1954 ...
  .. ..$ pr   : num [1:68] 345 1072 415 683 581 ...
  .. ..$ index: num [1:68] -0.333 -0.372 -0.688 -0.727 -0.912 ...
  ..$ : tibble [68 × 3] (S3: tbl_df/tbl/data.frame)
  .. ..$ yr   : num [1:68] 1950 1951 1952 1953 1954 ...
  .. ..$ pr   : num [1:68] 345 1072 415 683 581 ...
  .. ..$ index: num [1:68] -0.0567 -0.4192 -0.7108 -0.0508 -0.3175 ...
  ..$ : tibble [68 × 3] (S3: tbl_df/tbl/data.frame)
  .. ..$ yr   : num [1:68] 1950 1951 1952 1953 1954 ...
  .. ..$ pr   : num [1:68] 345 1072 415 683 581 ...
  .. ..$ index: num [1:68] 0.335 0.149 0.282 0.216 0.386 ...
  ..$ : tibble [68 × 3] (S3: tbl_df/tbl/data.frame)
  .. ..$ yr   : num [1:68] 1950 1951 1952 1953 1954 ...
  .. ..$ pr   : num [1:68] 345 1072 415 683 581 ...
  .. ..$ index: num [1:68] 0.49 -0.07 -0.37 0.4 0.51 -0.64 0.17 -0.02 0.12 0.49 ...
  ..$ : tibble [68 × 3] (S3: tbl_df/tbl/data.frame)
  .. ..$ yr   : num [1:68] 1950 1951 1952 1953 1954 ...
  .. ..$ pr   : num [1:68] 345 1072 415 683 581 ...
  .. ..$ index: num [1:68] 0.0217 0.4025 -0.0117 -0.0567 0.1425 ...
 - attr(*, "groups")= tibble [6 × 3] (S3: tbl_df/tbl/data.frame)
  ..$ city   : chr [1:6] "Barcelona" "Barcelona" "Barcelona" "Barcelona" ...
  ..$ telecon: chr [1:6] "AO" "EA" "EATL/WRUS" "MO" ...
  ..$ .rows  : list&lt;int&gt; [1:6] 
  .. ..$ : int 1
  .. ..$ : int 2
  .. ..$ : int 3
  .. ..$ : int 4
  .. ..$ : int 5
  .. ..$ : int 6
  .. ..@ ptype: int(0) 
  ..- attr(*, ".drop")= logi TRUE</code></pre>
</div>
</div>
<p>The next step is to create a function, in which we define the correlation test and pass it to the clean format using the <code><a href="https://generics.r-lib.org/reference/tidy.html">tidy()</a></code> function, which we apply to each groupings.</p>
<div class="cell">
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">cor_fun</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">df</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/stats/cor.test.html">cor.test</a></span><span class="op">(</span><span class="va">df</span><span class="op">$</span><span class="va">pr</span>, <span class="va">df</span><span class="op">$</span><span class="va">index</span>, method <span class="op">=</span> <span class="st">"spearman"</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://generics.r-lib.org/reference/tidy.html">tidy</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now we only have to apply our function to the column that contains the tables for each combination between city and teleconnection. To do this, we use the <code><a href="https://purrr.tidyverse.org/reference/map.html">map()</a></code> function that applies another function to a vector or list. What we do is create a new column that contains the result, a statistical summary table, for each combination.</p>
<div class="cell">
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">data_nest</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span><span class="va">data_nest</span>, model <span class="op">=</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span><span class="op">(</span><span class="va">data</span>, <span class="va">cor_fun</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">data_nest</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 4
# Groups:   city, telecon [6]
  city   telecon   data              model           
  &lt;chr&gt;  &lt;chr&gt;     &lt;list&gt;            &lt;list&gt;          
1 Bilbao NAO       &lt;tibble [68 × 3]&gt; &lt;tibble [1 × 5]&gt;
2 Bilbao WeMO      &lt;tibble [68 × 3]&gt; &lt;tibble [1 × 5]&gt;
3 Bilbao EA        &lt;tibble [68 × 3]&gt; &lt;tibble [1 × 5]&gt;
4 Bilbao POL-EUAS  &lt;tibble [68 × 3]&gt; &lt;tibble [1 × 5]&gt;
5 Bilbao EATL/WRUS &lt;tibble [68 × 3]&gt; &lt;tibble [1 × 5]&gt;
6 Bilbao MO        &lt;tibble [68 × 3]&gt; &lt;tibble [1 × 5]&gt;</code></pre>
</div>
<div class="sourceCode" id="cb39"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/str.html">str</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html">slice</a></span><span class="op">(</span><span class="va">data_nest</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>gropd_df [6 × 4] (S3: grouped_df/tbl_df/tbl/data.frame)
 $ city   : chr [1:6] "Barcelona" "Barcelona" "Barcelona" "Barcelona" ...
 $ telecon: chr [1:6] "AO" "EA" "EATL/WRUS" "MO" ...
 $ data   :List of 6
  ..$ : tibble [68 × 3] (S3: tbl_df/tbl/data.frame)
  .. ..$ yr   : num [1:68] 1950 1951 1952 1953 1954 ...
  .. ..$ pr   : num [1:68] 345 1072 415 683 581 ...
  .. ..$ index: num [1:68] -0.199333 -0.364667 -0.674917 -0.016417 -0.000583 ...
  ..$ : tibble [68 × 3] (S3: tbl_df/tbl/data.frame)
  .. ..$ yr   : num [1:68] 1950 1951 1952 1953 1954 ...
  .. ..$ pr   : num [1:68] 345 1072 415 683 581 ...
  .. ..$ index: num [1:68] -0.333 -0.372 -0.688 -0.727 -0.912 ...
  ..$ : tibble [68 × 3] (S3: tbl_df/tbl/data.frame)
  .. ..$ yr   : num [1:68] 1950 1951 1952 1953 1954 ...
  .. ..$ pr   : num [1:68] 345 1072 415 683 581 ...
  .. ..$ index: num [1:68] -0.0567 -0.4192 -0.7108 -0.0508 -0.3175 ...
  ..$ : tibble [68 × 3] (S3: tbl_df/tbl/data.frame)
  .. ..$ yr   : num [1:68] 1950 1951 1952 1953 1954 ...
  .. ..$ pr   : num [1:68] 345 1072 415 683 581 ...
  .. ..$ index: num [1:68] 0.335 0.149 0.282 0.216 0.386 ...
  ..$ : tibble [68 × 3] (S3: tbl_df/tbl/data.frame)
  .. ..$ yr   : num [1:68] 1950 1951 1952 1953 1954 ...
  .. ..$ pr   : num [1:68] 345 1072 415 683 581 ...
  .. ..$ index: num [1:68] 0.49 -0.07 -0.37 0.4 0.51 -0.64 0.17 -0.02 0.12 0.49 ...
  ..$ : tibble [68 × 3] (S3: tbl_df/tbl/data.frame)
  .. ..$ yr   : num [1:68] 1950 1951 1952 1953 1954 ...
  .. ..$ pr   : num [1:68] 345 1072 415 683 581 ...
  .. ..$ index: num [1:68] 0.0217 0.4025 -0.0117 -0.0567 0.1425 ...
 $ model  :List of 6
  ..$ : tibble [1 × 5] (S3: tbl_df/tbl/data.frame)
  .. ..$ estimate   : Named num -0.00989
  .. .. ..- attr(*, "names")= chr "rho"
  .. ..$ statistic  : Named num 52912
  .. .. ..- attr(*, "names")= chr "S"
  .. ..$ p.value    : num 0.936
  .. ..$ method     : chr "Spearman's rank correlation rho"
  .. ..$ alternative: chr "two.sided"
  ..$ : tibble [1 × 5] (S3: tbl_df/tbl/data.frame)
  .. ..$ estimate   : Named num -0.295
  .. .. ..- attr(*, "names")= chr "rho"
  .. ..$ statistic  : Named num 67832
  .. .. ..- attr(*, "names")= chr "S"
  .. ..$ p.value    : num 0.0147
  .. ..$ method     : chr "Spearman's rank correlation rho"
  .. ..$ alternative: chr "two.sided"
  ..$ : tibble [1 × 5] (S3: tbl_df/tbl/data.frame)
  .. ..$ estimate   : Named num 0.161
  .. .. ..- attr(*, "names")= chr "rho"
  .. ..$ statistic  : Named num 43966
  .. .. ..- attr(*, "names")= chr "S"
  .. ..$ p.value    : num 0.19
  .. ..$ method     : chr "Spearman's rank correlation rho"
  .. ..$ alternative: chr "two.sided"
  ..$ : tibble [1 × 5] (S3: tbl_df/tbl/data.frame)
  .. ..$ estimate   : Named num -0.255
  .. .. ..- attr(*, "names")= chr "rho"
  .. ..$ statistic  : Named num 65754
  .. .. ..- attr(*, "names")= chr "S"
  .. ..$ p.value    : num 0.0361
  .. ..$ method     : chr "Spearman's rank correlation rho"
  .. ..$ alternative: chr "two.sided"
  ..$ : tibble [1 × 5] (S3: tbl_df/tbl/data.frame)
  .. ..$ estimate   : Named num -0.0203
  .. .. ..- attr(*, "names")= chr "rho"
  .. ..$ statistic  : Named num 53460
  .. .. ..- attr(*, "names")= chr "S"
  .. ..$ p.value    : num 0.869
  .. ..$ method     : chr "Spearman's rank correlation rho"
  .. ..$ alternative: chr "two.sided"
  ..$ : tibble [1 × 5] (S3: tbl_df/tbl/data.frame)
  .. ..$ estimate   : Named num 0.178
  .. .. ..- attr(*, "names")= chr "rho"
  .. ..$ statistic  : Named num 43082
  .. .. ..- attr(*, "names")= chr "S"
  .. ..$ p.value    : num 0.147
  .. ..$ method     : chr "Spearman's rank correlation rho"
  .. ..$ alternative: chr "two.sided"
 - attr(*, "groups")= tibble [6 × 3] (S3: tbl_df/tbl/data.frame)
  ..$ city   : chr [1:6] "Barcelona" "Barcelona" "Barcelona" "Barcelona" ...
  ..$ telecon: chr [1:6] "AO" "EA" "EATL/WRUS" "MO" ...
  ..$ .rows  : list&lt;int&gt; [1:6] 
  .. ..$ : int 1
  .. ..$ : int 2
  .. ..$ : int 3
  .. ..$ : int 4
  .. ..$ : int 5
  .. ..$ : int 6
  .. ..@ ptype: int(0) 
  ..- attr(*, ".drop")= logi TRUE</code></pre>
</div>
</div>
<p>How can we undo the list of tables in each row of our table?</p>
<p>First we eliminate the column with the data and then simply we can apply the <code><a href="https://tidyr.tidyverse.org/reference/unnest.html">unnest()</a></code> function.</p>
<div class="cell">
<div class="sourceCode" id="cb41"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">corr_pr</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">data_nest</span>, <span class="op">-</span><span class="va">data</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://tidyr.tidyverse.org/reference/unnest.html">unnest</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: `cols` is now required when using `unnest()`.
ℹ Please use `cols = c(model)`.</code></pre>
</div>
<div class="sourceCode" id="cb43"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">corr_pr</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 40 × 7
# Groups:   city, telecon [40]
   city     telecon   estimate statistic  p.value method             alternative
   &lt;chr&gt;    &lt;chr&gt;        &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt; &lt;chr&gt;              &lt;chr&gt;      
 1 Bilbao   NAO         0.153     44372. 0.213    Spearman's rank c… two.sided  
 2 Bilbao   WeMO        0.404     31242  0.000706 Spearman's rank c… two.sided  
 3 Bilbao   EA         -0.256     65825. 0.0348   Spearman's rank c… two.sided  
 4 Bilbao   POL-EUAS    0.147     44670  0.230    Spearman's rank c… two.sided  
 5 Bilbao   EATL/WRUS   0.0155    51584. 0.900    Spearman's rank c… two.sided  
 6 Bilbao   MO         -0.0457    54788  0.711    Spearman's rank c… two.sided  
 7 Bilbao   SCAND       0.357     33688  0.00296  Spearman's rank c… two.sided  
 8 Bilbao   AO         -0.185     62070  0.131    Spearman's rank c… two.sided  
 9 Santiago NAO        -0.181     61902. 0.139    Spearman's rank c… two.sided  
10 Santiago WeMO        0.332     35014  0.00594  Spearman's rank c… two.sided  
# ℹ 30 more rows</code></pre>
</div>
</div>
<p>The result is a table in which we can see the correlations and their statistical significance for each city and teleconnection index.</p>
</section><section id="heatmap-of-the-results" class="level2"><h2 class="anchored" data-anchor-id="heatmap-of-the-results">Heatmap of the results</h2>
<p>Finally, we make a heatmap of the obtained result. But, previously we create a column that indicates whether the correlation is significant with p-value less than 0.05.</p>
<div class="cell">
<div class="sourceCode" id="cb45"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">corr_pr</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span><span class="va">corr_pr</span>, sig <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">p.value</span> <span class="op">&lt;</span> <span class="fl">0.05</span>, <span class="st">"Sig."</span>, <span class="st">"Non Sig."</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode" id="cb46"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_tile.html">geom_tile</a></span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="va">corr_pr</span>,</span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span><span class="va">city</span>, <span class="va">telecon</span>, fill <span class="op">=</span> <span class="va">estimate</span><span class="op">)</span>,</span>
<span>    linewidth <span class="op">=</span> <span class="fl">1</span>,</span>
<span>    colour <span class="op">=</span> <span class="st">"white"</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_tile.html">geom_tile</a></span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">corr_pr</span>, <span class="va">sig</span> <span class="op">==</span> <span class="st">"Sig."</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span><span class="va">city</span>, <span class="va">telecon</span><span class="op">)</span>,</span>
<span>    linewidth <span class="op">=</span> <span class="fl">1</span>,</span>
<span>    colour <span class="op">=</span> <span class="st">"black"</span>,</span>
<span>    fill <span class="op">=</span> <span class="cn">NA</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_text.html">geom_text</a></span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="va">corr_pr</span>,</span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span><span class="va">city</span>, <span class="va">telecon</span>,</span>
<span>      label <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">estimate</span>, <span class="fl">2</span><span class="op">)</span>,</span>
<span>      fontface <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">sig</span> <span class="op">==</span> <span class="st">"Sig."</span>, <span class="st">"bold"</span>, <span class="st">"plain"</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_gradient.html">scale_fill_gradient2</a></span><span class="op">(</span>breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">0.2</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="cn">NULL</span>, y <span class="op">=</span> <span class="cn">NULL</span>, fill <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_cartesian.html">coord_cartesian</a></span><span class="op">(</span>expand <span class="op">=</span> <span class="cn">F</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_void</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>axis.text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><a href="index_files/figure-html/unnamed-chunk-15-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-1"><img src="index_files/figure-html/unnamed-chunk-15-1.png" class="img-fluid figure-img" width="2100"></a></p>
</figure>
</div>
</div>
</div>


</section><a onclick="window.scrollTo(0, 0); return false;" role="button" id="quarto-back-to-top"><i class="bi bi-arrow-up"></i> Back to top</a><div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" id="quarto-reuse"><h2 class="anchored quarto-appendix-heading">Reuse</h2><div class="quarto-appendix-contents"><div><a rel="license" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a></div></div></section><section class="quarto-appendix-contents" id="quarto-citation"><h2 class="anchored quarto-appendix-heading">Citation</h2><div><div class="quarto-appendix-secondary-label">For attribution, please cite this work as:</div><div id="ref-royé2019" class="csl-entry quarto-appendix-citeas" role="listitem">
Royé, Dominic. 2019. <span>“Tidy Correlation Tests in R.”</span> April
17, 2019. <a href="https://dominicroye.github.io/blog/2019-04-17-tidy-correlation-tests-in-r/">https://dominicroye.github.io/blog/2019-04-17-tidy-correlation-tests-in-r/</a>.
</div></div></section></div></main><!-- /main --><style> 
.button-container { 
  padding-top: 2em;
  padding-bottom: 1em;
  display: flex; 
  justify-content: center; 
  align-items: center;
}
</style>
<div class="button-container">
<a href="https://www.buymeacoffee.com/drxeo" target="_blank"><img src="https://cdn.buymeacoffee.com/buttons/default-orange.png" alt="Buy Me A Coffee" height="41" width="174"></a>
</div>
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/dominicroye\.github\.io");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->
<footer class="footer"><div class="nav-footer">
    <div class="nav-footer-left">
<p>© 2018-2025 Dominic Royé ∙ Made with <a href="https://quarto.org">Quarto</a></p>
</div>   
    <div class="nav-footer-center">
<p><a class="link-dark me-1" href="https://bsky.app/profile/drxeo.eu" title="Bluesky" target="_blank" rel="noopener"><i class="fa-brands fa-bluesky" aria-label="bluesky"></i></a> <a class="link-dark me-1" href="https://www.linkedin.com/in/dominicroye/" title="LinkedIn" target="_blank" rel="noopener"><i class="fa-brands fa-linkedin" aria-label="linkedin"></i></a> <a class="link-dark me-1" href="https://github.com/dominicroye" title="github" target="_blank" rel="noopener"><i class="fa-brands fa-github" aria-label="github"></i></a> <a class="link-dark me-1" href="https://orcid.org/0000-0002-5516-6396" title="orcid" target="_blank" rel="noopener"><i class="ai  ai-orcid"></i></a> <a class="link-dark me-1" href="https://scholar.google.es/citations?user=EoYa8jUAAAAJ&amp;hl=es" title="Google Scholar" target="_blank" rel="noopener"><i class="ai  ai-google-scholar"></i></a></p>
</div>
    <div class="nav-footer-right">
      <ul class="footer-items list-unstyled">
<li class="nav-item">
    <a class="nav-link" href="../../contact.html">
<p>Contact</p>
</a>
  </li>  
</ul>
</div>
  </div>
</footer><script>var lightboxQuarto = GLightbox({"closeEffect":"zoom","descPosition":"bottom","loop":false,"openEffect":"zoom","selector":".lightbox"});
(function() {
  let previousOnload = window.onload;
  window.onload = () => {
    if (previousOnload) {
      previousOnload();
    }
    lightboxQuarto.on('slide_before_load', (data) => {
      const { slideIndex, slideNode, slideConfig, player, trigger } = data;
      const href = trigger.getAttribute('href');
      if (href !== null) {
        const imgEl = window.document.querySelector(`a[href="${href}"] img`);
        if (imgEl !== null) {
          const srcAttr = imgEl.getAttribute("src");
          if (srcAttr && srcAttr.startsWith("data:")) {
            slideConfig.href = srcAttr;
          }
        }
      } 
    });
  
    lightboxQuarto.on('slide_after_load', (data) => {
      const { slideIndex, slideNode, slideConfig, player, trigger } = data;
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(slideNode);
      }
    });
  
  };
  
})();
          </script>


<script src="../../site_libs/quarto-html/zenscroll-min.js"></script>
</body></html>