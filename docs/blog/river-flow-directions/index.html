<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">

<head>

<meta charset="utf-8" />
<meta name="generator" content="quarto-1.6.39" />

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />

<meta name="author" content="Dominic Royé" />
<meta name="dcterms.date" content="2020-07-24" />

<title>River flow directions – Dr Dominic Royé</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>

<!-- htmldependencies:E3FAD763 -->
<script id="quarto-search-options" type="application/json">{
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

<script type="text/javascript">

(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
ga('create', 'UA-27463794-2', 'auto');

ga('send', {
  hitType: 'pageview',
  'anonymizeIp': true,
});
</script>
<style>html{ scroll-behavior: smooth; }</style>


</head>

<body>

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a href="/index.html" class="navbar-brand navbar-brand-logo">
    <img src="/assets/img/logo.svg" alt="" class="navbar-logo" />
    </a>
    <a class="navbar-brand" href="/index.html">
    <span class="navbar-title">Dr Dominic Royé</span>
    </a>
  </div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse"
  aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation"
  onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="/about/index.html"> 
<span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="/blog/index.html"> 
<span class="menu-text">Blog</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="/publication/index.html"> 
<span class="menu-text">Publications</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="/project/index.html"> 
<span class="menu-text">Data Viz</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <div id="quarto-toc-target"></div>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<!-- source: https://github.com/gadenbuie/garrickadenbuie-com/blob/main/_partials/title-block-link-buttons/title-block.html -->
<!-- 
<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title"> 
-->
<!-- <header id="title-block-header" class="quarto-title-block default page-columns"> -->
<!-- <div class="quarto-title page-columns page-full featured-image p-4" style="background-image: url(featured.png), url(featured.jpg), url(../featured.jpg);"> -->
<header id="title-block-header" class="quarto-title-block default page-columns">
<div id="title-block-header-title" class="quarto-title page-columns page-full page-layout-full featured-image p-4">

<h1 class="title">River flow directions</h1>

<div class="no-row-height column-margin column-container">
  
  <img src="featured.png" class="img-fluid" style="max-width: 125%;height: auto;">
  
</div>

    <div class="quarto-categories">
        <div class="quarto-category">gis</div>
        <div class="quarto-category">R</div>
        <div class="quarto-category">R:advanced</div>
        <div class="quarto-category">river</div>
        <div class="quarto-category">directions</div>
        <div class="quarto-category">distribution</div>
      </div>
  </div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Dominic Royé </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">July 24, 2020</p>
    </div>
  </div>
  
    <div>
    <div class="quarto-title-meta-heading">Modified</div>
    <div class="quarto-title-meta-contents">
      <p class="date-modified">January 3, 2025</p>
    </div>
  </div>
    
  </div>
  



</header>

<style type="text/css">

#toc-title {
  
  display:none;

}

#quarto-toc-toggle {
  
    display:none;
    
}
  
</style>

<nav id="TOC" role="doc-toc">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#packages" id="toc-packages">Packages</a></li>
  <li><a href="#initial-considerations" id="toc-initial-considerations">Initial considerations</a></li>
  <li><a href="#preparation" id="toc-preparation">Preparation</a>
  <ul>
  <li><a href="#data" id="toc-data">Data</a></li>
  <li><a href="#import-and-project" id="toc-import-and-project">Import and project</a></li>
  <li><a href="#extract-the-angles" id="toc-extract-the-angles">Extract the angles</a></li>
  <li><a href="#selection" id="toc-selection">Selection</a></li>
  </ul></li>
  <li><a href="#estimate-the-distribution" id="toc-estimate-the-distribution">Estimate the distribution</a></li>
  <li><a href="#visualization" id="toc-visualization">Visualization</a></li>
  </ul>
</nav>
<p>I recently created a visualization of the distribution of river flow directions and also of coastal orientations. Following its publication in social networks, I was asked to make a post about how I did it. Well, here we go to start with an example of rivers, coastal orientation is somewhat more complex. I did the same for a selection of European rivers here in this. However, originally I started with the orientation of the European coasts.</p>
<p><a href="orientacion_eu.png" class="lightbox" data-gallery="quarto-lightbox-gallery-1"><img src="orientacion_eu.png" class="img-fluid" /></a></p>
<section id="packages" class="level2">
<h2>Packages</h2>
<p>In this post we will use the following packages:</p>
<div class="cell">
<div class="cell-output-display">
<table class="caption-top">
<colgroup>
<col style="width: 13%" />
<col style="width: 86%" />
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">Packages</th>
<th style="text-align: left;">Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">tidyverse</td>
<td style="text-align: left;">Collection of packages (visualization, manipulation): ggplot2, dplyr, purrr, etc.</td>
</tr>
<tr class="even">
<td style="text-align: left;">remotes</td>
<td style="text-align: left;">Installation from remote repositories</td>
</tr>
<tr class="odd">
<td style="text-align: left;">qgisprocess</td>
<td style="text-align: left;">Interface between R and QGIS</td>
</tr>
<tr class="even">
<td style="text-align: left;">sf</td>
<td style="text-align: left;">Simple Feature: import, export and manipulate vector data</td>
</tr>
<tr class="odd">
<td style="text-align: left;">ggtext</td>
<td style="text-align: left;">Improved text rendering support for ggplot2</td>
</tr>
<tr class="even">
<td style="text-align: left;">geomtextpath</td>
<td style="text-align: left;">ggplot2 extension for curved text on lines</td>
</tr>
<tr class="odd">
<td style="text-align: left;">circular</td>
<td style="text-align: left;">Functions for working with circular data</td>
</tr>
<tr class="even">
<td style="text-align: left;">geosphere</td>
<td style="text-align: left;">Spherical trigonometry for geographic applications</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>In the case of the <code>qgisprocess</code> package, it is necessary to install QIGS &gt;= 3.16 <a href="https://download.qgis.org/">here</a>. I will explain the reason for using QGIS later.</p>
<div class="cell">
<div class="sourceCode" id="cb1"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># install the packages if necessary</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">require</span>(<span class="st">&quot;tidyverse&quot;</span>)) <span class="fu">install.packages</span>(<span class="st">&quot;tidyverse&quot;</span>)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">require</span>(<span class="st">&quot;remotes&quot;</span>)) <span class="fu">install.packages</span>(<span class="st">&quot;remotes&quot;</span>)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">require</span>(<span class="st">&quot;qgisprocess&quot;</span>)) remotes<span class="sc">::</span><span class="fu">install_github</span>(<span class="st">&quot;paleolimbot/qgisprocess&quot;</span>)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">require</span>(<span class="st">&quot;sf&quot;</span>)) <span class="fu">install.packages</span>(<span class="st">&quot;sf&quot;</span>)</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">require</span>(<span class="st">&quot;ggtext&quot;</span>)) <span class="fu">install.packages</span>(<span class="st">&quot;ggtext&quot;</span>)</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">require</span>(<span class="st">&quot;circular&quot;</span>)) <span class="fu">install.packages</span>(<span class="st">&quot;circular&quot;</span>)</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">require</span>(<span class="st">&quot;geosphere&quot;</span>)) <span class="fu">install.packages</span>(<span class="st">&quot;geosphere&quot;</span>)</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">require</span>(<span class="st">&quot;geomtextpath&quot;</span>)) <span class="fu">install.packages</span>(<span class="st">&quot;geomtextpath&quot;</span>)</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="co"># packages</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sf)</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggtext)</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(circular)</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(geosphere)</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(qgisprocess)</span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(geomtextpath)</span></code></pre></div>
</div>
</section>
<section id="initial-considerations" class="level1">
<h1>Initial considerations</h1>
<p>Angles in vectorial lines are based on the angle between two vertices, and the number of vertices depends on the complexity, and therefore the resolution, of the vector data. Consequently, there can be differences in using different resolutions of a spatial line, either from the coast or from the river as in this example. A straight line is simply constructed with two points of longitude and latitude.</p>
<p>Related to this is fractality, an apparently irregular structure but that is repeated at different scales, known from coastlines or also from river. The most paradoxical feature is that the length of a coastline depends on the measurement scale, the smaller the measurement increment, the longer is the measured coastline.</p>
<p>There are two possibilities of obtaining the vertice angles. In the first one we calculate the angle between all consecutive vertices.</p>
<p>For example, imagine two points, Madrid (-3.71, 40.43) and Barcelona (2.14, 41.4).</p>
<p>What is the angle of a straight line between both cities?</p>
<div class="cell">
<div class="sourceCode" id="cb2"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">bearingRhumb</span>(<span class="fu">c</span>(<span class="sc">-</span><span class="fl">3.71</span>, <span class="fl">40.43</span>), <span class="fu">c</span>(<span class="fl">2.14</span>, <span class="fl">41.4</span>))</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 77.62391</code></pre>
</div>
</div>
<p>We see that it is 77º, that is, northeast direction. But what if we go from Barcelona to Madrid?</p>
<div class="cell">
<div class="sourceCode" id="cb4"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="fu">bearingRhumb</span>(<span class="fu">c</span>(<span class="fl">2.14</span>, <span class="fl">41.4</span>), <span class="fu">c</span>(<span class="sc">-</span><span class="fl">3.71</span>, <span class="fl">40.43</span>))</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 257.6239</code></pre>
</div>
</div>
<p>The angle is different because we <em>move</em> from the northeast to the southwest. We can easily invert the direction to get the opposite angle.</p>
<div class="cell">
<div class="sourceCode" id="cb6"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># opposite angle of Barcelona -&gt; Madrid</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="fu">bearingRhumb</span>(<span class="fu">c</span>(<span class="fl">2.14</span>, <span class="fl">41.4</span>), <span class="fu">c</span>(<span class="sc">-</span><span class="fl">3.71</span>, <span class="fl">40.43</span>)) <span class="sc">-</span> <span class="dv">180</span></span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 77.62391</code></pre>
</div>
<div class="sourceCode" id="cb8"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># opposite angle of Madrid -&gt; Barcelona</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="fu">bearingRhumb</span>(<span class="fu">c</span>(<span class="sc">-</span><span class="fl">3.71</span>, <span class="fl">40.43</span>), <span class="fu">c</span>(<span class="fl">2.14</span>, <span class="fl">41.4</span>)) <span class="sc">+</span> <span class="dv">180</span></span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 257.6239</code></pre>
</div>
</div>
<p>The direction in which we calculate the angles is important. In the case of rivers, it is expected to be the direction of flow from origin to the mouth, however, a problem may be that the vertices, which build the lines, are not geographically ordered in the attribute table. Another problem may be that the vertices start at the mouth which would give the reverse angle as we have seen before.</p>
<p>However, there is an easier way. We can take advantage of the attributes of projected coordinate systems (Robinson projection, etc.) that include the angle between the vertices. We will use this last approach in this post. Still, we must pay close attention to the results as stated above.</p>
</section>
<section id="preparation" class="level1">
<h1>Preparation</h1>
<section id="data" class="level2">
<h2>Data</h2>
<p>We download the central lines of the largest rivers in the world (<a href="assets/www/RiverHRCenterlinesCombo.zip">here</a>), also accessible in <a href="https://www.sciencebase.gov/catalog/item/5a145fdde4b09fc93dcfd36c">Zeenatul Basher et al. 2018</a>.</p>
</section>
<section id="import-and-project" class="level2">
<h2>Import and project</h2>
<p>The first thing we do is to import, project the spatial lines and delete the third dimension <em>Z</em>, chaining the following functions: <code>st_read()</code> helps us import any vector format, <code>st_zm()</code> delete the dimension Z or M of a geometry and <code>st_transform()</code> projects the vector data to the new projection in <em>proj4</em> format. We combine the functions with the famous pipe (<code>|&gt;</code>) that facilitates the application of a sequence of functions on a data set. All functions in the <code>sf</code> package start with <code>st_*</code> with reference to the spatial character, similar to <em>PostGIS</em>. In the same style as <em>PostGIS</em>, verbs are used as function names.</p>
<div class="cell">
<div class="sourceCode" id="cb10"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>proj_rob <span class="ot">&lt;-</span> <span class="st">&quot;ESRI:54030&quot;</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>river_line <span class="ot">&lt;-</span> <span class="fu">st_read</span>(<span class="st">&quot;RiverHRCenterlinesCombo.shp&quot;</span>) <span class="sc">|&gt;</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_zm</span>() <span class="sc">|&gt;</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_transform</span>(proj_rob)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Reading layer `RiverHRCenterlinesCombo&#39; from data source 
  `C:\Users\xeo19\Downloads\dominicroye.github.io\blog\river-flow-directions\RiverHRCenterlinesCombo.shp&#39; 
  using driver `ESRI Shapefile&#39;
Simple feature collection with 78 features and 6 fields
Geometry type: MULTILINESTRING
Dimension:     XY, XYZ
Bounding box:  xmin: -164.7059 ymin: -36.97094 xmax: 151.5931 ymax: 72.64474
z_range:       zmin: 0 zmax: 0
Geodetic CRS:  WGS 84</code></pre>
</div>
</div>
</section>
<section id="extract-the-angles" class="level2">
<h2>Extract the angles</h2>
<p>In the next step we have to extract the vertice angles. Unfortunately, as far as I know, it is not possible to extract the attributes with some function from the <code>sf</code> package. Although the function <code>st_coordinates()</code> returns the coordinates, it does not include other attributes. Therefore, we must use another way, and that is the open software Quantum GIS in which we can find a tool to extract all the vertice attributes. We could import the vector data into QGIS Desktop and export the vertices from there, but it is also possible to access the QGIS tools from R directly.</p>
<p>For this, we need to have QGIS installed. The <code>qgisprocess</code> package allows us to use very easily all the tools of the software in R. First we use the <code>qgis_configure()</code> function to define all the necessary QGIS paths.</p>
<div class="cell">
<div class="sourceCode" id="cb12"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co"># paths to QGIS</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="fu">qgis_configure</span>()</span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>getOption(&#39;qgisprocess.path&#39;) was not found.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Sys.getenv(&#39;R_QGISPROCESS_PATH&#39;) was not found.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Trying &#39;qgis_process&#39; on PATH...</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>&#39;qgis_process&#39; is not available on PATH.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Found 2 QGIS installations containing &#39;qgis_process&#39;:
 C:/Program Files/QGIS 3.34.2/bin/qgis_process-qgis.bat
C:/Program Files/QGIS 3.34.0/bin/qgis_process-qgis.bat</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Trying command &#39;C:/Program Files/QGIS 3.34.2/bin/qgis_process-qgis.bat&#39;</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Success!</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Now using &#39;qgis_process&#39; at &#39;C:/Program Files/QGIS 3.34.2/bin/qgis_process-qgis.bat&#39;.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>&gt;&gt;&gt; If you need another installed QGIS instance, run `qgis_configure()`;
    see `?qgis_configure` if you need to preset the path of &#39;qgis_process&#39;.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>QGIS version is now set to: 3.34.2-Prizren</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Using JSON for output serialization.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Using JSON for input serialization.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>
Standard error message from &#39;qgis_process&#39;:
Problem with GRASS installation: GRASS was not found or is not correctly installed</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>2 out of 3 available processing provider plugins are enabled.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>
Standard error message from &#39;qgis_process&#39;:
Problem with GRASS installation: GRASS was not found or is not correctly installed</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>You now have access to 376 algorithms from 5 QGIS processing providers.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>&gt;&gt;&gt; Run `qgis_enable_plugins()` to enable 1 disabled plugin and access
    its algorithms: otbprovider</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>
Saving configuration to &#39;C:\Users\xeo19\AppData\Local\R-qgisprocess\R-qgisprocess\Cache/cache-0.4.1.rds&#39;</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Use qgis_algorithms(), qgis_providers(), qgis_plugins(), qgis_path() and
qgis_version() to inspect the cache environment.</code></pre>
</div>
</div>
<p>The <code>qgis_algorithms()</code> function helps us to search for different QGIS tools. In addition the <code>qgis_show_help()</code> function specifies the way of usage with all the required parameters.</p>
<div class="cell">
<div class="sourceCode" id="cb34"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="co"># search tools</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a><span class="fu">qgis_algorithms</span>()</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 376 × 24
   provider provider_title algorithm                algorithm_id algorithm_title
   &lt;chr&gt;    &lt;chr&gt;          &lt;chr&gt;                    &lt;chr&gt;        &lt;chr&gt;          
 1 3d       QGIS (3D)      3d:tessellate            tessellate   Tessellate     
 2 gdal     GDAL           gdal:aspect              aspect       Aspect         
 3 gdal     GDAL           gdal:assignprojection    assignproje… Assign project…
 4 gdal     GDAL           gdal:buffervectors       buffervecto… Buffer vectors 
 5 gdal     GDAL           gdal:buildvirtualraster  buildvirtua… Build virtual …
 6 gdal     GDAL           gdal:buildvirtualvector  buildvirtua… Build virtual …
 7 gdal     GDAL           gdal:cliprasterbyextent  cliprasterb… Clip raster by…
 8 gdal     GDAL           gdal:cliprasterbymaskla… cliprasterb… Clip raster by…
 9 gdal     GDAL           gdal:clipvectorbyextent  clipvectorb… Clip vector by…
10 gdal     GDAL           gdal:clipvectorbypolygon clipvectorb… Clip vector by…
# ℹ 366 more rows
# ℹ 19 more variables: provider_can_be_activated &lt;lgl&gt;,
#   provider_is_active &lt;lgl&gt;, provider_long_name &lt;chr&gt;, provider_version &lt;chr&gt;,
#   provider_warning &lt;chr&gt;, can_cancel &lt;lgl&gt;, deprecated &lt;lgl&gt;, group &lt;chr&gt;,
#   has_known_issues &lt;lgl&gt;, help_url &lt;chr&gt;, requires_matching_crs &lt;lgl&gt;,
#   short_description &lt;chr&gt;, tags &lt;list&gt;, default_raster_file_extension &lt;chr&gt;,
#   default_vector_file_extension &lt;chr&gt;, …</code></pre>
</div>
<div class="sourceCode" id="cb36"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="co"># usage of tool</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a><span class="fu">qgis_show_help</span>(<span class="st">&quot;native:extractvertices&quot;</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Extract vertices (native:extractvertices)

----------------
Description
----------------
This algorithm takes a line or polygon layer and generates a point layer with points representing the vertices in the input lines or polygons. The attributes associated to each point are the same ones associated to the line or polygon that the point belongs to.

Additional fields are added to the point indicating the vertex index (beginning at 0), the vertexs part and its index within the part (as well as its ring for polygons), distance along original geometry and bisector angle of vertex for original geometry.

----------------
Arguments
----------------

INPUT: Input layer
    Argument type:  source
    Acceptable values:
        - Path to a vector layer
OUTPUT: Vertices
    Argument type:  sink
    Acceptable values:
        - Path for new vector layer

----------------
Outputs
----------------

OUTPUT: &lt;outputVector&gt;
    Vertices</code></pre>
</div>
</div>
<p>In our case the tool to extract the vertices is simple and only has one input and one output. The function <code>qgis_run_algorithm()</code> executes a QGIS tool indicating the algorithm and its arguments. The advantage of using the algorithm directly from R is that we can pass objects of class <code>sf</code> (or <code>sp</code>) and <code>raster</code> that we have imported or created in R. As output we create a <code>geojson</code>, it could also be of another vector format, and we save it in a temporary folder. To obtain the QGIS output we need to use <code>qgis_extract_output()</code> function.</p>
<div class="cell">
<div class="sourceCode" id="cb38"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>river_vertices <span class="ot">&lt;-</span> <span class="fu">qgis_run_algorithm</span>(</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">alg =</span> <span class="st">&quot;native:extractvertices&quot;</span>,</span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">INPUT =</span> river_line,</span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">OUTPUT =</span> <span class="fu">file.path</span>(<span class="fu">tempdir</span>(), <span class="st">&quot;rivers_world_vertices.geojson&quot;</span>)</span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a>river_vertices <span class="ot">&lt;-</span> <span class="fu">st_read</span>(<span class="fu">qgis_extract_output</span>(river_vertices, <span class="st">&quot;OUTPUT&quot;</span>))</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Reading layer `rivers_world_vertices&#39; from data source 
  `C:\Users\xeo19\AppData\Local\Temp\RtmpSIybwj\rivers_world_vertices.geojson&#39; 
  using driver `GeoJSON&#39;
Simple feature collection with 339734 features and 12 fields
Geometry type: POINT
Dimension:     XY
Bounding box:  xmin: -12117400 ymin: -3953778 xmax: 13751910 ymax: 7507359
Projected CRS: World_Robinson</code></pre>
</div>
</div>
</section>
<section id="selection" class="level2">
<h2>Selection</h2>
<p>Before continuing with the distribution estimation of the angles, we filter some rivers of interest. The functions of the <code>tidyverse</code> collection are compatible with the <code>sf</code> package. In the last post I made an introduction to <code>tidyverse</code> <a href="https://dominicroye.github.io/en/2020/a-very-short-introduction-to-tidyverse/">here</a>.</p>
<div class="cell">
<div class="sourceCode" id="cb40"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>river_vertices <span class="ot">&lt;-</span> <span class="fu">filter</span>(</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>  river_vertices,</span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>  NAME <span class="sc">%in%</span> <span class="fu">c</span>(</span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;Mississippi&quot;</span>, <span class="st">&quot;Colorado&quot;</span>,</span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;Amazon&quot;</span>, <span class="st">&quot;Nile&quot;</span>, <span class="st">&quot;Orange&quot;</span>,</span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;Ganges&quot;</span>, <span class="st">&quot;Yangtze&quot;</span>, <span class="st">&quot;Danube&quot;</span>,</span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;Mackenzie&quot;</span>, <span class="st">&quot;Lena&quot;</span>, <span class="st">&quot;Murray&quot;</span>,</span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;Niger&quot;</span></span>
<span id="cb40-9"><a href="#cb40-9" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb40-10"><a href="#cb40-10" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb40-11"><a href="#cb40-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-12"><a href="#cb40-12" aria-hidden="true" tabindex="-1"></a>river_vertices</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Simple feature collection with 94702 features and 12 fields
Geometry type: POINT
Dimension:     XY
Bounding box:  xmin: -10377520 ymin: -3953778 xmax: 13124340 ymax: 7507359
Projected CRS: World_Robinson
First 10 features:
   fid NAME SYSTEM name_alt scalerank rivernum Length_km vertex_index
1    6 Nile   &lt;NA&gt;     &lt;NA&gt;         1        4  3343.871            0
2    6 Nile   &lt;NA&gt;     &lt;NA&gt;         1        4  3343.871            1
3    6 Nile   &lt;NA&gt;     &lt;NA&gt;         1        4  3343.871            2
4    6 Nile   &lt;NA&gt;     &lt;NA&gt;         1        4  3343.871            3
5    6 Nile   &lt;NA&gt;     &lt;NA&gt;         1        4  3343.871            4
6    6 Nile   &lt;NA&gt;     &lt;NA&gt;         1        4  3343.871            5
7    6 Nile   &lt;NA&gt;     &lt;NA&gt;         1        4  3343.871            6
8    6 Nile   &lt;NA&gt;     &lt;NA&gt;         1        4  3343.871            7
9    6 Nile   &lt;NA&gt;     &lt;NA&gt;         1        4  3343.871            8
10   6 Nile   &lt;NA&gt;     &lt;NA&gt;         1        4  3343.871            9
   vertex_part vertex_part_index  distance      angle                geometry
1            0                 0     0.000  31.096005 POINT (3037149 1672482)
2            0                 1  1208.130  22.456672 POINT (3037772 1673517)
3            0                 2  2324.160   8.602259 POINT (3038039 1674600)
4            0                 3  3656.452   8.573580 POINT (3038118 1675930)
5            0                 4  5735.538  24.406889 POINT (3038612 1677950)
6            0                 5  6758.322  25.134763 POINT (3039200 1678787)
7            0                 6 10432.834   6.998982 POINT (3040164 1682333)
8            0                 7 14865.136   4.239641 POINT (3040070 1686764)
9            0                 8 16563.207 358.730530 POINT (3040356 1688438)
10           0                 9 18376.526 347.480822 POINT (3039972 1690210)</code></pre>
</div>
</div>
</section>
</section>
<section id="estimate-the-distribution" class="level1">
<h1>Estimate the distribution</h1>
<p>To visualize the distribution we can use either a histogram or a density graph. But in the case of estimating the probability density function, we find a mathematical problem when applying it to circular data. For circular data we should not use the <code>density()</code> standard function of R since in our data a direction of 360º is the same at 0º, which would cause errors in this range of values. It is a general problem for different statistical metrics. More statistical details are explained in the <code>circular</code> package. This package allows you to define the characteristics of circular data (unit, data type, rotation, etc.) as an object class in R.</p>
<p>So what we do is to build a function that estimates the density and returns a table with the angles (x) and the density estimates (y). Since rivers have different lengths, and we want to see differences regardless of that, we normalize the estimates using the maximum value. Unlike the <code>density()</code> function, in which the smoothing bandwidth <code>bw</code> is optimized, here it is required to indicate it manually. It is similar to defining the bar width in a histogram. There is an optimization function for the bandwidth, <code>bw.nrd.circular()</code> that could be used here.</p>
<div class="cell">
<div class="sourceCode" id="cb42"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>dens_circ <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>  dens <span class="ot">&lt;-</span> <span class="fu">density.circular</span>(<span class="fu">circular</span>(x<span class="sc">$</span>angle, <span class="at">units =</span> <span class="st">&quot;degrees&quot;</span>),</span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">bw =</span> <span class="dv">70</span>, <span class="at">kernel =</span> <span class="st">&quot;vonmises&quot;</span>,</span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">control.circular =</span> <span class="fu">list</span>(<span class="at">units =</span> <span class="st">&quot;degrees&quot;</span>)</span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-8"><a href="#cb42-8" aria-hidden="true" tabindex="-1"></a>  df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">x =</span> dens<span class="sc">$</span>x, <span class="at">y =</span> dens<span class="sc">$</span>y <span class="sc">/</span> <span class="fu">max</span>(dens<span class="sc">$</span>y))</span>
<span id="cb42-9"><a href="#cb42-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-10"><a href="#cb42-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(df)</span>
<span id="cb42-11"><a href="#cb42-11" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
</div>
<p>Finally, we estimate the density of each river in our selection. We use the <code>split()</code> function of R Base to get a table of each river in a list object. Then we apply our density estimation function to the list with the function <code>map_df()</code> from the <code>purrr</code> package. The suffix <code>_df</code> allows us to get a joined table, instead of a list with the results of each river. However, it is necessary to indicate the name of the column with the argument <code>.id</code>, which will contain the name of each river. Otherwise we would not know how to differentiate the results. Also here I recommend reading more details in the last post about <code>tidyverse</code> <a href="https://dominicroye.github.io/en/2020/a-very-short-introduction-to-tidyverse/">here</a>.</p>
<div class="cell">
<div class="sourceCode" id="cb43"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>dens_river <span class="ot">&lt;-</span> <span class="fu">split</span>(river_vertices, river_vertices<span class="sc">$</span>NAME) <span class="sc">|&gt;</span></span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">map_df</span>(dens_circ, <span class="at">.id =</span> <span class="st">&quot;river&quot;</span>)</span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a><span class="co"># results</span></span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(dens_river)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   river        x         y
1 Amazon 0.000000 0.2399907
2 Amazon 0.704501 0.2492548
3 Amazon 1.409002 0.2585758
4 Amazon 2.113503 0.2679779
5 Amazon 2.818004 0.2774859
6 Amazon 3.522505 0.2871232</code></pre>
</div>
</div>
</section>
<section id="visualization" class="level1">
<h1>Visualization</h1>
<p>In the next step we create two objects with the title and the plot caption. In the title we are using an html code to color part of the text instead of a legend. You can use html very easily with the <code>ggtext</code> package.</p>
<div class="cell">
<div class="sourceCode" id="cb45"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="co"># title with html</span></span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>title <span class="ot">&lt;-</span> <span class="st">&quot;Relative distribution of river &lt;span style=&#39;color:#011FFD;&#39;&gt;&lt;strong&gt;flow direction&lt;/strong&gt;&lt;/span&gt; in the world&quot;</span></span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a>caption <span class="ot">&lt;-</span> <span class="st">&quot;Based on data from Zeenatul Basher, 20180215&quot;</span></span></code></pre></div>
</div>
<p>The background grid that creates <code>ggplot</code> by default for polar coordinates did not convince me, so we create a table with x axis background lines.</p>
<div class="cell">
<div class="sourceCode" id="cb46"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>grid_x <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">x =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">360</span> <span class="sc">-</span> <span class="fl">22.5</span>, <span class="at">by =</span> <span class="fl">22.5</span>),</span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">y =</span> <span class="fu">rep</span>(<span class="dv">0</span>, <span class="dv">16</span>),</span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">xend =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">360</span> <span class="sc">-</span> <span class="fl">22.5</span>, <span class="at">by =</span> <span class="fl">22.5</span>),</span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">yend =</span> <span class="fu">rep</span>(<span class="cn">Inf</span>, <span class="dv">16</span>)</span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
</div>
<p>Next we define all the styles of the graph. The most important thing in this step is the <code>element_textbox()</code> function of the <code>ggtext</code> package to be able to interpret our html code incorporated into the title.</p>
<div class="cell">
<div class="sourceCode" id="cb47"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>theme_polar <span class="ot">&lt;-</span> <span class="cf">function</span>() {</span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>(<span class="at">base_family =</span> <span class="st">&quot;Montserrat&quot;</span>) <span class="sc">%+replace%</span></span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(</span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a>      <span class="at">axis.title.y =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a>      <span class="at">axis.text.y =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a>      <span class="at">legend.title =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb47-7"><a href="#cb47-7" aria-hidden="true" tabindex="-1"></a>      <span class="at">plot.title =</span> <span class="fu">element_textbox</span>(</span>
<span id="cb47-8"><a href="#cb47-8" aria-hidden="true" tabindex="-1"></a>        <span class="at">hjust =</span> <span class="fl">0.5</span>,</span>
<span id="cb47-9"><a href="#cb47-9" aria-hidden="true" tabindex="-1"></a>        <span class="at">colour =</span> <span class="st">&quot;white&quot;</span>,</span>
<span id="cb47-10"><a href="#cb47-10" aria-hidden="true" tabindex="-1"></a>        <span class="at">size =</span> <span class="dv">18</span>,</span>
<span id="cb47-11"><a href="#cb47-11" aria-hidden="true" tabindex="-1"></a>        <span class="at">margin =</span> <span class="fu">margin</span>(<span class="at">t =</span> <span class="dv">10</span>, <span class="at">b =</span> <span class="dv">15</span>)</span>
<span id="cb47-12"><a href="#cb47-12" aria-hidden="true" tabindex="-1"></a>      ),</span>
<span id="cb47-13"><a href="#cb47-13" aria-hidden="true" tabindex="-1"></a>      <span class="at">plot.caption =</span> <span class="fu">element_text</span>(</span>
<span id="cb47-14"><a href="#cb47-14" aria-hidden="true" tabindex="-1"></a>        <span class="at">colour =</span> <span class="st">&quot;white&quot;</span></span>
<span id="cb47-15"><a href="#cb47-15" aria-hidden="true" tabindex="-1"></a>      ),</span>
<span id="cb47-16"><a href="#cb47-16" aria-hidden="true" tabindex="-1"></a>      <span class="at">axis.text.x =</span> <span class="fu">element_text</span>(</span>
<span id="cb47-17"><a href="#cb47-17" aria-hidden="true" tabindex="-1"></a>        <span class="at">colour =</span> <span class="st">&quot;white&quot;</span>,</span>
<span id="cb47-18"><a href="#cb47-18" aria-hidden="true" tabindex="-1"></a>        <span class="at">margin =</span> <span class="fu">margin</span>(<span class="at">b =</span> <span class="dv">2</span>)</span>
<span id="cb47-19"><a href="#cb47-19" aria-hidden="true" tabindex="-1"></a>      ),</span>
<span id="cb47-20"><a href="#cb47-20" aria-hidden="true" tabindex="-1"></a>      <span class="at">strip.text =</span> <span class="fu">element_text</span>(</span>
<span id="cb47-21"><a href="#cb47-21" aria-hidden="true" tabindex="-1"></a>        <span class="at">colour =</span> <span class="st">&quot;white&quot;</span>,</span>
<span id="cb47-22"><a href="#cb47-22" aria-hidden="true" tabindex="-1"></a>        <span class="at">face =</span> <span class="st">&quot;bold&quot;</span></span>
<span id="cb47-23"><a href="#cb47-23" aria-hidden="true" tabindex="-1"></a>      ),</span>
<span id="cb47-24"><a href="#cb47-24" aria-hidden="true" tabindex="-1"></a>      <span class="at">panel.background =</span> <span class="fu">element_rect</span>(<span class="at">fill =</span> <span class="st">&quot;black&quot;</span>),</span>
<span id="cb47-25"><a href="#cb47-25" aria-hidden="true" tabindex="-1"></a>      <span class="at">plot.background =</span> <span class="fu">element_rect</span>(<span class="at">fill =</span> <span class="st">&quot;black&quot;</span>),</span>
<span id="cb47-26"><a href="#cb47-26" aria-hidden="true" tabindex="-1"></a>      <span class="at">panel.grid =</span> <span class="fu">element_blank</span>()</span>
<span id="cb47-27"><a href="#cb47-27" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb47-28"><a href="#cb47-28" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
</div>
<p>Finally we build the graph: 1) We use the <code>geom_hline()</code> function with different y intersection points to create the background grid. The <code>geom_segment()</code> function creates the x grid. 2) We create the density area using the <code>geom_area()</code> function. 3) In <code>scale_x_continous()</code> we define a negative lower limit so that it does not collapse at a small point. The labels of the eight main directions are indicated in the <code>scale_y_continous()</code> function, and 4) Finally, we change to a polar coordinate system and set the variable to create facets.</p>
<div class="cell">
<div class="sourceCode" id="cb48"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a> <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="fu">c</span>(<span class="dv">0</span>, .<span class="dv">2</span>, .<span class="dv">4</span>, .<span class="dv">6</span>, .<span class="dv">8</span>, <span class="dv">1</span>), </span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a>            <span class="at">colour =</span> <span class="st">&quot;white&quot;</span>,</span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a>            <span class="at">linewidth =</span> .<span class="dv">4</span>) <span class="sc">+</span></span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a> <span class="fu">geom_segment</span>(</span>
<span id="cb48-6"><a href="#cb48-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> grid_x,</span>
<span id="cb48-7"><a href="#cb48-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(</span>
<span id="cb48-8"><a href="#cb48-8" aria-hidden="true" tabindex="-1"></a>      <span class="at">x =</span> x,</span>
<span id="cb48-9"><a href="#cb48-9" aria-hidden="true" tabindex="-1"></a>      <span class="at">y =</span> y,</span>
<span id="cb48-10"><a href="#cb48-10" aria-hidden="true" tabindex="-1"></a>      <span class="at">xend =</span> xend,</span>
<span id="cb48-11"><a href="#cb48-11" aria-hidden="true" tabindex="-1"></a>      <span class="at">yend =</span> yend</span>
<span id="cb48-12"><a href="#cb48-12" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb48-13"><a href="#cb48-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">linetype =</span> <span class="st">&quot;dashed&quot;</span>,</span>
<span id="cb48-14"><a href="#cb48-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">colour =</span> <span class="st">&quot;white&quot;</span>,</span>
<span id="cb48-15"><a href="#cb48-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">linewidth =</span> .<span class="dv">2</span></span>
<span id="cb48-16"><a href="#cb48-16" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb48-17"><a href="#cb48-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_area</span>(</span>
<span id="cb48-18"><a href="#cb48-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> dens_river,</span>
<span id="cb48-19"><a href="#cb48-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">y =</span> y, <span class="at">ymin =</span> <span class="dv">0</span>, <span class="at">ymax =</span> y),</span>
<span id="cb48-20"><a href="#cb48-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">alpha =</span> .<span class="dv">7</span>,</span>
<span id="cb48-21"><a href="#cb48-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">colour =</span> <span class="cn">NA</span>,</span>
<span id="cb48-22"><a href="#cb48-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">show.legend =</span> <span class="cn">FALSE</span>,</span>
<span id="cb48-23"><a href="#cb48-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">fill =</span> <span class="st">&quot;#011FFD&quot;</span></span>
<span id="cb48-24"><a href="#cb48-24" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb48-25"><a href="#cb48-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">limits =</span> <span class="fu">c</span>(<span class="sc">-</span>.<span class="dv">2</span>, <span class="dv">1</span>), <span class="at">expand =</span> <span class="fu">expansion</span>(<span class="dv">0</span>)) <span class="sc">+</span></span>
<span id="cb48-26"><a href="#cb48-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(</span>
<span id="cb48-27"><a href="#cb48-27" aria-hidden="true" tabindex="-1"></a>    <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">360</span>),</span>
<span id="cb48-28"><a href="#cb48-28" aria-hidden="true" tabindex="-1"></a>    <span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">360</span> <span class="sc">-</span> <span class="fl">22.5</span>, <span class="at">by =</span> <span class="fl">22.5</span><span class="sc">*</span><span class="dv">2</span>),</span>
<span id="cb48-29"><a href="#cb48-29" aria-hidden="true" tabindex="-1"></a>    <span class="at">minor_breaks =</span> <span class="cn">NULL</span>,</span>
<span id="cb48-30"><a href="#cb48-30" aria-hidden="true" tabindex="-1"></a>    <span class="at">labels =</span> <span class="fu">c</span>(</span>
<span id="cb48-31"><a href="#cb48-31" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;N&quot;</span>, <span class="st">&quot;NE&quot;</span>, <span class="st">&quot;E&quot;</span>, <span class="st">&quot;SE&quot;</span>,</span>
<span id="cb48-32"><a href="#cb48-32" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;S&quot;</span>, <span class="st">&quot;SW&quot;</span>, <span class="st">&quot;W&quot;</span>,  <span class="st">&quot;NW&quot;</span></span>
<span id="cb48-33"><a href="#cb48-33" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb48-34"><a href="#cb48-34" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb48-35"><a href="#cb48-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_curvedpolar</span>(<span class="at">direction =</span> <span class="sc">-</span><span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb48-36"><a href="#cb48-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(river <span class="sc">~</span> ., <span class="at">ncol =</span> <span class="dv">4</span>) <span class="sc">+</span></span>
<span id="cb48-37"><a href="#cb48-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> title, <span class="at">caption =</span> caption, <span class="at">x =</span> <span class="cn">NULL</span>) <span class="sc">+</span></span>
<span id="cb48-38"><a href="#cb48-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_polar</span>()</span></code></pre></div>
<div class="cell-output-display">
<div>
<figure>
<p><a href="index_files/figure-html/unnamed-chunk-16-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-2"><img src="index_files/figure-html/unnamed-chunk-16-1.png" class="img-fluid" width="2400" /></a></p>
</figure>
</div>
</div>
</div>
<div id="quarto-navigation-envelope" class="hidden">
<p><span class="hidden quarto-markdown-envelope-contents" data-render-id="cXVhcnRvLWludC1zaWRlYmFyLXRpdGxl">Dr Dominic Royé</span> <span class="hidden quarto-markdown-envelope-contents" data-render-id="cXVhcnRvLWludC1uYXZiYXItdGl0bGU=">Dr Dominic Royé</span> <span class="hidden quarto-markdown-envelope-contents" data-render-id="cXVhcnRvLWludC1uYXZiYXI6QWJvdXQ=">About</span> <span class="hidden quarto-markdown-envelope-contents" data-render-id="cXVhcnRvLWludC1uYXZiYXI6L2Fib3V0L2luZGV4Lmh0bWw=">/about/index.html</span> <span class="hidden quarto-markdown-envelope-contents" data-render-id="cXVhcnRvLWludC1uYXZiYXI6QmxvZw==">Blog</span> <span class="hidden quarto-markdown-envelope-contents" data-render-id="cXVhcnRvLWludC1uYXZiYXI6L2Jsb2cvaW5kZXguaHRtbA==">/blog/index.html</span> <span class="hidden quarto-markdown-envelope-contents" data-render-id="cXVhcnRvLWludC1uYXZiYXI6UHVibGljYXRpb25z">Publications</span> <span class="hidden quarto-markdown-envelope-contents" data-render-id="cXVhcnRvLWludC1uYXZiYXI6L3B1YmxpY2F0aW9uL2luZGV4Lmh0bWw=">/publication/index.html</span> <span class="hidden quarto-markdown-envelope-contents" data-render-id="cXVhcnRvLWludC1uYXZiYXI6RGF0YSBWaXo=">Data Viz</span> <span class="hidden quarto-markdown-envelope-contents" data-render-id="cXVhcnRvLWludC1uYXZiYXI6L3Byb2plY3QvaW5kZXguaHRtbA==">/project/index.html</span></p>
<div class="hidden quarto-markdown-envelope-contents" data-render-id="Zm9vdGVyLWxlZnQ=">
<p>© 2018-2025 Dominic Royé ∙ Made with <a href="https://quarto.org">Quarto</a></p>
</div>
<div class="hidden quarto-markdown-envelope-contents" data-render-id="Zm9vdGVyLWNlbnRlcg==">
<p><a class="link-dark me-1" href="https://bsky.app/profile/drxeo.eu" title="Bluesky" target="_blank" rel="noopener"><i class="fa-brands fa-bluesky" aria-label="bluesky"></i></a> <a class="link-dark me-1" href="https://www.linkedin.com/in/dominicroye/" title="LinkedIn" target="_blank" rel="noopener"><i class="fa-brands fa-linkedin" aria-label="linkedin"></i></a> <a class="link-dark me-1" href="https://github.com/dominicroye" title="github" target="_blank" rel="noopener"><i class="fa-brands fa-github" aria-label="github"></i></a> <a class="link-dark me-1" href="https://orcid.org/0000-0002-5516-6396" title="orcid" target="_blank" rel="noopener"><i class="ai  ai-orcid"></i></a> <a class="link-dark me-1" href="https://scholar.google.es/citations?user=EoYa8jUAAAAJ&hl=es" title="Google Scholar" target="_blank"rel="noopener"><i class="ai  ai-google-scholar"></i></a></p>
</div>
<div class="hidden quarto-markdown-envelope-contents" data-render-id="Zm9vdGVyLXJpZ2h0LS9jb250YWN0Lmh0bWw=">
<p>Contact</p>
</div>
</div>
<div id="quarto-meta-markdown" class="hidden">
<p><span class="hidden quarto-markdown-envelope-contents" data-render-id="cXVhcnRvLW1ldGF0aXRsZQ==">River flow directions</span> <span class="hidden quarto-markdown-envelope-contents" data-render-id="cXVhcnRvLXR3aXR0ZXJjYXJkdGl0bGU=">River flow directions</span> <span class="hidden quarto-markdown-envelope-contents" data-render-id="cXVhcnRvLW9nY2FyZHRpdGxl">River flow directions</span> <span class="hidden quarto-markdown-envelope-contents" data-render-id="cXVhcnRvLW1ldGFzaXRlbmFtZQ==">Dr Dominic Royé</span> <span class="hidden quarto-markdown-envelope-contents" data-render-id="cXVhcnRvLXR3aXR0ZXJjYXJkZGVzYw==">I recently created a visualization of the distribution of river flow directions and also of coastal orientations. Following its publication in social networks, I was asked to make a post about how I did it. Well, here we go to start with an example of rivers, coastal orientation is somewhat more complex.</span> <span class="hidden quarto-markdown-envelope-contents" data-render-id="cXVhcnRvLW9nY2FyZGRkZXNj">I recently created a visualization of the distribution of river flow directions and also of coastal orientations. Following its publication in social networks, I was asked to make a post about how I did it. Well, here we go to start with an example of rivers, coastal orientation is somewhat more complex.</span></p>
</div>
</section>

</main> <!-- /main -->
<style> 
.button-container { 
  padding-top: 2em;
  padding-bottom: 1em;
  display: flex; 
  justify-content: center; 
  align-items: center;
}
</style>

<div class="button-container">
<a href="https://www.buymeacoffee.com/drxeo" target="_blank"><img src="https://cdn.buymeacoffee.com/buttons/default-orange.png" alt="Buy Me A Coffee" height="41" width="174"></a>
</div>
<script id = "quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/dominicroye\.github\.io");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
      <div class='footer-contents'>&#169; 2018-2025 Dominic Royé &#8729; Made with [Quarto](https://quarto.org)</div>  
    </div>   
    <div class="nav-footer-center">
      <div class='footer-contents'><a class="link-dark me-1" href="https://bsky.app/profile/drxeo.eu" title="Bluesky" target="_blank" rel="noopener"></a>
<a class="link-dark me-1" href="https://www.linkedin.com/in/dominicroye/" title="LinkedIn" target="_blank" rel="noopener"></a>
<a class="link-dark me-1" href="https://github.com/dominicroye" title="github" target="_blank" rel="noopener"></a>
<a class="link-dark me-1" href="https://orcid.org/0000-0002-5516-6396" title="orcid" target="_blank" rel="noopener"></a>
<a class="link-dark me-1" href="https://scholar.google.es/citations?user=EoYa8jUAAAAJ&hl=es" title="Google Scholar" target="_blank"rel="noopener"></a>
</div>  
    </div>
    <div class="nav-footer-right">
      <ul class="footer-items list-unstyled">
    <li class="nav-item">
    <a class="nav-link" href="/contact.html">
 Contact
    </a>
  </li>  
</ul>
    </div>
  </div>
</footer>
<script>var lightboxQuarto = GLightbox({"closeEffect":"zoom","descPosition":"bottom","loop":false,"openEffect":"zoom","selector":".lightbox"});
(function() {
  let previousOnload = window.onload;
  window.onload = () => {
    if (previousOnload) {
      previousOnload();
    }
    lightboxQuarto.on('slide_before_load', (data) => {
      const { slideIndex, slideNode, slideConfig, player, trigger } = data;
      const href = trigger.getAttribute('href');
      if (href !== null) {
        const imgEl = window.document.querySelector(`a[href="${href}"] img`);
        if (imgEl !== null) {
          const srcAttr = imgEl.getAttribute("src");
          if (srcAttr && srcAttr.startsWith("data:")) {
            slideConfig.href = srcAttr;
          }
        }
      } 
    });
  
    lightboxQuarto.on('slide_after_load', (data) => {
      const { slideIndex, slideNode, slideConfig, player, trigger } = data;
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(slideNode);
      }
    });
  
  };
  
})();
          </script>

</body>

</html>
