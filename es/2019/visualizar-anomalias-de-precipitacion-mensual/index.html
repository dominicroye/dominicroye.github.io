<!DOCTYPE html><html lang="es-ES" >


<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  
  
  
    <meta name="generator" content="Wowchemy 5.3.0 for Hugo" />
  

  
  









  




  
  
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  

  
  
  
    
      
      <link rel="preload" as="style" href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Roboto+Mono&family=Roboto:wght@400;700&display=swap">
      <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Roboto+Mono&family=Roboto:wght@400;700&display=swap" media="print" onload="this.media='all'">
    
  

  
  
  
  
  
    
    
    
  
  

  <meta name="author" content="Dr. Dominic Royé" />

  
  
  
    
  
  <meta name="description" content="Normalmente cuando visualizamos anomalías de precipitación mensual, simplemente usamos un gráfico de barras indicando con color rojo y azul valores negativos y positivos. No obstante, no nos explica el contexto general de estas mismas anomalías. Por ejemplo, ¿cuál fue la anomalía más alta o más baja en cada mes? En principio, podríamos usar un *boxplot* para visualizar la distribución de las anomalías, pero en este caso concreto no encajarían bien estéticamente, por lo que debemos buscar una alternativa. Aquí os presento una forma gráfica muy útil." />

  
  <link rel="alternate" hreflang="es-ES" href="https://dominicroye.github.io/es/2019/visualizar-anomalias-de-precipitacion-mensual/" />

  
  
  
    <meta name="theme-color" content="#1565c0" />
  

  
  

  

  <link rel="stylesheet" href="/css/vendor-bundle.min.f1ecf783c14edc00c9320c205831ad8e.css" media="print" onload="this.media='all'">

  
  
  
    
    
      <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/academicons@1.9.1/css/academicons.min.css" integrity="sha512-W0xM4mr6dEP9nREo7Z9z+9X70wytKvMGeDsj7ps2+xg5QPrEBXC8tAW1IFnzjR6eoJ90JmCnFzerQJTLzIEHjA==" crossorigin="anonymous" media="print" onload="this.media='all'">
    

    
    
    
    
      
      
    
    
    

    
    
    
      
    
    
      
      
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@10.2.1/build/styles/dracula.min.css" crossorigin="anonymous" title="hl-light" media="print" onload="this.media='all'">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@10.2.1/build/styles/dracula.min.css" crossorigin="anonymous" title="hl-dark" media="print" onload="this.media='all'" disabled>
      
    

    
    
    
      <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.7.1/dist/leaflet.min.css" integrity="" crossorigin="anonymous" media="print" onload="this.media='all'">
    

    

    
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      
        
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
  

  
  
  
  
  
  <link rel="stylesheet" href="/css/wowchemy.b48d89910a3f8560bb2d78fedea8d682.css" />

  




<script async src="https://www.googletagmanager.com/gtag/js?id=UA-27463794-2"></script>
<script>
  window.dataLayer = window.dataLayer || [];

  function gtag() {
      dataLayer.push(arguments);
  }

  function trackOutboundLink(url, target) {
    gtag('event', 'click', {
         'event_category': 'outbound',
         'event_label': url,
         'transport_type': 'beacon',
         'event_callback': function () {
           if (target !== '_blank') {
             document.location = url;
           }
         }
    });
    console.debug("Outbound link clicked: " + url);
  }

  function onClickCallback(event) {
    if ((event.target.tagName !== 'A') || (event.target.host === window.location.host)) {
      return;
    }
    trackOutboundLink(event.target, event.target.getAttribute('target'));  
  }

  gtag('js', new Date());
  gtag('config', 'UA-27463794-2', {});
  gtag('set', {'cookie_flags': 'SameSite=None;Secure'});

  
  document.addEventListener('click', onClickCallback, false);
</script>


  

  

  




  
  
  

  

  
    <link rel="manifest" href="/es/manifest.webmanifest" />
  

  <link rel="icon" type="image/png" href="/media/icon_hu27cb63416a395b8c8d0d7112b85e26a9_17299_32x32_fill_lanczos_center_3.png" />
  <link rel="apple-touch-icon" type="image/png" href="/media/icon_hu27cb63416a395b8c8d0d7112b85e26a9_17299_180x180_fill_lanczos_center_3.png" />

  <link rel="canonical" href="https://dominicroye.github.io/es/2019/visualizar-anomalias-de-precipitacion-mensual/" />

  
  
  
  
  
  
  
  
    
  
  

  
  
    
    
  
  <meta property="twitter:card" content="summary_large_image" />
  
    <meta property="twitter:site" content="@@dr_xeo" />
    <meta property="twitter:creator" content="@@dr_xeo" />
  
  <meta property="og:site_name" content="Dr. Dominic Royé" />
  <meta property="og:url" content="https://dominicroye.github.io/es/2019/visualizar-anomalias-de-precipitacion-mensual/" />
  <meta property="og:title" content="Visualizar anomalías de precipitación mensual | Dr. Dominic Royé" />
  <meta property="og:description" content="Normalmente cuando visualizamos anomalías de precipitación mensual, simplemente usamos un gráfico de barras indicando con color rojo y azul valores negativos y positivos. No obstante, no nos explica el contexto general de estas mismas anomalías. Por ejemplo, ¿cuál fue la anomalía más alta o más baja en cada mes? En principio, podríamos usar un *boxplot* para visualizar la distribución de las anomalías, pero en este caso concreto no encajarían bien estéticamente, por lo que debemos buscar una alternativa. Aquí os presento una forma gráfica muy útil." /><meta property="og:image" content="https://dominicroye.github.io/es/2019/visualizar-anomalias-de-precipitacion-mensual/featured.png" />
    <meta property="twitter:image" content="https://dominicroye.github.io/es/2019/visualizar-anomalias-de-precipitacion-mensual/featured.png" /><meta property="og:locale" content="es-ES" />
  
    
      <meta
        property="article:published_time"
        content="2019-07-07T00:00:00&#43;00:00"
      />
    
    <meta property="article:modified_time" content="2019-07-07T00:00:00&#43;00:00">
  

  


    






  




<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://dominicroye.github.io/es/2019/visualizar-anomalias-de-precipitacion-mensual/"
  },
  "headline": "Visualizar anomalías de precipitación mensual",
  
  "image": [
    "https://dominicroye.github.io/es/2019/visualizar-anomalias-de-precipitacion-mensual/featured.png"
  ],
  
  "datePublished": "2019-07-07T00:00:00Z",
  "dateModified": "2019-07-07T00:00:00Z",
  
  "author": {
    "@type": "Person",
    "name": "Dr. Dominic Royé"
  },
  
  "publisher": {
    "@type": "Organization",
    "name": "University of Santiago de Compostela",
    "logo": {
      "@type": "ImageObject",
      "url": "https://dominicroye.github.io/media/logo_hu6637600e1c36fe7812a10a6623aaebda_116520_192x192_fit_lanczos_3.png"
    }
  },
  "description": "Normalmente cuando visualizamos anomalías de precipitación mensual, simplemente usamos un gráfico de barras indicando con color rojo y azul valores negativos y positivos. No obstante, no nos explica el contexto general de estas mismas anomalías. Por ejemplo, ¿cuál fue la anomalía más alta o más baja en cada mes? En principio, podríamos usar un *boxplot* para visualizar la distribución de las anomalías, pero en este caso concreto no encajarían bien estéticamente, por lo que debemos buscar una alternativa. Aquí os presento una forma gráfica muy útil."
}
</script>

  

  

  

  





  <title>Visualizar anomalías de precipitación mensual | Dr. Dominic Royé</title>
</head>


<body id="top" data-spy="scroll" data-offset="70" data-target="#TableOfContents" class="page-wrapper   " data-wc-page-id="6e12309cec2969a7f723e804916a9e72" >

  
  
  
  
  
  
  
  
  
  <script src="/js/wowchemy-init.min.2da3b1fa37e894630bf6de39b1b694b3.js"></script>

  




  <div class="page-header">
    







 



  


<header class="header--fixed">
  <nav class="navbar navbar-expand-lg navbar-light compensate-for-scrollbar" id="navbar-main">
    <div class="container-xl">

      
      <div class="d-none d-lg-inline-flex">
        <a class="navbar-brand" href="/es/"><img src="/media/logo_hu6637600e1c36fe7812a10a6623aaebda_116520_0x70_resize_lanczos_3.png" alt="Dr. Dominic Royé"
            
            >
             <div style = "padding-top:0.5em;">Dr. Dominic Royé</div></a>
      </div>
      

      
      <button type="button" class="navbar-toggler" data-toggle="collapse"
              data-target="#navbar-content" aria-controls="navbar-content" aria-expanded="false" aria-label="Barra de navegación">
      <span><i class="fas fa-bars"></i></span>
      </button>
      

      
      <div class="navbar-brand-mobile-wrapper d-inline-flex d-lg-none">
        <a class="navbar-brand" href="/es/"><img src="/media/logo_hu6637600e1c36fe7812a10a6623aaebda_116520_0x70_resize_lanczos_3.png" alt="Dr. Dominic Royé"
          
          ></a>
      </div>
      

      
      
      <div class="navbar-collapse main-menu-item collapse justify-content-end" id="navbar-content">

        
        <ul class="navbar-nav d-md-inline-flex">
          

          

          
          
          

          

          
          
          
          

          
            
            
          

          <li class="nav-item">
            <a class="nav-link " href="/es/#"><span>inicio</span></a>
          </li>

          
          

          

          
          
          
            
          

          

          
          
          
          

          
            
              
              
            
            
              
              
              
                
              
              
            
          

          <li class="nav-item">
            <a class="nav-link " href="/es/#posts"><span>blog</span></a>
          </li>

          
          

          

          
          
          
            
          

          

          
          
          
          

          
            
              
              
            
            
              
              
              
                
              
              
            
          

          <li class="nav-item">
            <a class="nav-link " href="/es/#featured"><span>publicaciones</span></a>
          </li>

          
          

          

          
          
          
            
          

          

          
          
          
          

          
            
              
              
            
            
              
              
              
                
              
              
            
          

          <li class="nav-item">
            <a class="nav-link " href="/es/#projects"><span>gráficos</span></a>
          </li>

          
          

          

          
          
          
            
          

          

          
          
          
          

          
            
              
              
            
            
              
              
              
                
              
              
            
          

          <li class="nav-item">
            <a class="nav-link " href="/es/#about"><span>mí</span></a>
          </li>

          
          

        

          
        </ul>
      </div>

      <ul class="nav-icons navbar-nav flex-row ml-auto d-flex pl-md-2">

        
        
          
            
            <li class="nav-item d-none d-lg-inline-flex">
              <a class="nav-link" href="https://twitter.com/dr_xeo" data-toggle="tooltip" data-placement="bottom" title="Sígueme en Twitter" target="_blank" rel="noopener" aria-label="Sígueme en Twitter">
                <i class="fab fa-twitter" aria-hidden="true"></i>
              </a>
            </li>
          
        

        
        

        
        

        
        

      </ul>

    </div>
  </nav>
</header>


  </div>

  <div class="page-body">
    <article class="article">

  




















  
  
    
  


<div class="article-container pt-3">
  <h1>Visualizar anomalías de precipitación mensual</h1>

  

  


<div class="article-metadata">

  
  

  
  <span class="article-date">
    
    
      
    
    2019-07-07
  </span>
  

  

  
  <span class="middot-divider"></span>
  <span class="article-reading-time">
    9 min de lectura
  </span>
  

  
  
  
  
  
  

  
  
  <span class="middot-divider"></span>
  <span class="article-categories">
    <i class="fas fa-folder mr-1"></i><a href="/es/category/visualizacion/">visualización</a>, <a href="/es/category/r/">R</a>, <a href="/es/category/rintermedio/">R:intermedio</a></span>
  

</div>

  





</div>


<div class="article-header article-container featured-image-wrapper mt-4 mb-4" style="max-width: 720px; max-height: 370px;">
  <div style="position: relative">
    <img src="/es/2019/visualizar-anomalias-de-precipitacion-mensual/featured_hu6cc175b16e8f734e9fbe97a3cdf8545c_80024_720x0_resize_lanczos_3.png" width="720" height="370" alt="" class="featured-image">
    
  </div>
</div>



  <div class="article-container">

    <div class="article-style">
      
<script src="https://dominicroye.github.io/es/2019/visualizar-anomalias-de-precipitacion-mensual/index.es_files/header-attrs/header-attrs.js"></script>


<p>Normalmente cuando visualizamos anomalías de precipitación mensual, simplemente usamos un gráfico de barras indicando con color rojo y azul valores negativos y positivos. No obstante, no nos explica el contexto general de estas mismas anomalías. Por ejemplo, ¿cuál fue la anomalía más alta o más baja en cada mes? En principio, podríamos usar un <em>boxplot</em> para visualizar la distribución de las anomalías, pero en este caso concreto no encajarían bien estéticamente, por lo que debemos buscar una alternativa. Aquí os presento una forma gráfica muy útil.</p>
<div id="paquetes" class="section level2">
<h2>Paquetes</h2>
<p>En este post usaremos los siguientes paquetes:</p>
<table>
<colgroup>
<col width="10%" />
<col width="89%" />
</colgroup>
<thead>
<tr class="header">
<th align="left">Paquete</th>
<th align="left">Descripción</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">tidyverse</td>
<td align="left">Conjunto de paquetes (visualización y manipulación de datos): ggplot2, dplyr, purrr,etc.</td>
</tr>
<tr class="even">
<td align="left">readr</td>
<td align="left">Importar datos</td>
</tr>
<tr class="odd">
<td align="left">ggthemes</td>
<td align="left">Estilos para ggplot2</td>
</tr>
<tr class="even">
<td align="left">lubridate</td>
<td align="left">Fácil manipulación de fechas y tiempos</td>
</tr>
<tr class="odd">
<td align="left">cowplot</td>
<td align="left">Fácil creación de múltiples gráficos con ggplot2</td>
</tr>
</tbody>
</table>
<pre class="r"><code>#instalamos los paquetes si hace falta
if(!require(&quot;tidyverse&quot;)) install.packages(&quot;tidyverse&quot;)
if(!require(&quot;ggthemes&quot;)) install.packages(&quot;broom&quot;)
if(!require(&quot;cowplot&quot;)) install.packages(&quot;cowplot&quot;)
if(!require(&quot;lubridate&quot;)) install.packages(&quot;lubridate&quot;)

#paquetes
library(tidyverse) #contiene readr
library(ggthemes)
library(cowplot)
library(lubridate)</code></pre>
</div>
<div id="preparar-los-datos" class="section level2">
<h2>Preparar los datos</h2>
<p>Primero importamos la precipitación diaria de la estación meteorológica seleccionada (<a href="/files/RR_STAID001394.txt">descarga</a>). Usaremos datos de Santiago de Compostela (España) accesible a través de <a href="https://eca.knmi.nl">ECA&amp;D</a>.</p>
<div id="paso-1-importar-los-datos" class="section level3">
<h3>Paso 1: importar los datos</h3>
<p>No sólo importamos los datos en formato <em>csv</em>, sino también hacemos los primeros cambios. Saltamos las primeras 21 filas que contienen información sobre la estación meteorológica. Además, convertimos la fecha a clase <code>date</code> y reemplazamos valores ausentes (-9999) por <code>NA</code>. La precipitación está en 0.1 mm, por tanto, debemos dividir los valores por 10. Después seleccionamos las columnas <em>DATE</em> y <em>RR</em>, y las renombramos.</p>
<pre class="r"><code>data &lt;- read_csv(&quot;RR_STAID001394.txt&quot;, skip = 21) %&gt;%
             mutate(DATE = ymd(DATE), RR = ifelse(RR == -9999, NA, RR/10)) %&gt;%
               select(DATE:RR) %&gt;% 
             rename(date = DATE, pr = RR)</code></pre>
<pre><code>## Rows: 27606 Columns: 5</code></pre>
<pre><code>## -- Column specification --------------------------------------------------------
## Delimiter: &quot;,&quot;
## dbl (5): STAID, SOUID, DATE, RR, Q_RR</code></pre>
<pre><code>## 
## i Use `spec()` to retrieve the full column specification for this data.
## i Specify the column types or set `show_col_types = FALSE` to quiet this message.</code></pre>
<pre class="r"><code>data</code></pre>
<pre><code>## # A tibble: 27,606 x 2
##    date          pr
##    &lt;date&gt;     &lt;dbl&gt;
##  1 1943-11-01   0.6
##  2 1943-11-02   0  
##  3 1943-11-03   0  
##  4 1943-11-04   0  
##  5 1943-11-05   0  
##  6 1943-11-06   0  
##  7 1943-11-07   0  
##  8 1943-11-08   0  
##  9 1943-11-09   0  
## 10 1943-11-10   0  
## # ... with 27,596 more rows</code></pre>
</div>
<div id="paso-2-crear-valores-menusales" class="section level3">
<h3>Paso 2: crear valores menusales</h3>
<p>En el segundo paso calculamos las cantidades mensuales de precipitación. Para ello, a) limitamos el período a los años posteriores a 1950, b) añadimos como variable el mes con etiqueta y el año.</p>
<pre class="r"><code>data &lt;- mutate(data, mo = month(date, label = TRUE), yr = year(date)) %&gt;%
            filter(date &gt;= &quot;1950-01-01&quot;) %&gt;%
                group_by(yr, mo) %&gt;% 
                   summarise(prs = sum(pr, na.rm = TRUE))</code></pre>
<pre><code>## `summarise()` has grouped output by &#39;yr&#39;. You can override using the `.groups` argument.</code></pre>
<pre class="r"><code>data</code></pre>
<pre><code>## # A tibble: 833 x 3
## # Groups:   yr [70]
##       yr mo      prs
##    &lt;dbl&gt; &lt;ord&gt; &lt;dbl&gt;
##  1  1950 ene    55.6
##  2  1950 feb   349. 
##  3  1950 mar    85.8
##  4  1950 abr    33.4
##  5  1950 may   272. 
##  6  1950 jun   111. 
##  7  1950 jul    35.4
##  8  1950 ago    76.4
##  9  1950 sep    85  
## 10  1950 oct    53  
## # ... with 823 more rows</code></pre>
</div>
<div id="paso-3-estimar-las-anomalías" class="section level3">
<h3>Paso 3: estimar las anomalías</h3>
<p>Ahora debemos estimar los valores normales de cada mes y unir esta tabla a nuestros datos principales para posteriormente poder calcular la anomalía mensual. Expresamos la anomalía en porcentaje y restamos 100 para fijar el promedio en 0. Además, creamos una variable que nos indica si la anomalía es negativa o positiva, y otra con la fecha.</p>
<pre class="r"><code>pr_ref &lt;- filter(data, yr &gt; 1981, yr &lt;= 2010) %&gt;%
                   group_by(mo) %&gt;%
                      summarise(pr_ref = mean(prs))

data &lt;- left_join(data, pr_ref, by = &quot;mo&quot;)

data &lt;- mutate(data, 
               anom = (prs*100/pr_ref)-100, 
               date = str_c(yr, as.numeric(mo), 1, sep = &quot;-&quot;) %&gt;% ymd(),
               sign= ifelse(anom &gt; 0, &quot;pos&quot;, &quot;neg&quot;) %&gt;% factor(c(&quot;pos&quot;, &quot;neg&quot;)))</code></pre>
<p>Ya podemos hacer un primer ensayo de un gráfico de anomalías (la versión clásica), para ello filtramos el año 2018. En este caso usamos la geometría de barras, recuerda que por defecto la función <code>geom_bar()</code> aplica el conteo a la variable. No obstante, en este caso conocemos <code>y</code>, por tanto indicamos con el argumento <code>stat = "identity"</code> que debe usar el valor dado en <code>aes()</code>.</p>
<pre class="r"><code>filter(data, yr == 2018) %&gt;%
   ggplot(aes(date, anom, fill = sign)) + 
       geom_bar(stat = &quot;identity&quot;, show.legend = FALSE) + 
    scale_x_date(date_breaks = &quot;month&quot;, date_labels = &quot;%b&quot;) +
    scale_y_continuous(breaks = seq(-100, 100, 20)) +
    scale_fill_manual(values = c(&quot;#99000d&quot;, &quot;#034e7b&quot;)) +
         labs(y = &quot;Anomalía de precipitación (%)&quot;, x = &quot;&quot;) +
          theme_hc()</code></pre>
<p><img src="https://dominicroye.github.io/es/2019/visualizar-anomalias-de-precipitacion-mensual/index.es_files/figure-html/unnamed-chunk-6-1.png" width="672" /></p>
</div>
<div id="paso-4-calcular-las-medidas-estadísticas" class="section level3">
<h3>Paso 4: calcular las medidas estadísticas</h3>
<p>En este último paso estimamos el valor máximo, mínimo, el cuantil 25%/75% y el rango intercuartil por mes de toda la serie temporal.</p>
<pre class="r"><code>data_norm &lt;-     group_by(data, mo) %&gt;%
                     summarise(mx = max(anom),
                               min = min(anom),
                               q25 = quantile(anom, .25),
                               q75 = quantile(anom, .75),
                               iqr = q75-q25)

data_norm</code></pre>
<pre><code>## # A tibble: 12 x 6
##    mo       mx    min   q25   q75   iqr
##    &lt;ord&gt; &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
##  1 ene    193.  -89.6 -43.6 56.3   99.9
##  2 feb    320.  -96.5 -51.2 77.7  129. 
##  3 mar    381. -100   -40.6 88.2  129. 
##  4 abr    198.  -93.6 -51.2 17.1   68.3
##  5 may    141.  -90.1 -45.2 17.0   62.2
##  6 jun    419.  -99.3 -58.2 50.0  108. 
##  7 jul    311.  -98.2 -77.3 27.1  104. 
##  8 ago    264. -100   -68.2 39.8  108. 
##  9 sep    241.  -99.2 -64.9 48.6  113. 
## 10 oct    220.  -99.0 -54.5  4.69  59.2
## 11 nov    137.  -98.8 -44.0 39.7   83.7
## 12 dic    245.  -91.8 -49.8 36.0   85.8</code></pre>
</div>
</div>
<div id="crear-el-gráfico" class="section level2">
<h2>Crear el gráfico</h2>
<p>Para crear el gráfico de anomalías con leyenda es necesario separar el gráfico principal de las leyendas.</p>
<div id="parte-1" class="section level3">
<h3>Parte 1</h3>
<p>En esta primera parte vamos añadiendo capa por capa los diferentes elementos: 1) el rango de anomalías máximo-mínimo 2) el rango intercuartil 3) las anomalías del año 2018.</p>
<pre class="r"><code>#rango de anomalías máximo-mínimo 
g1.1 &lt;- ggplot(data_norm)+
           geom_crossbar(aes(x = mo, y = 0, ymin = min, ymax = mx),
                        fatten = 0, fill = &quot;grey90&quot;, colour = &quot;NA&quot;)

g1.1</code></pre>
<p><img src="https://dominicroye.github.io/es/2019/visualizar-anomalias-de-precipitacion-mensual/index.es_files/figure-html/unnamed-chunk-8-1.png" width="672" /></p>
<pre class="r"><code>#añadinos el rango intercuartil
g1.2 &lt;- g1.1 + geom_crossbar(aes(x = mo, y = 0, ymin = q25, ymax = q75),
                              fatten = 0, fill = &quot;grey70&quot;)

g1.2</code></pre>
<p><img src="https://dominicroye.github.io/es/2019/visualizar-anomalias-de-precipitacion-mensual/index.es_files/figure-html/unnamed-chunk-8-2.png" width="672" /></p>
<pre class="r"><code>#añadimos las anomalías del año 2018

g1.3 &lt;- g1.2 + geom_crossbar(data = filter(data, yr == 2018),
                aes(x = mo, y = 0, ymin = 0, ymax = anom, fill = sign),
                fatten = 0, width = 0.7, alpha = .7, colour = &quot;NA&quot;,
                show.legend = FALSE)
g1.3</code></pre>
<p><img src="https://dominicroye.github.io/es/2019/visualizar-anomalias-de-precipitacion-mensual/index.es_files/figure-html/unnamed-chunk-8-3.png" width="672" /></p>
<p>Finalmente añadimos unos últimos ajustes de estilo.</p>
<pre class="r"><code>g1 &lt;- g1.3 + geom_hline(yintercept = 0)+
               scale_fill_manual(values=c(&quot;#99000d&quot;,&quot;#034e7b&quot;))+
               scale_y_continuous(&quot;Anomalía de precipitación (%)&quot;,
                                   breaks = seq(-100, 500, 25),
                                   expand = c(0, 5))+
            labs(x = &quot;&quot;,
                 title = &quot;Anomalía de precipitación en Santiago de Compostela 2018&quot;,
                 caption=&quot;Dominic Royé (@dr_xeo) | Datos: eca.knmi.nl&quot;)+
            theme_hc()
g1</code></pre>
<p><img src="https://dominicroye.github.io/es/2019/visualizar-anomalias-de-precipitacion-mensual/index.es_files/figure-html/unnamed-chunk-9-1.png" width="672" /></p>
</div>
<div id="parte-2" class="section level3">
<h3>Parte 2</h3>
<p>Todavía nos falta una leyenda. Primero la creamos para los valores normales.</p>
<pre class="r"><code>#datos de la leyenda
legend &lt;- filter(data_norm, mo == &quot;ene&quot;)

legend_lab &lt;- gather(legend, stat, y, mx:q75) %&gt;%
                 mutate(stat = factor(stat, stat, c(&quot;máximo&quot;,
                                                   &quot;mínimo&quot;,
                                                   &quot;Cuantil 25%&quot;,
                                                   &quot;Cuantil 75%&quot;)) %&gt;%
                                            as.character())</code></pre>
<pre><code>## Warning: attributes are not identical across measure variables;
## they will be dropped</code></pre>
<pre class="r"><code>#gráfico de la leyenda
g2 &lt;- legend %&gt;% ggplot()+
                  geom_crossbar(aes(x = mo, y = 0, ymin = min, ymax = mx),
                                fatten = 0, fill = &quot;grey90&quot;, colour = &quot;NA&quot;, width = 0.2) +
                  geom_crossbar(aes(x = mo, y = 0, ymin = q25, ymax = q75),
                                fatten = 0, fill = &quot;grey70&quot;, width = 0.2) +
                  geom_text(data = legend_lab, 
                            aes(x = mo, y = y+c(12,-8,-10,12), label = stat), 
                            fontface = &quot;bold&quot;, size = 2) +
                   annotate(&quot;text&quot;, x = 1.18, y = 40, 
                            label = &quot;Período 1950-2018&quot;, angle = 90, size = 3) +
              theme_void() + 
                theme(plot.margin = unit(c(0, 0, 0, 0), &quot;cm&quot;))

g2</code></pre>
<p><img src="https://dominicroye.github.io/es/2019/visualizar-anomalias-de-precipitacion-mensual/index.es_files/figure-html/unnamed-chunk-10-1.png" width="672" /></p>
<p>Segundo, creamos otra leyenda para las anomalías actuales.</p>
<pre class="r"><code>legend2 &lt;- filter(data, yr == 1950, mo %in% c(&quot;ene&quot;,&quot;feb&quot;)) %&gt;% 
              ungroup() %&gt;% 
            select(mo, anom, sign)

legend2[2,1] &lt;- &quot;ene&quot;

legend_lab2 &lt;- data.frame(mo = rep(&quot;ene&quot;, 3), 
                          anom= c(110, 3, -70), 
                          label = c(&quot;Anomalía positiva&quot;, &quot;Promedio&quot;, &quot;Anomalía negativa&quot;))

g3 &lt;-  ggplot() + 
         geom_bar(data = legend2,
                aes(x = mo, y = anom, fill = sign),
                   alpha = .6, colour = &quot;NA&quot;, stat = &quot;identity&quot;, show.legend = FALSE, width = 0.2) +
         geom_segment(aes(x = .85, y = 0, xend = 1.15, yend = 0), linetype = &quot;dashed&quot;) +
         geom_text(data = legend_lab2, aes(x = mo, y = anom+c(10,5,-13), label = label), fontface = &quot;bold&quot;, size = 2) +
         annotate(&quot;text&quot;, x = 1.25, y = 20, 
                  label =&quot;Referencia 1971-2010&quot;, angle = 90, size = 3) +
         scale_fill_manual(values = c(&quot;#99000d&quot;, &quot;#034e7b&quot;)) +
        theme_void() +
         theme(plot.margin = unit(c(0, 0, 0, 0), &quot;cm&quot;))

g3</code></pre>
<p><img src="https://dominicroye.github.io/es/2019/visualizar-anomalias-de-precipitacion-mensual/index.es_files/figure-html/unnamed-chunk-11-1.png" width="672" /></p>
</div>
<div id="parte-3" class="section level3">
<h3>Parte 3</h3>
<p>Para finalizar sólo debemos unir el gráfico y las leyendas con ayuda del paquete <code>cowplot</code>. La función princial de <code>cowplot</code> es <code>plot_grid()</code> que ayuda en combinar diferentes gráficos. No obstante, en este caso se hace necesario usar unas funciones más flexibles para crear formatos menos habituales. La función <code>ggdraw()</code> configura la capa básica del gráfico, y las funciones que están destinadas a operar en esta capa comienzan con <code>draw_*</code>.</p>
<pre class="r"><code>p &lt;- ggdraw() +
       draw_plot(g1, x = 0, y = .3, width = 1, height = 0.6) +
       draw_plot(g2, x = 0, y = .15, width = .2, height = .15) +
       draw_plot(g3, x = 0.08, y = .15, width = .2, height = .15)

p</code></pre>
<p><img src="https://dominicroye.github.io/es/2019/visualizar-anomalias-de-precipitacion-mensual/index.es_files/figure-html/unnamed-chunk-12-1.png" width="3729" /></p>
<pre class="r"><code>save_plot(&quot;pr_anomalia2016_scq.png&quot;, p, dpi = 300, base_width = 12.43, base_height = 8.42)</code></pre>
</div>
</div>
<div id="múltiples-facetas" class="section level2">
<h2>Múltiples facetas</h2>
<p>En este apartado haremos el mismo gráfico como en el anterior, pero para varios años.</p>
<div id="parte-1-1" class="section level3">
<h3>Parte 1</h3>
<p>Únicamente debemos filtrar por un conjunto de años, en este caso de 2016 a 2018, usando el operador <code>%in%</code>, además añadimos la función <code>facet_grid()</code> a <code>ggplot</code>, lo que nos permite plotear los gráficos según una variable. La formula usada para la función de facetas es similar al uso en modelos: <code>variable_por_fila ~ variable_por_columna</code>. Cuando no tenemos una variable en columna debemos usar el <code>.</code>.</p>
<pre class="r"><code>#rango de anomalias maximo-minimo 
g1.1 &lt;- ggplot(data_norm)+
           geom_crossbar(aes(x = mo, y = 0, ymin = min, ymax = mx),
                        fatten = 0, fill = &quot;grey90&quot;, colour = &quot;NA&quot;)

g1.1</code></pre>
<p><img src="https://dominicroye.github.io/es/2019/visualizar-anomalias-de-precipitacion-mensual/index.es_files/figure-html/unnamed-chunk-13-1.png" width="672" /></p>
<pre class="r"><code>#añadinos el rango intercuartil
g1.2 &lt;- g1.1 + geom_crossbar(aes(x = mo, y = 0, ymin = q25, ymax = q75),
                              fatten = 0, fill = &quot;grey70&quot;)

g1.2</code></pre>
<p><img src="https://dominicroye.github.io/es/2019/visualizar-anomalias-de-precipitacion-mensual/index.es_files/figure-html/unnamed-chunk-13-2.png" width="672" /></p>
<pre class="r"><code>#añadimos las anomalías del año 2016-2018

g1.3 &lt;- g1.2 + geom_crossbar(data = filter(data, yr %in% 2016:2018),
                aes(x = mo, y = 0, ymin = 0, ymax = anom, fill = sign),
                fatten = 0, width = 0.7, alpha = .7, colour = &quot;NA&quot;,
                show.legend = FALSE) +
               facet_grid(yr ~ .)
g1.3</code></pre>
<p><img src="https://dominicroye.github.io/es/2019/visualizar-anomalias-de-precipitacion-mensual/index.es_files/figure-html/unnamed-chunk-13-3.png" width="672" /></p>
<p>Finalmente, añadimos unos últimos ajustes de estilo.</p>
<pre class="r"><code>g1 &lt;- g1.3 + geom_hline(yintercept = 0)+
               scale_fill_manual(values=c(&quot;#99000d&quot;,&quot;#034e7b&quot;))+
               scale_y_continuous(&quot;Anomalía de precipitación (%)&quot;,
                                   breaks = seq(-100, 500, 50),
                                   expand = c(0, 5))+
            labs(x = &quot;&quot;,
                 title = &quot;Anomalía de precipitación en Santiago de Compostela&quot;,
                 caption=&quot;Dominic Royé (@dr_xeo) | Datos: eca.knmi.nl&quot;)+
            theme_hc()
g1</code></pre>
<p><img src="https://dominicroye.github.io/es/2019/visualizar-anomalias-de-precipitacion-mensual/index.es_files/figure-html/unnamed-chunk-14-1.png" width="3729" /></p>
<p>Usamos la misma leyenda universal creada para el gráfico anterior.</p>
</div>
</div>
<div id="parte-2-1" class="section level2">
<h2>Parte 2</h2>
<p>Para finalizar, sólo unimos el gráfico y las leyendas con ayuda del paquete <code>cowplot</code>. Lo único que debemos ajustar aquí son los argumentos en la función <code>draw_plot()</code> para colocar correctamente las diferentes partes.</p>
<pre class="r"><code>p &lt;- ggdraw() +
       draw_plot(g1, x = 0, y = .18, width = 1, height = 0.8) +
       draw_plot(g2, x = 0, y = .08, width = .2, height = .15) +
       draw_plot(g3, x = 0.08, y = .08, width = .2, height = .15)

p</code></pre>
<p><img src="https://dominicroye.github.io/es/2019/visualizar-anomalias-de-precipitacion-mensual/index.es_files/figure-html/unnamed-chunk-15-1.png" width="3729" /></p>
<pre class="r"><code>save_plot(&quot;pr_anomalia20162018_scq.png&quot;, p, dpi = 300, base_width = 12.43, base_height = 8.42)</code></pre>
</div>

    </div>

    






<div class="article-tags">
  
  <a class="badge badge-light" href="/es/tag/anomalia/">anomalía</a>
  
  <a class="badge badge-light" href="/es/tag/precipitacion/">precipitación</a>
  
  <a class="badge badge-light" href="/es/tag/clima/">clima</a>
  
  <a class="badge badge-light" href="/es/tag/boxplot/">boxplot</a>
  
</div>



<div class="share-box">
  <ul class="share">
    
      
      
      
        
      
      
      
      <li>
        <a href="https://twitter.com/intent/tweet?url=https://dominicroye.github.io/es/2019/visualizar-anomalias-de-precipitacion-mensual/&amp;text=Visualizar%20anomal%c3%adas%20de%20precipitaci%c3%b3n%20mensual" target="_blank" rel="noopener" class="share-btn-twitter" aria-label="twitter">
          <i class="fab fa-twitter"></i>
        </a>
      </li>
    
      
      
      
        
      
      
      
      <li>
        <a href="https://www.facebook.com/sharer.php?u=https://dominicroye.github.io/es/2019/visualizar-anomalias-de-precipitacion-mensual/&amp;t=Visualizar%20anomal%c3%adas%20de%20precipitaci%c3%b3n%20mensual" target="_blank" rel="noopener" class="share-btn-facebook" aria-label="facebook">
          <i class="fab fa-facebook"></i>
        </a>
      </li>
    
      
      
      
        
      
      
      
      <li>
        <a href="mailto:?subject=Visualizar%20anomal%c3%adas%20de%20precipitaci%c3%b3n%20mensual&amp;body=https://dominicroye.github.io/es/2019/visualizar-anomalias-de-precipitacion-mensual/" target="_blank" rel="noopener" class="share-btn-email" aria-label="envelope">
          <i class="fas fa-envelope"></i>
        </a>
      </li>
    
      
      
      
        
      
      
      
      <li>
        <a href="https://www.linkedin.com/shareArticle?url=https://dominicroye.github.io/es/2019/visualizar-anomalias-de-precipitacion-mensual/&amp;title=Visualizar%20anomal%c3%adas%20de%20precipitaci%c3%b3n%20mensual" target="_blank" rel="noopener" class="share-btn-linkedin" aria-label="linkedin-in">
          <i class="fab fa-linkedin-in"></i>
        </a>
      </li>
    
      
      
      
        
      
      
      
      <li>
        <a href="whatsapp://send?text=Visualizar%20anomal%c3%adas%20de%20precipitaci%c3%b3n%20mensual%20https://dominicroye.github.io/es/2019/visualizar-anomalias-de-precipitacion-mensual/" target="_blank" rel="noopener" class="share-btn-whatsapp" aria-label="whatsapp">
          <i class="fab fa-whatsapp"></i>
        </a>
      </li>
    
      
      
      
        
      
      
      
      <li>
        <a href="https://service.weibo.com/share/share.php?url=https://dominicroye.github.io/es/2019/visualizar-anomalias-de-precipitacion-mensual/&amp;title=Visualizar%20anomal%c3%adas%20de%20precipitaci%c3%b3n%20mensual" target="_blank" rel="noopener" class="share-btn-weibo" aria-label="weibo">
          <i class="fab fa-weibo"></i>
        </a>
      </li>
    
  </ul>
</div>











  
  



  
  
  
    
  
  
  
  <div class="media author-card content-widget-hr">
    
      
      <a href="https://dominicroye.github.io/"><img class="avatar mr-3 avatar-circle" src="/es/author/dr.-dominic-roye/avatar_hu930bec32484cd86675af8880de95caa2_508993_270x270_fill_q75_lanczos_center.jpg" alt="Dr. Dominic Royé"></a>
    

    <div class="media-body">
      <h5 class="card-title"><a href="https://dominicroye.github.io/">Dr. Dominic Royé</a></h5>
      <h6 class="card-subtitle">Investigador postdoctoral senior</h6>
      
      <ul class="network-icon" aria-hidden="true">
  
    
    
    
      
    
    
    
    
    
      
    
    <li>
      <a href="https://twitter.com/dr_xeo" target="_blank" rel="noopener">
        <i class="fab fa-twitter"></i>
      </a>
    </li>
  
    
    
    
      
    
    
    
    
    
      
    
    <li>
      <a href="/es/#contact" >
        <i class="fas fa-envelope"></i>
      </a>
    </li>
  
    
    
    
    
    
    
    
      
    
    <li>
      <a href="https://scholar.google.es/citations?user=EoYa8jUAAAAJ&amp;hl=es" target="_blank" rel="noopener">
        <i class="ai ai-google-scholar"></i>
      </a>
    </li>
  
    
    
    
      
    
    
    
    
    
      
    
    <li>
      <a href="https://github.com/dominicroye" target="_blank" rel="noopener">
        <i class="fab fa-github"></i>
      </a>
    </li>
  
    
    
    
      
    
    
    
    
    
      
    
    <li>
      <a href="https://www.linkedin.com/in/dominicroye/" target="_blank" rel="noopener">
        <i class="fab fa-linkedin"></i>
      </a>
    </li>
  
    
    
    
    
    
    
    
      
    
    <li>
      <a href="https://www.researchgate.net/profile/Dominic_Roye" target="_blank" rel="noopener">
        <i class="ai ai-researchgate"></i>
      </a>
    </li>
  
</ul>

    </div>
  </div>
















  
  
  <div class="article-widget content-widget-hr">
    <h3>Relacionado</h3>
    <ul>
      
      <li><a href="/es/2020/visualizar-anomalias-climaticas/">Visualizar anomalías climáticas</a></li>
      
      <li><a href="/es/2020/un-heatmap-como-calendario/">Un heatmap como calendario</a></li>
      
      <li><a href="/es/2021/circulos-climaticos/">Círculos climáticos</a></li>
      
      <li><a href="/es/2020/animacion-climatica-de-la-temperatura-maxima/">Animación climática de la temperatura máxima</a></li>
      
      <li><a href="/es/2021/visualizar-el-ciclo-de-dia-noche-en-un-mapamundi/">Visualizar el ciclo de día-noche en un mapamundi</a></li>
      
    </ul>
  </div>
  





  </div>
</article>
  </div>

  <div class="page-footer">
    
    
    <div class="container">
      <footer class="site-footer">

  



  

  

  
  <p class="powered-by">
    © 2018-2022 Dominic Royé. All rights reserved
  </p>
  

  
  






  <p class="powered-by">
    
    
    
      
      
      
      
      
      
      Published with <a href="https://wowchemy.com/?utm_campaign=poweredby" target="_blank" rel="noopener">Wowchemy</a> — the free, <a href="https://github.com/wowchemy/wowchemy-hugo-themes" target="_blank" rel="noopener">open source</a> website builder that empowers creators.
    
  </p>
</footer>

    </div>
    
  </div>

  
<div id="modal" class="modal fade" role="dialog">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Citar</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <pre><code class="tex hljs"></code></pre>
      </div>
      <div class="modal-footer">
        <a class="btn btn-outline-primary my-1 js-copy-cite" href="#" target="_blank">
          <i class="fas fa-copy"></i> Copiar
        </a>
        <a class="btn btn-outline-primary my-1 js-download-cite" href="#" target="_blank">
          <i class="fas fa-download"></i> Descargar
        </a>
        <div id="modal-error"></div>
      </div>
    </div>
  </div>
</div>

      

    
    <script src="/js/vendor-bundle.min.b73dfaac3b6499dc997741748a7c3fe2.js"></script>

    
    
    
      
      
        <script src="https://cdn.jsdelivr.net/gh/desandro/imagesloaded@v4.1.4/imagesloaded.pkgd.min.js" integrity="sha512-S5PZ9GxJZO16tT9r3WJp/Safn31eu8uWrzglMahDT4dsmgqWonRY9grk3j+3tfuPr9WJNsfooOR7Gi7HL5W2jw==" crossorigin="anonymous"></script>
        <script src="https://cdn.jsdelivr.net/gh/metafizzy/isotope@v3.0.6/dist/isotope.pkgd.min.js" integrity="sha512-Zq2BOxyhvnRFXu0+WE6ojpZLOU2jdnqbrM1hmVdGzyeCa1DgM3X5Q4A/Is9xA1IkbUeDd7755dNNI/PzSf2Pew==" crossorigin="anonymous"></script>
      

      
      

      

      
        
        <script src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@10.2.1/build/highlight.min.js" integrity="sha512-Ypjm0o7jOxAd4hpdoppSEN0TQOC19UtPAqD+4s5AlXmUvbmmS/YMxYqAqarQYyxTnB6/rqip9qcxlNB/3U9Wdg==" crossorigin="anonymous"></script>
        
        
        <script src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@10.2.1/build/languages/r.min.js" crossorigin="anonymous"></script>
        
      

    

    
    
    
      <script src="https://cdn.jsdelivr.net/npm/leaflet@1.7.1/dist/leaflet.min.js" integrity="" crossorigin="anonymous"></script>
    

    
    

    
    
    

    
    

    
    
    
    

    
    

    
    
    
    
    
    
    
    
    
    <script src="/es/js/wowchemy.min.50d3bf3df0c53b31631bb48a62b35f92.js"></script>

    
  <script async defer src="https://buttons.github.io/buttons.js"></script>




</body>
</html>
