<!DOCTYPE html>
<html lang="en-us">
<head>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="generator" content="Source Themes Academic 3.2.0">
  <meta name="generator" content="Hugo 0.53" />
  <meta name="author" content="Dr. Dominic Royé">

  
  
  
  
    
  
  <meta name="description" content="Normalmente cuando visualizamos anomalías de precipitación mensual, simplemente usamos un gráfico de barras indicando con color rojo y azul valores negativos y positivos. No obstante, no nos explica el contexto general de estas mismas anomalías. Por ejemplo, ¿cuál fue la anomalía más alta o más baja en cada mes? En principio, podríamos usar un *boxplot* para visualizar la distribución de las anomalías, pero en este caso concreto no encajarían bien estéticamente, por lo que debemos buscar una alternativa. Aquí os presento una forma gráfica muy útil.">

  
  <link rel="alternate" hreflang="en-us" href="/es/2019/visualizar-anomal%C3%ADas-de-precipitaci%C3%B3n-mensual/">

  


  

  

  

  

  

  

  
  
  
  <meta name="theme-color" content="#2962ff">
  

  
  
  
  
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha256-eSi1q2PG6J7g7ib17yAaWMcrr5GrtohYChqibrV7PBE=" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/academicons/1.8.6/css/academicons.min.css" integrity="sha256-uFVgMKfistnJAfoCUQigIl+JfUaP47GrRKjf6CTPVmw=" crossorigin="anonymous">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.6.0/css/all.css" integrity="sha384-aOkxzJ5uQz7WBObEZcHvV5JvRW3TUc2rNPA7pe3AwnsUohiw1Vj2Rgx2KSOkF5+h" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.2.5/jquery.fancybox.min.css" integrity="sha256-ygkqlh3CYSUri3LhQxzdcm0n1EQvH2Y+U5S2idbLtxs=" crossorigin="anonymous">

    
    
    
      
    
    
      
      
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/dracula.min.css" crossorigin="anonymous">
      
    

    

    

  

  
  

  <link rel="stylesheet" href="/es/styles.css">
  
  <link rel="stylesheet" href="/css/override.css">
  

  
  
    <script>
      window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
      ga('create', 'UA-27463794-2', 'auto');
      ga('set', 'anonymizeIp', true);
      ga('require', 'eventTracker');
      ga('require', 'outboundLinkTracker');
      ga('require', 'urlChangeTracker');
      ga('send', 'pageview');
    </script>
    <script async src="//www.google-analytics.com/analytics.js"></script>
    
    <script async src="https://cdnjs.cloudflare.com/ajax/libs/autotrack/2.4.1/autotrack.js" integrity="sha512-HUmooslVKj4m6OBu0OgzjXXr+QuFYy/k7eLI5jdeEy/F4RSgMn6XRWRGkFi5IFaFgy7uFTkegp3Z0XnJf3Jq+g==" crossorigin="anonymous"></script>
    
  
  

  
  <link rel="alternate" href="/index.xml" type="application/rss+xml" title="Dominic Royé">
  <link rel="feed" href="/index.xml" type="application/rss+xml" title="Dominic Royé">
  

  <link rel="manifest" href="/site.webmanifest">
  <link rel="icon" type="image/png" href="/img/icon.png">
  <link rel="apple-touch-icon" type="image/png" href="/img/icon-192.png">

  <link rel="canonical" href="/es/2019/visualizar-anomal%C3%ADas-de-precipitaci%C3%B3n-mensual/">

  
  
  
  
    
  
  <meta property="twitter:card" content="summary_large_image">
  
  <meta property="og:site_name" content="Dominic Royé">
  <meta property="og:url" content="/es/2019/visualizar-anomal%C3%ADas-de-precipitaci%C3%B3n-mensual/">
  <meta property="og:title" content="Visualizar anomalías de precipitación mensual | Dominic Royé">
  <meta property="og:description" content="Normalmente cuando visualizamos anomalías de precipitación mensual, simplemente usamos un gráfico de barras indicando con color rojo y azul valores negativos y positivos. No obstante, no nos explica el contexto general de estas mismas anomalías. Por ejemplo, ¿cuál fue la anomalía más alta o más baja en cada mes? En principio, podríamos usar un *boxplot* para visualizar la distribución de las anomalías, pero en este caso concreto no encajarían bien estéticamente, por lo que debemos buscar una alternativa. Aquí os presento una forma gráfica muy útil."><meta property="og:image" content="/es/2019/visualizar-anomal%C3%ADas-de-precipitaci%C3%B3n-mensual/featured.png">
  <meta property="og:locale" content="en-us">
  
  <meta property="article:published_time" content="2019-07-07T00:00:00&#43;00:00">
  
  <meta property="article:modified_time" content="2019-07-07T00:00:00&#43;00:00">
  

  

<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.0.3/cookieconsent.min.css">
<script src="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.0.3/cookieconsent.min.js"></script>
<script>
  window.addEventListener("load", function(){
    window.cookieconsent.initialise({
      "palette": {
        "popup": {
          "background": "#2962ff",
          "text": "#fff"
        },
        "button": {
          "background": "#fff",
          "text": "#2962ff"
        }
      },
      "theme": "classic",
      "content": {
        "message": "Este sitio web utiliza cookies para garantizarle una mejor experiencia.",
        "dismiss": "Entendido!",
        "link": "Más información",
        "href": "https://cookies.insites.com"
      }
    })});
</script>


  

  <title>Visualizar anomalías de precipitación mensual | Dominic Royé</title>

</head>
<body id="top" data-spy="scroll" data-target="#TableOfContents" data-offset="71" >
  <aside class="search-results" id="search">
  <div class="container">
    <section class="search-header">

      <div class="row no-gutters justify-content-between mb-3">
        <div class="col-6">
          <h1>Search</h1>
        </div>
        <div class="col-6 col-search-close">
          <a class="js-search" href="#"><i class="fas fa-times-circle text-muted" aria-hidden="true"></i></a>
        </div>
      </div>

      <div id="search-box">
        
        
        
      </div>

    </section>
    <section class="section-search-results">

      <div id="search-hits">
        
      </div>

    </section>
  </div>
</aside>

<nav class="navbar navbar-light fixed-top navbar-expand-lg py-0" id="navbar-main">
  <div class="container">

    
      <a class="navbar-brand" href="/es"><div style="position:relative;float:left">Dominic Royé<img src="/img/portrait.jpg" alt="Dominic Royé" style="float: left;"></div></a>
      
      <button type="button" class="navbar-toggler" data-toggle="collapse"
              data-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Barra de navegación">
        <span><i class="fas fa-bars"></i></span>
      </button>
      

    
    <div class="collapse navbar-collapse" id="navbar">

      
      
      <ul class="navbar-nav ml-auto">
        

        

        
        
        

        <li class="nav-item">
          <a class="nav-link" href="/es/#">
            
            <span>inicio</span>
            
          </a>
        </li>

        
        

        

        
        
        
          
        

        <li class="nav-item">
          <a class="nav-link" href="/es/#posts">
            
            <span>blog</span>
            
          </a>
        </li>

        
        

        

        
        
        
          
        

        <li class="nav-item">
          <a class="nav-link" href="/es/#publications_selected">
            
            <span>publicaciones</span>
            
          </a>
        </li>

        
        

        

        
        
        
          
        

        <li class="nav-item">
          <a class="nav-link" href="/es/#graphs">
            
            <span>gráficos</span>
            
          </a>
        </li>

        
        

        

        
        
        
          
        

        <li class="nav-item">
          <a class="nav-link" href="/es/#about">
            
            <span>mí</span>
            
          </a>
        </li>

        
        

        

        
        
        
          
        

        <li class="nav-item">
          <a class="nav-link" href="/es/#teaching">
            
            <span>más</span>
            
          </a>
        </li>

        
        

      

        

        

        

        

      </ul>

    </div>
  </div>
</nav>


<article class="article" itemscope itemtype="http://schema.org/Article">

  













<div class="article-header d-xl-none">
  <div class="featured-image" style="background-image: url('/es/2019/visualizar-anomal%C3%ADas-de-precipitaci%C3%B3n-mensual/featured_hu6cc175b16e8f734e9fbe97a3cdf8545c_80024_800x0_resize_box_2.png');"></div>
  
</div>


<div class="container-fluid split-header d-none d-xl-block">
  <div class="row">
    <div class="col-6">
      <div class="split-header-content">
        <h1 itemprop="name">Visualizar anomalías de precipitación mensual</h1>

        

        

<div class="article-metadata">

  
  
  <span itemscope itemprop="author" itemtype="http://schema.org/Person">
    <meta itemprop="name" content="Dr. Dominic Royé">
  </span>
  

  <span class="article-date">
    
    <meta content="2019-07-07 00:00:00 &#43;0000 UTC" itemprop="datePublished">
    <time datetime="2019-07-07 00:00:00 &#43;0000 UTC" itemprop="dateModified">
      2019-07-07
    </time>
  </span>
  <span itemscope itemprop="publisher" itemtype="http://schema.org/Person">
    <meta itemprop="name" content="Dr. Dominic Royé">
  </span>

  

  
  
  <span class="middot-divider"></span>
  <a href="/es/2019/visualizar-anomal%C3%ADas-de-precipitaci%C3%B3n-mensual/#disqus_thread"></a>
  

  
  
  
  <span class="middot-divider"></span>
  <span class="article-categories">
    <i class="fas fa-folder"></i>
    
    <a href="/es/categories/visualizaci%C3%B3n/">visualización</a>, 
    
    <a href="/es/categories/r/">R</a>, 
    
    <a href="/es/categories/rintermedio/">R:intermedio</a>
    
  </span>
  
  

  

</div>


        







  










        
<div class="share-box" aria-hidden="true">
  <ul class="share">
    <li>
      <a class="twitter"
         href="https://twitter.com/intent/tweet?text=Visualizar%20anomal%c3%adas%20de%20precipitaci%c3%b3n%20mensual&amp;url=%2fes%2f2019%2fvisualizar-anomal%25C3%25ADas-de-precipitaci%25C3%25B3n-mensual%2f"
         target="_blank" rel="noopener">
        <i class="fab fa-twitter"></i>
      </a>
    </li>
    <li>
      <a class="facebook"
         href="https://www.facebook.com/sharer.php?u=%2fes%2f2019%2fvisualizar-anomal%25C3%25ADas-de-precipitaci%25C3%25B3n-mensual%2f"
         target="_blank" rel="noopener">
        <i class="fab fa-facebook-f"></i>
      </a>
    </li>
    <li>
      <a class="linkedin"
         href="https://www.linkedin.com/shareArticle?mini=true&amp;url=%2fes%2f2019%2fvisualizar-anomal%25C3%25ADas-de-precipitaci%25C3%25B3n-mensual%2f&amp;title=Visualizar%20anomal%c3%adas%20de%20precipitaci%c3%b3n%20mensual"
         target="_blank" rel="noopener">
        <i class="fab fa-linkedin-in"></i>
      </a>
    </li>
    <li>
      <a class="weibo"
         href="http://service.weibo.com/share/share.php?url=%2fes%2f2019%2fvisualizar-anomal%25C3%25ADas-de-precipitaci%25C3%25B3n-mensual%2f&amp;title=Visualizar%20anomal%c3%adas%20de%20precipitaci%c3%b3n%20mensual"
         target="_blank" rel="noopener">
        <i class="fab fa-weibo"></i>
      </a>
    </li>
    <li>
      <a class="email"
         href="mailto:?subject=Visualizar%20anomal%c3%adas%20de%20precipitaci%c3%b3n%20mensual&amp;body=%2fes%2f2019%2fvisualizar-anomal%25C3%25ADas-de-precipitaci%25C3%25B3n-mensual%2f">
        <i class="fas fa-envelope"></i>
      </a>
    </li>
  </ul>
</div>


      </div>
    </div>
    <div class="col-6">
      <div class="split-header-image">
        <img src="/es/2019/visualizar-anomal%C3%ADas-de-precipitaci%C3%B3n-mensual/featured_hu6cc175b16e8f734e9fbe97a3cdf8545c_80024_680x500_fill_q90_box_smart1_2.png" itemprop="image" alt="">
        
      </div>
    </div>
  </div>
</div>

<div class="article-container d-xl-none">
  <h1 itemprop="name">Visualizar anomalías de precipitación mensual</h1>

  

  

<div class="article-metadata">

  
  
  <span itemscope itemprop="author" itemtype="http://schema.org/Person">
    <meta itemprop="name" content="Dr. Dominic Royé">
  </span>
  

  <span class="article-date">
    
    <meta content="2019-07-07 00:00:00 &#43;0000 UTC" itemprop="datePublished">
    <time datetime="2019-07-07 00:00:00 &#43;0000 UTC" itemprop="dateModified">
      2019-07-07
    </time>
  </span>
  <span itemscope itemprop="publisher" itemtype="http://schema.org/Person">
    <meta itemprop="name" content="Dr. Dominic Royé">
  </span>

  

  
  
  <span class="middot-divider"></span>
  <a href="/es/2019/visualizar-anomal%C3%ADas-de-precipitaci%C3%B3n-mensual/#disqus_thread"></a>
  

  
  
  
  <span class="middot-divider"></span>
  <span class="article-categories">
    <i class="fas fa-folder"></i>
    
    <a href="/es/categories/visualizaci%C3%B3n/">visualización</a>, 
    
    <a href="/es/categories/r/">R</a>, 
    
    <a href="/es/categories/rintermedio/">R:intermedio</a>
    
  </span>
  
  

  
  
<div class="share-box" aria-hidden="true">
  <ul class="share">
    <li>
      <a class="twitter"
         href="https://twitter.com/intent/tweet?text=Visualizar%20anomal%c3%adas%20de%20precipitaci%c3%b3n%20mensual&amp;url=%2fes%2f2019%2fvisualizar-anomal%25C3%25ADas-de-precipitaci%25C3%25B3n-mensual%2f"
         target="_blank" rel="noopener">
        <i class="fab fa-twitter"></i>
      </a>
    </li>
    <li>
      <a class="facebook"
         href="https://www.facebook.com/sharer.php?u=%2fes%2f2019%2fvisualizar-anomal%25C3%25ADas-de-precipitaci%25C3%25B3n-mensual%2f"
         target="_blank" rel="noopener">
        <i class="fab fa-facebook-f"></i>
      </a>
    </li>
    <li>
      <a class="linkedin"
         href="https://www.linkedin.com/shareArticle?mini=true&amp;url=%2fes%2f2019%2fvisualizar-anomal%25C3%25ADas-de-precipitaci%25C3%25B3n-mensual%2f&amp;title=Visualizar%20anomal%c3%adas%20de%20precipitaci%c3%b3n%20mensual"
         target="_blank" rel="noopener">
        <i class="fab fa-linkedin-in"></i>
      </a>
    </li>
    <li>
      <a class="weibo"
         href="http://service.weibo.com/share/share.php?url=%2fes%2f2019%2fvisualizar-anomal%25C3%25ADas-de-precipitaci%25C3%25B3n-mensual%2f&amp;title=Visualizar%20anomal%c3%adas%20de%20precipitaci%c3%b3n%20mensual"
         target="_blank" rel="noopener">
        <i class="fab fa-weibo"></i>
      </a>
    </li>
    <li>
      <a class="email"
         href="mailto:?subject=Visualizar%20anomal%c3%adas%20de%20precipitaci%c3%b3n%20mensual&amp;body=%2fes%2f2019%2fvisualizar-anomal%25C3%25ADas-de-precipitaci%25C3%25B3n-mensual%2f">
        <i class="fas fa-envelope"></i>
      </a>
    </li>
  </ul>
</div>


  

</div>


  







  









</div>



  <div class="article-container">

    <div class="article-style" itemprop="articleBody">
      


<p>Normalmente cuando visualizamos anomalías de precipitación mensual, simplemente usamos un gráfico de barras indicando con color rojo y azul valores negativos y positivos. No obstante, no nos explica el contexto general de estas mismas anomalías. Por ejemplo, ¿cuál fue la anomalía más alta o más baja en cada mes? En principio, podríamos usar un <em>boxplot</em> para visualizar la distribución de las anomalías, pero en este caso concreto no encajarían bien estéticamente, por lo que debemos buscar una alternativa. Aquí os presento una forma gráfica muy útil.</p>
<div id="paquetes" class="section level2">
<h2>Paquetes</h2>
<p>En este post usaremos los siguientes paquetes:</p>
<table>
<thead>
<tr class="header">
<th align="left">Paquete</th>
<th align="left">Descripción</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">tidyverse</td>
<td align="left">Conjunto de paquetes (visualización y manipulación de datos): ggplot2, dplyr, purrr,etc.</td>
</tr>
<tr class="even">
<td align="left">readr</td>
<td align="left">Importar datos</td>
</tr>
<tr class="odd">
<td align="left">ggthemes</td>
<td align="left">Estilos para ggplot2</td>
</tr>
<tr class="even">
<td align="left">lubridate</td>
<td align="left">Fácil manipulación de fechas y tiempos</td>
</tr>
<tr class="odd">
<td align="left">cowplot</td>
<td align="left">Fácil creación de múltiples gráficos con ggplot2</td>
</tr>
</tbody>
</table>
<pre class="r"><code>#instalamos los paquetes si hace falta
if(!require(&quot;tidyverse&quot;)) install.packages(&quot;tidyverse&quot;)
if(!require(&quot;ggthemes&quot;)) install.packages(&quot;broom&quot;)
if(!require(&quot;cowplot&quot;)) install.packages(&quot;cowplot&quot;)
if(!require(&quot;lubridate&quot;)) install.packages(&quot;lubridate&quot;)

#paquetes
library(tidyverse) #contiene readr
library(ggthemes)
library(cowplot)
library(lubridate)</code></pre>
</div>
<div id="preparar-los-datos" class="section level2">
<h2>Preparar los datos</h2>
<p>Primero importamos la precipitación diaria de la estación meteorológica seleccionada (<a href="/files/RR_STAID001394.txt">descarga</a>). Usaremos datos de Santiago de Compostela (España) accesible a través de <a href="https://eca.knmi.nl">ECA&amp;D</a>.</p>
<div id="paso-1-importar-los-datos" class="section level3">
<h3>Paso 1: importar los datos</h3>
<p>No sólo importamos los datos en formato <em>csv</em>, sino también hacemos los primeros cambios. Saltamos las primeras 21 filas que contienen información sobre la estación meteorológica. Además, convertimos la fecha a clase <code>date</code> y reemplazamos valores ausentes (-9999) por <code>NA</code>. La precipitación está en 0.1 mm, por tanto, debemos dividir los valores por 10. Después seleccionamos las columnas <em>DATE</em> y <em>RR</em>, y las renombramos.</p>
<pre class="r"><code>data &lt;- read_csv(&quot;RR_STAID001394.txt&quot;, skip = 21) %&gt;%
             mutate(DATE = ymd(DATE), RR = ifelse(RR == -9999, NA, RR/10)) %&gt;%
               select(DATE:RR) %&gt;% 
             rename(date = DATE, pr = RR)</code></pre>
<pre><code>## Parsed with column specification:
## cols(
##   STAID = col_double(),
##   SOUID = col_double(),
##   DATE = col_double(),
##   RR = col_double(),
##   Q_RR = col_double()
## )</code></pre>
<pre class="r"><code>data</code></pre>
<pre><code>## # A tibble: 27,606 x 2
##    date          pr
##    &lt;date&gt;     &lt;dbl&gt;
##  1 1943-11-01   0.6
##  2 1943-11-02   0  
##  3 1943-11-03   0  
##  4 1943-11-04   0  
##  5 1943-11-05   0  
##  6 1943-11-06   0  
##  7 1943-11-07   0  
##  8 1943-11-08   0  
##  9 1943-11-09   0  
## 10 1943-11-10   0  
## # ... with 27,596 more rows</code></pre>
</div>
<div id="paso-2-crear-valores-menusales" class="section level3">
<h3>Paso 2: crear valores menusales</h3>
<p>En el segundo paso calculamos las cantidades mensuales de precipitación. Para ello, a) limitamos el período a los años posteriores a 1950, b) añadimos como variable el mes con etiqueta y el año.</p>
<pre class="r"><code>data &lt;- mutate(data, mo = month(date, label = TRUE), yr = year(date)) %&gt;%
            filter(date &gt;= &quot;1950-01-01&quot;) %&gt;%
                group_by(yr, mo) %&gt;% 
                   summarise(prs = sum(pr, na.rm = TRUE))

data</code></pre>
<pre><code>## # A tibble: 833 x 3
## # Groups:   yr [70]
##       yr mo      prs
##    &lt;dbl&gt; &lt;ord&gt; &lt;dbl&gt;
##  1  1950 ene    55.6
##  2  1950 feb   349. 
##  3  1950 mar    85.8
##  4  1950 abr    33.4
##  5  1950 may   272. 
##  6  1950 jun   111. 
##  7  1950 jul    35.4
##  8  1950 ago    76.4
##  9  1950 sep    85  
## 10  1950 oct    53  
## # ... with 823 more rows</code></pre>
</div>
<div id="paso-3-estimar-las-anomalías" class="section level3">
<h3>Paso 3: estimar las anomalías</h3>
<p>Ahora debemos estimar los valores normales de cada mes y unir esta tabla a nuestros datos principales para posteriormente poder calcular la anomalía mensual. Expresamos la anomalía en porcentaje y restamos 100 para fijar el promedio en 0. Además, creamos una variable que nos indica si la anomalía es negativa o positiva, y otra con la fecha.</p>
<pre class="r"><code>pr_ref &lt;- filter(data, yr &gt; 1981, yr &lt;= 2010) %&gt;%
                   group_by(mo) %&gt;%
                      summarise(pr_ref = mean(prs))

data &lt;- left_join(data, pr_ref, by = &quot;mo&quot;)

data &lt;- mutate(data, 
               anom = (prs*100/pr_ref)-100, 
               date = str_c(yr, as.numeric(mo), 1, sep = &quot;-&quot;) %&gt;% ymd(),
               sign= ifelse(anom &gt; 0, &quot;pos&quot;, &quot;neg&quot;))</code></pre>
<p>Ya podemos hacer un primer ensayo de un gráfico de anomalías (la versión clásica), para ello filtramos el año 2018. En este caso usamos la geometría de barras, recuerda que por defecto la función <code>geom_bar()</code> aplica el conteo a la variable. No obstante, en este caso conocemos <code>y</code>, por tanto indicamos con el argumento <code>stat = "identity"</code> que debe usar el valor dado en <code>aes()</code>.</p>
<pre class="r"><code>filter(data, yr == 2018) %&gt;%
   ggplot(aes(date, anom, fill = sign)) + 
       geom_bar(stat = &quot;identity&quot;, show.legend = FALSE) + 
    scale_x_date(date_breaks = &quot;month&quot;, date_labels = &quot;%b&quot;) +
    scale_y_continuous(breaks = seq(-100, 100, 20)) +
    scale_fill_manual(values = c(&quot;#99000d&quot;, &quot;#034e7b&quot;)) +
         labs(y = &quot;Anomalía de precipitación (%)&quot;, x = &quot;&quot;) +
          theme_hc()</code></pre>
<p><img src="/post/es/2019-07-07-visualizar-anomalias-precipitacion-mensual/index.es_files/figure-html/unnamed-chunk-6-1.png" width="672" /></p>
</div>
<div id="paso-4-calcular-las-medidas-estadísticas" class="section level3">
<h3>Paso 4: calcular las medidas estadísticas</h3>
<p>En este último paso estimamos el valor máximo, mínimo, el cuantil 25%/75% y el rango intercuartil por mes de toda la serie temporal.</p>
<pre class="r"><code>data_norm &lt;-     group_by(data, mo) %&gt;%
                     summarise(mx = max(anom),
                               min = min(anom),
                               q25 = quantile(anom, .25),
                               q75 = quantile(anom, .75),
                               iqr = q75-q25)

data_norm</code></pre>
<pre><code>## # A tibble: 12 x 6
##    mo       mx    min   q25   q75   iqr
##    &lt;ord&gt; &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
##  1 ene    193.  -89.6 -43.6 56.3   99.9
##  2 feb    320.  -96.5 -51.2 77.7  129. 
##  3 mar    381. -100   -40.6 88.2  129. 
##  4 abr    198.  -93.6 -51.2 17.1   68.3
##  5 may    141.  -90.1 -45.2 17.0   62.2
##  6 jun    419.  -99.3 -58.2 50.0  108. 
##  7 jul    311.  -98.2 -77.3 27.1  104. 
##  8 ago    264. -100   -68.2 39.8  108. 
##  9 sep    241.  -99.2 -64.9 48.6  113. 
## 10 oct    220.  -99.0 -54.5  4.69  59.2
## 11 nov    137.  -98.8 -44.0 39.7   83.7
## 12 dic    245.  -91.8 -49.8 36.0   85.8</code></pre>
</div>
</div>
<div id="crear-el-gráfico" class="section level2">
<h2>Crear el gráfico</h2>
<p>Para crear el gráfico de anomalías con leyenda es necesario separar el gráfico principal de las leyendas.</p>
<div id="parte-1" class="section level3">
<h3>Parte 1</h3>
<p>En esta primera parte vamos añadiendo capa por capa los diferentes elementos: 1) el rango de anomalías máximo-mínimo 2) el rango intercuartil 3) las anomalías del año 2018.</p>
<pre class="r"><code>#rango de anomalías máximo-mínimo 
g1.1 &lt;- ggplot(data_norm)+
           geom_crossbar(aes(x = mo, y = 0, ymin = min, ymax = mx),
                        fatten = 0, fill = &quot;grey90&quot;, colour = &quot;NA&quot;)

g1.1</code></pre>
<p><img src="/post/es/2019-07-07-visualizar-anomalias-precipitacion-mensual/index.es_files/figure-html/unnamed-chunk-8-1.png" width="672" /></p>
<pre class="r"><code>#añadinos el rango intercuartil
g1.2 &lt;- g1.1 + geom_crossbar(aes(x = mo, y = 0, ymin = q25, ymax = q75),
                              fatten = 0, fill = &quot;grey70&quot;)

g1.2</code></pre>
<p><img src="/post/es/2019-07-07-visualizar-anomalias-precipitacion-mensual/index.es_files/figure-html/unnamed-chunk-8-2.png" width="672" /></p>
<pre class="r"><code>#añadimos las anomalías del año 2018

g1.3 &lt;- g1.2 + geom_crossbar(data = filter(data, yr == 2018),
                aes(x = mo, y = 0, ymin = 0, ymax = anom, fill = sign),
                fatten = 0, width = 0.7, alpha = .7, colour = &quot;NA&quot;,
                show.legend = FALSE)
g1.3</code></pre>
<p><img src="/post/es/2019-07-07-visualizar-anomalias-precipitacion-mensual/index.es_files/figure-html/unnamed-chunk-8-3.png" width="672" /></p>
<p>Finalmente añadimos unos últimos ajustes de estilo.</p>
<pre class="r"><code>g1 &lt;- g1.3 + geom_hline(yintercept = 0)+
               scale_fill_manual(values=c(&quot;#99000d&quot;,&quot;#034e7b&quot;))+
               scale_y_continuous(&quot;Anomalía de precipitación (%)&quot;,
                                   breaks = seq(-100, 500, 25),
                                   expand = c(0, 5))+
            labs(x = &quot;&quot;,
                 title = &quot;Anomalía de precipitación en Santiago de Compostela 2018&quot;,
                 caption=&quot;Dominic Royé (@dr_xeo) | Datos: eca.knmi.nl&quot;)+
            theme_hc()
g1</code></pre>
<p><img src="/post/es/2019-07-07-visualizar-anomalias-precipitacion-mensual/index.es_files/figure-html/unnamed-chunk-9-1.png" width="672" /></p>
</div>
<div id="parte-2" class="section level3">
<h3>Parte 2</h3>
<p>Todavía nos falta una leyenda. Primero la creamos para los valores normales.</p>
<pre class="r"><code>#datos de la leyenda
legend &lt;- filter(data_norm, mo == &quot;ene&quot;)

legend_lab &lt;- gather(legend, stat, y, mx:q75) %&gt;%
                 mutate(stat = factor(stat, stat, c(&quot;máximo&quot;,
                                                   &quot;mínimo&quot;,
                                                   &quot;Cuantil 25%&quot;,
                                                   &quot;Cuantil 75%&quot;)) %&gt;%
                                            as.character())

#gráfico de la leyenda
g2 &lt;- legend %&gt;% ggplot()+
                  geom_crossbar(aes(x = mo, y = 0, ymin = min, ymax = mx),
                                fatten = 0, fill = &quot;grey90&quot;, colour = &quot;NA&quot;, width = 0.2) +
                  geom_crossbar(aes(x = mo, y = 0, ymin = q25, ymax = q75),
                                fatten = 0, fill = &quot;grey70&quot;, width = 0.2) +
                  geom_text(data = legend_lab, 
                            aes(x = mo, y = y+c(12,-8,-10,12), label = stat), 
                            fontface = &quot;bold&quot;, size = 2) +
                   annotate(&quot;text&quot;, x = 1.18, y = 40, 
                            label = &quot;Período 1950-2018&quot;, angle = 90, size = 3) +
              theme_void() + 
                theme(plot.margin = unit(c(0, 0, 0, 0), &quot;cm&quot;))

g2</code></pre>
<p><img src="/post/es/2019-07-07-visualizar-anomalias-precipitacion-mensual/index.es_files/figure-html/unnamed-chunk-10-1.png" width="672" /></p>
<p>Segundo, creamos otra leyenda para las anomalías actuales.</p>
<pre class="r"><code>legend2 &lt;- filter(data, yr == 1950, mo %in% c(&quot;ene&quot;,&quot;feb&quot;)) %&gt;% 
              ungroup() %&gt;% 
            select(mo, anom, sign)

legend2[2,1] &lt;- &quot;ene&quot;

legend_lab2 &lt;- data.frame(mo = rep(&quot;ene&quot;, 3), 
                          anom= c(110, 3, -70), 
                          label = c(&quot;Anomalía positiva&quot;, &quot;Promedio&quot;, &quot;Anomalía negativa&quot;))

g3 &lt;-  ggplot() + 
         geom_bar(data = legend2,
                aes(x = mo, y = anom, fill = sign),
                   alpha = .6, colour = &quot;NA&quot;, stat = &quot;identity&quot;, show.legend = FALSE, width = 0.2) +
         geom_segment(aes(x = .85, y = 0, xend = 1.15, yend = 0), linetype = &quot;dashed&quot;) +
         geom_text(data = legend_lab2, aes(x = mo, y = anom+c(10,5,-13), label = label), fontface = &quot;bold&quot;, size = 2) +
         annotate(&quot;text&quot;, x = 1.25, y = 20, 
                  label =&quot;Referencia 1971-2010&quot;, angle = 90, size = 3) +
         scale_fill_manual(values = c(&quot;#99000d&quot;, &quot;#034e7b&quot;)) +
        theme_void() +
         theme(plot.margin = unit(c(0, 0, 0, 0), &quot;cm&quot;))

g3</code></pre>
<p><img src="/post/es/2019-07-07-visualizar-anomalias-precipitacion-mensual/index.es_files/figure-html/unnamed-chunk-11-1.png" width="672" /></p>
</div>
<div id="parte-3" class="section level3">
<h3>Parte 3</h3>
<p>Para finalizar sólo debemos unir el gráfico y las leyendas con ayuda del paquete <code>cowplot</code>. La función princial de <code>cowplot</code> es <code>plot_grid()</code> que ayuda en combinar diferentes gráficos. No obstante, en este caso se hace necesario usar unas funciones más flexibles para crear formatos menos habituales. La función <code>ggdraw()</code> configura la capa básica del gráfico, y las funciones que están destinadas a operar en esta capa comienzan con <code>draw_*</code>.</p>
<pre class="r"><code>p &lt;- ggdraw() +
       draw_plot(g1, x = 0, y = .3, width = 1, height = 0.6) +
       draw_plot(g2, x = 0, y = .15, width = .2, height = .15) +
       draw_plot(g3, x = 0.08, y = .15, width = .2, height = .15)

p</code></pre>
<p><img src="/post/es/2019-07-07-visualizar-anomalias-precipitacion-mensual/index.es_files/figure-html/unnamed-chunk-12-1.png" width="3729" /></p>
<pre class="r"><code>save_plot(&quot;pr_anomalia2016_scq.png&quot;, p, dpi = 300, base_width = 12.43, base_height = 8.42)</code></pre>
</div>
</div>
<div id="múltiples-facetas" class="section level2">
<h2>Múltiples facetas</h2>
<p>En este apartado haremos el mismo gráfico como en el anterior, pero para varios años.</p>
<div id="parte-1-1" class="section level3">
<h3>Parte 1</h3>
<p>Únicamente debemos filtrar por un conjunto de años, en este caso de 2016 a 2018, usando el operador <code>%in%</code>, además añadimos la función <code>facet_grid()</code> a <code>ggplot</code>, lo que nos permite plotear los gráficos según una variable. La formula usada para la función de facetas es similar al uso en modelos: <code>variable_por_fila ~ variable_por_columna</code>. Cuando no tenemos una variable en columna debemos usar el <code>.</code>.</p>
<pre class="r"><code>#rango de anomalias maximo-minimo 
g1.1 &lt;- ggplot(data_norm)+
           geom_crossbar(aes(x = mo, y = 0, ymin = min, ymax = mx),
                        fatten = 0, fill = &quot;grey90&quot;, colour = &quot;NA&quot;)

g1.1</code></pre>
<p><img src="/post/es/2019-07-07-visualizar-anomalias-precipitacion-mensual/index.es_files/figure-html/unnamed-chunk-13-1.png" width="672" /></p>
<pre class="r"><code>#añadinos el rango intercuartil
g1.2 &lt;- g1.1 + geom_crossbar(aes(x = mo, y = 0, ymin = q25, ymax = q75),
                              fatten = 0, fill = &quot;grey70&quot;)

g1.2</code></pre>
<p><img src="/post/es/2019-07-07-visualizar-anomalias-precipitacion-mensual/index.es_files/figure-html/unnamed-chunk-13-2.png" width="672" /></p>
<pre class="r"><code>#añadimos las anomalías del año 2016-2018

g1.3 &lt;- g1.2 + geom_crossbar(data = filter(data, yr %in% 2016:2018),
                aes(x = mo, y = 0, ymin = 0, ymax = anom, fill = sign),
                fatten = 0, width = 0.7, alpha = .7, colour = &quot;NA&quot;,
                show.legend = FALSE) +
               facet_grid(yr ~ .)
g1.3</code></pre>
<p><img src="/post/es/2019-07-07-visualizar-anomalias-precipitacion-mensual/index.es_files/figure-html/unnamed-chunk-13-3.png" width="672" /></p>
<p>Finalmente, añadimos unos últimos ajustes de estilo.</p>
<pre class="r"><code>g1 &lt;- g1.3 + geom_hline(yintercept = 0)+
               scale_fill_manual(values=c(&quot;#99000d&quot;,&quot;#034e7b&quot;))+
               scale_y_continuous(&quot;Anomalía de precipitación (%)&quot;,
                                   breaks = seq(-100, 500, 50),
                                   expand = c(0, 5))+
            labs(x = &quot;&quot;,
                 title = &quot;Anomalía de precipitación en Santiago de Compostela&quot;,
                 caption=&quot;Dominic Royé (@dr_xeo) | Datos: eca.knmi.nl&quot;)+
            theme_hc()
g1</code></pre>
<p><img src="/post/es/2019-07-07-visualizar-anomalias-precipitacion-mensual/index.es_files/figure-html/unnamed-chunk-14-1.png" width="3729" /></p>
<p>Usamos la misma leyenda universal creada para el gráfico anterior.</p>
</div>
</div>
<div id="parte-2-1" class="section level2">
<h2>Parte 2</h2>
<p>Para finalizar, sólo unimos el gráfico y las leyendas con ayuda del paquete <code>cowplot</code>. Lo único que debemos ajustar aquí son los argumentos en la función <code>draw_plot()</code> para colocar correctamente las diferentes partes.</p>
<pre class="r"><code>p &lt;- ggdraw() +
       draw_plot(g1, x = 0, y = .18, width = 1, height = 0.8) +
       draw_plot(g2, x = 0, y = .08, width = .2, height = .15) +
       draw_plot(g3, x = 0.08, y = .08, width = .2, height = .15)

p</code></pre>
<p><img src="/post/es/2019-07-07-visualizar-anomalias-precipitacion-mensual/index.es_files/figure-html/unnamed-chunk-15-1.png" width="3729" /></p>
<pre class="r"><code>save_plot(&quot;pr_anomalia20162018_scq.png&quot;, p, dpi = 300, base_width = 12.43, base_height = 8.42)</code></pre>
</div>

    </div>

    


<div class="article-tags">
  
  <a class="badge badge-light" href="/es/tags/anomal%C3%ADa/">anomalía</a>
  
  <a class="badge badge-light" href="/es/tags/precipitaci%C3%B3n/">precipitación</a>
  
  <a class="badge badge-light" href="/es/tags/clima/">clima</a>
  
  <a class="badge badge-light" href="/es/tags/boxplot/">boxplot</a>
  
</div>



    






<div class="media author-card" itemscope itemtype="http://schema.org/Person">
  
  <img class="portrait mr-3" src="/img/potrai_domi.jpg" itemprop="image" alt="Avatar">
  
  <div class="media-body">
    <h5 class="card-title" itemprop="name"><a href="/es">Dr. Dominic Royé</a></h5>
    
    
    <ul class="network-icon" aria-hidden="true">
      
      
      
      
      
      
      
      
      <li>
        <a itemprop="sameAs" href="mailto:dominic.roye@usc.es" >
          <i class="fa fa-envelope"></i>
        </a>
      </li>
      
      
      
      
        
      
      
      
      
      
        
      
      <li>
        <a itemprop="sameAs" href="//twitter.com/dr_xeo" >
          <i class="fab fa-twitter"></i>
        </a>
      </li>
      
      
      
      
      
      
      
      
        
      
      <li>
        <a itemprop="sameAs" href="https://www.researchgate.net/profile/Dominic_Roye" target="_blank" rel="noopener">
          <i class="ai ai-researchgate"></i>
        </a>
      </li>
      
      
      
      
        
      
      
      
      
      
        
      
      <li>
        <a itemprop="sameAs" href="//github.com/dominicroye" >
          <i class="fab fa-github"></i>
        </a>
      </li>
      
    </ul>
  </div>
</div>




    
    
    <div class="article-widget">
      <div class="hr-light"></div>
      <h3>Relacionado</h3>
      <ul>
        
        <li><a href="/es/publication/os_tempos_2019/">Os tempos e o clima de Galicia</a></li>
        
        <li><a href="/es/graphs/climate/">Clima y tiempo</a></li>
        
      </ul>
    </div>
    

    
    <div class="article-widget">
      <div class="post-nav">
  
  <div class="post-nav-item">
    <div class="meta-nav">Siguiente</div>
    <a href="/es/2019/visualizar-el-crecimiento-urbano/" rel="next">Visualizar el crecimiento urbano</a>
  </div>
  
  
  <div class="post-nav-item">
    <div class="meta-nav">Anterior</div>
    <a href="/es/2019/resumir-tests-de-correlaciones-en-r/" rel="prev">Resumir tests de correlaciones en R</a>
  </div>
  
</div>

    </div>
    

    
<section id="comments">
  <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "https-dominicroye-github-io" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</section>



  </div>
</article>

<div class="container">
  <footer class="site-footer">
  

  <p class="powered-by">
    &copy; 2018-2020 Dominic Royé. All rights reserved. &middot; 

    Powered by the
    <a href="https://sourcethemes.com/academic/" target="_blank" rel="noopener">Academic theme</a> for
    <a href="https://gohugo.io" target="_blank" rel="noopener">Hugo</a>.

    
    <span class="float-right" aria-hidden="true">
      <a href="#" id="back_to_top">
        <span class="button_icon">
          <i class="fas fa-chevron-up fa-2x"></i>
        </span>
      </a>
    </span>
    
  </p>
</footer>

</div>


<div id="modal" class="modal fade" role="dialog">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Citar</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <pre><code class="tex hljs"></code></pre>
      </div>
      <div class="modal-footer">
        <a class="btn btn-outline-primary my-1 js-copy-cite" href="#" target="_blank">
          <i class="fas fa-copy"></i> Copiar
        </a>
        <a class="btn btn-outline-primary my-1 js-download-cite" href="#" target="_blank">
          <i class="fas fa-download"></i> Descargar
        </a>
        <div id="modal-error"></div>
      </div>
    </div>
  </div>
</div>

    

    
    

    
    
    
      <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha512-+NqPlbbtM1QqiK8ZAo4Yrj2c4lNQoGv8P79DPtKzj++l5jnN39rHA/xsqn8zE9l0uSoxaCdrOgFs6yjyfbBxSg==" crossorigin="anonymous"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.imagesloaded/4.1.3/imagesloaded.pkgd.min.js" integrity="sha512-umsR78NN0D23AzgoZ11K7raBD+R6hqKojyBZs1w8WvYlsI+QuKRGBx3LFCwhatzBunCjDuJpDHwxD13sLMbpRA==" crossorigin="anonymous"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha256-VsEqElsCHSGmnmHXGQzvoWjWwoznFSZc6hs7ARLRacQ=" crossorigin="anonymous"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.isotope/3.0.4/isotope.pkgd.min.js" integrity="sha512-VDBOIlDbuC4VWxGJNmuFRQ0Li0SKkDpmGyuhAG5LTDLd/dJ/S0WMVxriR2Y+CyPL5gzjpN4f/6iqWVBJlht0tQ==" crossorigin="anonymous"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.2.5/jquery.fancybox.min.js" integrity="sha256-X5PoE3KU5l+JcX+w09p/wHl9AzK333C4hJ2I9S5mD4M=" crossorigin="anonymous"></script>

      
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js" integrity="sha256-/BfiIkHlHoVihZdc6TFuj7MmJ0TWcWsMXkeDFwhi0zw=" crossorigin="anonymous"></script>
        
        <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/r.min.js"></script>
        
      

      
      
    

    
    

    
    
    
    <script id="dsq-count-scr" src="//https-dominicroye-github-io.disqus.com/count.js" async></script>
    

    
    
    <script>hljs.initHighlightingOnLoad();</script>
    

    

    
    

    

    
    

    
    

    
    
    
    
    
    
    
    
    <script src="/js/academic.min.d037ee5294b166a79dec317c58aea9cc.js"></script>

    

  </body>
</html>

