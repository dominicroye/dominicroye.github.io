<!DOCTYPE html><html lang="es-ES" >


<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  
  
  
    <meta name="generator" content="Wowchemy 5.3.0 for Hugo" />
  

  
  









  




  
  
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  

  
  
  
    
      
      <link rel="preload" as="style" href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Roboto+Mono&family=Roboto:wght@400;700&display=swap">
      <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Roboto+Mono&family=Roboto:wght@400;700&display=swap" media="print" onload="this.media='all'">
    
  

  
  
  
  
  
    
    
    
  
  

  <meta name="author" content="Dr. Dominic Royé" />

  
  
  
    
  
  <meta name="description" content="La información espacio-temporal es clave en muchas disciplinas, especialmente en la climatología o la meteorología, y ello hace necesario disponer de un formato que permita una estructura multidimensional. Además es importante que ese formato tenga un alto grado de compatibilidad de intercambio y pueda almacenar un elevado número de datos." />

  
  <link rel="alternate" hreflang="es-ES" href="https://dominicroye.github.io/es/2022/uso-de-datos-multidimensionales-espaciales/" />

  
  
  
    <meta name="theme-color" content="#1565c0" />
  

  
  

  

  <link rel="stylesheet" href="/css/vendor-bundle.min.f1ecf783c14edc00c9320c205831ad8e.css" media="print" onload="this.media='all'">

  
  
  
    
    
      <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/academicons@1.9.1/css/academicons.min.css" integrity="sha512-W0xM4mr6dEP9nREo7Z9z+9X70wytKvMGeDsj7ps2+xg5QPrEBXC8tAW1IFnzjR6eoJ90JmCnFzerQJTLzIEHjA==" crossorigin="anonymous" media="print" onload="this.media='all'">
    

    
    
    
    
      
      
    
    
    

    
    
    
      
    
    
      
      
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@10.2.1/build/styles/dracula.min.css" crossorigin="anonymous" title="hl-light" media="print" onload="this.media='all'">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@10.2.1/build/styles/dracula.min.css" crossorigin="anonymous" title="hl-dark" media="print" onload="this.media='all'" disabled>
      
    

    
    
    
      <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.7.1/dist/leaflet.min.css" integrity="" crossorigin="anonymous" media="print" onload="this.media='all'">
    

    

    
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      
        
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
  

  
  
  
  
  
  <link rel="stylesheet" href="/css/wowchemy.b48d89910a3f8560bb2d78fedea8d682.css" />

  




<script async src="https://www.googletagmanager.com/gtag/js?id=UA-27463794-2"></script>
<script>
  window.dataLayer = window.dataLayer || [];

  function gtag() {
      dataLayer.push(arguments);
  }

  function trackOutboundLink(url, target) {
    gtag('event', 'click', {
         'event_category': 'outbound',
         'event_label': url,
         'transport_type': 'beacon',
         'event_callback': function () {
           if (target !== '_blank') {
             document.location = url;
           }
         }
    });
    console.debug("Outbound link clicked: " + url);
  }

  function onClickCallback(event) {
    if ((event.target.tagName !== 'A') || (event.target.host === window.location.host)) {
      return;
    }
    trackOutboundLink(event.target, event.target.getAttribute('target'));  
  }

  gtag('js', new Date());
  gtag('config', 'UA-27463794-2', {});
  gtag('set', {'cookie_flags': 'SameSite=None;Secure'});

  
  document.addEventListener('click', onClickCallback, false);
</script>


  

  

  




  
  
  

  

  
    <link rel="manifest" href="/es/manifest.webmanifest" />
  

  <link rel="icon" type="image/png" href="/media/icon_hu27cb63416a395b8c8d0d7112b85e26a9_17299_32x32_fill_lanczos_center_3.png" />
  <link rel="apple-touch-icon" type="image/png" href="/media/icon_hu27cb63416a395b8c8d0d7112b85e26a9_17299_180x180_fill_lanczos_center_3.png" />

  <link rel="canonical" href="https://dominicroye.github.io/es/2022/uso-de-datos-multidimensionales-espaciales/" />

  
  
  
  
  
  
  
  
    
  
  

  
  
    
    
  
  <meta property="twitter:card" content="summary_large_image" />
  
    <meta property="twitter:site" content="@@dr_xeo" />
    <meta property="twitter:creator" content="@@dr_xeo" />
  
  <meta property="og:site_name" content="Dr. Dominic Royé" />
  <meta property="og:url" content="https://dominicroye.github.io/es/2022/uso-de-datos-multidimensionales-espaciales/" />
  <meta property="og:title" content="Uso de datos multidimensionales espaciales | Dr. Dominic Royé" />
  <meta property="og:description" content="La información espacio-temporal es clave en muchas disciplinas, especialmente en la climatología o la meteorología, y ello hace necesario disponer de un formato que permita una estructura multidimensional. Además es importante que ese formato tenga un alto grado de compatibilidad de intercambio y pueda almacenar un elevado número de datos." /><meta property="og:image" content="https://dominicroye.github.io/es/2022/uso-de-datos-multidimensionales-espaciales/featured.png" />
    <meta property="twitter:image" content="https://dominicroye.github.io/es/2022/uso-de-datos-multidimensionales-espaciales/featured.png" /><meta property="og:locale" content="es-ES" />
  
    
      <meta
        property="article:published_time"
        content="2022-03-08T00:00:00&#43;00:00"
      />
    
    <meta property="article:modified_time" content="2022-03-08T00:00:00&#43;00:00">
  

  


    






  




<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://dominicroye.github.io/es/2022/uso-de-datos-multidimensionales-espaciales/"
  },
  "headline": "Uso de datos multidimensionales espaciales",
  
  "image": [
    "https://dominicroye.github.io/es/2022/uso-de-datos-multidimensionales-espaciales/featured.png"
  ],
  
  "datePublished": "2022-03-08T00:00:00Z",
  "dateModified": "2022-03-08T00:00:00Z",
  
  "author": {
    "@type": "Person",
    "name": "Dr. Dominic Royé"
  },
  
  "publisher": {
    "@type": "Organization",
    "name": "University of Santiago de Compostela",
    "logo": {
      "@type": "ImageObject",
      "url": "https://dominicroye.github.io/media/logo_hu6637600e1c36fe7812a10a6623aaebda_116520_192x192_fit_lanczos_3.png"
    }
  },
  "description": "La información espacio-temporal es clave en muchas disciplinas, especialmente en la climatología o la meteorología, y ello hace necesario disponer de un formato que permita una estructura multidimensional. Además es importante que ese formato tenga un alto grado de compatibilidad de intercambio y pueda almacenar un elevado número de datos."
}
</script>

  

  

  

  





  <title>Uso de datos multidimensionales espaciales | Dr. Dominic Royé</title>
</head>


<body id="top" data-spy="scroll" data-offset="70" data-target="#TableOfContents" class="page-wrapper   " data-wc-page-id="892a033a948b7d367c08bce310fb11c2" >

  
  
  
  
  
  
  
  
  
  <script src="/js/wowchemy-init.min.2da3b1fa37e894630bf6de39b1b694b3.js"></script>

  




  <div class="page-header">
    







 



  


<header class="header--fixed">
  <nav class="navbar navbar-expand-lg navbar-light compensate-for-scrollbar" id="navbar-main">
    <div class="container-xl">

      
      <div class="d-none d-lg-inline-flex">
        <a class="navbar-brand" href="/es/"><img src="/media/logo_hu6637600e1c36fe7812a10a6623aaebda_116520_0x70_resize_lanczos_3.png" alt="Dr. Dominic Royé"
            
            >
             <div style = "padding-top:0.5em;">Dr. Dominic Royé</div></a>
      </div>
      

      
      <button type="button" class="navbar-toggler" data-toggle="collapse"
              data-target="#navbar-content" aria-controls="navbar-content" aria-expanded="false" aria-label="Barra de navegación">
      <span><i class="fas fa-bars"></i></span>
      </button>
      

      
      <div class="navbar-brand-mobile-wrapper d-inline-flex d-lg-none">
        <a class="navbar-brand" href="/es/"><img src="/media/logo_hu6637600e1c36fe7812a10a6623aaebda_116520_0x70_resize_lanczos_3.png" alt="Dr. Dominic Royé"
          
          ></a>
      </div>
      

      
      
      <div class="navbar-collapse main-menu-item collapse justify-content-end" id="navbar-content">

        
        <ul class="navbar-nav d-md-inline-flex">
          

          

          
          
          

          

          
          
          
          

          
            
            
          

          <li class="nav-item">
            <a class="nav-link " href="/es/#"><span>inicio</span></a>
          </li>

          
          

          

          
          
          
            
          

          

          
          
          
          

          
            
              
              
            
            
              
              
              
                
              
              
            
          

          <li class="nav-item">
            <a class="nav-link " href="/es/#posts"><span>blog</span></a>
          </li>

          
          

          

          
          
          
            
          

          

          
          
          
          

          
            
              
              
            
            
              
              
              
                
              
              
            
          

          <li class="nav-item">
            <a class="nav-link " href="/es/#featured"><span>publicaciones</span></a>
          </li>

          
          

          

          
          
          
            
          

          

          
          
          
          

          
            
              
              
            
            
              
              
              
                
              
              
            
          

          <li class="nav-item">
            <a class="nav-link " href="/es/#projects"><span>gráficos</span></a>
          </li>

          
          

          

          
          
          
            
          

          

          
          
          
          

          
            
              
              
            
            
              
              
              
                
              
              
            
          

          <li class="nav-item">
            <a class="nav-link " href="/es/#about"><span>mí</span></a>
          </li>

          
          

        

          
        </ul>
      </div>

      <ul class="nav-icons navbar-nav flex-row ml-auto d-flex pl-md-2">

        
        
          
            
            <li class="nav-item d-none d-lg-inline-flex">
              <a class="nav-link" href="https://twitter.com/dr_xeo" data-toggle="tooltip" data-placement="bottom" title="Sígueme en Twitter" target="_blank" rel="noopener" aria-label="Sígueme en Twitter">
                <i class="fab fa-twitter" aria-hidden="true"></i>
              </a>
            </li>
          
        

        
        

        
        

        
        

      </ul>

    </div>
  </nav>
</header>


  </div>

  <div class="page-body">
    <article class="article">

  




















  
  
    
  


<div class="article-container pt-3">
  <h1>Uso de datos multidimensionales espaciales</h1>

  

  


<div class="article-metadata">

  
  

  
  <span class="article-date">
    
    
      
    
    2022-03-08
  </span>
  

  

  
  <span class="middot-divider"></span>
  <span class="article-reading-time">
    13 min de lectura
  </span>
  

  
  
  
  
  
  

  
  
  <span class="middot-divider"></span>
  <span class="article-categories">
    <i class="fas fa-folder mr-1"></i><a href="/es/category/sig/">sig</a>, <a href="/es/category/r/">R</a>, <a href="/es/category/ravanzado/">R:avanzado</a>, <a href="/es/category/visualizacion/">visualización</a></span>
  

</div>

  





</div>


<div class="article-header article-container featured-image-wrapper mt-4 mb-4" style="max-width: 720px; max-height: 754px;">
  <div style="position: relative">
    <img src="/es/2022/uso-de-datos-multidimensionales-espaciales/featured_hu8b1e472f4da09e8aea47a308f0e9d86f_1183712_720x0_resize_lanczos_3.png" width="720" height="754" alt="" class="featured-image">
    
  </div>
</div>



  <div class="article-container">

    <div class="article-style">
      
<script src="https://dominicroye.github.io/es/2022/uso-de-datos-multidimensionales-espaciales/index.es_files/header-attrs/header-attrs.js"></script>


<div id="consideraciones-iniciales" class="section level1">
<h1>Consideraciones iniciales</h1>
<p>La información espacio-temporal es clave en muchas disciplinas, especialmente en la climatología o la meteorología, y ello hace necesario disponer de un formato que permita una estructura multidimensional. Además es importante que ese formato tenga un alto grado de compatibilidad de intercambio y pueda almacenar un elevado número de datos. Estas características llevaron al desarrollo del estándar abierto netCDF (NetworkCommon Data Form). El formato netCDF es un estándar abierto de intercambio de datos científicos multidimensionales que se utiliza con datos de observaciones o modelos, principalmente en disciplinas como la climatología, la meteorología y la oceanografía. La convención netCDF es gestionada por Unidata (unidata.ucar.edu/software/netcdf). Se trata de un formato espacio-temporal con una cuadrícula regular o irregular. La estructura multidimensional en forma de matriz (array) permite usar no sólo datos espacio-temporales, sino también multivariables. Las características generales del netCDF se refieren al uso de un sistema de coordenadas n-dimensional, de múltiples variables y de una rejilla regular o irregular. Además se incluyen metadatos que describen los contenidos. La extensión del formato netCDF es “nc”.</p>
<p><img src="3d_ncdf.es.png" /></p>
<p>Recientemente hice uso de datos de sequía de España en formato netCDF con una resolución de 1 km para representar el estado de sequía de cada año desde 1960 (<a href="https://monitordesequia.csic.es/historico/" class="uri">https://monitordesequia.csic.es/historico/</a>). El índice SPEI (Standardized Precipitation-Evapotranspiration Index) es ampliamente usado para describir la situación de sequía con referencia a diferentes intervalos temporales (3, 6, 12 meses etc).</p>
<p>{{&lt; tweet 1490260694851362821 &gt;}}</p>
<p>He sido preguntado en varias ocaciones sobre el manejo del formato netCDF, por esta razón, en este post hacemos uso de un subconjunto, el año 2017 del SPEI 12 meses, de estos mismos datos.</p>
</div>
<div id="paquetes" class="section level1">
<h1>Paquetes</h1>
<p>El manejo de datos en formato netCDF es posible a través de varios paquetes de forma directa o indirecta. Destaca el paquete <code>{ncdf4}</code> específicamente diseñado, del que hacen uso también otros paquetes aunque no lo veamos. El manejo con <code>{ncdf4}</code> es algo complejo, particularmente por la necesidad de gestionar la memoria RAM cuando tratamos grandes conjuntos de datos o también por la forma de manejar la clase <em>array</em>. Otro paquete muy potente es <code>{terra}</code>, que conocemos cuando trabajamos con datos raster y permite usar sus funciones también para el manejo del formato netCDF.</p>
<table>
<colgroup>
<col width="10%" />
<col width="89%" />
</colgroup>
<thead>
<tr class="header">
<th align="left">Paquete</th>
<th align="left">Descripción</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">tidyverse</td>
<td align="left">Conjunto de paquetes (visualización y manipulación de datos): ggplot2, dplyr, purrr,etc.</td>
</tr>
<tr class="even">
<td align="left">sf</td>
<td align="left">Simple Feature: importar, exportar y manipular datos vectoriales</td>
</tr>
<tr class="odd">
<td align="left">lubridate</td>
<td align="left">Fácil manipulación de fechas y tiempos</td>
</tr>
<tr class="even">
<td align="left">terra</td>
<td align="left">Importar, exportar y manipular raster (paquete sucesor de raster)</td>
</tr>
<tr class="odd">
<td align="left">mapSpain</td>
<td align="left">Límites administrativos de España</td>
</tr>
</tbody>
</table>
<pre class="r"><code># instalamos los paquetes si hace falta

if(!require(&quot;tidyverse&quot;)) install.packages(&quot;tidyverse&quot;)
if(!require(&quot;sf&quot;)) install.packages(&quot;sf&quot;)
if(!require(&quot;lubridate&quot;)) install.packages(&quot;lubridate&quot;)
if(!require(&quot;terra&quot;)) install.packages(&quot;terra&quot;)
if(!require(&quot;mapSpain&quot;)) install.packages(&quot;mapSpain&quot;)

# paquetes
library(tidyverse)
library(sf)
library(terra)
library(lubridate)
library(mapSpain)</code></pre>
<p>Para aquellos con menos experiencia con <code>tidyverse</code>, recomiendo una breve introducción en este blog <a href="https://dominicroye.github.io/es/2020/una-muy-breve-introducci%C3%B3n-a-tidyverse/">post</a>.</p>
</div>
<div id="datos" class="section level1">
<h1>Datos</h1>
<p>Primero descargamos los datos <a href="https://www.dropbox.com/s/ioo2ky7wb3zxkdx/spei12_2017.nc?dl=0">aquí</a>. Importamos los datos del índice SPEI-12 del año 2017 usando la función <code>rast()</code>. En realidad en este paso sólo hemos creado una referencia al archivo sin importar todos los datos a la memoria. Vemos en los metadatos el número de capas (<em>layers</em>) disponibles. El índice SPEI-12 está calculado semanalmente con 4 semanas por mes. Si nos fijamos en los metadatos, falta la definicón del sistema de coordenadas, por ello la definimos asignando el código EPSG:25830 (ETRS89/UTM 30N).</p>
<pre class="r"><code># importamos
spei &lt;- rast(&quot;spei12_2017.nc&quot;)
# metadatos
spei</code></pre>
<pre><code>## class       : SpatRaster 
## dimensions  : 834, 1115, 48  (nrow, ncol, nlyr)
## resolution  : 1100, 1100  (x, y)
## extent      : -80950, 1145550, 3979450, 4896850  (xmin, xmax, ymin, ymax)
## coord. ref. :  
## source      : spei12_2017.nc 
## names       : spei1~017_1, spei1~017_2, spei1~017_3, spei1~017_4, spei1~017_5, spei1~017_6, ... 
## time        : 2017-01-01 to 2017-12-23</code></pre>
<pre class="r"><code># definimos el sistema de coordenadas
crs(spei) &lt;- &quot;EPSG:25830&quot;

# mapeamos las primeras semanas
plot(spei)</code></pre>
<p><img src="https://dominicroye.github.io/es/2022/uso-de-datos-multidimensionales-espaciales/index.es_files/figure-html/unnamed-chunk-3-1.png" width="672" /></p>
</div>
<div id="extraer-metadatos" class="section level1">
<h1>Extraer metadatos</h1>
<p>Existen diferentes funciones para acceder a metadatos como las fechas, los nombres de las capas o de las variables. Recordemos que los archivos netCDF también pueden contener varias variables.</p>
<pre class="r"><code># fechas
t &lt;- time(spei)
head(t)</code></pre>
<pre><code>## [1] &quot;2017-01-01 UTC&quot; &quot;2017-01-09 UTC&quot; &quot;2017-01-16 UTC&quot; &quot;2017-01-23 UTC&quot;
## [5] &quot;2017-02-01 UTC&quot; &quot;2017-02-09 UTC&quot;</code></pre>
<pre class="r"><code># nombres de capas
names(spei) %&gt;% head()</code></pre>
<pre><code>## [1] &quot;spei12_2017_1&quot; &quot;spei12_2017_2&quot; &quot;spei12_2017_3&quot; &quot;spei12_2017_4&quot;
## [5] &quot;spei12_2017_5&quot; &quot;spei12_2017_6&quot;</code></pre>
<pre class="r"><code># nombres de variables
varnames(spei)</code></pre>
<pre><code>## [1] &quot;spei12_2017&quot;</code></pre>
</div>
<div id="extracción-de-series-temporales" class="section level1">
<h1>Extracción de series temporales</h1>
<p>Una posibiliad que permiten los datos netCDF es la extracción de series temporales, bien a partir de puntos o áreas. Creamos la series temporales del SPEI-12 para la ciudad de Zaragoza y el promedio de toda la comunidad autónoma de Aragón.</p>
<pre class="r"><code># coordenadas de Zaragoza
zar &lt;- st_point(c(-0.883333, 41.65)) %&gt;% 
          st_sfc(crs = 4326) %&gt;% 
           st_as_sf() %&gt;% 
            st_transform(25830)</code></pre>
<p>El paquete <code>{terra}</code> sólo acepta su propia clase vectorial <em>SpatVector</em>, por eso es necesario convertir el punto de clase <em>sf</em> con la función <code>vect()</code>. Para extraer la serie temporal empleamos la función <code>extract()</code>. Los datos extraídos los encontramos en forma de una tabla, cada fila es un elemento de los datos vectoriales y cada columna una capa. En nuestro caso sólo es una fila correspondiente a la ciudad de Zaragoza.</p>
<p><div class="alert alert-note">
  <div>
    Algunas funciones pueden tener conflictos con nombres de otros paquetes, para evitarlo podemos escribir el nombre del paquete delante de la función que queremos usar, separados por el símbolo de dos puntos escrito dos veces (<code>package_name::function_name</code>).
  </div>
</div>
</p>
<pre class="r"><code># extraer la serie temporal
spei_zar &lt;- terra::extract(spei, vect(zar))

# dimensiones
dim(spei_zar)</code></pre>
<pre><code>## [1]  1 49</code></pre>
<pre class="r"><code># creamos un data.frame
spei_zar &lt;- tibble(date = t, zar = unlist(spei_zar)[-1])
head(spei_zar)</code></pre>
<pre><code>## # A tibble: 6 x 2
##   date                  zar
##   &lt;dttm&gt;              &lt;dbl&gt;
## 1 2017-01-01 00:00:00 0.280
## 2 2017-01-09 00:00:00 0.25 
## 3 2017-01-16 00:00:00 0.220
## 4 2017-01-23 00:00:00 0.210
## 5 2017-02-01 00:00:00 0.350
## 6 2017-02-09 00:00:00 0.220</code></pre>
<p>El promedio de la comunidad autónoma de Aragón lo obtenemos usando la geometría de polígono e indicando el tipo de función con la que queremos resumir el área. La función <code>esp_get_ccaa()</code> del paquete <code>mapSpain()</code> es muy útil a la hora de importar límites administrativos españoles de diferentes niveles. En la extracción es importante que pasemos el argumento <code>na.rm = TRUE</code> de la función <code>mean()</code> para excluir píxeles sin valor.</p>
<pre class="r"><code># límites de Aragón
aragon &lt;- esp_get_ccaa(&quot;Aragón&quot;) %&gt;% 
            st_transform(25830)

# extraemos los valores medios del SPEI-12
spei_arag &lt;- terra::extract(spei, vect(aragon), fun = &quot;mean&quot;, na.rm = TRUE)

# añadimos los nuevos valores a nuestro data.frame
spei_zar &lt;- mutate(spei_zar, arag = unlist(spei_arag)[-1])</code></pre>
<p>En el seguiente paso transformamos la tabla al formato largo con <code>pivot_longer()</code>, fusionando el valor del índice SPEI de Zaragoza y Aragón. Además añadiremos una columna con la interpretación del índice y cambiaremos las etiquetas.</p>
<pre class="r"><code>spei_zar &lt;-  pivot_longer(spei_zar, 2:3, names_to = &quot;reg&quot;, values_to = &quot;spei&quot;) %&gt;%
             mutate(sign = case_when(spei &lt; -0.5 ~ &quot;sequía&quot;, 
                                    spei &gt; 0.5 ~ &quot;húmedo&quot;,
                                    TRUE ~ &quot;normal&quot;),
                    date = as_date(date),
                    reg = factor(reg, c(&quot;zar&quot;, &quot;arag&quot;), c(&quot;Zaragoza&quot;, &quot;Aragón&quot;)))</code></pre>
<p>Ahora falta por construir el gráfico en el que comparamos el SPEI-12 de Zaragoza con el promedio de Aragón. La función <code>geom_rect()</code> nos ayuda a dibujar diferentes rectángulos de fondo para marcar la sequía, episodio normal o húmedo.</p>
<pre class="r"><code># gráfico de serie temporal
ggplot(spei_zar) +
      geom_rect(aes(xmin = min(date), xmax = max(date), 
                    ymin = -0.5, ymax = 0.5), 
                fill = &quot;#41ab5d&quot;) +
      geom_rect(aes(xmin = min(date), xmax = max(date), 
                    ymin = -1, ymax = -0.5), 
                fill = &quot;#ffffcc&quot;) +
      geom_rect(aes(xmin = min(date), xmax = max(date), 
                    ymin = -1.5, ymax = -1), 
                fill = &quot;#F3641D&quot;) +
      geom_hline(yintercept = 0, size = 1, colour = &quot;white&quot;) +
      geom_line(aes(date, spei, linetype = reg), size = 1, alpha = .7) +
  scale_x_date(date_breaks = &quot;month&quot;, date_labels = &quot;%b&quot;) +
  labs(linetype = &quot;&quot;, y = &quot;SPEI-12&quot;, x = &quot;&quot;) +
  coord_cartesian(expand = FALSE) +
  theme_minimal() +
  theme(legend.position = c(.25, .9),
        panel.grid.minor = element_blank(),
        panel.ontop = TRUE)</code></pre>
<p><img src="https://dominicroye.github.io/es/2022/uso-de-datos-multidimensionales-espaciales/index.es_files/figure-html/unnamed-chunk-9-1.png" width="672" /></p>
</div>
<div id="mapa-de-sequía" class="section level1">
<h1>Mapa de sequía</h1>
<div id="españa" class="section level2">
<h2>España</h2>
<p>Con el objetivo de crear un mapa de la severidad de sequía en 2017, primero debemos hacer algunas modificaciones. Con la función <code>subset()</code> obtenemos una capa o varias como subconjunto, aquí seleccionamos la última para poder ver el estado de sequía de todo el año.</p>
<p>En el siguiente paso reemplazamos todos los valores mayores de -0,5 con <code>NA</code>. Se considera sequía cuando el índice SPEI está debajo de -0,5 y, en cambio, si está encima de 0,5 hablaríamos de un período húmedo.</p>
<p>La clase del raster no es directamente compatible con <code>ggplot</code>, por eso, lo convertimos en una tabla xyz con longitud, latitud y la variable. Cuando hacemos la misma conversión de varias capas cada columna representaría una capa. Finalmente renombramos nuestra columna del índice y añadimos una nueva columna con distintos grados de severidad de sequía.</p>
<pre class="r"><code># extraemos capa(s) con su índice 
spei_anual &lt;- subset(spei, 48) 

# sustituimos valores de no-sequía con NA
spei_anual[spei_anual &gt; -0.5] &lt;- NA

# convertimos nuestro raster en una tabla de xyz
spei_df &lt;- as.data.frame(spei_anual, xy = TRUE)
head(spei_df)</code></pre>
<pre><code>##            x       y spei12_2017_48
## 38096 123100 4858900          -1.48
## 39195 105500 4857800          -1.59
## 39197 107700 4857800          -1.40
## 39211 123100 4857800          -1.47
## 39212 124200 4857800          -1.50
## 40310 105500 4856700          -1.63</code></pre>
<pre class="r"><code># cambiamos el nombre de la variable
names(spei_df)[3] &lt;- &quot;spei&quot;

# categorizamos el índice y fijamos el orden del factor
spei_df &lt;- mutate(spei_df, spei_cat = case_when(spei &gt; -0.9 ~ &quot;leve&quot;,
                                                spei &gt; -1.5 &amp; spei &lt; -0.9 ~ &quot;moderada&quot;,
                                                spei &gt; -2 &amp; spei &lt;= -1.5 ~ &quot;severa&quot;,
                                                TRUE ~ &quot;extrema&quot;) %&gt;% 
                                      fct_relevel(c(&quot;leve&quot;, &quot;moderada&quot;, &quot;severa&quot;, &quot;extrema&quot;)))</code></pre>
<p>Un mapa de raster lo creamos con la geometría <code>geom_tile()</code> indicando longitud, latitud y el color de los píxeles con nuestra variable categorizada.</p>
<pre class="r"><code>ccaa &lt;- esp_get_ccaa() %&gt;% 
            filter(!ine.ccaa.name %in% c(&quot;Canarias&quot;, &quot;Ceuta&quot;, &quot;Melilla&quot;)) %&gt;% 
              st_transform(25830)

# mapa
ggplot(spei_df) +
   geom_tile(aes(x , y, fill = spei_cat)) +
  geom_sf(data = ccaa, fill = NA, size = .1, colour = &quot;white&quot;, alpha = .4) +
  scale_fill_manual(values = c(&quot;#ffffcc&quot;, &quot;#F3641D&quot;, &quot;#DE2929&quot;, &quot;#8B1A1A&quot;),
                    na.value = NA) +
  guides(fill = guide_legend(keywidth = 2, keyheight = .3, label.position = &quot;bottom&quot;,
                             title.position = &quot;top&quot;)) +
  coord_sf() +
  labs(fill = &quot;SEQUIA&quot;) +
  theme_void() +
  theme(legend.position = &quot;top&quot;,
        legend.justification = 0.2,
        plot.background = element_rect(fill = &quot;black&quot;, colour = NA),
        legend.title = element_text(colour = &quot;white&quot;, size = 20, hjust = .5),
        legend.text = element_text(colour = &quot;white&quot;),
        plot.margin = margin(t = 10))</code></pre>
<p><img src="https://dominicroye.github.io/es/2022/uso-de-datos-multidimensionales-espaciales/index.es_files/figure-html/unnamed-chunk-11-1.png" width="758.4" /></p>
</div>
<div id="aragón" class="section level2">
<h2>Aragón</h2>
<p>En este último ejemplo, seleccionamos la situación de sequía a 12 meses vista, a principios y final de año. La función principal es <code>crop()</code> que recorta a la extensión de un objeto espacial, en nuestro caso es Aragón, después aplicamos la función <code>mask()</code> que enmascara todos aquellos píxeles dentro de los límites dejando en <code>NA</code> los demás.</p>
<pre class="r"><code># subconjunto primera y ultima semana 2017
spei_sub &lt;- subset(spei, c(1, 48)) 

# recortamos y enmascaramos Aragón
spei_arag &lt;- crop(spei_sub, aragon) %&gt;% 
                    mask(vect(aragon)) 

# convertimos los datos a xyz
spei_df_arag &lt;- as.data.frame(spei_arag, xy = TRUE)

# renombramos las dos capas
names(spei_df_arag)[3:4] &lt;- c(&quot;Enero&quot;, &quot;Diciembre&quot;)

# pasamos al formato de tabla larga fusionando ambos meses
spei_df_arag &lt;- pivot_longer(spei_df_arag, 3:4, 
                             names_to = &quot;mes&quot;, 
                             values_to = &quot;spei&quot;) %&gt;% 
                mutate(mes = fct_relevel(mes, c(&quot;Enero&quot;, &quot;Diciembre&quot;)))</code></pre>
<p>Los dos mapas los hacemos de la misma forma como el de España. La diferencia principal es que usamos el índice SPEI directamente como variable continua. Además, para crear dos mapas con una fila añadimos la función <code>facet_grid()</code>. Por último, el índice muestra valores negativos y positivos, por tanto, es necesario una gama divergente de colores. Con el objetivo de centrar el punto medio en 0 debemos reescalar con ayuda de la función <code>rescale()</code> del paquete <code>scales</code>.</p>
<pre class="r"><code># mapa de Aragón
ggplot(spei_df_arag) +
   geom_tile(aes(x , y, fill = spei)) +
  geom_sf(data = aragon, fill = NA, size = .1, colour = &quot;white&quot;, alpha = .4) +
  scale_fill_distiller(palette = &quot;RdYlGn&quot;, direction = 1, 
                       values = scales::rescale(c(-2.1, 0, 0.9)),
                       breaks = seq(-2, 1, .5)) +
  guides(fill = guide_colorbar(barwidth = 8, barheight = .3, label.position = &quot;bottom&quot;)) +
  facet_grid(. ~ mes) +
  coord_sf() +
  labs(fill = &quot;SPEI-12&quot;, title = &quot;Aragón&quot;) +
  theme_void() +
  theme(legend.position = &quot;top&quot;,
        legend.justification = 0.5,
        legend.title = element_text(colour = &quot;white&quot;, vjust = 1.1),
        strip.text = element_text(colour = &quot;white&quot;),
        plot.background = element_rect(fill = &quot;black&quot;, colour = NA),
        plot.title = element_text(colour = &quot;white&quot;, size = 20, hjust = .5, vjust = 2.5,
                                  margin = margin(b = 10, t = 10)),
        legend.text = element_text(colour = &quot;white&quot;),
        plot.margin = margin(10, 10, 10, 10))</code></pre>
<p><img src="https://dominicroye.github.io/es/2022/uso-de-datos-multidimensionales-espaciales/index.es_files/figure-html/unnamed-chunk-13-1.png" width="768" /></p>
</div>
</div>
<div id="más-posibilidades" class="section level1">
<h1>Más posibilidades</h1>
<p>Es posible agrupar las diferentes capas aplicando una función. Usando los meses de cada semana del SPEI-12 podemos calcular el promedio mensual en 2017. Para ello hacemos uso de la función <code>tapp()</code> que a su vez aplica sobre índices otra función. Es imporante que el grupo o bien sea un factor o el índice de cada capa. Las funciónes <code>tapp()</code> y <code>app()</code> tienen un argumento para procesar en paralelo usando más de un núcleo.</p>
<pre class="r"><code># meses como factor
mo &lt;- month(t, label = TRUE)
mo</code></pre>
<pre><code>##  [1] ene ene ene ene feb feb feb feb mar mar mar mar abr abr abr abr may may may
## [20] may jun jun jun jun jul jul jul jul ago ago ago ago sep sep sep sep oct oct
## [39] oct oct nov nov nov nov dic dic dic dic
## 12 Levels: ene &lt; feb &lt; mar &lt; abr &lt; may &lt; jun &lt; jul &lt; ago &lt; sep &lt; ... &lt; dic</code></pre>
<pre class="r"><code># promedio por mes
spei_mo &lt;- tapp(spei, mo, mean)
spei_mo</code></pre>
<pre><code>## class       : SpatRaster 
## dimensions  : 834, 1115, 12  (nrow, ncol, nlyr)
## resolution  : 1100, 1100  (x, y)
## extent      : -80950, 1145550, 3979450, 4896850  (xmin, xmax, ymin, ymax)
## coord. ref. : ETRS89 / UTM zone 30N (EPSG:25830) 
## source      : memory 
## names       :     ene,     feb,     mar,     abr,     may,     jun, ... 
## min values  : -1.2800, -1.4675, -2.2400, -2.6500, -2.5775, -2.4675, ... 
## max values  :  1.3875,  1.9175,  1.7475,  1.8375,  1.7500,  1.7000, ...</code></pre>
<pre class="r"><code># mapas
plot(spei_mo)</code></pre>
<p><img src="https://dominicroye.github.io/es/2022/uso-de-datos-multidimensionales-espaciales/index.es_files/figure-html/unnamed-chunk-14-1.png" width="672" /></p>
<p>La función <code>mean()</code> directamente usado sobre un objeto de clase <code>SpatRaster</code> multidimensional devuelve el promedio por celda. El mismo resultado lo podemos obtener con la función <code>app()</code> que aplica cualquier función. El número de capas resultante depende de la función, por ejemplo, al aplicar <code>range()</code> el resultado son dos capas, una del valor mínimo y otra del máximo. Por último, la función <code>global()</code> resume con la función indicada cada capa en forma de una tabla.</p>
<pre class="r"><code># promedio sobre capas
spei_mean &lt;- mean(spei)
spei_mean</code></pre>
<pre><code>## class       : SpatRaster 
## dimensions  : 834, 1115, 1  (nrow, ncol, nlyr)
## resolution  : 1100, 1100  (x, y)
## extent      : -80950, 1145550, 3979450, 4896850  (xmin, xmax, ymin, ymax)
## coord. ref. : ETRS89 / UTM zone 30N (EPSG:25830) 
## source      : memory 
## name        :      mean 
## min value   : -2.127083 
## max value   :  1.568542</code></pre>
<pre class="r"><code># mapa
plot(spei_mean)</code></pre>
<p><img src="https://dominicroye.github.io/es/2022/uso-de-datos-multidimensionales-espaciales/index.es_files/figure-html/unnamed-chunk-15-1.png" width="672" /></p>
<pre class="r"><code># alternativa
spei_min &lt;- app(spei, min)
spei_min</code></pre>
<pre><code>## class       : SpatRaster 
## dimensions  : 834, 1115, 1  (nrow, ncol, nlyr)
## resolution  : 1100, 1100  (x, y)
## extent      : -80950, 1145550, 3979450, 4896850  (xmin, xmax, ymin, ymax)
## coord. ref. : ETRS89 / UTM zone 30N (EPSG:25830) 
## source      : memory 
## name        :   min 
## min value   : -3.33 
## max value   :  0.29</code></pre>
<pre class="r"><code>spei_range &lt;- app(spei, range)
names(spei_range) &lt;- c(&quot;min&quot;, &quot;max&quot;)
spei_range</code></pre>
<pre><code>## class       : SpatRaster 
## dimensions  : 834, 1115, 2  (nrow, ncol, nlyr)
## resolution  : 1100, 1100  (x, y)
## extent      : -80950, 1145550, 3979450, 4896850  (xmin, xmax, ymin, ymax)
## coord. ref. : ETRS89 / UTM zone 30N (EPSG:25830) 
## source      : memory 
## names       :   min,   max 
## min values  : -3.33, -1.06 
## max values  :  0.29,  2.02</code></pre>
<pre class="r"><code># mapa
plot(spei_range)</code></pre>
<p><img src="https://dominicroye.github.io/es/2022/uso-de-datos-multidimensionales-espaciales/index.es_files/figure-html/unnamed-chunk-15-2.png" width="672" /></p>
<pre class="r"><code># resumen estadístico por capa
global(spei, &quot;mean&quot;, na.rm = TRUE) %&gt;% head()</code></pre>
<pre><code>##                      mean
## spei12_2017_1 -0.03389126
## spei12_2017_2 -0.17395742
## spei12_2017_3 -0.13228593
## spei12_2017_4 -0.07536089
## spei12_2017_5  0.06718260
## spei12_2017_6 -0.03461822</code></pre>
<p><a href="https://www.buymeacoffee.com/drxeo" target="_blank"><img src="https://cdn.buymeacoffee.com/buttons/default-orange.png" alt="Buy Me A Coffee" height="41" width="174"></a></p>
</div>

    </div>

    






<div class="article-tags">
  
  <a class="badge badge-light" href="/es/tag/ncdf/">ncdf</a>
  
  <a class="badge badge-light" href="/es/tag/cubo/">cubo</a>
  
  <a class="badge badge-light" href="/es/tag/sequia/">sequia</a>
  
  <a class="badge badge-light" href="/es/tag/espana/">españa</a>
  
  <a class="badge badge-light" href="/es/tag/raster/">raster</a>
  
</div>



<div class="share-box">
  <ul class="share">
    
      
      
      
        
      
      
      
      <li>
        <a href="https://twitter.com/intent/tweet?url=https://dominicroye.github.io/es/2022/uso-de-datos-multidimensionales-espaciales/&amp;text=Uso%20de%20datos%20multidimensionales%20espaciales" target="_blank" rel="noopener" class="share-btn-twitter" aria-label="twitter">
          <i class="fab fa-twitter"></i>
        </a>
      </li>
    
      
      
      
        
      
      
      
      <li>
        <a href="https://www.facebook.com/sharer.php?u=https://dominicroye.github.io/es/2022/uso-de-datos-multidimensionales-espaciales/&amp;t=Uso%20de%20datos%20multidimensionales%20espaciales" target="_blank" rel="noopener" class="share-btn-facebook" aria-label="facebook">
          <i class="fab fa-facebook"></i>
        </a>
      </li>
    
      
      
      
        
      
      
      
      <li>
        <a href="mailto:?subject=Uso%20de%20datos%20multidimensionales%20espaciales&amp;body=https://dominicroye.github.io/es/2022/uso-de-datos-multidimensionales-espaciales/" target="_blank" rel="noopener" class="share-btn-email" aria-label="envelope">
          <i class="fas fa-envelope"></i>
        </a>
      </li>
    
      
      
      
        
      
      
      
      <li>
        <a href="https://www.linkedin.com/shareArticle?url=https://dominicroye.github.io/es/2022/uso-de-datos-multidimensionales-espaciales/&amp;title=Uso%20de%20datos%20multidimensionales%20espaciales" target="_blank" rel="noopener" class="share-btn-linkedin" aria-label="linkedin-in">
          <i class="fab fa-linkedin-in"></i>
        </a>
      </li>
    
      
      
      
        
      
      
      
      <li>
        <a href="whatsapp://send?text=Uso%20de%20datos%20multidimensionales%20espaciales%20https://dominicroye.github.io/es/2022/uso-de-datos-multidimensionales-espaciales/" target="_blank" rel="noopener" class="share-btn-whatsapp" aria-label="whatsapp">
          <i class="fab fa-whatsapp"></i>
        </a>
      </li>
    
      
      
      
        
      
      
      
      <li>
        <a href="https://service.weibo.com/share/share.php?url=https://dominicroye.github.io/es/2022/uso-de-datos-multidimensionales-espaciales/&amp;title=Uso%20de%20datos%20multidimensionales%20espaciales" target="_blank" rel="noopener" class="share-btn-weibo" aria-label="weibo">
          <i class="fab fa-weibo"></i>
        </a>
      </li>
    
  </ul>
</div>











  
  



  
  
  
    
  
  
  
  <div class="media author-card content-widget-hr">
    
      
      <a href="https://dominicroye.github.io/"><img class="avatar mr-3 avatar-circle" src="/es/author/dr.-dominic-roye/avatar_hu930bec32484cd86675af8880de95caa2_508993_270x270_fill_q75_lanczos_center.jpg" alt="Dr. Dominic Royé"></a>
    

    <div class="media-body">
      <h5 class="card-title"><a href="https://dominicroye.github.io/">Dr. Dominic Royé</a></h5>
      <h6 class="card-subtitle">Investigador postdoctoral senior</h6>
      
      <ul class="network-icon" aria-hidden="true">
  
    
    
    
      
    
    
    
    
    
      
    
    <li>
      <a href="https://twitter.com/dr_xeo" target="_blank" rel="noopener">
        <i class="fab fa-twitter"></i>
      </a>
    </li>
  
    
    
    
      
    
    
    
    
    
      
    
    <li>
      <a href="/es/#contact" >
        <i class="fas fa-envelope"></i>
      </a>
    </li>
  
    
    
    
    
    
    
    
      
    
    <li>
      <a href="https://scholar.google.es/citations?user=EoYa8jUAAAAJ&amp;hl=es" target="_blank" rel="noopener">
        <i class="ai ai-google-scholar"></i>
      </a>
    </li>
  
    
    
    
      
    
    
    
    
    
      
    
    <li>
      <a href="https://github.com/dominicroye" target="_blank" rel="noopener">
        <i class="fab fa-github"></i>
      </a>
    </li>
  
    
    
    
      
    
    
    
    
    
      
    
    <li>
      <a href="https://www.linkedin.com/in/dominicroye/" target="_blank" rel="noopener">
        <i class="fab fa-linkedin"></i>
      </a>
    </li>
  
    
    
    
    
    
    
    
      
    
    <li>
      <a href="https://www.researchgate.net/profile/Dominic_Roye" target="_blank" rel="noopener">
        <i class="ai ai-researchgate"></i>
      </a>
    </li>
  
</ul>

    </div>
  </div>
















  
  
  <div class="article-widget content-widget-hr">
    <h3>Relacionado</h3>
    <ul>
      
      <li><a href="/es/2021/mapa-dasimetrico-bivariante/">Mapa dasimétrico bivariante</a></li>
      
      <li><a href="/es/2019/calcular-la-distancia-al-mar-en-r/">Calcular la distancia al mar en R</a></li>
      
      <li><a href="/es/2021/visualizar-el-ciclo-de-dia-noche-en-un-mapamundi/">Visualizar el ciclo de día-noche en un mapamundi</a></li>
      
      <li><a href="/es/2021/cartografia-firefly/">Cartografía firefly</a></li>
      
      <li><a href="/es/2020/animacion-climatica-de-la-temperatura-maxima/">Animación climática de la temperatura máxima</a></li>
      
    </ul>
  </div>
  





  </div>
</article>
  </div>

  <div class="page-footer">
    
    
    <div class="container">
      <footer class="site-footer">

  



  

  

  
  <p class="powered-by">
    © 2018-2022 Dominic Royé. All rights reserved
  </p>
  

  
  






  <p class="powered-by">
    
    
    
      
      
      
      
      
      
      Published with <a href="https://wowchemy.com/?utm_campaign=poweredby" target="_blank" rel="noopener">Wowchemy</a> — the free, <a href="https://github.com/wowchemy/wowchemy-hugo-themes" target="_blank" rel="noopener">open source</a> website builder that empowers creators.
    
  </p>
</footer>

    </div>
    
  </div>

  
<div id="modal" class="modal fade" role="dialog">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Citar</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <pre><code class="tex hljs"></code></pre>
      </div>
      <div class="modal-footer">
        <a class="btn btn-outline-primary my-1 js-copy-cite" href="#" target="_blank">
          <i class="fas fa-copy"></i> Copiar
        </a>
        <a class="btn btn-outline-primary my-1 js-download-cite" href="#" target="_blank">
          <i class="fas fa-download"></i> Descargar
        </a>
        <div id="modal-error"></div>
      </div>
    </div>
  </div>
</div>

      

    
    <script src="/js/vendor-bundle.min.b73dfaac3b6499dc997741748a7c3fe2.js"></script>

    
    
    
      
      
        <script src="https://cdn.jsdelivr.net/gh/desandro/imagesloaded@v4.1.4/imagesloaded.pkgd.min.js" integrity="sha512-S5PZ9GxJZO16tT9r3WJp/Safn31eu8uWrzglMahDT4dsmgqWonRY9grk3j+3tfuPr9WJNsfooOR7Gi7HL5W2jw==" crossorigin="anonymous"></script>
        <script src="https://cdn.jsdelivr.net/gh/metafizzy/isotope@v3.0.6/dist/isotope.pkgd.min.js" integrity="sha512-Zq2BOxyhvnRFXu0+WE6ojpZLOU2jdnqbrM1hmVdGzyeCa1DgM3X5Q4A/Is9xA1IkbUeDd7755dNNI/PzSf2Pew==" crossorigin="anonymous"></script>
      

      
      

      

      
        
        <script src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@10.2.1/build/highlight.min.js" integrity="sha512-Ypjm0o7jOxAd4hpdoppSEN0TQOC19UtPAqD+4s5AlXmUvbmmS/YMxYqAqarQYyxTnB6/rqip9qcxlNB/3U9Wdg==" crossorigin="anonymous"></script>
        
        
        <script src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@10.2.1/build/languages/r.min.js" crossorigin="anonymous"></script>
        
      

    

    
    
    
      <script src="https://cdn.jsdelivr.net/npm/leaflet@1.7.1/dist/leaflet.min.js" integrity="" crossorigin="anonymous"></script>
    

    
    

    
    
    

    
    

    
    
    
    

    
    

    
    
    
    
    
    
    
    
    
    <script src="/es/js/wowchemy.min.50d3bf3df0c53b31631bb48a62b35f92.js"></script>

    
  <script async defer src="https://buttons.github.io/buttons.js"></script>




</body>
</html>
