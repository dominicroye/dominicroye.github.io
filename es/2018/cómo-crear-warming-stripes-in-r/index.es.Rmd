---
categories: ["visualización","R","R:elemental"]
title: Cómo crear 'Warming Stripes' in R
date: '2018-12-05'
slug: como-crear-warming-stripes-en-r
tags: ["ggplot2","warming stripes","calentamiento global"]
header:
  caption: ''
  image: 'tiras_lisboa.png'
lang: es
summary: "Este año se hicieron muy famosos en todo el mundo los llamados warming stripes, las tiras del calentamiento global, que fueron creados por el científico Ed Hawkins de la Universidad de Reading. Estos gráficos representan y comunican el cambio climático de una forma muy ilustrativa y eficaz."
---

Este año se hicieron muy famosos en todo el mundo los llamados *warming stripes*, las tiras del calentamiento global, que fueron creadas por el científico [Ed Hawkins](https://twitter.com/ed_hawkins?lang=es) de la Universidad de Reading. Estos gráficos representan y comunican el cambio climático de una forma muy ilustrativa y eficaz. 

```{r echo=FALSE}
blogdown::shortcode('tweet', '999242147135188993')
```

A partir de su idea, creé tiras para ejemplos de España, como el siguiente de Madrid.

```{r echo=FALSE}
blogdown::shortcode('tweet', '1002954473927561217')
```

En este post voy a enseñar cómo se pueden crear estas tiras en R con el paquete *ggplot2*. Aunque debo decir que existen muchos caminos en R que nos pueden llevar al mismo resultado o a uno similar, incluso dentro de *ggplot2*. 

## Datos

En este caso usaremos las temperaturas anuales de Lisboa del 
[GISS Surface Temperature Analysis](https://data.giss.nasa.gov/gistemp/stdata/) que comprenden el periodo 1880-2018. Se trata de series temporales homogeneizadas. También se podrían usar temperaturas mensuales u otras series temporales. El archivo se puede descargar [aquí](/files/temp_lisboa.csv). Lo primero que debemos hacer, siempre y cuando no lo hayamos hecho, es instalar la colección de paquetes *tidyverse* que incluyen también *ggplot2*. Además, nos hará falta el paquete *lubridate* para el tratamiento de fechas. Después, importamos los datos de Lisboa que están en formato csv.

```{r,message=FALSE,error=FALSE,warning=FALSE}
#instalamos los paquetes lubridate y tidyverse
if(!require("lubridate")) install.packages("lubridate")
if(!require("tidyverse")) install.packages("tidyverse")

#paquetes
library(tidyverse)
library(lubridate)
library(RColorBrewer)

#importar las temperaturas anuales
temp_lisboa <- read_csv("temp_lisboa.csv")

str(temp_lisboa)

```

Vemos en las columnas que tenemos valores mensuales y estacionales, y el valor anual. Pero antes de proceder a visualizar la temperatura anual, debemos sustituir los valores ausentes *999.9* por ``NA``, usando la función ``ifelse( )`` que lleva una condición y los argumentos correspondientes a verdadero y falso de la condición dada.

```{r,message=FALSE,error=FALSE,warning=FALSE}
#selecionamos la columna del año y la temperatura anual
temp_lisboa_yr <- select(temp_lisboa, YEAR, metANN)

#cambiamos el nombre de la columna 
temp_lisboa_yr <- rename(temp_lisboa_yr, ta = metANN)

#valores ausentes 999.9
summary(temp_lisboa_yr) 

temp_lisboa_yr <- mutate(temp_lisboa_yr, ta = ifelse(ta == 999.9, NA, ta))

```


Cuando usamos el año como variable, no solemos convertirlo en un objeto de fecha, no obstante es aconsejable. De este modo nos permite usar las funciones de fechas del paquete *lubridate* y las funciones de apoyo dentro de *ggplot2*. La función ``str_c( )`` del paquete *stringr*, forma parte de la colección de *tidyverse*, es similar a ``paste( )`` de R Base que nos permite combinar caracteres especificando un separador (sep="-"). La función ``ymd( )`` (year month day) del paquete *lubridate* convierte una fecha en un objeto *Date*. Es posible combinar varias funciones 
haciendo uso del *pipe operator* ``%>%`` que ayuda a encadenar sin asignar el resultado a un nuevo objeto. Su uso es muy extendido especialmente con el paquete *tidyverse*. Si quieres saber más de su uso, [aquí](https://www.datacamp.com/community/tutorials/pipe-r-tutorial) tienes un tutorial.

```{r,message=FALSE,error=FALSE,warning=FALSE}

temp_lisboa_yr <- mutate(temp_lisboa_yr, date = str_c(YEAR, "01-01", sep = "-") %>% ymd())

```

## Creando las tiras

Primero, creamos el estilo del gráfico, especificando todo los argumentos del aspecto que queremos ajustar. Partimos del estilo por defecto de ``theme_minimal( )``. Además, asignamos 
los colores procedientes de *RColorBrewer* a un objeto *col_srip*. Más información sobre los colores usados [aquí](http://colorbrewer2.org). 

```{r,message=FALSE,error=FALSE,warning=FALSE}

theme_strip <- theme_minimal()+
                 theme(axis.text.y = element_blank(),
                       axis.line.y = element_blank(),
                       axis.title = element_blank(),
                       panel.grid.major = element_blank(),
                       legend.title = element_blank(),
                       axis.text.x = element_text(vjust = 3),
                       panel.grid.minor = element_blank(),
                       plot.title = element_text(size = 14, face = "bold")
                       )


col_strip <- brewer.pal(11, "RdBu")

brewer.pal.info

```

Para el gráfico final usamos la geometría ``geom_tile( )``. Como los datos no tienen un valor específico para el eje Y, usamos un valor *dummy*, aquí es 1. Además, ajusto el ancho de la barra de colores en la leyenda. 

```{r,message=FALSE,error=FALSE,warning=FALSE,fig.width=12, fig.height=3}

     ggplot(temp_lisboa_yr,
             aes(x = date, y = 1,fill = ta))+
        geom_tile()+
           scale_x_date(date_breaks = "6 years",
                     date_labels = "%Y",
                     expand = c(0, 0))+
           scale_y_continuous(expand = c(0, 0))+
           scale_fill_gradientn(colors = rev(col_strip))+
           guides(fill = guide_colorbar(barwidth = 1))+
           labs(title = "LISBOA 1880-2018",
                caption = "Datos: GISS Surface Temperature Analysis")+
             theme_strip

```

En el caso de que quisieramos obtener únicamente las tiras, podemos usar ``theme_void( )`` y el argumento *show.legend=FALSE* en ``geom_tile( )`` para eliminar todos los elementos de estilo. También podemos cambiar el color para los valores ``NA``, incluyendo el argumento *na.value="grey70"* en la función ``scale_fill_gradientn( )``.

```{r,message=FALSE,error=FALSE,warning=FALSE,fig.width=12, fig.height=3}

     ggplot(temp_lisboa_yr,
             aes(x = date, y = 1, fill = ta))+
        geom_tile(show.legend = FALSE)+
           scale_x_date(date_breaks = "6 years",
                     date_labels = "%Y",
                     expand = c(0, 0))+
           scale_y_discrete(expand = c(0, 0))+
           scale_fill_gradientn(colors = rev(col_strip))+
             theme_void()

```

