<!DOCTYPE html>
<html lang="en-us">
<head>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="generator" content="Source Themes Academic 3.2.0">
  <meta name="generator" content="Hugo 0.53" />
  <meta name="author" content="Dr. Dominic Royé">

  
  
  
  
    
  
  <meta name="description" content="Recientemente creé una visualización de la distribución de las direcciones del flujo fluvial y  también de las orientaciones costeras. A raíz de su publicación en los RRSS me pidieron que hiciera un post acerca de cómo lo hice. Pues bien, aquí vamos para empezar con un ejemplo de los ríos, la orientación costera es algo más compleja.">

  
  <link rel="alternate" hreflang="en-us" href="/es/2020/direcciones-del-flujo-fluvial/">

  


  

  

  

  

  

  

  
  
  
  <meta name="theme-color" content="#2962ff">
  

  
  
  
  
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha256-eSi1q2PG6J7g7ib17yAaWMcrr5GrtohYChqibrV7PBE=" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/academicons/1.8.6/css/academicons.min.css" integrity="sha256-uFVgMKfistnJAfoCUQigIl+JfUaP47GrRKjf6CTPVmw=" crossorigin="anonymous">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.6.0/css/all.css" integrity="sha384-aOkxzJ5uQz7WBObEZcHvV5JvRW3TUc2rNPA7pe3AwnsUohiw1Vj2Rgx2KSOkF5+h" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.2.5/jquery.fancybox.min.css" integrity="sha256-ygkqlh3CYSUri3LhQxzdcm0n1EQvH2Y+U5S2idbLtxs=" crossorigin="anonymous">

    
    
    
      
    
    
      
      
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/dracula.min.css" crossorigin="anonymous">
      
    

    

    

  

  
  

  <link rel="stylesheet" href="/es/styles.css">
  
  <link rel="stylesheet" href="/css/override.css">
  

  
  
    <script>
      window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
      ga('create', 'UA-27463794-2', 'auto');
      ga('set', 'anonymizeIp', true);
      ga('require', 'eventTracker');
      ga('require', 'outboundLinkTracker');
      ga('require', 'urlChangeTracker');
      ga('send', 'pageview');
    </script>
    <script async src="//www.google-analytics.com/analytics.js"></script>
    
    <script async src="https://cdnjs.cloudflare.com/ajax/libs/autotrack/2.4.1/autotrack.js" integrity="sha512-HUmooslVKj4m6OBu0OgzjXXr+QuFYy/k7eLI5jdeEy/F4RSgMn6XRWRGkFi5IFaFgy7uFTkegp3Z0XnJf3Jq+g==" crossorigin="anonymous"></script>
    
  
  

  
  <link rel="alternate" href="/index.xml" type="application/rss+xml" title="Dominic Royé">
  <link rel="feed" href="/index.xml" type="application/rss+xml" title="Dominic Royé">
  

  <link rel="manifest" href="/site.webmanifest">
  <link rel="icon" type="image/png" href="/img/icon.png">
  <link rel="apple-touch-icon" type="image/png" href="/img/icon-192.png">

  <link rel="canonical" href="/es/2020/direcciones-del-flujo-fluvial/">

  
  
  
  
    
  
  <meta property="twitter:card" content="summary_large_image">
  
  <meta property="og:site_name" content="Dominic Royé">
  <meta property="og:url" content="/es/2020/direcciones-del-flujo-fluvial/">
  <meta property="og:title" content="Direcciones del flujo fluvial | Dominic Royé">
  <meta property="og:description" content="Recientemente creé una visualización de la distribución de las direcciones del flujo fluvial y  también de las orientaciones costeras. A raíz de su publicación en los RRSS me pidieron que hiciera un post acerca de cómo lo hice. Pues bien, aquí vamos para empezar con un ejemplo de los ríos, la orientación costera es algo más compleja."><meta property="og:image" content="/es/2020/direcciones-del-flujo-fluvial/featured.jpg">
  <meta property="og:locale" content="en-us">
  
  <meta property="article:published_time" content="2020-07-24T00:00:00&#43;00:00">
  
  <meta property="article:modified_time" content="2020-07-24T00:00:00&#43;00:00">
  

  

<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.0.3/cookieconsent.min.css">
<script src="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.0.3/cookieconsent.min.js"></script>
<script>
  window.addEventListener("load", function(){
    window.cookieconsent.initialise({
      "palette": {
        "popup": {
          "background": "#2962ff",
          "text": "#fff"
        },
        "button": {
          "background": "#fff",
          "text": "#2962ff"
        }
      },
      "theme": "classic",
      "content": {
        "message": "Este sitio web utiliza cookies para garantizarle una mejor experiencia.",
        "dismiss": "Entendido!",
        "link": "Más información",
        "href": "https://cookies.insites.com"
      }
    })});
</script>


  

  <title>Direcciones del flujo fluvial | Dominic Royé</title>

</head>
<body id="top" data-spy="scroll" data-target="#TableOfContents" data-offset="71" >
  <aside class="search-results" id="search">
  <div class="container">
    <section class="search-header">

      <div class="row no-gutters justify-content-between mb-3">
        <div class="col-6">
          <h1>Search</h1>
        </div>
        <div class="col-6 col-search-close">
          <a class="js-search" href="#"><i class="fas fa-times-circle text-muted" aria-hidden="true"></i></a>
        </div>
      </div>

      <div id="search-box">
        
        
        
      </div>

    </section>
    <section class="section-search-results">

      <div id="search-hits">
        
      </div>

    </section>
  </div>
</aside>

<nav class="navbar navbar-light fixed-top navbar-expand-lg py-0" id="navbar-main">
  <div class="container">

    
      <a class="navbar-brand" href="/es"><div style="position:relative;float:left">Dominic Royé<img src="/img/portrait.jpg" alt="Dominic Royé" style="float: left;"></div></a>
      
      <button type="button" class="navbar-toggler" data-toggle="collapse"
              data-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Barra de navegación">
        <span><i class="fas fa-bars"></i></span>
      </button>
      

    
    <div class="collapse navbar-collapse" id="navbar">

      
      
      <ul class="navbar-nav ml-auto">
        

        

        
        
        

        <li class="nav-item">
          <a class="nav-link" href="/es/#">
            
            <span>inicio</span>
            
          </a>
        </li>

        
        

        

        
        
        
          
        

        <li class="nav-item">
          <a class="nav-link" href="/es/#posts">
            
            <span>blog</span>
            
          </a>
        </li>

        
        

        

        
        
        
          
        

        <li class="nav-item">
          <a class="nav-link" href="/es/#publications_selected">
            
            <span>publicaciones</span>
            
          </a>
        </li>

        
        

        

        
        
        
          
        

        <li class="nav-item">
          <a class="nav-link" href="/es/#graphs">
            
            <span>gráficos</span>
            
          </a>
        </li>

        
        

        

        
        
        
          
        

        <li class="nav-item">
          <a class="nav-link" href="/es/#about">
            
            <span>mí</span>
            
          </a>
        </li>

        
        

        

        
        
        
          
        

        <li class="nav-item">
          <a class="nav-link" href="/es/#teaching">
            
            <span>más</span>
            
          </a>
        </li>

        
        

      

        

        

        

        

      </ul>

    </div>
  </div>
</nav>


<article class="article" itemscope itemtype="http://schema.org/Article">

  













<div class="article-header d-xl-none">
  <div class="featured-image" style="background-image: url('/es/2020/direcciones-del-flujo-fluvial/featured_hu6f0ab3e4def1f473c5ed71797e177e68_651656_800x0_resize_q75_box.jpg');"></div>
  
</div>


<div class="container-fluid split-header d-none d-xl-block">
  <div class="row">
    <div class="col-6">
      <div class="split-header-content">
        <h1 itemprop="name">Direcciones del flujo fluvial</h1>

        

        

<div class="article-metadata">

  
  
  <span itemscope itemprop="author" itemtype="http://schema.org/Person">
    <meta itemprop="name" content="Dr. Dominic Royé">
  </span>
  

  <span class="article-date">
    
    <meta content="2020-07-24 00:00:00 &#43;0000 UTC" itemprop="datePublished">
    <time datetime="2020-07-24 00:00:00 &#43;0000 UTC" itemprop="dateModified">
      2020-07-24
    </time>
  </span>
  <span itemscope itemprop="publisher" itemtype="http://schema.org/Person">
    <meta itemprop="name" content="Dr. Dominic Royé">
  </span>

  

  
  
  <span class="middot-divider"></span>
  <a href="/es/2020/direcciones-del-flujo-fluvial/#disqus_thread"></a>
  

  
  
  
  <span class="middot-divider"></span>
  <span class="article-categories">
    <i class="fas fa-folder"></i>
    
    <a href="/es/categories/sig/">sig</a>, 
    
    <a href="/es/categories/r/">R</a>, 
    
    <a href="/es/categories/ravanzado/">R:avanzado</a>
    
  </span>
  
  

  

</div>


        







  










        
<div class="share-box" aria-hidden="true">
  <ul class="share">
    <li>
      <a class="twitter"
         href="https://twitter.com/intent/tweet?text=Direcciones%20del%20flujo%20fluvial&amp;url=%2fes%2f2020%2fdirecciones-del-flujo-fluvial%2f"
         target="_blank" rel="noopener">
        <i class="fab fa-twitter"></i>
      </a>
    </li>
    <li>
      <a class="facebook"
         href="https://www.facebook.com/sharer.php?u=%2fes%2f2020%2fdirecciones-del-flujo-fluvial%2f"
         target="_blank" rel="noopener">
        <i class="fab fa-facebook-f"></i>
      </a>
    </li>
    <li>
      <a class="linkedin"
         href="https://www.linkedin.com/shareArticle?mini=true&amp;url=%2fes%2f2020%2fdirecciones-del-flujo-fluvial%2f&amp;title=Direcciones%20del%20flujo%20fluvial"
         target="_blank" rel="noopener">
        <i class="fab fa-linkedin-in"></i>
      </a>
    </li>
    <li>
      <a class="weibo"
         href="http://service.weibo.com/share/share.php?url=%2fes%2f2020%2fdirecciones-del-flujo-fluvial%2f&amp;title=Direcciones%20del%20flujo%20fluvial"
         target="_blank" rel="noopener">
        <i class="fab fa-weibo"></i>
      </a>
    </li>
    <li>
      <a class="email"
         href="mailto:?subject=Direcciones%20del%20flujo%20fluvial&amp;body=%2fes%2f2020%2fdirecciones-del-flujo-fluvial%2f">
        <i class="fas fa-envelope"></i>
      </a>
    </li>
  </ul>
</div>


      </div>
    </div>
    <div class="col-6">
      <div class="split-header-image">
        <img src="/es/2020/direcciones-del-flujo-fluvial/featured_hu6f0ab3e4def1f473c5ed71797e177e68_651656_680x500_fill_q90_box_smart1.jpg" itemprop="image" alt="">
        
      </div>
    </div>
  </div>
</div>

<div class="article-container d-xl-none">
  <h1 itemprop="name">Direcciones del flujo fluvial</h1>

  

  

<div class="article-metadata">

  
  
  <span itemscope itemprop="author" itemtype="http://schema.org/Person">
    <meta itemprop="name" content="Dr. Dominic Royé">
  </span>
  

  <span class="article-date">
    
    <meta content="2020-07-24 00:00:00 &#43;0000 UTC" itemprop="datePublished">
    <time datetime="2020-07-24 00:00:00 &#43;0000 UTC" itemprop="dateModified">
      2020-07-24
    </time>
  </span>
  <span itemscope itemprop="publisher" itemtype="http://schema.org/Person">
    <meta itemprop="name" content="Dr. Dominic Royé">
  </span>

  

  
  
  <span class="middot-divider"></span>
  <a href="/es/2020/direcciones-del-flujo-fluvial/#disqus_thread"></a>
  

  
  
  
  <span class="middot-divider"></span>
  <span class="article-categories">
    <i class="fas fa-folder"></i>
    
    <a href="/es/categories/sig/">sig</a>, 
    
    <a href="/es/categories/r/">R</a>, 
    
    <a href="/es/categories/ravanzado/">R:avanzado</a>
    
  </span>
  
  

  
  
<div class="share-box" aria-hidden="true">
  <ul class="share">
    <li>
      <a class="twitter"
         href="https://twitter.com/intent/tweet?text=Direcciones%20del%20flujo%20fluvial&amp;url=%2fes%2f2020%2fdirecciones-del-flujo-fluvial%2f"
         target="_blank" rel="noopener">
        <i class="fab fa-twitter"></i>
      </a>
    </li>
    <li>
      <a class="facebook"
         href="https://www.facebook.com/sharer.php?u=%2fes%2f2020%2fdirecciones-del-flujo-fluvial%2f"
         target="_blank" rel="noopener">
        <i class="fab fa-facebook-f"></i>
      </a>
    </li>
    <li>
      <a class="linkedin"
         href="https://www.linkedin.com/shareArticle?mini=true&amp;url=%2fes%2f2020%2fdirecciones-del-flujo-fluvial%2f&amp;title=Direcciones%20del%20flujo%20fluvial"
         target="_blank" rel="noopener">
        <i class="fab fa-linkedin-in"></i>
      </a>
    </li>
    <li>
      <a class="weibo"
         href="http://service.weibo.com/share/share.php?url=%2fes%2f2020%2fdirecciones-del-flujo-fluvial%2f&amp;title=Direcciones%20del%20flujo%20fluvial"
         target="_blank" rel="noopener">
        <i class="fab fa-weibo"></i>
      </a>
    </li>
    <li>
      <a class="email"
         href="mailto:?subject=Direcciones%20del%20flujo%20fluvial&amp;body=%2fes%2f2020%2fdirecciones-del-flujo-fluvial%2f">
        <i class="fas fa-envelope"></i>
      </a>
    </li>
  </ul>
</div>


  

</div>


  







  









</div>



  <div class="article-container">

    <div class="article-style" itemprop="articleBody">
      


<p>Recientemente creé una visualización de la distribución de las direcciones del flujo fluvial y también de las orientaciones costeras. A raíz de su publicación en los RRSS (<a href="https://twitter.com/dr_xeo/status/1277978724034465798?s=2">aquí</a>) me pidieron que hiciera un post acerca de cómo lo hice. Pues bien, aquí vamos para empezar con un ejemplo de los ríos, la orientación costera es algo más compleja. Lo mismo hice para una selección de ríos europeos aquí en este <a href="https://twitter.com/dr_xeo/status/1277243216828473345?s=20">tweet</a>. No obstante, originalmente empecé con la orientación de las costas europeas.</p>
<blockquote class="twitter-tweet"><p lang="en" dir="ltr">Have you ever wondered where the European <a href="https://twitter.com/hashtag/coasts?src=hash&amp;ref_src=twsrc%5Etfw">#coasts</a> are oriented? <a href="https://twitter.com/hashtag/rstats?src=hash&amp;ref_src=twsrc%5Etfw">#rstats</a> <a href="https://twitter.com/hashtag/ggplot2?src=hash&amp;ref_src=twsrc%5Etfw">#ggplot2</a> <a href="https://twitter.com/hashtag/geography?src=hash&amp;ref_src=twsrc%5Etfw">#geography</a> <a href="https://twitter.com/hashtag/dataviz?src=hash&amp;ref_src=twsrc%5Etfw">#dataviz</a> <a href="https://t.co/tpWVxSoHlw">pic.twitter.com/tpWVxSoHlw</a></p>&mdash; Dominic Royé (@dr_xeo) <a href="https://twitter.com/dr_xeo/status/1265286552525180929?ref_src=twsrc%5Etfw">May 26, 2020</a></blockquote>
<script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>

<div id="paquetes" class="section level2">
<h2>Paquetes</h2>
<p>En este post usaremos los siguientes paquetes:</p>
<table>
<colgroup>
<col width="10%" />
<col width="89%" />
</colgroup>
<thead>
<tr class="header">
<th align="left">Paquete</th>
<th align="left">Descripción</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">tidyverse</td>
<td align="left">Conjunto de paquetes (visualización y manipulación de datos): ggplot2, dplyr, purrr,etc.</td>
</tr>
<tr class="even">
<td align="left">remotes</td>
<td align="left">Instalación desde repositorios remotos</td>
</tr>
<tr class="odd">
<td align="left">RQGIS3</td>
<td align="left">Interfaz entre R y QGIS3</td>
</tr>
<tr class="even">
<td align="left">sf</td>
<td align="left">Simple Feature: importar, exportar y manipular datos vectoriales</td>
</tr>
<tr class="odd">
<td align="left">ggtext</td>
<td align="left">Soporte para la representación de texto mejorado con ggplot2</td>
</tr>
<tr class="even">
<td align="left">sysfonts</td>
<td align="left">Cargar fuentes en R</td>
</tr>
<tr class="odd">
<td align="left">showtext</td>
<td align="left">Usar fuentes más fácilmente en gráficos R</td>
</tr>
<tr class="even">
<td align="left">circular</td>
<td align="left">Funciones para trabajar con datos circulares</td>
</tr>
<tr class="odd">
<td align="left">geosphere</td>
<td align="left">Trigonometría esférica para aplicaciones geográficas</td>
</tr>
</tbody>
</table>
<p>En el caso del paquete <code>RQGIS3</code> es necesario instalar QGIS en OSGeo4W <a href="https://www.qgis.org/es/site/forusers/download.html">aquí</a>. Más adelante explicaré la razón del uso de QGIS.</p>
<pre class="r"><code># instalamos los paquetes si hace falta
if(!require(&quot;tidyverse&quot;)) install.packages(&quot;tidyverse&quot;)
if(!require(&quot;remotes&quot;)) install.packages(&quot;remotes&quot;)
if(!require(&quot;RQGIS3&quot;)) remotes::install_github(&quot;jannes-m/RQGIS3&quot;)
if(!require(&quot;sf&quot;)) install.packages(&quot;sf&quot;)
if(!require(&quot;ggtext&quot;)) install.packages(&quot;ggtext&quot;)
if(!require(&quot;circular&quot;)) install.packages(&quot;circular&quot;)
if(!require(&quot;geosphere&quot;)) install.packages(&quot;geosphere&quot;)
if(!require(&quot;sysfonts&quot;)) install.packages(&quot;sysfonts&quot;)
if(!require(&quot;showtext&quot;)) install.packages(&quot;showtext&quot;)

# paquetes
library(sf)
library(tidyverse)
library(ggtext)
library(circular)
library(geosphere)
library(RQGIS3)
library(showtext)
library(sysfonts)</code></pre>
</div>
<div id="consideraciones-iniciales" class="section level1">
<h1>Consideraciones iniciales</h1>
<p>Los ángulos en líneas vectoriales se basan en el ángulo entre dos vértices, y el número de vértices depende de la complejidad, y en consecuencia de la resolución, de los datos vectoriales. Por tanto, puede haber diferencias en usar distintas resoluciones de una línea vectorial, sea de la costa o del río como en este ejemplo. Una línea recta simplemente se construye con dos puntos de longitud y latitud.</p>
<p>Relacionado con ello está la fractalidad, una estructura aparentemente irregular pero que se repite a diferentes escalas, de la línea de costa o también del río. La característica más paradójica es que la longitud de una línea costera depende de la escala de medida, cuanto menor es el incremento de medida, la longitud medida se incrementa.</p>
<p>Existen dos posibiliades de obtener los ángulos de los vértices. En la primera calculamos el ángulo entre todos los vértices consecutivos.</p>
<p>Por ejemplo, imaginémonos dos puntos, Madrid (-3.71, 40.43) y Barcelona (2.14, 41.4).</p>
<p>¿Cuál es el ángulo de su línea recta?</p>
<pre class="r"><code>bearingRhumb(c(-3.71, 40.43), c(2.14, 41.4))</code></pre>
<pre><code>## [1] 77.62391</code></pre>
<p>Vemos que es el de 77º, o sea, dirección noreste. Pero, ¿y si voy de Barcelona a Madrid?</p>
<pre class="r"><code>bearingRhumb(c(2.14, 41.4), c(-3.71, 40.43))</code></pre>
<pre><code>## [1] 257.6239</code></pre>
<p>El angúlo es diferente porque nos <em>movemos</em> desde el noreste al suroeste. Podemos invertir fácilmente el ángulo para obtener el <em>movimiento</em> contrario.</p>
<pre class="r"><code># ángulo contrario de Barcelona -&gt; Madrid
bearingRhumb(c(2.14, 41.4), c(-3.71, 40.43)) - 180</code></pre>
<pre><code>## [1] 77.62391</code></pre>
<pre class="r"><code># ángulo contrario de Madrid -&gt; Barcelona
bearingRhumb(c(-3.71, 40.43), c(2.14, 41.4)) + 180</code></pre>
<pre><code>## [1] 257.6239</code></pre>
<p>La dirección en la que calculamos los ángulos es importante. En el caso de los ríos se espera que sea la dirección de flujo de origen a la desembocadura, ahora bien, un problema puede ser que los vértices, que construyen las líneas, no estén ordenados geográficamente en la tabla de atributos. Otro problema puede ser que los vértices empiecen en la desembocadura lo que daría al angúlo inverso como lo hemos visto antes.</p>
<p>Sin embargo, hay una forma más fácil. Podemos aprovechar los atributos de los sistemas de coordenadas proyectados (proyección Robinson, etc) que incluyen el ángulo entre los vértices. Este último enfoque lo vamos usar en este post. Aún así, debemos prestar mucha atención a los resultados según lo dicho anteriormente.</p>
</div>
<div id="preparación" class="section level1">
<h1>Preparación</h1>
<div id="datos" class="section level2">
<h2>Datos</h2>
<p>Descargamos las líneas centrales de los ríos más grandes del mundo (<a href="/files/RiverHRCenterlinesCombo.zip">descarga</a>), accesible también en <a href="https://www.sciencebase.gov/catalog/item/5a145fdde4b09fc93dcfd36c">Zeenatul Basher et al. 2018</a>.</p>
</div>
<div id="importar-y-proyectar" class="section level2">
<h2>Importar y proyectar</h2>
<p>Lo primero que hacemos es importar, proyectar y eliminar la tercera dimensión <em>Z</em>, usando el encadenamiento de las siguientes functions: <code>st_read()</code> nos ayuda a importar cualquier formato vectorial, <code>st_zm()</code> elimina la dimensión Z o M de una geometría vectorial y <code>st_transform()</code> proyecta los datos vectoriales a la nueva proyección en formato <em>proj4</em>. La combinación de las funciones la realizamos con el famoso <em>pipe</em> (<code>%&gt;%</code>) que facilita la aplicación de una secuencia de funciones sobre un conjunto de datos, más detalles en este <a href="https://dominicroye.github.io/es/2020/una-muy-breve-introducci%C3%B3n-a-tidyverse/">post</a>. Todas las funciones del paquete <code>sf</code> comienzan por <code>st_*</code> haciendo referencia al carácter espacial de su aplicación, similar a <em>PostGIS.</em> Igualmente, y al mismo estilo que <em>PostGIS</em>, se usan verbos como nombres de función.</p>
<pre class="r"><code>proj_rob &lt;- &quot;+proj=robin +lon_0=0 +x_0=0 +y_0=0 +ellps=WGS84 +datum=WGS84 +units=m no_defs&quot;

river_line &lt;- st_read(&quot;RiverHRCenterlinesCombo.shp&quot;) %&gt;% 
                 st_zm() %&gt;% 
                    st_transform(proj_rob)</code></pre>
<pre><code>## Reading layer `RiverHRCenterlinesCombo&#39; from data source `C:\Users\xeo19\Documents\GitHub\blogR_update\content\post\es\2020-07-24-direcciones-del-flujo-fluvial\RiverHRCenterlinesCombo.shp&#39; using driver `ESRI Shapefile&#39;
## Simple feature collection with 78 features and 6 fields
## geometry type:  MULTILINESTRING
## dimension:      XYZ
## bbox:           xmin: -164.7059 ymin: -36.97094 xmax: 151.5931 ymax: 72.64474
## z_range:        zmin: 0 zmax: 0
## geographic CRS: WGS 84</code></pre>
</div>
<div id="extraer-los-ángulos" class="section level2">
<h2>Extraer los ángulos</h2>
<p>En el siguiente paso debemos extraer los ángulos de los vértices. Desgraciadamente, hasta donde sepa, no es posible extraer los atributos con alguna función del paquete <code>sf</code>. Aunque la función <code>st_coordinates()</code> nos devuelve las coordenadas, no incluye otros atributos. Por eso, debemos usar otra forma, y es que el open software Quantum GIS extrae todos los atributos de los vértices. Podríamos importar los datos vectoriales en QGIS Desktop y exportar los vértices desde allí, pero también es posible acceder a las funciones de QGIS desde R directamente.</p>
<p>Para ello, tenemos que tener instalado QGIS en OSGeo4W. El paquete <code>RQGIS3</code> nos permite de forma muy fácil usar las funciones del programa en R. Primero empleamos la función <code>set_env()</code> para definir todas las rutas necesarias de QGIS e inciamos la API con <code>open_app()</code>.</p>
<pre class="r"><code># rutas a QGIS
set_env()</code></pre>
<pre><code>## Trying to find QGIS in C:/OSGEO4~1</code></pre>
<pre><code>## $root
## [1] &quot;C:/OSGeo4W64&quot;
## 
## $qgis_prefix_path
## [1] &quot;C:/OSGeo4W64/apps/qgis&quot;
## 
## $python_plugins
## [1] &quot;C:/OSGeo4W64/apps/qgis/python/plugins&quot;
## 
## $platform
## [1] &quot;Windows&quot;</code></pre>
<pre class="r"><code># inicio de QGIS Python
open_app()</code></pre>
<p>La función <code>find_algorithms()</code> nos ayuda a buscar diferentes herramientas de QGIS. Además la función <code>get_usage()</code> especifica la forma de uso con todos los argumentos requeridos.</p>
<pre class="r"><code># buscar herramientas
find_algorithms(search_term = &quot;vertices&quot;, name_only = TRUE)</code></pre>
<pre><code>## [1] &quot;native:extractspecificvertices&quot;         
## [2] &quot;native:extractvertices&quot;                 
## [3] &quot;native:filterverticesbym&quot;               
## [4] &quot;native:filterverticesbyz&quot;               
## [5] &quot;native:removeduplicatevertices&quot;         
## [6] &quot;saga:convertpolygonlineverticestopoints&quot;</code></pre>
<pre class="r"><code># uso de la herramienta
get_usage(alg = &quot;native:extractvertices&quot;)</code></pre>
<pre><code>## Extract vertices (native:extractvertices)
## 
## This algorithm takes a line or polygon layer and generates a point layer with points representing the vertices in the input lines or polygons. The attributes associated to each point are the same ones associated to the line or polygon that the point belongs to.
## 
## Additional fields are added to the point indicating the vertex index (beginning at 0)
## the vertex’s part and its index within the part (as well as its ring for polygons)
## distance along original geometry and bisector angle of vertex for original geometry.
## 
## 
## ----------------
## Input parameters
## ----------------
## 
## INPUT: Input layer
## 
##  Parameter type: QgsProcessingParameterFeatureSource
## 
##  Accepted data types:
##      - str: layer ID
##      - str: layer name
##      - str: layer source
##      - QgsProcessingFeatureSourceDefinition
##      - QgsProperty
##      - QgsVectorLayer
## 
## OUTPUT: Vertices
## 
##  Parameter type: QgsProcessingParameterFeatureSink
## 
##  Accepted data types:
##      - str: destination vector file
## e.g. d:/test.shp
##      - str: memory: to store result in temporary memory layer
##      - str: using vector provider ID prefix and destination URI
## e.g. postgres:… to store result in PostGIS table
##      - QgsProcessingOutputLayerDefinition
##      - QgsProperty
## 
## ----------------
## Outputs
## ----------------
## 
## OUTPUT:  &lt;QgsProcessingOutputVectorLayer&gt;
##  Vertices</code></pre>
<p>En nuestro caso la herramienta para extraer los vértices es simple y sólo lleva una entrada y una salida. La función <code>run_qgis()</code> ejecuta una herramienta de QGIS indicando el algoritmo y sus argumentos. La ventaja de usar el algoritmo directamente desde R es que podemos pasar objetos de clase <code>sf</code> (o <code>sp</code>) y <code>raster</code> que tenemos importados o creados en R. Como salida creamos un <code>geojson</code>, también podría ser de otro formato vectorial, y lo guardamos en una carpeta temporal. Al mismo tiempo le indicamos que importe el resultado directamente a R (<code>load_output = TRUE</code>).</p>
<pre class="r"><code>river_vertices &lt;- run_qgis(alg = &quot;native:extractvertices&quot;,
               INPUT = river_line,
               OUTPUT = file.path(tempdir(), &quot;rivers_world_vertices.geojson&quot;),
               load_output = TRUE)</code></pre>
<pre><code>## $OUTPUT
## [1] &quot;C:/Users/xeo19/AppData/Local/Temp/RtmpGurVm9/rivers_world_vertices.geojson&quot;</code></pre>
<div class="alert alert-note">
  <p>Actualmente en Windows parece haber problemas con la librería de <em>proj</em>. En principio si termina creando el objeto <code>river_vertices</code> no debes preocuparte. En caso contrario, recomiendo mirar la discusión en el <em>issue</em> abierto en <a href="https://github.com/r-spatial/RQGIS3/issues/20">gitbub</a>.</p>

</div>

</div>
<div id="selección" class="section level2">
<h2>Selección</h2>
<p>Antes de seguir con la estimación de la distribución de los ángulos, filtramos algunos ríos de interés. Las funciones de la colección <code>tidyverse</code> son compatibles con el paquete <code>sf</code>. En el último post hice una introducción a <code>tidyverse</code> <a href="https://dominicroye.github.io/es/2020/una-muy-breve-introducci%C3%B3n-a-tidyverse/">aquí</a>.</p>
<pre class="r"><code>river_vertices &lt;-  filter(river_vertices, 
                          NAME %in% c(&quot;Mississippi&quot;, &quot;Colorado&quot;, 
                                      &quot;Amazon&quot;, &quot;Nile&quot;, &quot;Orange&quot;, 
                                      &quot;Ganges&quot;, &quot;Yangtze&quot;, &quot;Danube&quot;,
                                      &quot;Mackenzie&quot;, &quot;Lena&quot;, &quot;Murray&quot;, 
                                      &quot;Niger&quot;)
                          ) 

river_vertices </code></pre>
<pre><code>## Simple feature collection with 94702 features and 11 fields
## geometry type:  POINT
## dimension:      XY
## bbox:           xmin: -10377520 ymin: -3953778 xmax: 13124340 ymax: 7507359
## geographic CRS: WGS 84</code></pre>
<pre><code>## Warning in st_is_longlat(x): bounding box has potentially an invalid value range
## for longlat data

## Warning in st_is_longlat(x): bounding box has potentially an invalid value range
## for longlat data</code></pre>
<pre><code>## # A tibble: 94,702 x 12
##    NAME  SYSTEM name_alt scalerank rivernum Length_km vertex_index vertex_part
##  * &lt;chr&gt; &lt;chr&gt;  &lt;chr&gt;        &lt;dbl&gt;    &lt;dbl&gt;     &lt;dbl&gt;        &lt;int&gt;       &lt;int&gt;
##  1 Nile  &lt;NA&gt;   &lt;NA&gt;             1        4     3344.            0           0
##  2 Nile  &lt;NA&gt;   &lt;NA&gt;             1        4     3344.            1           0
##  3 Nile  &lt;NA&gt;   &lt;NA&gt;             1        4     3344.            2           0
##  4 Nile  &lt;NA&gt;   &lt;NA&gt;             1        4     3344.            3           0
##  5 Nile  &lt;NA&gt;   &lt;NA&gt;             1        4     3344.            4           0
##  6 Nile  &lt;NA&gt;   &lt;NA&gt;             1        4     3344.            5           0
##  7 Nile  &lt;NA&gt;   &lt;NA&gt;             1        4     3344.            6           0
##  8 Nile  &lt;NA&gt;   &lt;NA&gt;             1        4     3344.            7           0
##  9 Nile  &lt;NA&gt;   &lt;NA&gt;             1        4     3344.            8           0
## 10 Nile  &lt;NA&gt;   &lt;NA&gt;             1        4     3344.            9           0
## # ... with 94,692 more rows, and 4 more variables: vertex_part_index &lt;int&gt;,
## #   distance &lt;dbl&gt;, angle &lt;dbl&gt;, geometry &lt;POINT [°]&gt;</code></pre>
</div>
</div>
<div id="estimar-la-distribución" class="section level1">
<h1>Estimar la distribución</h1>
<p>Para visualizar la distribución podemos usar, o bien un histograma o un gráfico de densidad. Pero en el caso de estimar la función de densidad de probabilidad nos encontramos con un problema matemático a la hora de aplicarlo a datos circulares. No debemos usar la función estandar de R <code>density()</code> dado que en nuestros datos una dirección de 360º es la misma a 0º, lo que provocaría errores en este rango de valores. Es un problema general para diferentes métricas estadísticas. Más detalles estadísticos se explican en el paquete <code>circular</code>. Este paquete permite definir las características de los datos circulares (unidad, tipo de datos, rotación, etc.) como una clase de objeto en R.</p>
<p>Por tanto, lo que hacemos es construir una función que estime la densidad y devuelva una tabla con los ángulos (x) y las estimaciones de densidad (y). Dado que los ríos tienen diferentes longitudes, y queremos ver diferencias independientemente de ello, normalizamos las estimaciones usando el valor máximo. A diferencia de la función <code>density()</code>, en la que el ancho de banda de suavizado <code>bw</code> es optimizado, aquí es requerido indicarlo. Es similar a definir el ancho de barra en un histograma. Existe una función de optimización para la banda, <code>bw.nrd.circular()</code> que se podría emplear aquí.</p>
<pre class="r"><code>dens_circ &lt;- function(x){
  
  dens &lt;- density.circular(circular(x$angle, units = &quot;degrees&quot;),
                                     bw = 70, kernel = &quot;vonmises&quot;,
                                     control.circular = list(units = &quot;degrees&quot;))
  
  df &lt;- data.frame(x = dens$x, y = dens$y/max(dens$y))
  
  return(df)
  
}</code></pre>
<p>Para finalizar, estimamos la densidad de cada río de nuestra selección. Empleamos la función <code>split()</code> de <em>R Base</em> para obtener una tabla de cada río en una lista. Después aplicamos con la función <code>map_df()</code> del paquete <code>purrr</code> nuestra función de estimación de densidad a la lista. El sufijo <code>_df</code> permite que obtengamos una tabla unida, en lugar de una lista con los resultados de cada río. No obstante, es necesario indicar el nombre de la columna con el argumento <code>.id</code>, la que contendrá el nombre de cada río. En caso contrario no sabríamos diferenciar los resultados. También aquí recomiendo leer más detalles en el último post sobre <code>tidyverse</code> <a href="https://dominicroye.github.io/es/2020/una-muy-breve-introducci%C3%B3n-a-tidyverse/">aquí</a>.</p>
<pre class="r"><code>dens_river &lt;- split(river_vertices, river_vertices$NAME) %&gt;% 
                  map_df(dens_circ, .id = &quot;river&quot;)

# resultado
head(dens_river)</code></pre>
<pre><code>##    river        x         y
## 1 Amazon 0.000000 0.2399907
## 2 Amazon 0.704501 0.2492548
## 3 Amazon 1.409002 0.2585758
## 4 Amazon 2.113503 0.2679779
## 5 Amazon 2.818004 0.2774859
## 6 Amazon 3.522505 0.2871232</code></pre>
</div>
<div id="visualización" class="section level1">
<h1>Visualización</h1>
<p>Ahora ya sólo nos queda la visualización mediante el famoso paquete <code>ggplot</code>. Primero añadimos una nueva fuente <em>Montserrat</em> para usarla en este gráfico.</p>
<pre class="r"><code># descarga de fuente
font_add_google(&quot;Montserrat&quot;, &quot;Montserrat&quot;)

# usar showtext para fuentes
showtext_opts(dpi = 200)
showtext_auto() </code></pre>
<p>En el siguiente paso creamos dos objetos con el título y con una nota de pie. En el título estamos usando un código html para dar color a una parte de texto en sustitución de una leyenda. Se puede usar html de forma muy fácil con el paquete <code>ggtext</code>.</p>
<pre class="r"><code># título con html 
title &lt;- &quot;Relative distribution of river &lt;span style=&#39;color:#011FFD;&#39;&gt;&lt;strong&gt;flow direction&lt;/strong&gt;&lt;/span&gt; in the world&quot;


caption &lt;- &quot;Based on data from Zeenatul Basher, 20180215&quot;</code></pre>
<p>La cuadrícula de fondo que crea <code>ggplot</code> por defecto para coordenadas polares no me convenció, por eso creamos una tabla con las líneas de fondo del eje x.</p>
<pre class="r"><code>grid_x &lt;- tibble(x = seq(0, 360 - 22.5, by = 22.5), 
                 y = rep(0, 16), 
                 xend = seq(0, 360 - 22.5, by = 22.5), 
                 yend = rep(Inf, 16))</code></pre>
<p>A continuación definimos todos los estilos del gráfico. Lo más importante en este paso es la función <code>element_textbox()</code> del paquete <code>ggtext</code> para poder interpretar nuestro código html incorporado al título.</p>
<pre class="r"><code>theme_polar &lt;- theme_minimal() +
               theme(axis.title.y = element_blank(),
                     axis.text.y = element_blank(),
                     legend.title = element_blank(),
                     plot.title = element_textbox(family = &quot;Montserrat&quot;, 
                                                   hjust = 0.5, 
                                                   colour = &quot;white&quot;, 
                                                   size = 15),
                     plot.caption = element_text(family = &quot;Montserrat&quot;, 
                                                 colour = &quot;white&quot;),
                     axis.text.x = element_text(family = &quot;Montserrat&quot;, 
                                                 colour = &quot;white&quot;),
                     strip.text = element_text(family = &quot;Montserrat&quot;, 
                                               colour = &quot;white&quot;, 
                                               face = &quot;bold&quot;),
                     panel.background = element_rect(fill = &quot;black&quot;),
                     plot.background = element_rect(fill = &quot;black&quot;),
                     panel.grid = element_blank()
                    )</code></pre>
<p>Para terminar construimos el gráfico: 1) Usamos la función <code>geom_hline()</code> con diferentes puntos de intersección en <em>y</em> para crear la cuadrícula de fondo. La función <code>geom_segment()</code> crea la cuadrícula en <em>x</em>. 2) El área de densidad la creamos usando la función <code>geom_area()</code>. 3) En <code>scale_x_continous()</code> definimos un límite inferior
negativo para que no colapse en un punto pequeño. Las etiquetas de las ocho direcciones principales las indicamos en la función <code>scale_y_continous()</code>, y 4) Por último, cambiamos a un sistema de coordenadas polar y fijamos la variable para crear facetas.</p>
<pre class="r"><code>ggplot() +
  geom_hline(yintercept = c(0, .2, .6, .8, 1), colour = &quot;white&quot;) +
  geom_segment(data = grid_x , 
               aes(x = x, y = y, xend = xend, yend = yend), 
               linetype = &quot;dashed&quot;, col = &quot;white&quot;) +
  geom_area(data = dens_river, 
            aes(x = x, y = y, ymin = 0, ymax = y), 
            alpha = .7, 
            colour = NA, 
            show.legend = FALSE,
            fill = &quot;#011FFD&quot;) + 
  scale_y_continuous(limits = c(-.2, 1), expand = c(0, 0)) +
  scale_x_continuous(limits = c(0, 360), 
                     breaks = seq(0, 360 - 22.5, by = 22.5),
                     minor_breaks = NULL,
                     labels = c(&quot;N&quot;, &quot;&quot;, &quot;NE&quot;, &quot;&quot;, &quot;E&quot;, &quot;&quot;, &quot;SE&quot;, &quot;&quot;,
                                &quot;S&quot;, &quot;&quot;, &quot;SW&quot;, &quot;&quot;, &quot;W&quot;, &quot;&quot;, &quot;NW&quot;, &quot;&quot;)) +
  coord_polar() + 
  facet_wrap(river ~ ., ncol = 4) +
  labs(title = title, caption = caption, x = &quot;&quot;) +
  theme_polar</code></pre>
<pre><code>## Warning: Ignoring unknown aesthetics: ymin, ymax</code></pre>
<p><img src="/post/es/2020-07-24-direcciones-del-flujo-fluvial/index.es_files/figure-html/unnamed-chunk-19-1.png" width="672" /></p>
</div>

    </div>

    


<div class="article-tags">
  
  <a class="badge badge-light" href="/es/tags/direcciones/">direcciones</a>
  
  <a class="badge badge-light" href="/es/tags/rios/">rios</a>
  
  <a class="badge badge-light" href="/es/tags/fluvial/">fluvial</a>
  
  <a class="badge badge-light" href="/es/tags/orientaci%C3%B3n/">orientación</a>
  
  <a class="badge badge-light" href="/es/tags/distribuci%C3%B3n/">distribución</a>
  
</div>



    






<div class="media author-card" itemscope itemtype="http://schema.org/Person">
  
  <img class="portrait mr-3" src="/img/potrai_domi.jpg" itemprop="image" alt="Avatar">
  
  <div class="media-body">
    <h5 class="card-title" itemprop="name"><a href="/es">Dr. Dominic Royé</a></h5>
    
    
    <ul class="network-icon" aria-hidden="true">
      
      
      
      
      
      
      
      
      <li>
        <a itemprop="sameAs" href="mailto:dominic.roye@usc.es" >
          <i class="fa fa-envelope"></i>
        </a>
      </li>
      
      
      
      
        
      
      
      
      
      
        
      
      <li>
        <a itemprop="sameAs" href="//twitter.com/dr_xeo" >
          <i class="fab fa-twitter"></i>
        </a>
      </li>
      
      
      
      
      
      
      
      
        
      
      <li>
        <a itemprop="sameAs" href="https://www.researchgate.net/profile/Dominic_Roye" target="_blank" rel="noopener">
          <i class="ai ai-researchgate"></i>
        </a>
      </li>
      
      
      
      
        
      
      
      
      
      
        
      
      <li>
        <a itemprop="sameAs" href="//github.com/dominicroye" >
          <i class="fab fa-github"></i>
        </a>
      </li>
      
    </ul>
  </div>
</div>




    
    
    <div class="article-widget">
      <div class="hr-light"></div>
      <h3>Relacionado</h3>
      <ul>
        
        <li><a href="/es/graphs/geography/">Geografía</a></li>
        
      </ul>
    </div>
    

    
    <div class="article-widget">
      <div class="post-nav">
  
  <div class="post-nav-item">
    <div class="meta-nav">Siguiente</div>
    <a href="/es/2020/animaci%C3%B3n-clim%C3%A1tica-de-la-temperatura-m%C3%A1xima/" rel="next">Animación climática de la temperatura máxima</a>
  </div>
  
  
  <div class="post-nav-item">
    <div class="meta-nav">Anterior</div>
    <a href="/es/2020/una-muy-breve-introducci%C3%B3n-a-tidyverse/" rel="prev">Una muy breve introducción a Tidyverse</a>
  </div>
  
</div>

    </div>
    

    
<section id="comments">
  <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "https-dominicroye-github-io" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</section>



  </div>
</article>

<div class="container">
  <footer class="site-footer">
  

  <p class="powered-by">
    &copy; 2018-2020 Dominic Royé. All rights reserved. &middot; 

    Powered by the
    <a href="https://sourcethemes.com/academic/" target="_blank" rel="noopener">Academic theme</a> for
    <a href="https://gohugo.io" target="_blank" rel="noopener">Hugo</a>.

    
    <span class="float-right" aria-hidden="true">
      <a href="#" id="back_to_top">
        <span class="button_icon">
          <i class="fas fa-chevron-up fa-2x"></i>
        </span>
      </a>
    </span>
    
  </p>
</footer>

</div>


<div id="modal" class="modal fade" role="dialog">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Citar</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <pre><code class="tex hljs"></code></pre>
      </div>
      <div class="modal-footer">
        <a class="btn btn-outline-primary my-1 js-copy-cite" href="#" target="_blank">
          <i class="fas fa-copy"></i> Copiar
        </a>
        <a class="btn btn-outline-primary my-1 js-download-cite" href="#" target="_blank">
          <i class="fas fa-download"></i> Descargar
        </a>
        <div id="modal-error"></div>
      </div>
    </div>
  </div>
</div>

    

    
    

    
    
    
      <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha512-+NqPlbbtM1QqiK8ZAo4Yrj2c4lNQoGv8P79DPtKzj++l5jnN39rHA/xsqn8zE9l0uSoxaCdrOgFs6yjyfbBxSg==" crossorigin="anonymous"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.imagesloaded/4.1.3/imagesloaded.pkgd.min.js" integrity="sha512-umsR78NN0D23AzgoZ11K7raBD+R6hqKojyBZs1w8WvYlsI+QuKRGBx3LFCwhatzBunCjDuJpDHwxD13sLMbpRA==" crossorigin="anonymous"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha256-VsEqElsCHSGmnmHXGQzvoWjWwoznFSZc6hs7ARLRacQ=" crossorigin="anonymous"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.isotope/3.0.4/isotope.pkgd.min.js" integrity="sha512-VDBOIlDbuC4VWxGJNmuFRQ0Li0SKkDpmGyuhAG5LTDLd/dJ/S0WMVxriR2Y+CyPL5gzjpN4f/6iqWVBJlht0tQ==" crossorigin="anonymous"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.2.5/jquery.fancybox.min.js" integrity="sha256-X5PoE3KU5l+JcX+w09p/wHl9AzK333C4hJ2I9S5mD4M=" crossorigin="anonymous"></script>

      
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js" integrity="sha256-/BfiIkHlHoVihZdc6TFuj7MmJ0TWcWsMXkeDFwhi0zw=" crossorigin="anonymous"></script>
        
        <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/r.min.js"></script>
        
      

      
      
    

    
    

    
    
    
    <script id="dsq-count-scr" src="//https-dominicroye-github-io.disqus.com/count.js" async></script>
    

    
    
    <script>hljs.initHighlightingOnLoad();</script>
    

    

    
    

    

    
    

    
    

    
    
    
    
    
    
    
    
    <script src="/js/academic.min.d037ee5294b166a79dec317c58aea9cc.js"></script>

    

  </body>
</html>

