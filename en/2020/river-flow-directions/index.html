<!DOCTYPE html>
<html lang="en-us">
<head>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="generator" content="Source Themes Academic 3.2.0">
  <meta name="generator" content="Hugo 0.55.0" />
  <meta name="author" content="Dr. Dominic Royé">

  
  
  
  
    
  
  <meta name="description" content="I recently created a visualization of the distribution of river flow directions and also of coastal orientations. Following its publication in social networks, I was asked to make a post about how I did it. Well, here we go to start with an example of rivers, coastal orientation is somewhat more complex.">

  
  <link rel="alternate" hreflang="en-us" href="https://dominicroye.github.io/en/2020/river-flow-directions/">

  


  

  

  

  

  

  

  
  
  
  <meta name="theme-color" content="#2962ff">
  

  
  
  
  
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha256-eSi1q2PG6J7g7ib17yAaWMcrr5GrtohYChqibrV7PBE=" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/academicons/1.8.6/css/academicons.min.css" integrity="sha256-uFVgMKfistnJAfoCUQigIl+JfUaP47GrRKjf6CTPVmw=" crossorigin="anonymous">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.6.0/css/all.css" integrity="sha384-aOkxzJ5uQz7WBObEZcHvV5JvRW3TUc2rNPA7pe3AwnsUohiw1Vj2Rgx2KSOkF5+h" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.2.5/jquery.fancybox.min.css" integrity="sha256-ygkqlh3CYSUri3LhQxzdcm0n1EQvH2Y+U5S2idbLtxs=" crossorigin="anonymous">

    
    
    
      
    
    
      
      
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/dracula.min.css" crossorigin="anonymous">
      
    

    

    

  

  
  

  <link rel="stylesheet" href="/en/styles.css">
  
  <link rel="stylesheet" href="/css/override.css">
  

  
  
    <script>
      window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
      ga('create', 'UA-27463794-2', 'auto');
      ga('set', 'anonymizeIp', true);
      ga('require', 'eventTracker');
      ga('require', 'outboundLinkTracker');
      ga('require', 'urlChangeTracker');
      ga('send', 'pageview');
    </script>
    <script async src="//www.google-analytics.com/analytics.js"></script>
    
    <script async src="https://cdnjs.cloudflare.com/ajax/libs/autotrack/2.4.1/autotrack.js" integrity="sha512-HUmooslVKj4m6OBu0OgzjXXr+QuFYy/k7eLI5jdeEy/F4RSgMn6XRWRGkFi5IFaFgy7uFTkegp3Z0XnJf3Jq+g==" crossorigin="anonymous"></script>
    
  
  

  
  <link rel="alternate" href="https://dominicroye.github.io/index.xml" type="application/rss+xml" title="Dominic Royé">
  <link rel="feed" href="https://dominicroye.github.io/index.xml" type="application/rss+xml" title="Dominic Royé">
  

  <link rel="manifest" href="/site.webmanifest">
  <link rel="icon" type="image/png" href="/img/icon.png">
  <link rel="apple-touch-icon" type="image/png" href="/img/icon-192.png">

  <link rel="canonical" href="https://dominicroye.github.io/en/2020/river-flow-directions/">

  
  
  
  
    
  
  <meta property="twitter:card" content="summary_large_image">
  
  <meta property="og:site_name" content="Dominic Royé">
  <meta property="og:url" content="https://dominicroye.github.io/en/2020/river-flow-directions/">
  <meta property="og:title" content="River flow directions | Dominic Royé">
  <meta property="og:description" content="I recently created a visualization of the distribution of river flow directions and also of coastal orientations. Following its publication in social networks, I was asked to make a post about how I did it. Well, here we go to start with an example of rivers, coastal orientation is somewhat more complex."><meta property="og:image" content="https://dominicroye.github.io/en/2020/river-flow-directions/featured.jpg">
  <meta property="og:locale" content="en-us">
  
  <meta property="article:published_time" content="2020-07-24T00:00:00&#43;00:00">
  
  <meta property="article:modified_time" content="2020-07-24T00:00:00&#43;00:00">
  

  

<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.0.3/cookieconsent.min.css">
<script src="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.0.3/cookieconsent.min.js"></script>
<script>
  window.addEventListener("load", function(){
    window.cookieconsent.initialise({
      "palette": {
        "popup": {
          "background": "#2962ff",
          "text": "#fff"
        },
        "button": {
          "background": "#fff",
          "text": "#2962ff"
        }
      },
      "theme": "classic",
      "content": {
        "message": "This website uses cookies to ensure you get the best experience on our website.",
        "dismiss": "Got it!",
        "link": "Learn more",
        "href": "https://cookies.insites.com"
      }
    })});
</script>


  

  <title>River flow directions | Dominic Royé</title>

</head>
<body id="top" data-spy="scroll" data-target="#TableOfContents" data-offset="71" >
  <aside class="search-results" id="search">
  <div class="container">
    <section class="search-header">

      <div class="row no-gutters justify-content-between mb-3">
        <div class="col-6">
          <h1>Search</h1>
        </div>
        <div class="col-6 col-search-close">
          <a class="js-search" href="#"><i class="fas fa-times-circle text-muted" aria-hidden="true"></i></a>
        </div>
      </div>

      <div id="search-box">
        
        
        
      </div>

    </section>
    <section class="section-search-results">

      <div id="search-hits">
        
      </div>

    </section>
  </div>
</aside>

<nav class="navbar navbar-light fixed-top navbar-expand-lg py-0" id="navbar-main">
  <div class="container">

    
      <a class="navbar-brand" href="/en/"><div style="position:relative;float:left">Dominic Royé<img src="/img/portrait.jpg" alt="Dominic Royé" style="float: left;"></div></a>
      
      <button type="button" class="navbar-toggler" data-toggle="collapse"
              data-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
        <span><i class="fas fa-bars"></i></span>
      </button>
      

    
    <div class="collapse navbar-collapse" id="navbar">

      
      
      <ul class="navbar-nav ml-auto">
        

        

        
        
        

        <li class="nav-item">
          <a class="nav-link" href="/en/#">
            
            <span>home</span>
            
          </a>
        </li>

        
        

        

        
        
        
          
        

        <li class="nav-item">
          <a class="nav-link" href="/en/#posts">
            
            <span>blog</span>
            
          </a>
        </li>

        
        

        

        
        
        
          
        

        <li class="nav-item">
          <a class="nav-link" href="/en/#publications_selected">
            
            <span>publications</span>
            
          </a>
        </li>

        
        

        

        
        
        
          
        

        <li class="nav-item">
          <a class="nav-link" href="/en/#graphs">
            
            <span>graphs</span>
            
          </a>
        </li>

        
        

        

        
        
        
          
        

        <li class="nav-item">
          <a class="nav-link" href="/en/#teaching">
            
            <span>more</span>
            
          </a>
        </li>

        
        

        

        
        
        
          
        

        <li class="nav-item">
          <a class="nav-link" href="/en/#about">
            
            <span>me</span>
            
          </a>
        </li>

        
        

      

        

        

        

        

      </ul>

    </div>
  </div>
</nav>


<article class="article" itemscope itemtype="http://schema.org/Article">

  













<div class="article-header d-xl-none">
  <div class="featured-image" style="background-image: url('/en/2020/river-flow-directions/featured_hu6f0ab3e4def1f473c5ed71797e177e68_651656_800x0_resize_q75_box.jpg');"></div>
  
</div>


<div class="container-fluid split-header d-none d-xl-block">
  <div class="row">
    <div class="col-6">
      <div class="split-header-content">
        <h1 itemprop="name">River flow directions</h1>

        

        

<div class="article-metadata">

  
  
  <span itemscope itemprop="author" itemtype="http://schema.org/Person">
    <meta itemprop="name" content="Dr. Dominic Royé">
  </span>
  

  <span class="article-date">
    
    <meta content="2020-07-24 00:00:00 &#43;0000 UTC" itemprop="datePublished">
    <time datetime="2020-07-24 00:00:00 &#43;0000 UTC" itemprop="dateModified">
      2020-07-24
    </time>
  </span>
  <span itemscope itemprop="publisher" itemtype="http://schema.org/Person">
    <meta itemprop="name" content="Dr. Dominic Royé">
  </span>

  

  
  
  <span class="middot-divider"></span>
  <a href="/en/2020/river-flow-directions/#disqus_thread"></a>
  

  
  
  
  <span class="middot-divider"></span>
  <span class="article-categories">
    <i class="fas fa-folder"></i>
    
    <a href="/en/categories/gis/">gis</a>, 
    
    <a href="/en/categories/r/">R</a>, 
    
    <a href="">R:advanced</a>
    
  </span>
  
  

  

</div>


        







  










        
<div class="share-box" aria-hidden="true">
  <ul class="share">
    <li>
      <a class="twitter"
         href="https://twitter.com/intent/tweet?text=River%20flow%20directions&amp;url=https%3a%2f%2fdominicroye.github.io%2fen%2f2020%2friver-flow-directions%2f"
         target="_blank" rel="noopener">
        <i class="fab fa-twitter"></i>
      </a>
    </li>
    <li>
      <a class="facebook"
         href="https://www.facebook.com/sharer.php?u=https%3a%2f%2fdominicroye.github.io%2fen%2f2020%2friver-flow-directions%2f"
         target="_blank" rel="noopener">
        <i class="fab fa-facebook-f"></i>
      </a>
    </li>
    <li>
      <a class="linkedin"
         href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fdominicroye.github.io%2fen%2f2020%2friver-flow-directions%2f&amp;title=River%20flow%20directions"
         target="_blank" rel="noopener">
        <i class="fab fa-linkedin-in"></i>
      </a>
    </li>
    <li>
      <a class="weibo"
         href="http://service.weibo.com/share/share.php?url=https%3a%2f%2fdominicroye.github.io%2fen%2f2020%2friver-flow-directions%2f&amp;title=River%20flow%20directions"
         target="_blank" rel="noopener">
        <i class="fab fa-weibo"></i>
      </a>
    </li>
    <li>
      <a class="email"
         href="mailto:?subject=River%20flow%20directions&amp;body=https%3a%2f%2fdominicroye.github.io%2fen%2f2020%2friver-flow-directions%2f">
        <i class="fas fa-envelope"></i>
      </a>
    </li>
  </ul>
</div>


      </div>
    </div>
    <div class="col-6">
      <div class="split-header-image">
        <img src="/en/2020/river-flow-directions/featured_hu6f0ab3e4def1f473c5ed71797e177e68_651656_680x500_fill_q90_box_smart1.jpg" itemprop="image" alt="">
        
      </div>
    </div>
  </div>
</div>

<div class="article-container d-xl-none">
  <h1 itemprop="name">River flow directions</h1>

  

  

<div class="article-metadata">

  
  
  <span itemscope itemprop="author" itemtype="http://schema.org/Person">
    <meta itemprop="name" content="Dr. Dominic Royé">
  </span>
  

  <span class="article-date">
    
    <meta content="2020-07-24 00:00:00 &#43;0000 UTC" itemprop="datePublished">
    <time datetime="2020-07-24 00:00:00 &#43;0000 UTC" itemprop="dateModified">
      2020-07-24
    </time>
  </span>
  <span itemscope itemprop="publisher" itemtype="http://schema.org/Person">
    <meta itemprop="name" content="Dr. Dominic Royé">
  </span>

  

  
  
  <span class="middot-divider"></span>
  <a href="/en/2020/river-flow-directions/#disqus_thread"></a>
  

  
  
  
  <span class="middot-divider"></span>
  <span class="article-categories">
    <i class="fas fa-folder"></i>
    
    <a href="/en/categories/gis/">gis</a>, 
    
    <a href="/en/categories/r/">R</a>, 
    
    <a href="">R:advanced</a>
    
  </span>
  
  

  
  
<div class="share-box" aria-hidden="true">
  <ul class="share">
    <li>
      <a class="twitter"
         href="https://twitter.com/intent/tweet?text=River%20flow%20directions&amp;url=https%3a%2f%2fdominicroye.github.io%2fen%2f2020%2friver-flow-directions%2f"
         target="_blank" rel="noopener">
        <i class="fab fa-twitter"></i>
      </a>
    </li>
    <li>
      <a class="facebook"
         href="https://www.facebook.com/sharer.php?u=https%3a%2f%2fdominicroye.github.io%2fen%2f2020%2friver-flow-directions%2f"
         target="_blank" rel="noopener">
        <i class="fab fa-facebook-f"></i>
      </a>
    </li>
    <li>
      <a class="linkedin"
         href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fdominicroye.github.io%2fen%2f2020%2friver-flow-directions%2f&amp;title=River%20flow%20directions"
         target="_blank" rel="noopener">
        <i class="fab fa-linkedin-in"></i>
      </a>
    </li>
    <li>
      <a class="weibo"
         href="http://service.weibo.com/share/share.php?url=https%3a%2f%2fdominicroye.github.io%2fen%2f2020%2friver-flow-directions%2f&amp;title=River%20flow%20directions"
         target="_blank" rel="noopener">
        <i class="fab fa-weibo"></i>
      </a>
    </li>
    <li>
      <a class="email"
         href="mailto:?subject=River%20flow%20directions&amp;body=https%3a%2f%2fdominicroye.github.io%2fen%2f2020%2friver-flow-directions%2f">
        <i class="fas fa-envelope"></i>
      </a>
    </li>
  </ul>
</div>


  

</div>


  







  









</div>



  <div class="article-container">

    <div class="article-style" itemprop="articleBody">
      


<p>I recently created a visualization of the distribution of river flow directions and also of coastal orientations. Following its publication in social networks (<a href="%5Btweet%5D(https://twitter.com/dr_xeo/status/1277978724034465798?s=20)">here</a>), I was asked to make a post about how I did it. Well, here we go to start with an example of rivers, coastal orientation is somewhat more complex. I did the same for a selection of European rivers here in this <a href="https://twitter.com/dr_xeo/status/1277243216828473345?s=20">tweet</a>. However, originally I started with the orientation of the European coasts.</p>
<blockquote class="twitter-tweet"><p lang="en" dir="ltr">Have you ever wondered where the European <a href="https://twitter.com/hashtag/coasts?src=hash&amp;ref_src=twsrc%5Etfw">#coasts</a> are oriented? <a href="https://twitter.com/hashtag/rstats?src=hash&amp;ref_src=twsrc%5Etfw">#rstats</a> <a href="https://twitter.com/hashtag/ggplot2?src=hash&amp;ref_src=twsrc%5Etfw">#ggplot2</a> <a href="https://twitter.com/hashtag/geography?src=hash&amp;ref_src=twsrc%5Etfw">#geography</a> <a href="https://twitter.com/hashtag/dataviz?src=hash&amp;ref_src=twsrc%5Etfw">#dataviz</a> <a href="https://t.co/tpWVxSoHlw">pic.twitter.com/tpWVxSoHlw</a></p>&mdash; Dominic Royé (@dr_xeo) <a href="https://twitter.com/dr_xeo/status/1265286552525180929?ref_src=twsrc%5Etfw">May 26, 2020</a></blockquote>
<script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>

<div id="packages" class="section level2">
<h2>Packages</h2>
<p>In this post we will use the following packages:</p>
<table>
<colgroup>
<col width="10%" />
<col width="89%" />
</colgroup>
<thead>
<tr class="header">
<th align="left">Packages</th>
<th align="left">Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">tidyverse</td>
<td align="left">Collection of packages (visualization, manipulation): ggplot2, dplyr, purrr, etc.</td>
</tr>
<tr class="even">
<td align="left">remotes</td>
<td align="left">Installation from remote repositories</td>
</tr>
<tr class="odd">
<td align="left">RQGIS3</td>
<td align="left">Interface between R and QGIS3</td>
</tr>
<tr class="even">
<td align="left">sf</td>
<td align="left">Simple Feature: import, export and manipulate vector data</td>
</tr>
<tr class="odd">
<td align="left">ggtext</td>
<td align="left">Improved text rendering support for ggplot2</td>
</tr>
<tr class="even">
<td align="left">sysfonts</td>
<td align="left">Load fonts in R</td>
</tr>
<tr class="odd">
<td align="left">showtext</td>
<td align="left">Use fonts more easily in R graphs</td>
</tr>
<tr class="even">
<td align="left">circular</td>
<td align="left">Functions for working with circular data</td>
</tr>
<tr class="odd">
<td align="left">geosphere</td>
<td align="left">Spherical trigonometry for geographic applications</td>
</tr>
</tbody>
</table>
<p>In the case of the <code>RQGIS3</code> package, it is necessary to install QGIS in OSGeo4W <a href="https://www.qgis.org/es/site/forusers/download.html">here</a>. I will explain the reason for using QGIS later.</p>
<pre class="r"><code># install the packages if necessary
if(!require(&quot;tidyverse&quot;)) install.packages(&quot;tidyverse&quot;)
if(!require(&quot;remotes&quot;)) install.packages(&quot;remotes&quot;)
if(!require(&quot;RQGIS3&quot;)) remotes::install_github(&quot;jannes-m/RQGIS3&quot;)
if(!require(&quot;sf&quot;)) install.packages(&quot;sf&quot;)
if(!require(&quot;ggtext&quot;)) install.packages(&quot;ggtext&quot;)
if(!require(&quot;circular&quot;)) install.packages(&quot;circular&quot;)
if(!require(&quot;geosphere&quot;)) install.packages(&quot;geosphere&quot;)
if(!require(&quot;sysfonts&quot;)) install.packages(&quot;sysfonts&quot;)
if(!require(&quot;showtext&quot;)) install.packages(&quot;showtext&quot;)

# packages
library(sf)
library(tidyverse)
library(ggtext)
library(circular)
library(geosphere)
library(RQGIS3)
library(showtext)
library(sysfonts)</code></pre>
</div>
<div id="initial-considerations" class="section level1">
<h1>Initial considerations</h1>
<p>Angles in vectorial lines are based on the angle between two vertices, and the number of vertices depends on the complexity, and therefore the resolution, of the vector data. Consequently, there can be differences in using different resolutions of a spatial line, either from the coast or from the river as in this example. A straight line is simply constructed with two points of longitude and latitude.</p>
<p>Related to this is fractality, an apparently irregular structure but that is repeated at different scales, known from coastlines or also from river. The most paradoxical feature is that the length of a coastline depends on the measurement scale, the smaller the measurement increment, the longer is the measured coastline.</p>
<p>There are two possibilities of obtaining the vertice angles. In the first one we calculate the angle between all consecutive vertices.</p>
<p>For example, imagine two points, Madrid (-3.71, 40.43) and Barcelona (2.14, 41.4).</p>
<p>What is the angle of a straight line between both cities?</p>
<pre class="r"><code>bearingRhumb(c(-3.71, 40.43), c(2.14, 41.4))</code></pre>
<pre><code>## [1] 77.62391</code></pre>
<p>We see that it is 77º, that is, northeast direction. But what if we go from Barcelona to Madrid?</p>
<pre class="r"><code>bearingRhumb(c(2.14, 41.4), c(-3.71, 40.43))</code></pre>
<pre><code>## [1] 257.6239</code></pre>
<p>The angle is different because we <em>move</em> from the northeast to the southwest. We can easily invert the direction to get the opposite angle.</p>
<pre class="r"><code># opposite angle of Barcelona -&gt; Madrid
bearingRhumb(c(2.14, 41.4), c(-3.71, 40.43)) - 180</code></pre>
<pre><code>## [1] 77.62391</code></pre>
<pre class="r"><code># opposite angle of Madrid -&gt; Barcelona
bearingRhumb(c(-3.71, 40.43), c(2.14, 41.4)) + 180</code></pre>
<pre><code>## [1] 257.6239</code></pre>
<p>The direction in which we calculate the angles is important. In the case of rivers, it is expected to be the direction of flow from origin to the mouth, however, a problem may be that the vertices, which build the lines, are not geographically ordered in the attribute table. Another problem may be that the vertices start at the mouth which would give the reverse angle as we have seen before.</p>
<p>However, there is an easier way. We can take advantage of the attributes of projected coordinate systems (Robinson projection, etc.) that include the angle between the vertices. We will use this last approach in this post. Still, we must pay close attention to the results as stated above.</p>
</div>
<div id="preparation" class="section level1">
<h1>Preparation</h1>
<div id="data" class="section level2">
<h2>Data</h2>
<p>We download the central lines of the largest rivers in the world (<a href="/files/RiverHRCenterlinesCombo.zip">here</a>), also accessible in <a href="https://www.sciencebase.gov/catalog/item/5a145fdde4b09fc93dcfd36c">Zeenatul Basher et al. 2018</a>.</p>
</div>
<div id="import-and-project" class="section level2">
<h2>Import and project</h2>
<p>The first thing we do is to import, project the spatial lines and delete the third dimension <em>Z</em>, chaining the following functions: <code>st_read()</code> helps us import any vector format, <code>st_zm()</code> delete the dimension Z or M of a geometry and <code>st_transform()</code> projects the vector data to the new projection in <em>proj4</em> format. We combine the functions with the famous pipe (<code>%&gt;%</code>) that facilitates the application of a sequence of functions on a data set, more details in this <a href="https://dominicroye.github.io/en/2020/a-very-short-introduction-to-tidyverse/">post</a>. All functions in the <code>sf</code> package start with <code>st_*</code> with reference to the spatial character, similar to <em>PostGIS</em>. In the same style as <em>PostGIS</em>, verbs are used as function names.</p>
<pre class="r"><code>proj_rob &lt;- &quot;+proj=robin +lon_0=0 +x_0=0 +y_0=0 +ellps=WGS84 +datum=WGS84 +units=m no_defs&quot;

river_line &lt;- st_read(&quot;RiverHRCenterlinesCombo.shp&quot;) %&gt;% 
                 st_zm() %&gt;% 
                    st_transform(proj_rob)</code></pre>
<pre><code>## Reading layer `RiverHRCenterlinesCombo&#39; from data source `C:\Users\xeo19\Documents\GitHub\blogR_update\content\post\en\2020-07-24-river-flow-directions\RiverHRCenterlinesCombo.shp&#39; using driver `ESRI Shapefile&#39;
## Simple feature collection with 78 features and 6 fields
## geometry type:  MULTILINESTRING
## dimension:      XYZ
## bbox:           xmin: -164.7059 ymin: -36.97094 xmax: 151.5931 ymax: 72.64474
## z_range:        zmin: 0 zmax: 0
## geographic CRS: WGS 84</code></pre>
</div>
<div id="extract-the-angles" class="section level2">
<h2>Extract the angles</h2>
<p>In the next step we have to extract the vertice angles. Unfortunately, as far as I know, it is not possible to extract the attributes with some function from the <code>sf</code> package. Although the function <code>st_coordinates()</code> returns the coordinates, it does not include other attributes. Therefore, we must use another way, and that is the open software Quantum GIS in which we can find a tool to extract all the vertice attributes. We could import the vector data into QGIS Desktop and export the vertices from there, but it is also possible to access the QGIS tools from R directly.</p>
<p>For this, we need to have QGIS installed in OSGeo4W. The <code>RQGIS3</code> package allows us to use very easily all the tools of the software in R. First we use the <code>set_env()</code> function to define all the necessary QGIS paths and start the API with <code>open_app()</code>.</p>
<pre class="r"><code># paths to QGIS
set_env()</code></pre>
<pre><code>## Trying to find QGIS in C:/OSGEO4~1</code></pre>
<pre><code>## $root
## [1] &quot;C:/OSGeo4W64&quot;
## 
## $qgis_prefix_path
## [1] &quot;C:/OSGeo4W64/apps/qgis&quot;
## 
## $python_plugins
## [1] &quot;C:/OSGeo4W64/apps/qgis/python/plugins&quot;
## 
## $platform
## [1] &quot;Windows&quot;</code></pre>
<pre class="r"><code># start of QGIS Python
open_app()</code></pre>
<p>The <code>find_algorithms()</code> function helps us to search for different QGIS tools. In addition the <code>get_usage()</code> function specifies the way of usage with all the required parameters.</p>
<pre class="r"><code># search tools
find_algorithms(search_term = &quot;vertices&quot;, name_only = TRUE)</code></pre>
<pre><code>## [1] &quot;native:extractspecificvertices&quot;         
## [2] &quot;native:extractvertices&quot;                 
## [3] &quot;native:filterverticesbym&quot;               
## [4] &quot;native:filterverticesbyz&quot;               
## [5] &quot;native:removeduplicatevertices&quot;         
## [6] &quot;saga:convertpolygonlineverticestopoints&quot;</code></pre>
<pre class="r"><code># usage of tool
get_usage(alg = &quot;native:extractvertices&quot;)</code></pre>
<pre><code>## Extract vertices (native:extractvertices)
## 
## This algorithm takes a line or polygon layer and generates a point layer with points representing the vertices in the input lines or polygons. The attributes associated to each point are the same ones associated to the line or polygon that the point belongs to.
## 
## Additional fields are added to the point indicating the vertex index (beginning at 0)
## the vertex’s part and its index within the part (as well as its ring for polygons)
## distance along original geometry and bisector angle of vertex for original geometry.
## 
## 
## ----------------
## Input parameters
## ----------------
## 
## INPUT: Input layer
## 
##  Parameter type: QgsProcessingParameterFeatureSource
## 
##  Accepted data types:
##      - str: layer ID
##      - str: layer name
##      - str: layer source
##      - QgsProcessingFeatureSourceDefinition
##      - QgsProperty
##      - QgsVectorLayer
## 
## OUTPUT: Vertices
## 
##  Parameter type: QgsProcessingParameterFeatureSink
## 
##  Accepted data types:
##      - str: destination vector file
## e.g. d:/test.shp
##      - str: memory: to store result in temporary memory layer
##      - str: using vector provider ID prefix and destination URI
## e.g. postgres:… to store result in PostGIS table
##      - QgsProcessingOutputLayerDefinition
##      - QgsProperty
## 
## ----------------
## Outputs
## ----------------
## 
## OUTPUT:  &lt;QgsProcessingOutputVectorLayer&gt;
##  Vertices</code></pre>
<p>In our case the tool to extract the vertices is simple and only has one input and one output. The function <code>run_qgis()</code> executes a QGIS tool indicating the algorithm and its arguments. The advantage of using the algorithm directly from R is that we can pass objects of class <code>sf</code> (or <code>sp</code>) and <code>raster</code> that we have imported or created in R. As output we create a <code>geojson</code>, it could also be of another vector format, and we save it in a temporary folder. At the same time we indicate to import the result directly into R (<code>load_output = TRUE</code>).</p>
<pre class="r"><code>river_vertices &lt;- run_qgis(alg = &quot;native:extractvertices&quot;,
               INPUT = river_line,
               OUTPUT = file.path(tempdir(), &quot;rivers_world_vertices.geojson&quot;),
               load_output = TRUE)</code></pre>
<pre><code>## $OUTPUT
## [1] &quot;C:/Users/xeo19/AppData/Local/Temp/RtmpYb53tP/rivers_world_vertices.geojson&quot;</code></pre>
<p><div class="alert alert-note">
  
Currently on Windows there seem to be problems with the <em>proj</em> library. In principle, if the function ends up creating the <code>river_vertices</code> object, you should not worry. Otherwise, I recommend looking at the discussion in the issue opened at <a href="https://github.com/r-spatial/RQGIS3/issues/20">gitbub</a>.

</div>
</p>
</div>
<div id="selection" class="section level2">
<h2>Selection</h2>
<p>Before continuing with the distribution estimation of the angles, we filter some rivers of interest. The functions of the <code>tidyverse</code> collection are compatible with the <code>sf</code> package. In the last post I made an introduction to <code>tidyverse</code> <a href="https://dominicroye.github.io/en/2020/a-very-short-introduction-to-tidyverse/">here</a>.</p>
<pre class="r"><code>river_vertices &lt;-  filter(river_vertices, 
                          NAME %in% c(&quot;Mississippi&quot;, &quot;Colorado&quot;, 
                                      &quot;Amazon&quot;, &quot;Nile&quot;, &quot;Orange&quot;, 
                                      &quot;Ganges&quot;, &quot;Yangtze&quot;, &quot;Danube&quot;,
                                      &quot;Mackenzie&quot;, &quot;Lena&quot;, &quot;Murray&quot;, 
                                      &quot;Niger&quot;)
                          ) 

river_vertices </code></pre>
<pre><code>## Simple feature collection with 94702 features and 11 fields
## geometry type:  POINT
## dimension:      XY
## bbox:           xmin: -10377520 ymin: -3953778 xmax: 13124340 ymax: 7507359
## geographic CRS: WGS 84</code></pre>
<pre><code>## Warning in st_is_longlat(x): bounding box has potentially an invalid value range
## for longlat data

## Warning in st_is_longlat(x): bounding box has potentially an invalid value range
## for longlat data</code></pre>
<pre><code>## # A tibble: 94,702 x 12
##    NAME  SYSTEM name_alt scalerank rivernum Length_km vertex_index vertex_part
##  * &lt;chr&gt; &lt;chr&gt;  &lt;chr&gt;        &lt;dbl&gt;    &lt;dbl&gt;     &lt;dbl&gt;        &lt;int&gt;       &lt;int&gt;
##  1 Nile  &lt;NA&gt;   &lt;NA&gt;             1        4     3344.            0           0
##  2 Nile  &lt;NA&gt;   &lt;NA&gt;             1        4     3344.            1           0
##  3 Nile  &lt;NA&gt;   &lt;NA&gt;             1        4     3344.            2           0
##  4 Nile  &lt;NA&gt;   &lt;NA&gt;             1        4     3344.            3           0
##  5 Nile  &lt;NA&gt;   &lt;NA&gt;             1        4     3344.            4           0
##  6 Nile  &lt;NA&gt;   &lt;NA&gt;             1        4     3344.            5           0
##  7 Nile  &lt;NA&gt;   &lt;NA&gt;             1        4     3344.            6           0
##  8 Nile  &lt;NA&gt;   &lt;NA&gt;             1        4     3344.            7           0
##  9 Nile  &lt;NA&gt;   &lt;NA&gt;             1        4     3344.            8           0
## 10 Nile  &lt;NA&gt;   &lt;NA&gt;             1        4     3344.            9           0
## # ... with 94,692 more rows, and 4 more variables: vertex_part_index &lt;int&gt;,
## #   distance &lt;dbl&gt;, angle &lt;dbl&gt;, geometry &lt;POINT [°]&gt;</code></pre>
</div>
</div>
<div id="estimate-the-distribution" class="section level1">
<h1>Estimate the distribution</h1>
<p>To visualize the distribution we can use either a histogram or a density graph. But in the case of estimating the probability density function, we find a mathematical problem when applying it to circular data. For circular data we should not use the <code>density()</code> standard function of R since in our data a direction of 360º is the same at 0º, which would cause errors in this range of values. It is a general problem for different statistical metrics. More statistical details are explained in the <code>circular</code> package. This package allows you to define the characteristics of circular data (unit, data type, rotation, etc.) as an object class in R.</p>
<p>So what we do is to build a function that estimates the density and returns a table with the angles (x) and the density estimates (y). Since rivers have different lengths, and we want to see differences regardless of that, we normalize the estimates using the maximum value. Unlike the <code>density()</code> function, in which the smoothing bandwidth <code>bw</code> is optimized, here it is required to indicate it manually. It is similar to defining the bar width in a histogram. There is an optimization function for the bandwidth, <code>bw.nrd.circular()</code> that could be used here.</p>
<pre class="r"><code>dens_circ &lt;- function(x){
  
  dens &lt;- density.circular(circular(x$angle, units = &quot;degrees&quot;),
                                     bw = 70, kernel = &quot;vonmises&quot;,
                                     control.circular = list(units = &quot;degrees&quot;))
  
  df &lt;- data.frame(x = dens$x, y = dens$y/max(dens$y))
  
  return(df)
  
}</code></pre>
<p>Finally, we estimate the density of each river in our selection. We use the <code>split()</code> function of R Base to get a table of each river in a list object. Then we apply our density estimation function to the list with the function <code>map_df()</code> from the <code>purrr</code> package. The suffix <code>_df</code> allows us to get a joined table, instead of a list with the results of each river. However, it is necessary to indicate the name of the column with the argument <code>.id</code>, which will contain the name of each river. Otherwise we would not know how to differentiate the results. Also here I recommend reading more details in the last post about <code>tidyverse</code> <a href="https://dominicroye.github.io/en/2020/a-very-short-introduction-to-tidyverse/">here</a>.</p>
<pre class="r"><code>dens_river &lt;- split(river_vertices, river_vertices$NAME) %&gt;% 
                  map_df(dens_circ, .id = &quot;river&quot;)

# results
head(dens_river)</code></pre>
<pre><code>##    river        x         y
## 1 Amazon 0.000000 0.2399907
## 2 Amazon 0.704501 0.2492548
## 3 Amazon 1.409002 0.2585758
## 4 Amazon 2.113503 0.2679779
## 5 Amazon 2.818004 0.2774859
## 6 Amazon 3.522505 0.2871232</code></pre>
</div>
<div id="visualization" class="section level1">
<h1>Visualization</h1>
<p>Now we only have to make the graph through the famous <code>ggplot</code> package. First we add a new font <em>Montserrat</em> for it use in this plot.</p>
<pre class="r"><code># font download
font_add_google(&quot;Montserrat&quot;, &quot;Montserrat&quot;)

# use of showtext
showtext_opts(dpi = 200)
showtext_auto() </code></pre>
<p>In the next step we create two objects with the title and the plot caption. In the title we are using an html code to color part of the text instead of a legend. You can use html very easily with the <code>ggtext</code> package.</p>
<pre class="r"><code># title with html
title &lt;- &quot;Relative distribution of river &lt;span style=&#39;color:#011FFD;&#39;&gt;&lt;strong&gt;flow direction&lt;/strong&gt;&lt;/span&gt; in the world&quot;


caption &lt;- &quot;Based on data from Zeenatul Basher, 20180215&quot;</code></pre>
<p>The background grid that creates <code>ggplot</code> by default for polar coordinates did not convince me, so we create a table with x axis background lines.</p>
<pre class="r"><code>grid_x &lt;- tibble(x = seq(0, 360 - 22.5, by = 22.5), 
                 y = rep(0, 16), 
                 xend = seq(0, 360 - 22.5, by = 22.5), 
                 yend = rep(Inf, 16))</code></pre>
<p>Next we define all the styles of the graph. The most important thing in this step is the <code>element_textbox()</code> function of the <code>ggtext</code> package to be able to interpret our html code incorporated into the title.</p>
<pre class="r"><code>theme_polar &lt;- theme_minimal() +
               theme(axis.title.y = element_blank(),
                     axis.text.y = element_blank(),
                     legend.title = element_blank(),
                     plot.title = element_textbox(family = &quot;Montserrat&quot;, 
                                                   hjust = 0.5, 
                                                   colour = &quot;white&quot;, 
                                                   size = 15),
                     plot.caption = element_text(family = &quot;Montserrat&quot;, 
                                                 colour = &quot;white&quot;),
                     axis.text.x = element_text(family = &quot;Montserrat&quot;, 
                                                 colour = &quot;white&quot;),
                     strip.text = element_text(family = &quot;Montserrat&quot;, 
                                               colour = &quot;white&quot;, 
                                               face = &quot;bold&quot;),
                     panel.background = element_rect(fill = &quot;black&quot;),
                     plot.background = element_rect(fill = &quot;black&quot;),
                     panel.grid = element_blank()
                    )</code></pre>
<p>Finally we build the graph: 1) We use the <code>geom_hline()</code> function with different y intersection points to create the background grid. The <code>geom_segment()</code> function creates the x grid. 2) We create the density area using the <code>geom_area()</code> function. 3) In <code>scale_x_continous()</code> we define a negative lower limit so that it does not collapse at a small point. The labels of the eight main directions are indicated in the <code>scale_y_continous()</code> function, and 4) Finally, we change to a polar coordinate system and set the variable to create facets.</p>
<pre class="r"><code>ggplot() +
  geom_hline(yintercept = c(0, .2, .6, .8, 1), colour = &quot;white&quot;) +
  geom_segment(data = grid_x , 
               aes(x = x, y = y, xend = xend, yend = yend), 
               linetype = &quot;dashed&quot;, col = &quot;white&quot;) +
  geom_area(data = dens_river, 
            aes(x = x, y = y, ymin = 0, ymax = y), 
            alpha = .7, 
            colour = NA, 
            show.legend = FALSE,
            fill = &quot;#011FFD&quot;) + 
  scale_y_continuous(limits = c(-.2, 1), expand = c(0, 0)) +
  scale_x_continuous(limits = c(0, 360), 
                     breaks = seq(0, 360 - 22.5, by = 22.5),
                     minor_breaks = NULL,
                     labels = c(&quot;N&quot;, &quot;&quot;, &quot;NE&quot;, &quot;&quot;, &quot;E&quot;, &quot;&quot;, &quot;SE&quot;, &quot;&quot;,
                                &quot;S&quot;, &quot;&quot;, &quot;SW&quot;, &quot;&quot;, &quot;W&quot;, &quot;&quot;, &quot;NW&quot;, &quot;&quot;)) +
  coord_polar() + 
  facet_wrap(river ~ ., ncol = 4) +
  labs(title = title, caption = caption, x = &quot;&quot;) +
  theme_polar</code></pre>
<pre><code>## Warning: Ignoring unknown aesthetics: ymin, ymax</code></pre>
<p><img src="/post/en/2020-07-24-river-flow-directions/index.en_files/figure-html/unnamed-chunk-19-1.png" width="672" /></p>
</div>

    </div>

    


<div class="article-tags">
  
  <a class="badge badge-light" href="/en/tags/directions/">directions</a>
  
  <a class="badge badge-light" href="/en/tags/river/">river</a>
  
  <a class="badge badge-light" href="/en/tags/fluvial/">fluvial</a>
  
  <a class="badge badge-light" href="/en/tags/orientation/">orientation</a>
  
  <a class="badge badge-light" href="/en/tags/distribution/">distribution</a>
  
</div>



    






<div class="media author-card" itemscope itemtype="http://schema.org/Person">
  
  <img class="portrait mr-3" src="/img/potrai_domi.jpg" itemprop="image" alt="Avatar">
  
  <div class="media-body">
    <h5 class="card-title" itemprop="name"><a href="/en/">Dr. Dominic Royé</a></h5>
    
    
    <ul class="network-icon" aria-hidden="true">
      
      
      
      
      
      
      
      
      <li>
        <a itemprop="sameAs" href="mailto:dominic.roye@usc.es" >
          <i class="fa fa-envelope"></i>
        </a>
      </li>
      
      
      
      
        
      
      
      
      
      
        
      
      <li>
        <a itemprop="sameAs" href="//twitter.com/dr_xeo" >
          <i class="fab fa-twitter"></i>
        </a>
      </li>
      
      
      
      
      
      
      
      
        
      
      <li>
        <a itemprop="sameAs" href="https://www.researchgate.net/profile/Dominic_Roye" target="_blank" rel="noopener">
          <i class="ai ai-researchgate"></i>
        </a>
      </li>
      
      
      
      
        
      
      
      
      
      
        
      
      <li>
        <a itemprop="sameAs" href="//github.com/dominicroye" >
          <i class="fab fa-github"></i>
        </a>
      </li>
      
    </ul>
  </div>
</div>




    
    

    
    <div class="article-widget">
      <div class="post-nav">
  
  <div class="post-nav-item">
    <div class="meta-nav">Next</div>
    <a href="https://dominicroye.github.io/en/2020/climate-animation-of-maximum-temperatures/" rel="next">Climate animation of maximum temperatures</a>
  </div>
  
  
  <div class="post-nav-item">
    <div class="meta-nav">Previous</div>
    <a href="https://dominicroye.github.io/en/2020/a-very-short-introduction-to-tidyverse/" rel="prev">A very short introduction to Tidyverse</a>
  </div>
  
</div>

    </div>
    

    
<section id="comments">
  <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "https-dominicroye-github-io" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</section>



  </div>
</article>

<div class="container">
  <footer class="site-footer">
  

  <p class="powered-by">
    &copy; 2018-2021 Dominic Royé. All rights reserved. &middot; 

    Powered by the
    <a href="https://sourcethemes.com/academic/" target="_blank" rel="noopener">Academic theme</a> for
    <a href="https://gohugo.io" target="_blank" rel="noopener">Hugo</a>.

    
    <span class="float-right" aria-hidden="true">
      <a href="#" id="back_to_top">
        <span class="button_icon">
          <i class="fas fa-chevron-up fa-2x"></i>
        </span>
      </a>
    </span>
    
  </p>
</footer>

</div>


<div id="modal" class="modal fade" role="dialog">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Cite</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <pre><code class="tex hljs"></code></pre>
      </div>
      <div class="modal-footer">
        <a class="btn btn-outline-primary my-1 js-copy-cite" href="#" target="_blank">
          <i class="fas fa-copy"></i> Copy
        </a>
        <a class="btn btn-outline-primary my-1 js-download-cite" href="#" target="_blank">
          <i class="fas fa-download"></i> Download
        </a>
        <div id="modal-error"></div>
      </div>
    </div>
  </div>
</div>

    

    
    

    
    
    
      <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha512-+NqPlbbtM1QqiK8ZAo4Yrj2c4lNQoGv8P79DPtKzj++l5jnN39rHA/xsqn8zE9l0uSoxaCdrOgFs6yjyfbBxSg==" crossorigin="anonymous"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.imagesloaded/4.1.3/imagesloaded.pkgd.min.js" integrity="sha512-umsR78NN0D23AzgoZ11K7raBD+R6hqKojyBZs1w8WvYlsI+QuKRGBx3LFCwhatzBunCjDuJpDHwxD13sLMbpRA==" crossorigin="anonymous"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha256-VsEqElsCHSGmnmHXGQzvoWjWwoznFSZc6hs7ARLRacQ=" crossorigin="anonymous"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.isotope/3.0.4/isotope.pkgd.min.js" integrity="sha512-VDBOIlDbuC4VWxGJNmuFRQ0Li0SKkDpmGyuhAG5LTDLd/dJ/S0WMVxriR2Y+CyPL5gzjpN4f/6iqWVBJlht0tQ==" crossorigin="anonymous"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.2.5/jquery.fancybox.min.js" integrity="sha256-X5PoE3KU5l+JcX+w09p/wHl9AzK333C4hJ2I9S5mD4M=" crossorigin="anonymous"></script>

      
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js" integrity="sha256-/BfiIkHlHoVihZdc6TFuj7MmJ0TWcWsMXkeDFwhi0zw=" crossorigin="anonymous"></script>
        
        <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/r.min.js"></script>
        
      

      
      
    

    
    

    
    
    
    <script id="dsq-count-scr" src="//https-dominicroye-github-io.disqus.com/count.js" async></script>
    

    
    
    <script>hljs.initHighlightingOnLoad();</script>
    

    

    
    

    

    
    

    
    

    
    
    
    
    
    
    
    
    <script src="/js/academic.min.d037ee5294b166a79dec317c58aea9cc.js"></script>

    

  </body>
</html>

