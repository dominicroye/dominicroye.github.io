<!DOCTYPE html><html lang="en-us" >


<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  
  
  
    <meta name="generator" content="Wowchemy 5.3.0 for Hugo" />
  

  
  









  




  
  
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  

  
  
  
    
      
      <link rel="preload" as="style" href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Roboto+Mono&family=Roboto:wght@400;700&display=swap">
      <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Roboto+Mono&family=Roboto:wght@400;700&display=swap" media="print" onload="this.media='all'">
    
  

  
  
  
  
  
    
    
    
  
  

  <meta name="author" content="Dr. Dominic Royé" />

  
  
  
    
  
  <meta name="description" content="I recently created a visualization of the distribution of river flow directions and also of coastal orientations. Following its publication in social networks, I was asked to make a post about how I did it. Well, here we go to start with an example of rivers, coastal orientation is somewhat more complex." />

  
  <link rel="alternate" hreflang="en-us" href="https://dominicroye.github.io/en/2020/river-flow-directions/" />

  
  
  
    <meta name="theme-color" content="#1565c0" />
  

  
  

  

  <link rel="stylesheet" href="/css/vendor-bundle.min.f1ecf783c14edc00c9320c205831ad8e.css" media="print" onload="this.media='all'">

  
  
  
    
    
      <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/academicons@1.9.1/css/academicons.min.css" integrity="sha512-W0xM4mr6dEP9nREo7Z9z+9X70wytKvMGeDsj7ps2+xg5QPrEBXC8tAW1IFnzjR6eoJ90JmCnFzerQJTLzIEHjA==" crossorigin="anonymous" media="print" onload="this.media='all'">
    

    
    
    
    
      
      
    
    
    

    
    
    
      
    
    
      
      
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@10.2.1/build/styles/dracula.min.css" crossorigin="anonymous" title="hl-light" media="print" onload="this.media='all'">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@10.2.1/build/styles/dracula.min.css" crossorigin="anonymous" title="hl-dark" media="print" onload="this.media='all'" disabled>
      
    

    
    
    
      <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.7.1/dist/leaflet.min.css" integrity="" crossorigin="anonymous" media="print" onload="this.media='all'">
    

    

    
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      
        
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
  

  
  
  
  
  
  <link rel="stylesheet" href="/css/wowchemy.b48d89910a3f8560bb2d78fedea8d682.css" />

  




<script async src="https://www.googletagmanager.com/gtag/js?id=UA-27463794-2"></script>
<script>
  window.dataLayer = window.dataLayer || [];

  function gtag() {
      dataLayer.push(arguments);
  }

  function trackOutboundLink(url, target) {
    gtag('event', 'click', {
         'event_category': 'outbound',
         'event_label': url,
         'transport_type': 'beacon',
         'event_callback': function () {
           if (target !== '_blank') {
             document.location = url;
           }
         }
    });
    console.debug("Outbound link clicked: " + url);
  }

  function onClickCallback(event) {
    if ((event.target.tagName !== 'A') || (event.target.host === window.location.host)) {
      return;
    }
    trackOutboundLink(event.target, event.target.getAttribute('target'));  
  }

  gtag('js', new Date());
  gtag('config', 'UA-27463794-2', {});
  gtag('set', {'cookie_flags': 'SameSite=None;Secure'});

  
  document.addEventListener('click', onClickCallback, false);
</script>


  

  

  




  
  
  

  

  
    <link rel="manifest" href="/en/manifest.webmanifest" />
  

  <link rel="icon" type="image/png" href="/media/icon_hu27cb63416a395b8c8d0d7112b85e26a9_17299_32x32_fill_lanczos_center_3.png" />
  <link rel="apple-touch-icon" type="image/png" href="/media/icon_hu27cb63416a395b8c8d0d7112b85e26a9_17299_180x180_fill_lanczos_center_3.png" />

  <link rel="canonical" href="https://dominicroye.github.io/en/2020/river-flow-directions/" />

  
  
  
  
  
  
  
  
    
  
  

  
  
    
    
  
  <meta property="twitter:card" content="summary_large_image" />
  
    <meta property="twitter:site" content="@@dr_xeo" />
    <meta property="twitter:creator" content="@@dr_xeo" />
  
  <meta property="og:site_name" content="Dr. Dominic Royé" />
  <meta property="og:url" content="https://dominicroye.github.io/en/2020/river-flow-directions/" />
  <meta property="og:title" content="River flow directions | Dr. Dominic Royé" />
  <meta property="og:description" content="I recently created a visualization of the distribution of river flow directions and also of coastal orientations. Following its publication in social networks, I was asked to make a post about how I did it. Well, here we go to start with an example of rivers, coastal orientation is somewhat more complex." /><meta property="og:image" content="https://dominicroye.github.io/en/2020/river-flow-directions/featured.jpg" />
    <meta property="twitter:image" content="https://dominicroye.github.io/en/2020/river-flow-directions/featured.jpg" /><meta property="og:locale" content="en-us" />
  
    
      <meta
        property="article:published_time"
        content="2020-07-24T00:00:00&#43;00:00"
      />
    
    <meta property="article:modified_time" content="2020-07-24T00:00:00&#43;00:00">
  

  


    






  




<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://dominicroye.github.io/en/2020/river-flow-directions/"
  },
  "headline": "River flow directions",
  
  "image": [
    "https://dominicroye.github.io/en/2020/river-flow-directions/featured.jpg"
  ],
  
  "datePublished": "2020-07-24T00:00:00Z",
  "dateModified": "2020-07-24T00:00:00Z",
  
  "author": {
    "@type": "Person",
    "name": "Dr. Dominic Royé"
  },
  
  "publisher": {
    "@type": "Organization",
    "name": "University of Santiago de Compostela",
    "logo": {
      "@type": "ImageObject",
      "url": "https://dominicroye.github.io/media/logo_hu6637600e1c36fe7812a10a6623aaebda_116520_192x192_fit_lanczos_3.png"
    }
  },
  "description": "I recently created a visualization of the distribution of river flow directions and also of coastal orientations. Following its publication in social networks, I was asked to make a post about how I did it. Well, here we go to start with an example of rivers, coastal orientation is somewhat more complex."
}
</script>

  

  

  

  





  <title>River flow directions | Dr. Dominic Royé</title>
</head>


<body id="top" data-spy="scroll" data-offset="70" data-target="#TableOfContents" class="page-wrapper   " data-wc-page-id="9d75b104d90d7166a22838092da8ff2d" >

  
  
  
  
  
  
  
  
  
  <script src="/js/wowchemy-init.min.2da3b1fa37e894630bf6de39b1b694b3.js"></script>

  




  <div class="page-header">
    







 



  


<header class="header--fixed">
  <nav class="navbar navbar-expand-lg navbar-light compensate-for-scrollbar" id="navbar-main">
    <div class="container-xl">

      
      <div class="d-none d-lg-inline-flex">
        <a class="navbar-brand" href="/en/"><img src="/media/logo_hu6637600e1c36fe7812a10a6623aaebda_116520_0x70_resize_lanczos_3.png" alt="Dr. Dominic Royé"
            
            >
             <div style = "padding-top:0.5em;">Dr. Dominic Royé</div></a>
      </div>
      

      
      <button type="button" class="navbar-toggler" data-toggle="collapse"
              data-target="#navbar-content" aria-controls="navbar-content" aria-expanded="false" aria-label="Toggle navigation">
      <span><i class="fas fa-bars"></i></span>
      </button>
      

      
      <div class="navbar-brand-mobile-wrapper d-inline-flex d-lg-none">
        <a class="navbar-brand" href="/en/"><img src="/media/logo_hu6637600e1c36fe7812a10a6623aaebda_116520_0x70_resize_lanczos_3.png" alt="Dr. Dominic Royé"
          
          ></a>
      </div>
      

      
      
      <div class="navbar-collapse main-menu-item collapse justify-content-end" id="navbar-content">

        
        <ul class="navbar-nav d-md-inline-flex">
          

          

          
          
          

          

          
          
          
          

          
            
            
          

          <li class="nav-item">
            <a class="nav-link " href="/en/#"><span>home</span></a>
          </li>

          
          

          

          
          
          
            
          

          

          
          
          
          

          
            
              
              
            
            
              
              
              
                
              
              
            
          

          <li class="nav-item">
            <a class="nav-link " href="/en/#posts"><span>blog</span></a>
          </li>

          
          

          

          
          
          
            
          

          

          
          
          
          

          
            
              
              
            
            
              
              
              
                
              
              
            
          

          <li class="nav-item">
            <a class="nav-link " href="/en/#featured"><span>publications</span></a>
          </li>

          
          

          

          
          
          
            
          

          

          
          
          
          

          
            
              
              
            
            
              
              
              
                
              
              
            
          

          <li class="nav-item">
            <a class="nav-link " href="/en/#projects"><span>graphs</span></a>
          </li>

          
          

          

          
          
          
            
          

          

          
          
          
          

          
            
              
              
            
            
              
              
              
                
              
              
            
          

          <li class="nav-item">
            <a class="nav-link " href="/en/#about"><span>me</span></a>
          </li>

          
          

        

          
        </ul>
      </div>

      <ul class="nav-icons navbar-nav flex-row ml-auto d-flex pl-md-2">

        
        
          
            
            <li class="nav-item d-none d-lg-inline-flex">
              <a class="nav-link" href="https://twitter.com/dr_xeo" data-toggle="tooltip" data-placement="bottom" title="Follow me on Twitter" target="_blank" rel="noopener" aria-label="Follow me on Twitter">
                <i class="fab fa-twitter" aria-hidden="true"></i>
              </a>
            </li>
          
        

        
        

        
        

        
        

      </ul>

    </div>
  </nav>
</header>


  </div>

  <div class="page-body">
    <article class="article">

  




















  
  
    
  


<div class="article-container pt-3">
  <h1>River flow directions</h1>

  

  


<div class="article-metadata">

  
  

  
  <span class="article-date">
    
    
      
    
    2020-07-24
  </span>
  

  

  
  <span class="middot-divider"></span>
  <span class="article-reading-time">
    14 min read
  </span>
  

  
  
  
  
  
  

  
  
  <span class="middot-divider"></span>
  <span class="article-categories">
    <i class="fas fa-folder mr-1"></i><a href="/en/category/gis/">gis</a>, <a href="/en/category/r/">R</a>, <a href="/en/category/radvanced/">R:advanced</a></span>
  

</div>

  





</div>


<div class="article-header article-container featured-image-wrapper mt-4 mb-4" style="max-width: 720px; max-height: 670px;">
  <div style="position: relative">
    <img src="/en/2020/river-flow-directions/featured_hu6f0ab3e4def1f473c5ed71797e177e68_651656_720x0_resize_q75_lanczos.jpg" width="720" height="670" alt="" class="featured-image">
    
  </div>
</div>



  <div class="article-container">

    <div class="article-style">
      
<script src="https://dominicroye.github.io/en/2020/river-flow-directions/index.en_files/header-attrs/header-attrs.js"></script>


<p>I recently created a visualization of the distribution of river flow directions and also of coastal orientations. Following its publication in social networks (<a href="%5Btweet%5D(https://twitter.com/dr_xeo/status/1277978724034465798?s=20)">here</a>), I was asked to make a post about how I did it. Well, here we go to start with an example of rivers, coastal orientation is somewhat more complex. I did the same for a selection of European rivers here in this <a href="https://twitter.com/dr_xeo/status/1277243216828473345?s=20">tweet</a>. However, originally I started with the orientation of the European coasts.</p>
<p><blockquote class="twitter-tweet"><p lang="en" dir="ltr">Have you ever wondered where the European <a href="https://twitter.com/hashtag/coasts?src=hash&amp;ref_src=twsrc%5Etfw">#coasts</a> are oriented? <a href="https://twitter.com/hashtag/rstats?src=hash&amp;ref_src=twsrc%5Etfw">#rstats</a> <a href="https://twitter.com/hashtag/ggplot2?src=hash&amp;ref_src=twsrc%5Etfw">#ggplot2</a> <a href="https://twitter.com/hashtag/geography?src=hash&amp;ref_src=twsrc%5Etfw">#geography</a> <a href="https://twitter.com/hashtag/dataviz?src=hash&amp;ref_src=twsrc%5Etfw">#dataviz</a> <a href="https://t.co/tpWVxSoHlw">pic.twitter.com/tpWVxSoHlw</a></p>&mdash; Dr. Dominic Royé (@dr_xeo) <a href="https://twitter.com/dr_xeo/status/1265286552525180929?ref_src=twsrc%5Etfw">May 26, 2020</a></blockquote>
<script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
</p>
<div id="packages" class="section level2">
<h2>Packages</h2>
<p>In this post we will use the following packages:</p>
<table>
<colgroup>
<col width="12%" />
<col width="87%" />
</colgroup>
<thead>
<tr class="header">
<th align="left">Packages</th>
<th align="left">Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">tidyverse</td>
<td align="left">Collection of packages (visualization, manipulation): ggplot2, dplyr, purrr, etc.</td>
</tr>
<tr class="even">
<td align="left">remotes</td>
<td align="left">Installation from remote repositories</td>
</tr>
<tr class="odd">
<td align="left">qgisprocess</td>
<td align="left">Interface between R and QGIS</td>
</tr>
<tr class="even">
<td align="left">sf</td>
<td align="left">Simple Feature: import, export and manipulate vector data</td>
</tr>
<tr class="odd">
<td align="left">ggtext</td>
<td align="left">Improved text rendering support for ggplot2</td>
</tr>
<tr class="even">
<td align="left">sysfonts</td>
<td align="left">Load fonts in R</td>
</tr>
<tr class="odd">
<td align="left">showtext</td>
<td align="left">Use fonts more easily in R graphs</td>
</tr>
<tr class="even">
<td align="left">circular</td>
<td align="left">Functions for working with circular data</td>
</tr>
<tr class="odd">
<td align="left">geosphere</td>
<td align="left">Spherical trigonometry for geographic applications</td>
</tr>
</tbody>
</table>
<p>In the case of the <code>qgisprocess</code> package, it is necessary to install QIGS &gt;= 3.16 <a href="https://download.qgis.org/">here</a>. I will explain the reason for using QGIS later.</p>
<pre class="r"><code># install the packages if necessary
if(!require(&quot;tidyverse&quot;)) install.packages(&quot;tidyverse&quot;)
if(!require(&quot;remotes&quot;)) install.packages(&quot;remotes&quot;)
if(!require(&quot;qgisprocess&quot;)) remotes::install_github(&quot;paleolimbot/qgisprocess&quot;)
if(!require(&quot;sf&quot;)) install.packages(&quot;sf&quot;)
if(!require(&quot;ggtext&quot;)) install.packages(&quot;ggtext&quot;)
if(!require(&quot;circular&quot;)) install.packages(&quot;circular&quot;)
if(!require(&quot;geosphere&quot;)) install.packages(&quot;geosphere&quot;)
if(!require(&quot;sysfonts&quot;)) install.packages(&quot;sysfonts&quot;)
if(!require(&quot;showtext&quot;)) install.packages(&quot;showtext&quot;)

# packages
library(sf)
library(tidyverse)
library(ggtext)
library(circular)
library(geosphere)
library(qgisprocess)
library(showtext)
library(sysfonts)</code></pre>
</div>
<div id="initial-considerations" class="section level1">
<h1>Initial considerations</h1>
<p>Angles in vectorial lines are based on the angle between two vertices, and the number of vertices depends on the complexity, and therefore the resolution, of the vector data. Consequently, there can be differences in using different resolutions of a spatial line, either from the coast or from the river as in this example. A straight line is simply constructed with two points of longitude and latitude.</p>
<p>Related to this is fractality, an apparently irregular structure but that is repeated at different scales, known from coastlines or also from river. The most paradoxical feature is that the length of a coastline depends on the measurement scale, the smaller the measurement increment, the longer is the measured coastline.</p>
<p>There are two possibilities of obtaining the vertice angles. In the first one we calculate the angle between all consecutive vertices.</p>
<p>For example, imagine two points, Madrid (-3.71, 40.43) and Barcelona (2.14, 41.4).</p>
<p>What is the angle of a straight line between both cities?</p>
<pre class="r"><code>bearingRhumb(c(-3.71, 40.43), c(2.14, 41.4))</code></pre>
<pre><code>## [1] 77.62391</code></pre>
<p>We see that it is 77º, that is, northeast direction. But what if we go from Barcelona to Madrid?</p>
<pre class="r"><code>bearingRhumb(c(2.14, 41.4), c(-3.71, 40.43))</code></pre>
<pre><code>## [1] 257.6239</code></pre>
<p>The angle is different because we <em>move</em> from the northeast to the southwest. We can easily invert the direction to get the opposite angle.</p>
<pre class="r"><code># opposite angle of Barcelona -&gt; Madrid
bearingRhumb(c(2.14, 41.4), c(-3.71, 40.43)) - 180</code></pre>
<pre><code>## [1] 77.62391</code></pre>
<pre class="r"><code># opposite angle of Madrid -&gt; Barcelona
bearingRhumb(c(-3.71, 40.43), c(2.14, 41.4)) + 180</code></pre>
<pre><code>## [1] 257.6239</code></pre>
<p>The direction in which we calculate the angles is important. In the case of rivers, it is expected to be the direction of flow from origin to the mouth, however, a problem may be that the vertices, which build the lines, are not geographically ordered in the attribute table. Another problem may be that the vertices start at the mouth which would give the reverse angle as we have seen before.</p>
<p>However, there is an easier way. We can take advantage of the attributes of projected coordinate systems (Robinson projection, etc.) that include the angle between the vertices. We will use this last approach in this post. Still, we must pay close attention to the results as stated above.</p>
</div>
<div id="preparation" class="section level1">
<h1>Preparation</h1>
<div id="data" class="section level2">
<h2>Data</h2>
<p>We download the central lines of the largest rivers in the world (<a href="/files/RiverHRCenterlinesCombo.zip">here</a>), also accessible in <a href="https://www.sciencebase.gov/catalog/item/5a145fdde4b09fc93dcfd36c">Zeenatul Basher et al. 2018</a>.</p>
</div>
<div id="import-and-project" class="section level2">
<h2>Import and project</h2>
<p>The first thing we do is to import, project the spatial lines and delete the third dimension <em>Z</em>, chaining the following functions: <code>st_read()</code> helps us import any vector format, <code>st_zm()</code> delete the dimension Z or M of a geometry and <code>st_transform()</code> projects the vector data to the new projection in <em>proj4</em> format. We combine the functions with the famous pipe (<code>%&gt;%</code>) that facilitates the application of a sequence of functions on a data set, more details in this <a href="https://dominicroye.github.io/en/2020/a-very-short-introduction-to-tidyverse/">post</a>. All functions in the <code>sf</code> package start with <code>st_*</code> with reference to the spatial character, similar to <em>PostGIS</em>. In the same style as <em>PostGIS</em>, verbs are used as function names.</p>
<pre class="r"><code>proj_rob &lt;- &quot;+proj=robin +lon_0=0 +x_0=0 +y_0=0 +ellps=WGS84 +datum=WGS84 +units=m no_defs&quot;

river_line &lt;- st_read(&quot;RiverHRCenterlinesCombo.shp&quot;) %&gt;% 
                 st_zm() %&gt;% 
                    st_transform(proj_rob)</code></pre>
<pre><code>## Reading layer `RiverHRCenterlinesCombo&#39; from data source 
##   `E:\GitHub\blog_update_2021\content\en\post\2020-07-24-river-flow-directions\RiverHRCenterlinesCombo.shp&#39; 
##   using driver `ESRI Shapefile&#39;
## Simple feature collection with 78 features and 6 fields
## Geometry type: MULTILINESTRING
## Dimension:     XYZ
## Bounding box:  xmin: -164.7059 ymin: -36.97094 xmax: 151.5931 ymax: 72.64474
## z_range:       zmin: 0 zmax: 0
## Geodetic CRS:  WGS 84</code></pre>
</div>
<div id="extract-the-angles" class="section level2">
<h2>Extract the angles</h2>
<p>In the next step we have to extract the vertice angles. Unfortunately, as far as I know, it is not possible to extract the attributes with some function from the <code>sf</code> package. Although the function <code>st_coordinates()</code> returns the coordinates, it does not include other attributes. Therefore, we must use another way, and that is the open software Quantum GIS in which we can find a tool to extract all the vertice attributes. We could import the vector data into QGIS Desktop and export the vertices from there, but it is also possible to access the QGIS tools from R directly.</p>
<p>For this, we need to have QGIS installed. The <code>qgisprocess</code> package allows us to use very easily all the tools of the software in R. First we use the <code>qgis_configure()</code> function to define all the necessary QGIS paths.</p>
<pre class="r"><code># paths to QGIS
qgis_configure()</code></pre>
<pre><code>## getOption(&#39;qgisprocess.path&#39;) was not found.</code></pre>
<pre><code>## Sys.getenv(&#39;R_QGISPROCESS_PATH&#39;) was not found.</code></pre>
<pre><code>## Trying &#39;qgis_process&#39; on PATH</code></pre>
<pre><code>## Error in processx::run(&quot;cmd.exe&quot;, c(&quot;/c&quot;, &quot;call&quot;, path, args), ...): System command &#39;cmd.exe&#39; failed, exit status: 1, stderr:
## E&gt; &quot;qgis_process&quot; no se reconoce como un comando interno o externo,
## E&gt; programa o archivo por lotes ejecutable.</code></pre>
<pre><code>## Found 1 QGIS installation containing &#39;qgis_process&#39;:
##  C:/Program Files/QGIS 3.18/bin/qgis_process-qgis.bat</code></pre>
<pre><code>## Trying command &#39;C:/Program Files/QGIS 3.18/bin/qgis_process-qgis.bat&#39;</code></pre>
<pre><code>## Success!</code></pre>
<pre><code>## QGIS version: 3.18.1-Zürich</code></pre>
<pre><code>## Metadata of 986 algorithms queried and stored in cache.
## Run `qgis_algorithms()` to see them.</code></pre>
<p>The <code>qgis_algorithms()</code> function helps us to search for different QGIS tools. In addition the <code>qgis_show_help()</code> function specifies the way of usage with all the required parameters.</p>
<pre class="r"><code># search tools
qgis_algorithms()</code></pre>
<pre><code>## # A tibble: 986 x 5
##    provider provider_title algorithm                algorithm_id algorithm_title
##    &lt;chr&gt;    &lt;chr&gt;          &lt;chr&gt;                    &lt;chr&gt;        &lt;chr&gt;          
##  1 3d       QGIS (3D)      3d:tessellate            tessellate   Tessellate     
##  2 gdal     GDAL           gdal:aspect              aspect       Aspect         
##  3 gdal     GDAL           gdal:assignprojection    assignproje~ Assign project~
##  4 gdal     GDAL           gdal:buffervectors       buffervecto~ Buffer vectors 
##  5 gdal     GDAL           gdal:buildvirtualraster  buildvirtua~ Build virtual ~
##  6 gdal     GDAL           gdal:buildvirtualvector  buildvirtua~ Build virtual ~
##  7 gdal     GDAL           gdal:cliprasterbyextent  cliprasterb~ Clip raster by~
##  8 gdal     GDAL           gdal:cliprasterbymaskla~ cliprasterb~ Clip raster by~
##  9 gdal     GDAL           gdal:clipvectorbyextent  clipvectorb~ Clip vector by~
## 10 gdal     GDAL           gdal:clipvectorbypolygon clipvectorb~ Clip vector by~
## # ... with 976 more rows</code></pre>
<pre class="r"><code># usage of tool
qgis_show_help(&quot;native:extractvertices&quot;)</code></pre>
<pre><code>## Extract vertices (native:extractvertices)
## 
## ----------------
## Description
## ----------------
## This algorithm takes a line or polygon layer and generates a point layer with points representing the vertices in the input lines or polygons. The attributes associated to each point are the same ones associated to the line or polygon that the point belongs to.
## 
## Additional fields are added to the point indicating the vertex index (beginning at 0), the vertex’s part and its index within the part (as well as its ring for polygons), distance along original geometry and bisector angle of vertex for original geometry.
## 
## ----------------
## Arguments
## ----------------
## 
## INPUT: Input layer
##  Argument type:  source
##  Acceptable values:
##      - Path to a vector layer
## OUTPUT: Vertices
##  Argument type:  sink
##  Acceptable values:
##      - Path for new vector layer
## 
## ----------------
## Outputs
## ----------------
## 
## OUTPUT: &lt;outputVector&gt;
##  Vertices</code></pre>
<p>In our case the tool to extract the vertices is simple and only has one input and one output. The function <code>qgis_run_algorithm()</code> executes a QGIS tool indicating the algorithm and its arguments. The advantage of using the algorithm directly from R is that we can pass objects of class <code>sf</code> (or <code>sp</code>) and <code>raster</code> that we have imported or created in R. As output we create a <code>geojson</code>, it could also be of another vector format, and we save it in a temporary folder. To obtain the QGIS output we need to use <code>qgis_output()</code> function.</p>
<pre class="r"><code>river_vertices &lt;- qgis_run_algorithm(alg = &quot;native:extractvertices&quot;,
               INPUT = river_line,
               OUTPUT = file.path(tempdir(), &quot;rivers_world_vertices.geojson&quot;))</code></pre>
<pre><code>## Running cmd.exe /c call \
##   &quot;C:/Program Files/QGIS 3.18/bin/qgis_process-qgis.bat&quot; run \
##   &quot;native:extractvertices&quot; \
##   &quot;--INPUT=C:\Users\xeo19\AppData\Local\Temp\Rtmpkf37V1\file1f54157824f7\file1f54f432848.gpkg&quot; \
##   &quot;--OUTPUT=C:\Users\xeo19\AppData\Local\Temp\Rtmpkf37V1/rivers_world_vertices.geojson&quot;
## 
## ----------------
## Inputs
## ----------------
## 
## INPUT:   C:\Users\xeo19\AppData\Local\Temp\Rtmpkf37V1\file1f54157824f7\file1f54f432848.gpkg
## OUTPUT:  C:\Users\xeo19\AppData\Local\Temp\Rtmpkf37V1/rivers_world_vertices.geojson
## 
## 
## 0...10...20...30...40...50...60...70...80...90...
## ----------------
## Results
## ----------------
## 
## OUTPUT:  C:\Users\xeo19\AppData\Local\Temp\Rtmpkf37V1/rivers_world_vertices.geojson</code></pre>
<pre class="r"><code>river_vertices &lt;- st_read(qgis_output(river_vertices, &quot;OUTPUT&quot;))</code></pre>
<pre><code>## Reading layer `rivers_world_vertices&#39; from data source 
##   `C:\Users\xeo19\AppData\Local\Temp\Rtmpkf37V1\rivers_world_vertices.geojson&#39; 
##   using driver `GeoJSON&#39;
## Simple feature collection with 339734 features and 12 fields
## Geometry type: POINT
## Dimension:     XY
## Bounding box:  xmin: -12117400 ymin: -3953778 xmax: 13751910 ymax: 7507359
## Geodetic CRS:  WGS 84</code></pre>
<p><div class="alert alert-note">
  <div>
    Currently on Windows there seem to be problems with the <em>proj</em> library. In principle, if the function ends up creating the <code>river_vertices</code> object, you should not worry.
  </div>
</div>
</p>
</div>
<div id="selection" class="section level2">
<h2>Selection</h2>
<p>Before continuing with the distribution estimation of the angles, we filter some rivers of interest. The functions of the <code>tidyverse</code> collection are compatible with the <code>sf</code> package. In the last post I made an introduction to <code>tidyverse</code> <a href="https://dominicroye.github.io/en/2020/a-very-short-introduction-to-tidyverse/">here</a>.</p>
<pre class="r"><code>river_vertices &lt;-  filter(river_vertices, 
                          NAME %in% c(&quot;Mississippi&quot;, &quot;Colorado&quot;, 
                                      &quot;Amazon&quot;, &quot;Nile&quot;, &quot;Orange&quot;, 
                                      &quot;Ganges&quot;, &quot;Yangtze&quot;, &quot;Danube&quot;,
                                      &quot;Mackenzie&quot;, &quot;Lena&quot;, &quot;Murray&quot;, 
                                      &quot;Niger&quot;)
                          ) 

river_vertices </code></pre>
<pre><code>## Simple feature collection with 94702 features and 12 fields
## Geometry type: POINT
## Dimension:     XY
## Bounding box:  xmin: -10377520 ymin: -3953778 xmax: 13124340 ymax: 7507359
## Geodetic CRS:  WGS 84
## First 10 features:
##    fid NAME SYSTEM name_alt scalerank rivernum Length_km vertex_index
## 1    6 Nile   &lt;NA&gt;     &lt;NA&gt;         1        4  3343.871            0
## 2    6 Nile   &lt;NA&gt;     &lt;NA&gt;         1        4  3343.871            1
## 3    6 Nile   &lt;NA&gt;     &lt;NA&gt;         1        4  3343.871            2
## 4    6 Nile   &lt;NA&gt;     &lt;NA&gt;         1        4  3343.871            3
## 5    6 Nile   &lt;NA&gt;     &lt;NA&gt;         1        4  3343.871            4
## 6    6 Nile   &lt;NA&gt;     &lt;NA&gt;         1        4  3343.871            5
## 7    6 Nile   &lt;NA&gt;     &lt;NA&gt;         1        4  3343.871            6
## 8    6 Nile   &lt;NA&gt;     &lt;NA&gt;         1        4  3343.871            7
## 9    6 Nile   &lt;NA&gt;     &lt;NA&gt;         1        4  3343.871            8
## 10   6 Nile   &lt;NA&gt;     &lt;NA&gt;         1        4  3343.871            9
##    vertex_part vertex_part_index  distance      angle                geometry
## 1            0                 0     0.000  31.096005 POINT (3037149 1672482)
## 2            0                 1  1208.130  22.456672 POINT (3037772 1673517)
## 3            0                 2  2324.160   8.602259 POINT (3038039 1674600)
## 4            0                 3  3656.452   8.573580 POINT (3038118 1675930)
## 5            0                 4  5735.538  24.406889 POINT (3038612 1677950)
## 6            0                 5  6758.322  25.134763 POINT (3039200 1678787)
## 7            0                 6 10432.834   6.998982 POINT (3040164 1682333)
## 8            0                 7 14865.136   4.239641 POINT (3040070 1686764)
## 9            0                 8 16563.207 358.730530 POINT (3040356 1688438)
## 10           0                 9 18376.526 347.480822 POINT (3039972 1690210)</code></pre>
</div>
</div>
<div id="estimate-the-distribution" class="section level1">
<h1>Estimate the distribution</h1>
<p>To visualize the distribution we can use either a histogram or a density graph. But in the case of estimating the probability density function, we find a mathematical problem when applying it to circular data. For circular data we should not use the <code>density()</code> standard function of R since in our data a direction of 360º is the same at 0º, which would cause errors in this range of values. It is a general problem for different statistical metrics. More statistical details are explained in the <code>circular</code> package. This package allows you to define the characteristics of circular data (unit, data type, rotation, etc.) as an object class in R.</p>
<p>So what we do is to build a function that estimates the density and returns a table with the angles (x) and the density estimates (y). Since rivers have different lengths, and we want to see differences regardless of that, we normalize the estimates using the maximum value. Unlike the <code>density()</code> function, in which the smoothing bandwidth <code>bw</code> is optimized, here it is required to indicate it manually. It is similar to defining the bar width in a histogram. There is an optimization function for the bandwidth, <code>bw.nrd.circular()</code> that could be used here.</p>
<pre class="r"><code>dens_circ &lt;- function(x){
  
  dens &lt;- density.circular(circular(x$angle, units = &quot;degrees&quot;),
                                     bw = 70, kernel = &quot;vonmises&quot;,
                                     control.circular = list(units = &quot;degrees&quot;))
  
  df &lt;- data.frame(x = dens$x, y = dens$y/max(dens$y))
  
  return(df)
  
}</code></pre>
<p>Finally, we estimate the density of each river in our selection. We use the <code>split()</code> function of R Base to get a table of each river in a list object. Then we apply our density estimation function to the list with the function <code>map_df()</code> from the <code>purrr</code> package. The suffix <code>_df</code> allows us to get a joined table, instead of a list with the results of each river. However, it is necessary to indicate the name of the column with the argument <code>.id</code>, which will contain the name of each river. Otherwise we would not know how to differentiate the results. Also here I recommend reading more details in the last post about <code>tidyverse</code> <a href="https://dominicroye.github.io/en/2020/a-very-short-introduction-to-tidyverse/">here</a>.</p>
<pre class="r"><code>dens_river &lt;- split(river_vertices, river_vertices$NAME) %&gt;% 
                  map_df(dens_circ, .id = &quot;river&quot;)

# results
head(dens_river)</code></pre>
<pre><code>##    river        x         y
## 1 Amazon 0.000000 0.2399907
## 2 Amazon 0.704501 0.2492548
## 3 Amazon 1.409002 0.2585758
## 4 Amazon 2.113503 0.2679779
## 5 Amazon 2.818004 0.2774859
## 6 Amazon 3.522505 0.2871232</code></pre>
</div>
<div id="visualization" class="section level1">
<h1>Visualization</h1>
<p>Now we only have to make the graph through the famous <code>ggplot</code> package. First we add a new font <em>Montserrat</em> for it use in this plot.</p>
<pre class="r"><code># font download
font_add_google(&quot;Montserrat&quot;, &quot;Montserrat&quot;)

# use of showtext
showtext_opts(dpi = 200)
showtext_auto() </code></pre>
<p>In the next step we create two objects with the title and the plot caption. In the title we are using an html code to color part of the text instead of a legend. You can use html very easily with the <code>ggtext</code> package.</p>
<pre class="r"><code># title with html
title &lt;- &quot;Relative distribution of river &lt;span style=&#39;color:#011FFD;&#39;&gt;&lt;strong&gt;flow direction&lt;/strong&gt;&lt;/span&gt; in the world&quot;


caption &lt;- &quot;Based on data from Zeenatul Basher, 20180215&quot;</code></pre>
<p>The background grid that creates <code>ggplot</code> by default for polar coordinates did not convince me, so we create a table with x axis background lines.</p>
<pre class="r"><code>grid_x &lt;- tibble(x = seq(0, 360 - 22.5, by = 22.5), 
                 y = rep(0, 16), 
                 xend = seq(0, 360 - 22.5, by = 22.5), 
                 yend = rep(Inf, 16))</code></pre>
<p>Next we define all the styles of the graph. The most important thing in this step is the <code>element_textbox()</code> function of the <code>ggtext</code> package to be able to interpret our html code incorporated into the title.</p>
<pre class="r"><code>theme_polar &lt;- function(){
               theme_minimal() %+replace%
               theme(axis.title.y = element_blank(),
                     axis.text.y = element_blank(),
                     legend.title = element_blank(),
                     plot.title = element_textbox(family = &quot;Montserrat&quot;, 
                                                   hjust = 0.5, 
                                                   colour = &quot;white&quot;, 
                                                   size = 15),
                     plot.caption = element_text(family = &quot;Montserrat&quot;, 
                                                 colour = &quot;white&quot;),
                     axis.text.x = element_text(family = &quot;Montserrat&quot;, 
                                                 colour = &quot;white&quot;),
                     strip.text = element_text(family = &quot;Montserrat&quot;, 
                                               colour = &quot;white&quot;, 
                                               face = &quot;bold&quot;),
                     panel.background = element_rect(fill = &quot;black&quot;),
                     plot.background = element_rect(fill = &quot;black&quot;),
                     panel.grid = element_blank()
                    )
}</code></pre>
<p>Finally we build the graph: 1) We use the <code>geom_hline()</code> function with different y intersection points to create the background grid. The <code>geom_segment()</code> function creates the x grid. 2) We create the density area using the <code>geom_area()</code> function. 3) In <code>scale_x_continous()</code> we define a negative lower limit so that it does not collapse at a small point. The labels of the eight main directions are indicated in the <code>scale_y_continous()</code> function, and 4) Finally, we change to a polar coordinate system and set the variable to create facets.</p>
<pre class="r"><code>ggplot() +
  geom_hline(yintercept = c(0, .2, .4, .6, .8, 1), colour = &quot;white&quot;) +
  geom_segment(data = grid_x , 
               aes(x = x, y = y, xend = xend, yend = yend), 
               linetype = &quot;dashed&quot;, col = &quot;white&quot;) +
  geom_area(data = dens_river, 
            aes(x = x, y = y, ymin = 0, ymax = y), 
            alpha = .7, 
            colour = NA, 
            show.legend = FALSE,
            fill = &quot;#011FFD&quot;) + 
  scale_y_continuous(limits = c(-.2, 1), expand = c(0, 0)) +
  scale_x_continuous(limits = c(0, 360), 
                     breaks = seq(0, 360 - 22.5, by = 22.5),
                     minor_breaks = NULL,
                     labels = c(&quot;N&quot;, &quot;&quot;, &quot;NE&quot;, &quot;&quot;, &quot;E&quot;, &quot;&quot;, &quot;SE&quot;, &quot;&quot;,
                                &quot;S&quot;, &quot;&quot;, &quot;SW&quot;, &quot;&quot;, &quot;W&quot;, &quot;&quot;, &quot;NW&quot;, &quot;&quot;)) +
  coord_polar() + 
  facet_wrap(river ~ ., ncol = 4) +
  labs(title = title, caption = caption, x = &quot;&quot;) +
  theme_polar()</code></pre>
<pre><code>## Warning: Ignoring unknown aesthetics: ymin, ymax</code></pre>
<p><img src="https://dominicroye.github.io/en/2020/river-flow-directions/index.en_files/figure-html/unnamed-chunk-19-1.png" width="672" /></p>
<p><a href="https://www.buymeacoffee.com/drxeo" target="_blank"><img src="https://cdn.buymeacoffee.com/buttons/default-orange.png" alt="Buy Me A Coffee" height="41" width="174"></a></p>
</div>

    </div>

    






<div class="article-tags">
  
  <a class="badge badge-light" href="/en/tag/directions/">directions</a>
  
  <a class="badge badge-light" href="/en/tag/river/">river</a>
  
  <a class="badge badge-light" href="/en/tag/fluvial/">fluvial</a>
  
  <a class="badge badge-light" href="/en/tag/orientation/">orientation</a>
  
  <a class="badge badge-light" href="/en/tag/distribution/">distribution</a>
  
</div>



<div class="share-box">
  <ul class="share">
    
      
      
      
        
      
      
      
      <li>
        <a href="https://twitter.com/intent/tweet?url=https://dominicroye.github.io/en/2020/river-flow-directions/&amp;text=River%20flow%20directions" target="_blank" rel="noopener" class="share-btn-twitter" aria-label="twitter">
          <i class="fab fa-twitter"></i>
        </a>
      </li>
    
      
      
      
        
      
      
      
      <li>
        <a href="https://www.facebook.com/sharer.php?u=https://dominicroye.github.io/en/2020/river-flow-directions/&amp;t=River%20flow%20directions" target="_blank" rel="noopener" class="share-btn-facebook" aria-label="facebook">
          <i class="fab fa-facebook"></i>
        </a>
      </li>
    
      
      
      
        
      
      
      
      <li>
        <a href="mailto:?subject=River%20flow%20directions&amp;body=https://dominicroye.github.io/en/2020/river-flow-directions/" target="_blank" rel="noopener" class="share-btn-email" aria-label="envelope">
          <i class="fas fa-envelope"></i>
        </a>
      </li>
    
      
      
      
        
      
      
      
      <li>
        <a href="https://www.linkedin.com/shareArticle?url=https://dominicroye.github.io/en/2020/river-flow-directions/&amp;title=River%20flow%20directions" target="_blank" rel="noopener" class="share-btn-linkedin" aria-label="linkedin-in">
          <i class="fab fa-linkedin-in"></i>
        </a>
      </li>
    
      
      
      
        
      
      
      
      <li>
        <a href="whatsapp://send?text=River%20flow%20directions%20https://dominicroye.github.io/en/2020/river-flow-directions/" target="_blank" rel="noopener" class="share-btn-whatsapp" aria-label="whatsapp">
          <i class="fab fa-whatsapp"></i>
        </a>
      </li>
    
      
      
      
        
      
      
      
      <li>
        <a href="https://service.weibo.com/share/share.php?url=https://dominicroye.github.io/en/2020/river-flow-directions/&amp;title=River%20flow%20directions" target="_blank" rel="noopener" class="share-btn-weibo" aria-label="weibo">
          <i class="fab fa-weibo"></i>
        </a>
      </li>
    
  </ul>
</div>











  
  



  
  
  
    
  
  
  
  <div class="media author-card content-widget-hr">
    
      
      <a href="https://dominicroye.github.io/"><img class="avatar mr-3 avatar-circle" src="/en/author/dr.-dominic-roye/avatar_hu930bec32484cd86675af8880de95caa2_508993_270x270_fill_q75_lanczos_center.jpg" alt="Dr. Dominic Royé"></a>
    

    <div class="media-body">
      <h5 class="card-title"><a href="https://dominicroye.github.io/">Dr. Dominic Royé</a></h5>
      <h6 class="card-subtitle">Researcher and responsible for data science</h6>
      
      <ul class="network-icon" aria-hidden="true">
  
    
    
    
      
    
    
    
    
    
      
    
    <li>
      <a href="https://twitter.com/dr_xeo" target="_blank" rel="noopener">
        <i class="fab fa-twitter"></i>
      </a>
    </li>
  
    
    
    
      
    
    
    
    
    
    <li>
      <a href="mailto:dominic.roye@ficlima.org" >
        <i class="fas fa-envelope"></i>
      </a>
    </li>
  
    
    
    
    
    
    
    
      
    
    <li>
      <a href="https://scholar.google.es/citations?user=EoYa8jUAAAAJ&amp;hl=es" target="_blank" rel="noopener">
        <i class="ai ai-google-scholar"></i>
      </a>
    </li>
  
    
    
    
      
    
    
    
    
    
      
    
    <li>
      <a href="https://github.com/dominicroye" target="_blank" rel="noopener">
        <i class="fab fa-github"></i>
      </a>
    </li>
  
    
    
    
      
    
    
    
    
    
      
    
    <li>
      <a href="https://www.linkedin.com/in/dominicroye/" target="_blank" rel="noopener">
        <i class="fab fa-linkedin"></i>
      </a>
    </li>
  
    
    
    
    
    
    
    
      
    
    <li>
      <a href="https://www.researchgate.net/profile/Dominic_Roye" target="_blank" rel="noopener">
        <i class="ai ai-researchgate"></i>
      </a>
    </li>
  
</ul>

    </div>
  </div>
















  
  
  <div class="article-widget content-widget-hr">
    <h3>Related</h3>
    <ul>
      
      <li><a href="/en/2023/tomorrows-weather/">Tomorrow&#39;s weather</a></li>
      
      <li><a href="/en/2021/bivariate-dasymetric-map/">Bivariate dasymetric map</a></li>
      
      <li><a href="/en/2022/hillshade-effects/">Hillshade effects</a></li>
      
      <li><a href="/en/2022/use-of-multidimensional-spatial-data/">Use of multidimensional spatial data</a></li>
      
      <li><a href="/en/2021/visualize-the-day-night-cycle-on-a-world-map/">Visualize the day-night cycle on a world map</a></li>
      
    </ul>
  </div>
  





  </div>
</article>
  </div>

  <div class="page-footer">
    
    
    <div class="container">
      <footer class="site-footer">

  



  

  

  
  <p class="powered-by">
    © 2018-2023 Dominic Royé. All rights reserved
  </p>
  

  
  






  <p class="powered-by">
    
    
    
      
      
      
      
      
      
      Published with <a href="https://wowchemy.com/?utm_campaign=poweredby" target="_blank" rel="noopener">Wowchemy</a> — the free, <a href="https://github.com/wowchemy/wowchemy-hugo-themes" target="_blank" rel="noopener">open source</a> website builder that empowers creators.
    
  </p>
</footer>

    </div>
    
  </div>

  
<div id="modal" class="modal fade" role="dialog">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Cite</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <pre><code class="tex hljs"></code></pre>
      </div>
      <div class="modal-footer">
        <a class="btn btn-outline-primary my-1 js-copy-cite" href="#" target="_blank">
          <i class="fas fa-copy"></i> Copy
        </a>
        <a class="btn btn-outline-primary my-1 js-download-cite" href="#" target="_blank">
          <i class="fas fa-download"></i> Download
        </a>
        <div id="modal-error"></div>
      </div>
    </div>
  </div>
</div>

      

    
    <script src="/js/vendor-bundle.min.b73dfaac3b6499dc997741748a7c3fe2.js"></script>

    
    
    
      
      
        <script src="https://cdn.jsdelivr.net/gh/desandro/imagesloaded@v4.1.4/imagesloaded.pkgd.min.js" integrity="sha512-S5PZ9GxJZO16tT9r3WJp/Safn31eu8uWrzglMahDT4dsmgqWonRY9grk3j+3tfuPr9WJNsfooOR7Gi7HL5W2jw==" crossorigin="anonymous"></script>
        <script src="https://cdn.jsdelivr.net/gh/metafizzy/isotope@v3.0.6/dist/isotope.pkgd.min.js" integrity="sha512-Zq2BOxyhvnRFXu0+WE6ojpZLOU2jdnqbrM1hmVdGzyeCa1DgM3X5Q4A/Is9xA1IkbUeDd7755dNNI/PzSf2Pew==" crossorigin="anonymous"></script>
      

      
      

      

      
        
        <script src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@10.2.1/build/highlight.min.js" integrity="sha512-Ypjm0o7jOxAd4hpdoppSEN0TQOC19UtPAqD+4s5AlXmUvbmmS/YMxYqAqarQYyxTnB6/rqip9qcxlNB/3U9Wdg==" crossorigin="anonymous"></script>
        
        
        <script src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@10.2.1/build/languages/r.min.js" crossorigin="anonymous"></script>
        
      

    

    
    
    
      <script src="https://cdn.jsdelivr.net/npm/leaflet@1.7.1/dist/leaflet.min.js" integrity="" crossorigin="anonymous"></script>
    

    
    

    
    
    

    
    

    
    
    
    

    
    

    
    
    
    
    
    
    
    
    
    <script src="/en/js/wowchemy.min.50d3bf3df0c53b31631bb48a62b35f92.js"></script>

    
  <script async defer src="https://buttons.github.io/buttons.js"></script>




</body>
</html>
