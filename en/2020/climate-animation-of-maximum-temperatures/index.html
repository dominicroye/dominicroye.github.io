<!DOCTYPE html>
<html lang="en-us">
<head>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="generator" content="Source Themes Academic 3.2.0">
  <meta name="generator" content="Hugo 0.53" />
  <meta name="author" content="Dr. Dominic Royé">

  
  
  
  
    
  
  <meta name="description" content="In the field of data visualization, the animation of spatial data in its temporal dimension can show fascinating changes and patterns. As a result of one of the last publications in the social networks that I have made, I was asked to make a post about how I created it. Well, here we go to start with an example of data from mainland Spain.">

  
  <link rel="alternate" hreflang="en-us" href="/en/2020/climate-animation-of-maximum-temperatures/">

  


  

  

  

  

  

  

  
  
  
  <meta name="theme-color" content="#2962ff">
  

  
  
  
  
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha256-eSi1q2PG6J7g7ib17yAaWMcrr5GrtohYChqibrV7PBE=" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/academicons/1.8.6/css/academicons.min.css" integrity="sha256-uFVgMKfistnJAfoCUQigIl+JfUaP47GrRKjf6CTPVmw=" crossorigin="anonymous">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.6.0/css/all.css" integrity="sha384-aOkxzJ5uQz7WBObEZcHvV5JvRW3TUc2rNPA7pe3AwnsUohiw1Vj2Rgx2KSOkF5+h" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.2.5/jquery.fancybox.min.css" integrity="sha256-ygkqlh3CYSUri3LhQxzdcm0n1EQvH2Y+U5S2idbLtxs=" crossorigin="anonymous">

    
    
    
      
    
    
      
      
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/dracula.min.css" crossorigin="anonymous">
      
    

    

    

  

  
  

  <link rel="stylesheet" href="/en/styles.css">
  
  <link rel="stylesheet" href="/css/override.css">
  

  
  
    <script>
      window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
      ga('create', 'UA-27463794-2', 'auto');
      ga('set', 'anonymizeIp', true);
      ga('require', 'eventTracker');
      ga('require', 'outboundLinkTracker');
      ga('require', 'urlChangeTracker');
      ga('send', 'pageview');
    </script>
    <script async src="//www.google-analytics.com/analytics.js"></script>
    
    <script async src="https://cdnjs.cloudflare.com/ajax/libs/autotrack/2.4.1/autotrack.js" integrity="sha512-HUmooslVKj4m6OBu0OgzjXXr+QuFYy/k7eLI5jdeEy/F4RSgMn6XRWRGkFi5IFaFgy7uFTkegp3Z0XnJf3Jq+g==" crossorigin="anonymous"></script>
    
  
  

  
  <link rel="alternate" href="/index.xml" type="application/rss+xml" title="Dominic Royé">
  <link rel="feed" href="/index.xml" type="application/rss+xml" title="Dominic Royé">
  

  <link rel="manifest" href="/site.webmanifest">
  <link rel="icon" type="image/png" href="/img/icon.png">
  <link rel="apple-touch-icon" type="image/png" href="/img/icon-192.png">

  <link rel="canonical" href="/en/2020/climate-animation-of-maximum-temperatures/">

  
  
  
  
    
  
  <meta property="twitter:card" content="summary_large_image">
  
  <meta property="og:site_name" content="Dominic Royé">
  <meta property="og:url" content="/en/2020/climate-animation-of-maximum-temperatures/">
  <meta property="og:title" content="Climate animation of maximum temperatures | Dominic Royé">
  <meta property="og:description" content="In the field of data visualization, the animation of spatial data in its temporal dimension can show fascinating changes and patterns. As a result of one of the last publications in the social networks that I have made, I was asked to make a post about how I created it. Well, here we go to start with an example of data from mainland Spain."><meta property="og:image" content="/en/2020/climate-animation-of-maximum-temperatures/featured.png">
  <meta property="og:locale" content="en-us">
  
  <meta property="article:published_time" content="2020-10-11T00:00:00&#43;00:00">
  
  <meta property="article:modified_time" content="2020-10-11T00:00:00&#43;00:00">
  

  

<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.0.3/cookieconsent.min.css">
<script src="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.0.3/cookieconsent.min.js"></script>
<script>
  window.addEventListener("load", function(){
    window.cookieconsent.initialise({
      "palette": {
        "popup": {
          "background": "#2962ff",
          "text": "#fff"
        },
        "button": {
          "background": "#fff",
          "text": "#2962ff"
        }
      },
      "theme": "classic",
      "content": {
        "message": "This website uses cookies to ensure you get the best experience on our website.",
        "dismiss": "Got it!",
        "link": "Learn more",
        "href": "https://cookies.insites.com"
      }
    })});
</script>


  

  <title>Climate animation of maximum temperatures | Dominic Royé</title>

</head>
<body id="top" data-spy="scroll" data-target="#TableOfContents" data-offset="71" >
  <aside class="search-results" id="search">
  <div class="container">
    <section class="search-header">

      <div class="row no-gutters justify-content-between mb-3">
        <div class="col-6">
          <h1>Search</h1>
        </div>
        <div class="col-6 col-search-close">
          <a class="js-search" href="#"><i class="fas fa-times-circle text-muted" aria-hidden="true"></i></a>
        </div>
      </div>

      <div id="search-box">
        
        
        
      </div>

    </section>
    <section class="section-search-results">

      <div id="search-hits">
        
      </div>

    </section>
  </div>
</aside>

<nav class="navbar navbar-light fixed-top navbar-expand-lg py-0" id="navbar-main">
  <div class="container">

    
      <a class="navbar-brand" href="/en"><div style="position:relative;float:left">Dominic Royé<img src="/img/portrait.jpg" alt="Dominic Royé" style="float: left;"></div></a>
      
      <button type="button" class="navbar-toggler" data-toggle="collapse"
              data-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
        <span><i class="fas fa-bars"></i></span>
      </button>
      

    
    <div class="collapse navbar-collapse" id="navbar">

      
      
      <ul class="navbar-nav ml-auto">
        

        

        
        
        

        <li class="nav-item">
          <a class="nav-link" href="/en/#">
            
            <span>home</span>
            
          </a>
        </li>

        
        

        

        
        
        
          
        

        <li class="nav-item">
          <a class="nav-link" href="/en/#posts">
            
            <span>blog</span>
            
          </a>
        </li>

        
        

        

        
        
        
          
        

        <li class="nav-item">
          <a class="nav-link" href="/en/#publications_selected">
            
            <span>publications</span>
            
          </a>
        </li>

        
        

        

        
        
        
          
        

        <li class="nav-item">
          <a class="nav-link" href="/en/#graphs">
            
            <span>graphs</span>
            
          </a>
        </li>

        
        

        

        
        
        
          
        

        <li class="nav-item">
          <a class="nav-link" href="/en/#teaching">
            
            <span>more</span>
            
          </a>
        </li>

        
        

        

        
        
        
          
        

        <li class="nav-item">
          <a class="nav-link" href="/en/#about">
            
            <span>me</span>
            
          </a>
        </li>

        
        

      

        

        

        

        

      </ul>

    </div>
  </div>
</nav>


<article class="article" itemscope itemtype="http://schema.org/Article">

  













<div class="article-header d-xl-none">
  <div class="featured-image" style="background-image: url('/en/2020/climate-animation-of-maximum-temperatures/featured_hu93dfd35c95b36af5dd3f447930c96c21_247222_800x0_resize_box_2.png');"></div>
  
</div>


<div class="container-fluid split-header d-none d-xl-block">
  <div class="row">
    <div class="col-6">
      <div class="split-header-content">
        <h1 itemprop="name">Climate animation of maximum temperatures</h1>

        

        

<div class="article-metadata">

  
  
  <span itemscope itemprop="author" itemtype="http://schema.org/Person">
    <meta itemprop="name" content="Dr. Dominic Royé">
  </span>
  

  <span class="article-date">
    
    <meta content="2020-10-11 00:00:00 &#43;0000 UTC" itemprop="datePublished">
    <time datetime="2020-10-11 00:00:00 &#43;0000 UTC" itemprop="dateModified">
      2020-10-11
    </time>
  </span>
  <span itemscope itemprop="publisher" itemtype="http://schema.org/Person">
    <meta itemprop="name" content="Dr. Dominic Royé">
  </span>

  

  
  
  <span class="middot-divider"></span>
  <a href="/en/2020/climate-animation-of-maximum-temperatures/#disqus_thread"></a>
  

  
  
  
  <span class="middot-divider"></span>
  <span class="article-categories">
    <i class="fas fa-folder"></i>
    
    <a href="/en/categories/visualization/">visualization</a>, 
    
    <a href="/en/categories/r/">R</a>, 
    
    <a href="/en/categories/radvanced/">R:advanced</a>
    
  </span>
  
  

  

</div>


        







  










        
<div class="share-box" aria-hidden="true">
  <ul class="share">
    <li>
      <a class="twitter"
         href="https://twitter.com/intent/tweet?text=Climate%20animation%20of%20maximum%20temperatures&amp;url=%2fen%2f2020%2fclimate-animation-of-maximum-temperatures%2f"
         target="_blank" rel="noopener">
        <i class="fab fa-twitter"></i>
      </a>
    </li>
    <li>
      <a class="facebook"
         href="https://www.facebook.com/sharer.php?u=%2fen%2f2020%2fclimate-animation-of-maximum-temperatures%2f"
         target="_blank" rel="noopener">
        <i class="fab fa-facebook-f"></i>
      </a>
    </li>
    <li>
      <a class="linkedin"
         href="https://www.linkedin.com/shareArticle?mini=true&amp;url=%2fen%2f2020%2fclimate-animation-of-maximum-temperatures%2f&amp;title=Climate%20animation%20of%20maximum%20temperatures"
         target="_blank" rel="noopener">
        <i class="fab fa-linkedin-in"></i>
      </a>
    </li>
    <li>
      <a class="weibo"
         href="http://service.weibo.com/share/share.php?url=%2fen%2f2020%2fclimate-animation-of-maximum-temperatures%2f&amp;title=Climate%20animation%20of%20maximum%20temperatures"
         target="_blank" rel="noopener">
        <i class="fab fa-weibo"></i>
      </a>
    </li>
    <li>
      <a class="email"
         href="mailto:?subject=Climate%20animation%20of%20maximum%20temperatures&amp;body=%2fen%2f2020%2fclimate-animation-of-maximum-temperatures%2f">
        <i class="fas fa-envelope"></i>
      </a>
    </li>
  </ul>
</div>


      </div>
    </div>
    <div class="col-6">
      <div class="split-header-image">
        <img src="/en/2020/climate-animation-of-maximum-temperatures/featured_hu93dfd35c95b36af5dd3f447930c96c21_247222_680x500_fill_q90_box_smart1_2.png" itemprop="image" alt="">
        
      </div>
    </div>
  </div>
</div>

<div class="article-container d-xl-none">
  <h1 itemprop="name">Climate animation of maximum temperatures</h1>

  

  

<div class="article-metadata">

  
  
  <span itemscope itemprop="author" itemtype="http://schema.org/Person">
    <meta itemprop="name" content="Dr. Dominic Royé">
  </span>
  

  <span class="article-date">
    
    <meta content="2020-10-11 00:00:00 &#43;0000 UTC" itemprop="datePublished">
    <time datetime="2020-10-11 00:00:00 &#43;0000 UTC" itemprop="dateModified">
      2020-10-11
    </time>
  </span>
  <span itemscope itemprop="publisher" itemtype="http://schema.org/Person">
    <meta itemprop="name" content="Dr. Dominic Royé">
  </span>

  

  
  
  <span class="middot-divider"></span>
  <a href="/en/2020/climate-animation-of-maximum-temperatures/#disqus_thread"></a>
  

  
  
  
  <span class="middot-divider"></span>
  <span class="article-categories">
    <i class="fas fa-folder"></i>
    
    <a href="/en/categories/visualization/">visualization</a>, 
    
    <a href="/en/categories/r/">R</a>, 
    
    <a href="/en/categories/radvanced/">R:advanced</a>
    
  </span>
  
  

  
  
<div class="share-box" aria-hidden="true">
  <ul class="share">
    <li>
      <a class="twitter"
         href="https://twitter.com/intent/tweet?text=Climate%20animation%20of%20maximum%20temperatures&amp;url=%2fen%2f2020%2fclimate-animation-of-maximum-temperatures%2f"
         target="_blank" rel="noopener">
        <i class="fab fa-twitter"></i>
      </a>
    </li>
    <li>
      <a class="facebook"
         href="https://www.facebook.com/sharer.php?u=%2fen%2f2020%2fclimate-animation-of-maximum-temperatures%2f"
         target="_blank" rel="noopener">
        <i class="fab fa-facebook-f"></i>
      </a>
    </li>
    <li>
      <a class="linkedin"
         href="https://www.linkedin.com/shareArticle?mini=true&amp;url=%2fen%2f2020%2fclimate-animation-of-maximum-temperatures%2f&amp;title=Climate%20animation%20of%20maximum%20temperatures"
         target="_blank" rel="noopener">
        <i class="fab fa-linkedin-in"></i>
      </a>
    </li>
    <li>
      <a class="weibo"
         href="http://service.weibo.com/share/share.php?url=%2fen%2f2020%2fclimate-animation-of-maximum-temperatures%2f&amp;title=Climate%20animation%20of%20maximum%20temperatures"
         target="_blank" rel="noopener">
        <i class="fab fa-weibo"></i>
      </a>
    </li>
    <li>
      <a class="email"
         href="mailto:?subject=Climate%20animation%20of%20maximum%20temperatures&amp;body=%2fen%2f2020%2fclimate-animation-of-maximum-temperatures%2f">
        <i class="fas fa-envelope"></i>
      </a>
    </li>
  </ul>
</div>


  

</div>


  







  









</div>



  <div class="article-container">

    <div class="article-style" itemprop="articleBody">
      


<p>In the field of data visualization, the animation of spatial data in its temporal dimension can show fascinating changes and patterns. As a result of one of the last publications in the social networks that I have made, I was asked to make a post about how I created it. Well, here we go to start with an example of data from mainland Spain. You can find more animations in the graphics <a href="https://dominicroye.github.io/en/graphs/climate/">section</a> of my blog.</p>
<blockquote class="twitter-tweet"><p lang="en" dir="ltr">I couldn&#39;t resist to make another animation. Smoothed daily maximum temperature throughout the year in Europe. <a href="https://twitter.com/hashtag/rstats?src=hash&amp;ref_src=twsrc%5Etfw">#rstats</a> <a href="https://twitter.com/hashtag/ggplot2?src=hash&amp;ref_src=twsrc%5Etfw">#ggplot2</a> <a href="https://twitter.com/hashtag/dataviz?src=hash&amp;ref_src=twsrc%5Etfw">#dataviz</a> <a href="https://twitter.com/hashtag/climate?src=hash&amp;ref_src=twsrc%5Etfw">#climate</a> <a href="https://t.co/ZC9L0vh3vR">pic.twitter.com/ZC9L0vh3vR</a></p>&mdash; Dominic Royé (@dr_xeo) <a href="https://twitter.com/dr_xeo/status/1259059168817930240?ref_src=twsrc%5Etfw">May 9, 2020</a></blockquote>
<script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>

<div id="packages" class="section level2">
<h2>Packages</h2>
<p>In this post we will use the following packages:</p>
<table>
<colgroup>
<col width="14%" />
<col width="85%" />
</colgroup>
<thead>
<tr class="header">
<th align="left">Packages</th>
<th align="left">Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">tidyverse</td>
<td align="left">Collection of packages (visualization, manipulation): ggplot2, dplyr, purrr, etc.</td>
</tr>
<tr class="even">
<td align="left">rnaturalearth</td>
<td align="left">Vector maps of the world ‘Natural Earth’</td>
</tr>
<tr class="odd">
<td align="left">lubridate</td>
<td align="left">Easy manipulation of dates and times</td>
</tr>
<tr class="even">
<td align="left">sf</td>
<td align="left">Simple Feature: import, export and manipulate vector data</td>
</tr>
<tr class="odd">
<td align="left">raster</td>
<td align="left">Import, export and manipulate raster</td>
</tr>
<tr class="even">
<td align="left">ggthemes</td>
<td align="left">Themes for ggplot2</td>
</tr>
<tr class="odd">
<td align="left">gifski</td>
<td align="left">Create gifs</td>
</tr>
<tr class="even">
<td align="left">showtext</td>
<td align="left">Use fonts more easily in R graphs</td>
</tr>
<tr class="odd">
<td align="left">sysfonts</td>
<td align="left">Load fonts in R</td>
</tr>
</tbody>
</table>
<pre class="r"><code># install the packages if necessary
if(!require(&quot;tidyverse&quot;)) install.packages(&quot;tidyverse&quot;)
if(!require(&quot;rnaturalearth&quot;)) install.packages(&quot;rnaturalearth&quot;)
if(!require(&quot;lubridate&quot;)) install.packages(&quot;lubridate&quot;)
if(!require(&quot;sf&quot;)) install.packages(&quot;sf&quot;)
if(!require(&quot;ggthemes&quot;)) install.packages(&quot;ggthemes&quot;)
if(!require(&quot;gifski&quot;)) install.packages(&quot;gifski&quot;)
if(!require(&quot;raster&quot;)) install.packages(&quot;raster&quot;)
if(!require(&quot;sysfonts&quot;)) install.packages(&quot;sysfonts&quot;)
if(!require(&quot;showtext&quot;)) install.packages(&quot;showtext&quot;)

# packages
library(raster)
library(tidyverse)
library(lubridate)
library(ggthemes)
library(sf)
library(rnaturalearth)
library(extrafont)
library(showtext)
library(RColorBrewer)
library(gifski)</code></pre>
<p>For those with less experience with <code>tidyverse</code>, I recommend the short introduction on this blog (<a href="https://dominicroye.github.io/en/2020/a-very-short-introduction-to-tidyverse/">post</a>).</p>
</div>
<div id="preparation" class="section level1">
<h1>Preparation</h1>
<div id="data" class="section level2">
<h2>Data</h2>
<p>First, we need to download the STEAD dataset of the maximum temperature (<em>tmax_pen.nc</em>) in <em>netCDF</em> format from the CSIC repository <a href="https://digital.csic.es/handle/10261/177655">here</a> (the size of the data is 2 GB). It is a set of data with a spatial resolution of 5 km and includes daily maximum temperatures from 1901 to 2014. In climatology and meteorology, a widely used format is that of <em>netCDF</em> databases, which allow to obtain a multidimensional structure and to exchange data independently of the usued operating system. It is a space-time format with a regular or irregular grid. The multidimensional structure in the form of arrays or cubes can handle not only spatio-temporal data but also multivariate ones. In our dataset we will have an array of three dimensions: longitude, latitude and time of the maximum temperature.</p>
<div class="figure">
<img src="/img/3d_ncdf.en.png" alt="" />
<p class="caption">Royé 2015. Sémata: Ciencias Sociais e Humanidades 27:11-37</p>
</div>
</div>
<div id="import-the-dataset" class="section level2">
<h2>Import the dataset</h2>
<p>The <em>netCDF</em> format with <em>.nc</em> extension can be imported via two main packages: 1) <code>ncdf4</code> and 2) <code>raster</code>. Actually, the <code>raster</code> package use the first package to import the <em>netCDF</em> datasets. In this post we will use the <code>raster</code> package since it is somewhat easier, with some very useful and more universal functions for all types of <em>raster</em> format. The main import functions are: <code>raster()</code>, <code>stack()</code> and <code>brick()</code>. The first function only allows you to import a single layer, instead, the last two functions are used for multidimensional data. In our dataset we only have one variable, therefore it would not be necessary to use the <code>varname</code> argument.</p>
<pre class="r"><code># import netCDF data
tmx &lt;- brick(&quot;tmax_pen.nc&quot;, varname = &quot;tx&quot;)</code></pre>
<pre><code>## Loading required namespace: ncdf4</code></pre>
<pre class="r"><code>tmx # metadata</code></pre>
<pre><code>## class      : RasterBrick 
## dimensions : 190, 230, 43700, 41638  (nrow, ncol, ncell, nlayers)
## resolution : 0.0585, 0.045  (x, y)
## extent     : -9.701833, 3.753167, 35.64247, 44.19247  (xmin, xmax, ymin, ymax)
## crs        : +proj=longlat +datum=WGS84 +no_defs 
## source     : C:/Users/xeo19/Documents/GitHub/blogR_update/content/post/en/2020-10-11-climate-animation-maximum-temperature/tmax_pen.nc 
## names      : X1, X2, X3, X4, X5, X6, X7, X8, X9, X10, X11, X12, X13, X14, X15, ... 
## Time (days since 1901-01-01): 1, 41638 (min, max)
## varname    : tx</code></pre>
<p>The <code>RasterBrick</code> object details show you all the necessary metadata: the resolution, the dimensions or the type of projection, or the name of the variable. It also tells us that it only points to the data source and has not imported them into the memory, which makes it easier to work with large datasets.</p>
<p>To access any layer we use <code>[[ ]]</code> with the corresponding index. So we can easily plot any day of the 41,638 days we have.</p>
<pre class="r"><code># map any day
plot(tmx[[200]], col = rev(heat.colors(7)))</code></pre>
<p><img src="/post/en/2020-10-11-climate-animation-maximum-temperature/index.en_files/figure-html/unnamed-chunk-6-1.png" width="672" /></p>
</div>
<div id="calculate-the-average-temperature" class="section level2">
<h2>Calculate the average temperature</h2>
<p>In this step the objective is to calculate the average maximum temperature for each day of the year. Therefore, the first thing we do is to create a vector, indicating the day of the year for the entire time series. In the <code>raster</code> package we have the <code>stackApply()</code> function that allows us to apply another function on groups of layers, or rather, indexes. Since our dataset is large, we include this function in parallelization functions.</p>
<p>For the parallelization we start and end always with the <code>beginClusterr()</code> and <code>endCluster()</code>. In the first function we must indicate the number of cores we want to use. In this case, I use 4 of 7 possible cores, however, the number must be changed according to the characteristics of each CPU, the general rule is n-1. So the <code>clusterR</code> function execute a function in parallel with multiple cores. The first argument corresponds to the raster object, the second to the used function, and as list argument we pass the arguments of the <code>stackApply()</code> function: the indexes that create the groups and the function used for each of the groups. Adding the argument <code>progress = 'text'</code> shows a progress bar of the calculation process.</p>
<div class="alert alert-note">
  <p>For the US dataset I did the preprocessing, the calculation of the average, in a cloud computing platform through <a href="https://earthengine.google.com/">Google Earth Engine</a>, which makes the whole process faster. In the case of Australia the preprocessing was more complex as the dataset is separated in multiple <em>netCDF</em> files for each year.</p>

</div>

<pre class="r"><code># convert the dates between 1901 and 2014 to days of the year
time_days &lt;- yday(seq(as_date(&quot;1901-01-01&quot;), as_date(&quot;2014-12-31&quot;), &quot;day&quot;))

# calculate the average
beginCluster(4)
tmx_mean &lt;- clusterR(tmx, stackApply, args = list(indices = time_days, fun = mean))
endCluster()</code></pre>
</div>
<div id="smooth-the-temperature-variability" class="section level2">
<h2>Smooth the temperature variability</h2>
<p>Before we start to smooth the time series of our <em>RasterBrick</em>, an example of why we do it. We extract a pixel from our dataset at coordinates -1º of longitude and 40º of latitude using the <code>extract()</code> function. Since the function with the same name appears in several packages, we must change to the form <code>package_name::function_name</code>. The result is a matrix with a single row corresponding to the pixel and 366 columns of the days of the year. The next step is to create a <em>data.frame</em> with a <em>dummy</em> date and the extracted maximum temperature.</p>
<pre class="r"><code># extract a pixel
point_ts &lt;- raster::extract(tmx_mean, matrix(c(-1, 40), nrow = 1))
dim(point_ts) # dimensions</code></pre>
<pre><code>## [1]   1 366</code></pre>
<pre class="r"><code># create a data.frame
df &lt;- data.frame(date = seq(as_date(&quot;2000-01-01&quot;), as_date(&quot;2000-12-31&quot;), &quot;day&quot;),
                 tmx = point_ts[1,])

# visualize the maximum temperature
ggplot(df, 
       aes(date, tmx)) + 
     geom_line() + 
  scale_x_date(date_breaks = &quot;month&quot;, date_labels = &quot;%b&quot;) +
  scale_y_continuous(breaks = seq(5, 28, 2)) +
  labs(y = &quot;maximum temperature&quot;, x = &quot;&quot;, colour =  &quot;&quot;) +
  theme_minimal()</code></pre>
<p><img src="/post/en/2020-10-11-climate-animation-maximum-temperature/index.en_files/figure-html/unnamed-chunk-8-1.png" width="672" /></p>
<p>The graph clearly shows the still existing variability, which would cause an animation to fluctuate quite a bit. Therefore, we create a smoothing function based on a local polynomial regression fit (LOESS), more details can be found in the help of the <code>loess()</code> function. The most important argument is <code>span</code>, which determines the degree of smoothing, the smaller the value the less smooth the curve will be. I found the best result showed a value of 0.5.</p>
<pre class="r"><code>daily_smooth &lt;- function(x, span = 0.5){
  
  if(all(is.na(x))){
   
    return(x) 
   
  } else {
    
  df &lt;- data.frame(yd = 1:366, ta = x)
  m &lt;- loess(ta ~ yd, span = span, data = df)
  est &lt;- predict(m, 1:366)

  return(est)
  
  }
}</code></pre>
<p>We apply our new smoothing function to the extracted time series and make some changes to be able to visualize the difference between the original and smoothed data.</p>
<pre class="r"><code># smooth the temperature
df &lt;- mutate(df, tmx_smoothed = daily_smooth(tmx)) %&gt;% 
          pivot_longer(2:3, names_to = &quot;var&quot;, values_to = &quot;temp&quot;)

# visualize the difference
ggplot(df, 
       aes(date, temp, 
           colour = var)) + 
     geom_line() + 
  scale_x_date(date_breaks = &quot;month&quot;, date_labels = &quot;%b&quot;) +
  scale_y_continuous(breaks = seq(5, 28, 2)) +
  scale_colour_manual(values = c(&quot;#f4a582&quot;, &quot;#b2182b&quot;)) +
  labs(y = &quot;maximum temperature&quot;, x = &quot;&quot;, colour =  &quot;&quot;) +
  theme_minimal()</code></pre>
<p><img src="/post/en/2020-10-11-climate-animation-maximum-temperature/index.en_files/figure-html/unnamed-chunk-10-1.png" width="672" /></p>
<p>As we see in the graph, the smoothed curve follows the original curve very well. In the next step we apply our function to the <em>RasterBrick</em> with the <code>calc()</code> function. The function returns as many layers as those returned by the function used for each of the time series.</p>
<pre class="r"><code># smooth the RasterBrick
tmx_smooth &lt;- calc(tmx_mean, fun = daily_smooth)</code></pre>
</div>
</div>
<div id="visualization" class="section level1">
<h1>Visualization</h1>
<div id="preparation-1" class="section level2">
<h2>Preparation</h2>
<p>To visualize the maximum temperatures throughout the year, first, we convert the <em>RasterBrick</em> to a <em>data.frame</em>, including longitude and latitude, but removing all time series without values (<code>NA</code>).</p>
<pre class="r"><code># convert to data.frame
tmx_mat &lt;- as.data.frame(tmx_smooth, xy = TRUE, na.rm = TRUE)

# rename the columns 
tmx_mat &lt;- set_names(tmx_mat, c(&quot;lon&quot;, &quot;lat&quot;, str_c(&quot;D&quot;, 1:366)))
str(tmx_mat[, 1:10])</code></pre>
<pre><code>## &#39;data.frame&#39;:    20676 obs. of  10 variables:
##  $ lon: num  -8.03 -7.98 -7.92 -7.86 -7.8 ...
##  $ lat: num  43.8 43.8 43.8 43.8 43.8 ...
##  $ D1 : num  10.5 10.3 10 10.9 11.5 ...
##  $ D2 : num  10.5 10.3 10.1 10.9 11.5 ...
##  $ D3 : num  10.5 10.3 10.1 10.9 11.5 ...
##  $ D4 : num  10.6 10.4 10.1 10.9 11.5 ...
##  $ D5 : num  10.6 10.4 10.1 11 11.6 ...
##  $ D6 : num  10.6 10.4 10.1 11 11.6 ...
##  $ D7 : num  10.6 10.4 10.2 11 11.6 ...
##  $ D8 : num  10.6 10.4 10.2 11 11.6 ...</code></pre>
<p>Second, we import the administrative boundaries with the <code>ne_countries()</code> function from the <code>rnaturalearth</code> package, limiting the extension to the region of the Iberian Peninsula, southern France and northern Africa.</p>
<pre class="r"><code># import global boundaries
map &lt;- ne_countries(scale = 10, returnclass = &quot;sf&quot;) %&gt;% st_cast(&quot;MULTILINESTRING&quot;)

# limit the extension
map &lt;- st_crop(map, xmin = -10, xmax = 5, ymin = 35, ymax = 44) </code></pre>
<pre><code>## although coordinates are longitude/latitude, st_intersection assumes that they are planar</code></pre>
<pre><code>## Warning: attribute variables are assumed to be spatially constant throughout all
## geometries</code></pre>
<pre class="r"><code># map of boundaries
plot(map)</code></pre>
<pre><code>## Warning: plotting the first 9 out of 94 attributes; use max.plot = 94 to plot
## all</code></pre>
<p><img src="/post/en/2020-10-11-climate-animation-maximum-temperature/index.en_files/figure-html/unnamed-chunk-13-1.png" width="672" /></p>
<p>Third, we create a vector with the day of the year as labels in order to include them later in the animation. In addition, we define the break points for the maximum temperature, adapted to the distribution of our data, to obtain a categorization with a total of 20 classes.</p>
<p>Fourth, we apply the <code>cut()</code> function with the breaks to all the columns with temperature data of each day of the year.</p>
<pre class="r"><code># labels of day of the year
lab &lt;- as_date(0:365, &quot;2000-01-01&quot;) %&gt;% format(&quot;%d %B&quot;)

# breaks for the temperature data
ct &lt;- c(-5, 0, 4, 6, 8, 10, 12, 14, 16, 18, 20, 22, 24, 26, 28, 30, 32, 34, 40, 45)

# categorized data with fixed breaks
tmx_mat_cat &lt;- mutate_at(tmx_mat, 3:368, cut, breaks = ct)</code></pre>
<p>Fifth, we download the Montserrat font and define the colors corresponding to the created classes.</p>
<pre class="r"><code># download font
font_add_google(&quot;Montserrat&quot;, &quot;Montserrat&quot;)

# use of showtext with 300 DPI
showtext_opts(dpi = 300)
showtext_auto()

# define the color ramp
col_spec &lt;- colorRampPalette(rev(brewer.pal(11, &quot;Spectral&quot;)))</code></pre>
</div>
<div id="static-map" class="section level2">
<h2>Static map</h2>
<p>In this first plot we make a map of May 29 (day 150). I am not going to explain all the details of the construction with <code>ggplot2</code>, however, it is important to note that I use the <code>aes_string()</code> function instead of <code>aes()</code> to use the column names in string format. With the <code>geom_raster()</code> function we add the gridded temperature data as the first layer of the graph and with <code>geom_sf()</code> the boundaries in <code>sf</code> class. Finally, the <code>guide_colorsteps()</code> function allows you to create a nice legend based on the classes created by the <code>cut()</code> function.</p>
<pre class="r"><code>ggplot(tmx_mat_cat) + 
         geom_raster(aes_string(&quot;lon&quot;, &quot;lat&quot;, fill = &quot;D150&quot;)) +
         geom_sf(data = map,
                 colour = &quot;grey50&quot;, size = 0.2) +
  coord_sf(expand = FALSE) +
  scale_fill_manual(values = col_spec(20), drop = FALSE) +
  guides(fill = guide_colorsteps(barwidth = 30, 
                                 barheight = 0.5,
                                 title.position = &quot;right&quot;,
                                 title.vjust = .1)) +
   theme_void() +
   theme(legend.position = &quot;top&quot;,
      legend.justification = 1,
      plot.caption = element_text(family = &quot;Montserrat&quot;, 
                                  margin = margin(b = 5, t = 10, unit = &quot;pt&quot;)),                
      plot.title = element_text(family = &quot;Montserrat&quot;, 
                                size = 16, face = &quot;bold&quot;, 
                                margin = margin(b = 2, t = 5, unit = &quot;pt&quot;)),
     legend.text = element_text(family = &quot;Montserrat&quot;),
     plot.subtitle = element_text(family = &quot;Montserrat&quot;, 
                                  size = 13, 
                                  margin = margin(b = 10, t = 5, unit = &quot;pt&quot;))) +
   labs(title = &quot;Average maximum temperature during the year in Spain&quot;, 
     subtitle = lab[150], 
     caption = &quot;Reference period 1901-2014. Data: STEAD&quot;,
     fill = &quot;ºC&quot;)</code></pre>
<p><img src="/img/fig_1.en.png" /></p>
</div>
<div id="animation-of-the-whole-year" class="section level2">
<h2>Animation of the whole year</h2>
<p>The final animation consists of creating a gif from all the images of 366 days, in principle, the <code>gganimate</code> package could be used, but in my experience it is slower, since it requires a <code>data.frame</code> in long format. In this example a long table would have more than seven million rows. So what we do here is to use a loop over the columns and join all the created images with the <code>gifski</code> package that also uses <code>gganimate</code> for rendering.</p>
<p>Before looping we create a vector with the time steps or names of the columns, and another vector with the name of the images, including the name of the folder. In order to obtain a list of images ordered by their number, we must maintain three figures, filling the positions on the left with zeros.</p>
<pre class="r"><code>time_step &lt;- str_c(&quot;D&quot;, 1:366)

files &lt;- str_c(&quot;./ta_anima/D&quot;, str_pad(1:366, 3, &quot;left&quot;, &quot;0&quot;), &quot;.png&quot;)</code></pre>
<p>Lastly, we include the above plot construction in a for loop.</p>
<pre class="r"><code>for(i in 1:366){

 ggplot(tmx_mat_cat) + 
         geom_raster(aes_string(&quot;lon&quot;, &quot;lat&quot;, fill = time_step[i])) +
         geom_sf(data = map,
                 colour = &quot;grey50&quot;, size = 0.2) +
  coord_sf(expand = FALSE) +
  scale_fill_manual(values = col_spec(20), drop = FALSE) +
  guides(fill = guide_colorsteps(barwidth = 30, 
                                 barheight = 0.5,
                                 title.position = &quot;right&quot;,
                                 title.vjust = .1)) +
   theme_void() +
   theme(legend.position = &quot;top&quot;,
      legend.justification = 1,
      plot.caption = element_text(family = &quot;Montserrat&quot;, 
                                  margin = margin(b = 5, t = 10, unit = &quot;pt&quot;)),                
      plot.title = element_text(family = &quot;Montserrat&quot;, 
                                size = 16, face = &quot;bold&quot;, 
                                margin = margin(b = 2, t = 5, unit = &quot;pt&quot;)),
     legend.text = element_text(family = &quot;Montserrat&quot;),
     plot.subtitle = element_text(family = &quot;Montserrat&quot;, 
                                  size = 13, 
                                  margin = margin(b = 10, t = 5, unit = &quot;pt&quot;))) +
   labs(title = &quot;Average maximum temperature during the year in Spain&quot;, 
     subtitle = lab[i], 
     caption = &quot;Reference period 1901-2014. Data: STEAD&quot;,
     fill = &quot;ºC&quot;)
  
  ggsave(files[i], width = 8.28, height = 7.33, type = &quot;cairo&quot;)
  
}</code></pre>
<p>After having created images for each day of the year, we only have to create the gif.</p>
<pre class="r"><code>gifski(files, &quot;tmx_spain.gif&quot;, width = 800, height = 700, loop = FALSE, delay = 0.05)</code></pre>
<p><img src="/img/tmx_spain.en.gif" /></p>
</div>
</div>

    </div>

    


<div class="article-tags">
  
  <a class="badge badge-light" href="/en/tags/animation/">animation</a>
  
  <a class="badge badge-light" href="/en/tags/temperature/">temperature</a>
  
  <a class="badge badge-light" href="/en/tags/climte/">climte</a>
  
  <a class="badge badge-light" href="/en/tags/gis/">GIS</a>
  
</div>



    






<div class="media author-card" itemscope itemtype="http://schema.org/Person">
  
  <img class="portrait mr-3" src="/img/potrai_domi.jpg" itemprop="image" alt="Avatar">
  
  <div class="media-body">
    <h5 class="card-title" itemprop="name"><a href="/en">Dr. Dominic Royé</a></h5>
    
    
    <ul class="network-icon" aria-hidden="true">
      
      
      
      
      
      
      
      
      <li>
        <a itemprop="sameAs" href="mailto:dominic.roye@usc.es" >
          <i class="fa fa-envelope"></i>
        </a>
      </li>
      
      
      
      
        
      
      
      
      
      
        
      
      <li>
        <a itemprop="sameAs" href="//twitter.com/dr_xeo" >
          <i class="fab fa-twitter"></i>
        </a>
      </li>
      
      
      
      
      
      
      
      
        
      
      <li>
        <a itemprop="sameAs" href="https://www.researchgate.net/profile/Dominic_Roye" target="_blank" rel="noopener">
          <i class="ai ai-researchgate"></i>
        </a>
      </li>
      
      
      
      
        
      
      
      
      
      
        
      
      <li>
        <a itemprop="sameAs" href="//github.com/dominicroye" >
          <i class="fab fa-github"></i>
        </a>
      </li>
      
    </ul>
  </div>
</div>




    
    
    <div class="article-widget">
      <div class="hr-light"></div>
      <h3>Related</h3>
      <ul>
        
        <li><a href="/en/2020/visualize-climate-anomalies/">Visualize climate anomalies</a></li>
        
        <li><a href="/en/publication/era5_esp_2020/">Comparison of temperature-mortality associations using observed weather station and reanalysis data in 52 Spanish cities</a></li>
        
        <li><a href="/en/publication/manual_rgis_2019/">Introducción a los SIG con R</a></li>
        
        <li><a href="/en/graphs/climate/">Climate and Weather</a></li>
        
        <li><a href="/en/publication/ncdf_2015/">The use of climate databases netCDF with array structure in the environment of R</a></li>
        
      </ul>
    </div>
    

    
    <div class="article-widget">
      <div class="post-nav">
  
  
  <div class="post-nav-item">
    <div class="meta-nav">Previous</div>
    <a href="/en/2020/river-flow-directions/" rel="prev">River flow directions</a>
  </div>
  
</div>

    </div>
    

    
<section id="comments">
  <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "https-dominicroye-github-io" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</section>



  </div>
</article>

<div class="container">
  <footer class="site-footer">
  

  <p class="powered-by">
    &copy; 2018-2020 Dominic Royé. All rights reserved. &middot; 

    Powered by the
    <a href="https://sourcethemes.com/academic/" target="_blank" rel="noopener">Academic theme</a> for
    <a href="https://gohugo.io" target="_blank" rel="noopener">Hugo</a>.

    
    <span class="float-right" aria-hidden="true">
      <a href="#" id="back_to_top">
        <span class="button_icon">
          <i class="fas fa-chevron-up fa-2x"></i>
        </span>
      </a>
    </span>
    
  </p>
</footer>

</div>


<div id="modal" class="modal fade" role="dialog">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Cite</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <pre><code class="tex hljs"></code></pre>
      </div>
      <div class="modal-footer">
        <a class="btn btn-outline-primary my-1 js-copy-cite" href="#" target="_blank">
          <i class="fas fa-copy"></i> Copy
        </a>
        <a class="btn btn-outline-primary my-1 js-download-cite" href="#" target="_blank">
          <i class="fas fa-download"></i> Download
        </a>
        <div id="modal-error"></div>
      </div>
    </div>
  </div>
</div>

    

    
    

    
    
    
      <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha512-+NqPlbbtM1QqiK8ZAo4Yrj2c4lNQoGv8P79DPtKzj++l5jnN39rHA/xsqn8zE9l0uSoxaCdrOgFs6yjyfbBxSg==" crossorigin="anonymous"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.imagesloaded/4.1.3/imagesloaded.pkgd.min.js" integrity="sha512-umsR78NN0D23AzgoZ11K7raBD+R6hqKojyBZs1w8WvYlsI+QuKRGBx3LFCwhatzBunCjDuJpDHwxD13sLMbpRA==" crossorigin="anonymous"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha256-VsEqElsCHSGmnmHXGQzvoWjWwoznFSZc6hs7ARLRacQ=" crossorigin="anonymous"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.isotope/3.0.4/isotope.pkgd.min.js" integrity="sha512-VDBOIlDbuC4VWxGJNmuFRQ0Li0SKkDpmGyuhAG5LTDLd/dJ/S0WMVxriR2Y+CyPL5gzjpN4f/6iqWVBJlht0tQ==" crossorigin="anonymous"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.2.5/jquery.fancybox.min.js" integrity="sha256-X5PoE3KU5l+JcX+w09p/wHl9AzK333C4hJ2I9S5mD4M=" crossorigin="anonymous"></script>

      
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js" integrity="sha256-/BfiIkHlHoVihZdc6TFuj7MmJ0TWcWsMXkeDFwhi0zw=" crossorigin="anonymous"></script>
        
        <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/r.min.js"></script>
        
      

      
      
    

    
    

    
    
    
    <script id="dsq-count-scr" src="//https-dominicroye-github-io.disqus.com/count.js" async></script>
    

    
    
    <script>hljs.initHighlightingOnLoad();</script>
    

    

    
    

    

    
    

    
    

    
    
    
    
    
    
    
    
    <script src="/js/academic.min.d037ee5294b166a79dec317c58aea9cc.js"></script>

    

  </body>
</html>

