---
categories: ["visualization","R","R:intermediate"]
title: A heatmap as calendar
date: '2020-12-20'
slug: calendar-heatmap
tags: ["calendar","temperature","climate", "heatmap"]
header:
  caption: ''
  image: 'calendar_heatmap_en.png'
lang: en
summary: "Recently I was looking for a visual representation to show the daily changes of temperature, precipitation and wind in an application [xeo81.shinyapps.io/MeteoExtremosGalicia](https://xeo81.shinyapps.io/MeteoExtremosGalicia/) (in Spanish), which led me to use a heatmap in the form of a calendar. The [shiny](https://shiny.rstudio.com/) application is updated every four hours with new data showing calendars for each weather station."
---

Recently I was looking for a visual representation to show the daily changes of temperature, precipitation and wind in an application [xeo81.shinyapps.io/MeteoExtremosGalicia](https://xeo81.shinyapps.io/MeteoExtremosGalicia/) (in Spanish), which led me to use a heatmap in the form of a calendar. The [shiny](https://shiny.rstudio.com/) application is updated every four hours with new data showing calendars for each weather station. The heatmap as a calendar allows you to visualize any variable with a daily time reference.

```{r echo=FALSE, include = FALSE, message=FALSE, warning=FALSE}
Sys.setlocale("LC_ALL","English")
```

## Packages

In this post we will use the following packages:

```{r echo=FALSE,message=FALSE,error=FALSE,warning=FALSE}
library(knitr)

tb <- data.frame(paquete=c("tidyverse", "lubridate",
                           "ragg"),
                 descripcion=c("Collection of packages (visualization, manipulation): ggplot2, dplyr, purrr, etc.",
                               "Easy manipulation of dates and times",
                               "ragg provides a set of high quality and high performance raster devices"

                                ))

kable(tb,booktabs = TRUE,col.names=c("Package","Description"))

```

```{r,message=FALSE,error=FALSE,warning=FALSE}
# instalamos los paquetes si hace falta
if(!require("tidyverse")) install.packages("tidyverse")
if(!require("ragg")) install.packages("ragg")
if(!require("lubridate")) install.packages("lubridate")

# paquetes
library(tidyverse)
library(lubridate)
library(ragg)
```

For those with less experience with ``tidyverse``, I recommend the short introduction on this blog [post](https://dominicroye.github.io/es/2020/una-muy-breve-introducci%C3%B3n-a-tidyverse/).


## Data 

In this example we will use the daily precipitation of Santiago de Compostela for this year 2020 (until December 20) [download](/files/precipitation_santiago.csv).

```{r, message=FALSE, warning=FALSE}
# import the data
dat_pr <- read_csv("precipitation_santiago.csv")
dat_pr
```

## Preparation

In the first step we must 1) complement the time series from December 21 to December 31 with ``NA``, 2) add the day of the week, the month, the week number and the day. Depending on whether we want each week to start on Sunday or Monday, we indicate it in the ``wday()`` function.

```{r, message=FALSE, warning=FALSE}

dat_pr <- dat_pr %>% 
          complete(date = seq(ymd("2020-01-01"), 
                              ymd("2020-12-31"), 
                              "day")) %>%
          mutate(weekday = wday(date, label = T, week_start = 1), 
                 month = month(date, label = T, abbr = F),
                 week = isoweek(date),
                 day = day(date))
```

In the next step we need to make a change in the week of the year, which is because in certain years there may be, for example, a few days at the end of the year as the first week of the following year. We also create two new columns. On the one hand, we categorize precipitation into 14 classes and on the other, we define a white text color for darker tones in the heatmap.

```{r, message=FALSE, warning=FALSE}
  
dat_pr <- mutate(dat_pr, 
                 week = case_when(month == "December" & week == 1 ~ 53,
                                  month == "January" & week %in% 52:53 ~ 0,
                                  TRUE ~ week),
                 pcat = cut(pr, c(-1, 0, .5, 1:5, 7, 9, 15, 20, 25, 30, 300)),
                 text_col = ifelse(pcat %in% c("(15,20]", "(20,25]", "(25,30]", "(30,300]"), 
                                   "white", "black")) 
      
dat_pr  
```


## Visualization

First we create a color ramp from Brewer colors.

```{r}
# color ramp
pubu <- RColorBrewer::brewer.pal(9, "PuBu")
col_p <- colorRampPalette(pubu)

```

Second, before building the chart, we define a custom theme as a function. To do this, we specify all the elements and their modifications with the help of the ``theme()`` function.

```{r}
theme_calendar <- function(){

 theme(aspect.ratio = 1/2,
       
       axis.title = element_blank(),
       axis.ticks = element_blank(),
       axis.text.y = element_blank(),
       axis.text = element_text(family = "Montserrat"),
       
       panel.grid = element_blank(),
       panel.background = element_blank(),
       
       strip.background = element_blank(),
       strip.text = element_text(family = "Montserrat", face = "bold", size = 15),
       
       legend.position = "top",
       legend.text = element_text(family = "Montserrat", hjust = .5),
       legend.title = element_text(family = "Montserrat", size = 9, hjust = 1),
       
       plot.caption =  element_text(family = "Montserrat", hjust = 1, size = 8),
       panel.border = element_rect(colour = "grey", fill=NA, size=1),
       plot.title = element_text(family = "Montserrat", hjust = .5, size = 26, 
                                 face = "bold", 
                                 margin = margin(0,0,0.5,0, unit = "cm")),
       plot.subtitle = element_text(family = "Montserrat", hjust = .5, size = 16)
  )
}
```

Finally, we build the final chart using ``geom_tile()`` and specify the day of the week as the X axis and the week number as the Y axis. As you can see in the variable of the week number (``-week``), I change the sign so that the first day of each month is in the first row. With ``geom_text()`` we add the number of each day with its color according to what we defined previously. In ``guides`` we make the adjustments of the colorbar and in ``scale_fill/colour_manual()`` we define the corresponding colors. An important step is found in ``facet_wrap()`` where we specify the facets composition of each month. The facets should have free scales and the ideal would be a 4 x 3 facet distribution. It is possible to modify the position of the day number to another using the arguments ``nudge_*`` in ``geom_text()`` (eg bottom-right corner: nudge_x = .35, nudge_y = -.25).

```{r, fig.height = 10, fig.width = 8, div = "ragg_png", message=FALSE, warning=FALSE}

    ggplot(dat_pr, 
           aes(weekday, -week, fill = pcat)) +
      geom_tile(colour = "white", size = .4)  + 
      geom_text(aes(label = day, colour = text_col), size = 2.5) +
      guides(fill = guide_colorsteps(barwidth = 25, 
                                     barheight = .4,
                                    title.position = "top")) +
       scale_fill_manual(values = c("white", col_p(13)),
                         na.value = "grey90", drop = FALSE) +
       scale_colour_manual(values = c("black", "white"), guide = FALSE) + 
       facet_wrap(~ month, nrow = 4, ncol = 3, scales = "free") +
       labs(title = "How is 2020 being in Santiago?", 
             subtitle = "Precipitation",
             caption = "Data: Meteogalicia",
             fill = "mm") +
       theme_calendar()

```

To export we will use the [``ragg``](https://github.com/r-lib/ragg) package, which provides higher performance and quality than the standard raster devices provided by grDevices.

```{r, message=FALSE, warning=FALSE}
ggsave("pr_calendar.png", height = 10, width = 8, device = agg_png())
```

In other heatmap calendars I have added the predominant wind direction of each day as an arrow using ``geom_arrow()`` from the ``metR`` package (it can be seen in the aforementioned application).
