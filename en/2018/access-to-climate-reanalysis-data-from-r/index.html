<!DOCTYPE html><html lang="en-us" >


<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  
  
  
    <meta name="generator" content="Wowchemy 5.3.0 for Hugo" />
  

  
  









  




  
  
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  

  
  
  
    
      
      <link rel="preload" as="style" href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Roboto+Mono&family=Roboto:wght@400;700&display=swap">
      <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Roboto+Mono&family=Roboto:wght@400;700&display=swap" media="print" onload="this.media='all'">
    
  

  
  
  
  
  
    
    
    
  
  

  <meta name="author" content="Dr. Dominic Royé" />

  
  
  
    
  
  <meta name="description" content="In this post, I will show how we can download and work directly with data from climatic reanalysis in R. These kind of datasets are combination of forcast models and data assimilation systems, which allows us to create corrected global grids of recent history of the atmosphere, land surface, and oceans." />

  
  <link rel="alternate" hreflang="en-us" href="https://dominicroye.github.io/en/2018/access-to-climate-reanalysis-data-from-r/" />

  
  
  
    <meta name="theme-color" content="#1565c0" />
  

  
  

  

  <link rel="stylesheet" href="/css/vendor-bundle.min.f1ecf783c14edc00c9320c205831ad8e.css" media="print" onload="this.media='all'">

  
  
  
    
    
      <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/academicons@1.9.1/css/academicons.min.css" integrity="sha512-W0xM4mr6dEP9nREo7Z9z+9X70wytKvMGeDsj7ps2+xg5QPrEBXC8tAW1IFnzjR6eoJ90JmCnFzerQJTLzIEHjA==" crossorigin="anonymous" media="print" onload="this.media='all'">
    

    
    
    
    
      
      
    
    
    

    
    
    
      
    
    
      
      
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@10.2.1/build/styles/dracula.min.css" crossorigin="anonymous" title="hl-light" media="print" onload="this.media='all'">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@10.2.1/build/styles/dracula.min.css" crossorigin="anonymous" title="hl-dark" media="print" onload="this.media='all'" disabled>
      
    

    
    
    
      <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.7.1/dist/leaflet.min.css" integrity="" crossorigin="anonymous" media="print" onload="this.media='all'">
    

    

    
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      
        
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
  

  
  
  
  
  
  <link rel="stylesheet" href="/css/wowchemy.b48d89910a3f8560bb2d78fedea8d682.css" />

  




<script async src="https://www.googletagmanager.com/gtag/js?id=UA-27463794-2"></script>
<script>
  window.dataLayer = window.dataLayer || [];

  function gtag() {
      dataLayer.push(arguments);
  }

  function trackOutboundLink(url, target) {
    gtag('event', 'click', {
         'event_category': 'outbound',
         'event_label': url,
         'transport_type': 'beacon',
         'event_callback': function () {
           if (target !== '_blank') {
             document.location = url;
           }
         }
    });
    console.debug("Outbound link clicked: " + url);
  }

  function onClickCallback(event) {
    if ((event.target.tagName !== 'A') || (event.target.host === window.location.host)) {
      return;
    }
    trackOutboundLink(event.target, event.target.getAttribute('target'));  
  }

  gtag('js', new Date());
  gtag('config', 'UA-27463794-2', {});
  gtag('set', {'cookie_flags': 'SameSite=None;Secure'});

  
  document.addEventListener('click', onClickCallback, false);
</script>


  

  

  




  
  
  

  

  
    <link rel="manifest" href="/en/manifest.webmanifest" />
  

  <link rel="icon" type="image/png" href="/media/icon_hu27cb63416a395b8c8d0d7112b85e26a9_17299_32x32_fill_lanczos_center_3.png" />
  <link rel="apple-touch-icon" type="image/png" href="/media/icon_hu27cb63416a395b8c8d0d7112b85e26a9_17299_180x180_fill_lanczos_center_3.png" />

  <link rel="canonical" href="https://dominicroye.github.io/en/2018/access-to-climate-reanalysis-data-from-r/" />

  
  
  
  
  
  
  
  
    
  
  

  
  
    
    
  
  <meta property="twitter:card" content="summary_large_image" />
  
    <meta property="twitter:site" content="@@dr_xeo" />
    <meta property="twitter:creator" content="@@dr_xeo" />
  
  <meta property="og:site_name" content="Dr. Dominic Royé" />
  <meta property="og:url" content="https://dominicroye.github.io/en/2018/access-to-climate-reanalysis-data-from-r/" />
  <meta property="og:title" content="Access to climate reanalysis data from R | Dr. Dominic Royé" />
  <meta property="og:description" content="In this post, I will show how we can download and work directly with data from climatic reanalysis in R. These kind of datasets are combination of forcast models and data assimilation systems, which allows us to create corrected global grids of recent history of the atmosphere, land surface, and oceans." /><meta property="og:image" content="https://dominicroye.github.io/en/2018/access-to-climate-reanalysis-data-from-r/featured.png" />
    <meta property="twitter:image" content="https://dominicroye.github.io/en/2018/access-to-climate-reanalysis-data-from-r/featured.png" /><meta property="og:locale" content="en-us" />
  
    
      <meta
        property="article:published_time"
        content="2018-09-15T10:59:44&#43;01:00"
      />
    
    <meta property="article:modified_time" content="2018-09-15T10:59:44&#43;01:00">
  

  


    






  




<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://dominicroye.github.io/en/2018/access-to-climate-reanalysis-data-from-r/"
  },
  "headline": "Access to climate reanalysis data from R",
  
  "image": [
    "https://dominicroye.github.io/en/2018/access-to-climate-reanalysis-data-from-r/featured.png"
  ],
  
  "datePublished": "2018-09-15T10:59:44+01:00",
  "dateModified": "2018-09-15T10:59:44+01:00",
  
  "author": {
    "@type": "Person",
    "name": "Dr. Dominic Royé"
  },
  
  "publisher": {
    "@type": "Organization",
    "name": "University of Santiago de Compostela",
    "logo": {
      "@type": "ImageObject",
      "url": "https://dominicroye.github.io/media/logo_hu6637600e1c36fe7812a10a6623aaebda_116520_192x192_fit_lanczos_3.png"
    }
  },
  "description": "In this post, I will show how we can download and work directly with data from climatic reanalysis in R. These kind of datasets are combination of forcast models and data assimilation systems, which allows us to create corrected global grids of recent history of the atmosphere, land surface, and oceans."
}
</script>

  

  

  

  





  <title>Access to climate reanalysis data from R | Dr. Dominic Royé</title>
</head>


<body id="top" data-spy="scroll" data-offset="70" data-target="#TableOfContents" class="page-wrapper   " data-wc-page-id="786e97c169dec212e503ce7288af513e" >

  
  
  
  
  
  
  
  
  
  <script src="/js/wowchemy-init.min.2da3b1fa37e894630bf6de39b1b694b3.js"></script>

  




  <div class="page-header">
    







 



  


<header class="header--fixed">
  <nav class="navbar navbar-expand-lg navbar-light compensate-for-scrollbar" id="navbar-main">
    <div class="container-xl">

      
      <div class="d-none d-lg-inline-flex">
        <a class="navbar-brand" href="/en/"><img src="/media/logo_hu6637600e1c36fe7812a10a6623aaebda_116520_0x70_resize_lanczos_3.png" alt="Dr. Dominic Royé"
            
            >
             <div style = "padding-top:0.5em;">Dr. Dominic Royé</div></a>
      </div>
      

      
      <button type="button" class="navbar-toggler" data-toggle="collapse"
              data-target="#navbar-content" aria-controls="navbar-content" aria-expanded="false" aria-label="Toggle navigation">
      <span><i class="fas fa-bars"></i></span>
      </button>
      

      
      <div class="navbar-brand-mobile-wrapper d-inline-flex d-lg-none">
        <a class="navbar-brand" href="/en/"><img src="/media/logo_hu6637600e1c36fe7812a10a6623aaebda_116520_0x70_resize_lanczos_3.png" alt="Dr. Dominic Royé"
          
          ></a>
      </div>
      

      
      
      <div class="navbar-collapse main-menu-item collapse justify-content-end" id="navbar-content">

        
        <ul class="navbar-nav d-md-inline-flex">
          

          

          
          
          

          

          
          
          
          

          
            
            
          

          <li class="nav-item">
            <a class="nav-link " href="/en/#"><span>home</span></a>
          </li>

          
          

          

          
          
          
            
          

          

          
          
          
          

          
            
              
              
            
            
              
              
              
                
              
              
            
          

          <li class="nav-item">
            <a class="nav-link " href="/en/#posts"><span>blog</span></a>
          </li>

          
          

          

          
          
          
            
          

          

          
          
          
          

          
            
              
              
            
            
              
              
              
                
              
              
            
          

          <li class="nav-item">
            <a class="nav-link " href="/en/#featured"><span>publications</span></a>
          </li>

          
          

          

          
          
          
            
          

          

          
          
          
          

          
            
              
              
            
            
              
              
              
                
              
              
            
          

          <li class="nav-item">
            <a class="nav-link " href="/en/#projects"><span>graphs</span></a>
          </li>

          
          

          

          
          
          
            
          

          

          
          
          
          

          
            
              
              
            
            
              
              
              
                
              
              
            
          

          <li class="nav-item">
            <a class="nav-link " href="/en/#about"><span>me</span></a>
          </li>

          
          

        

          
        </ul>
      </div>

      <ul class="nav-icons navbar-nav flex-row ml-auto d-flex pl-md-2">

        
        
          
            
            <li class="nav-item d-none d-lg-inline-flex">
              <a class="nav-link" href="https://twitter.com/dr_xeo" data-toggle="tooltip" data-placement="bottom" title="Follow me on Twitter" target="_blank" rel="noopener" aria-label="Follow me on Twitter">
                <i class="fab fa-twitter" aria-hidden="true"></i>
              </a>
            </li>
          
        

        
        

        
        

        
        

      </ul>

    </div>
  </nav>
</header>


  </div>

  <div class="page-body">
    <article class="article">

  




















  
  
    
  


<div class="article-container pt-3">
  <h1>Access to climate reanalysis data from R</h1>

  

  


<div class="article-metadata">

  
  

  
  <span class="article-date">
    
    
      
    
    2018-09-15
  </span>
  

  

  
  <span class="middot-divider"></span>
  <span class="article-reading-time">
    10 min read
  </span>
  

  
  
  
  
  
  

  
  
  <span class="middot-divider"></span>
  <span class="article-categories">
    <i class="fas fa-folder mr-1"></i><a href="/en/category/r/">R</a>, <a href="/en/category/rintermediate/">R:intermediate</a></span>
  

</div>

  





</div>


<div class="article-header article-container featured-image-wrapper mt-4 mb-4" style="max-width: 720px; max-height: 572px;">
  <div style="position: relative">
    <img src="/en/2018/access-to-climate-reanalysis-data-from-r/featured_hubf5f1f4c663823de4fface96a92fe838_257097_720x0_resize_lanczos_3.png" width="720" height="572" alt="" class="featured-image">
    
  </div>
</div>



  <div class="article-container">

    <div class="article-style">
      
<script src="https://dominicroye.github.io/en/2018/access-to-climate-reanalysis-data-from-r/index.en_files/header-attrs/header-attrs.js"></script>

<div id="TOC">
<ul>
<li><a href="#introduction"><span class="toc-section-number">1</span> Introduction</a></li>
<li><a href="#ncep"><span class="toc-section-number">2</span> NCEP</a>
<ul>
<li><a href="#packages"><span class="toc-section-number">2.1</span> Packages</a></li>
<li><a href="#data-download"><span class="toc-section-number">2.2</span> Data download</a></li>
<li><a href="#monthly-average"><span class="toc-section-number">2.3</span> Monthly average</a></li>
<li><a href="#visualization"><span class="toc-section-number">2.4</span> Visualization</a></li>
</ul></li>
<li><a href="#era-interim"><span class="toc-section-number">3</span> ERA-Interim</a>
<ul>
<li><a href="#installation"><span class="toc-section-number">3.1</span> Installation</a></li>
<li><a href="#connection-and-download-with-the-ecmwf-api"><span class="toc-section-number">3.2</span> Connection and download with the ECMWF API</a></li>
<li><a href="#processing-ncdf"><span class="toc-section-number">3.3</span> Processing ncdf</a></li>
</ul></li>
<li><a href="#update-for-accessing-era-5"><span class="toc-section-number">4</span> Update for accessing ERA-5</a></li>
</ul>
</div>

<p><em>A friend advised me to introduce R levels as categories. An idea that I now add to each blog post. There are three levels: elementary, intermediate, and advanced. I hope it will help the reader and the R user.</em></p>
<hr />
<div id="introduction" class="section level1" number="1">
<h1><span class="header-section-number">1</span> Introduction</h1>
<p>In this post, I will show how we can download and work directly with data from climatic reanalysis in R. These kind of datasets are a combination of forcast models and data assimilation systems, which allows us to create corrected global grids of recent history of the atmosphere, land surface, and oceans. The two most used reanalyses are <a href="https://climatedataguide.ucar.edu/climate-data/ncep-reanalysis-r2">NCEP-DO</a> (Reanalysis II) from the <em>NOAA/OAR/ESRL</em>, an improved version of <em>NCEP-NCAR</em> (Reanalysis I), and <em>ERA-Interim</em> from the <a href="https://www.ecmwf.int/en/research/climate-reanalysis"><em>ECMWF</em></a>. Since <em>NCEP-DO</em> is the first generation, it is recommended to use third-generation climate reanalysis, especially <em>ERA-Interim</em>. An overview of the current atmospheric reanalysis can be found <a href="https://reanalyses.org/index.php/atmosphere/overview-current-atmospheric-reanalyses">here</a>. First, let’s see how to access the <em>NCEP</em> data through an R library on <em>CRAN</em> that facilitates the download and handling of the data. Then we will do the same with the <em>ERA-Interim</em>, however, to access this last reanalysis dataset it is necessary to use <em>python</em> and the corresponding API of the <em>ECMWF</em>.</p>
</div>
<div id="ncep" class="section level1" number="2">
<h1><span class="header-section-number">2</span> NCEP</h1>
<p>To access the <em>NCEP</em> reanalysis it is required to install the corresponding package <em>RNCEP</em>. The main function is <code>NCEP.gather( )</code>. The resolution of the <em>NCEP</em> reanalysis is 2.5º X 2.5º.</p>
<div id="packages" class="section level2" number="2.1">
<h2><span class="header-section-number">2.1</span> Packages</h2>
<pre class="r"><code>#install the RNCEP, lubridate and tidyverse packages
if(!require(&quot;RNCEP&quot;)) install.packages(&quot;RNCEP&quot;)
if(!require(&quot;lubridate&quot;)) install.packages(&quot;lubridate&quot;)
if(!require(&quot;tidyverse&quot;)) install.packages(&quot;tidyverse&quot;)
if(!require(&quot;sf&quot;)) install.packages(&quot;sf&quot;)

#load the packages
library(RNCEP)
library(lubridate) #date and time manipulation
library(tidyverse) #data manipulation and visualization
library(RColorBrewer) #color schemes
library(sf) #to import a spatial object and to work with geom_sf in ggplot2</code></pre>
</div>
<div id="data-download" class="section level2" number="2.2">
<h2><span class="header-section-number">2.2</span> Data download</h2>
<p>We will download the air temperature of the 850haPa pressure level for the year 2016. The variables and pressure levels can be found in the details of the function <code>?NCEP.gather</code>. The <em>reanalysis2</em> argument allows us to download both version I and version II, being by default <em>FALSE</em>, that is, we access reanalysis I. In all the requests we will obtain data of every 6 hours (00:00, 06:00, 12:00 and 18:00). This supposes a total of 1464 values for the year 2016.</p>
<pre class="r"><code>#define the necessary arguments
month_range &lt;- c(1,12)     #period of months
year_range &lt;- c(2016,2016) #period of years

lat_range &lt;- c(30,60)      #latitude range
lon_range &lt;- c(-30,50)     #longitude range
 

data &lt;- NCEP.gather(&quot;air&quot;,    #name of the variable
                    850, #pressure level 850hPa
                    month_range,year_range,
                    lat_range,lon_range,
                    return.units = TRUE,
                    reanalysis2=TRUE)</code></pre>
<pre><code>## [1] Units of variable &#39;air&#39; are degK
## [1] Units of variable &#39;air&#39; are degK</code></pre>
<pre class="r"><code>#dimensions                    
dim(data) </code></pre>
<pre><code>## [1]   13   33 1464</code></pre>
<pre class="r"><code>#we find lon, lat and time with dimnames()
#date and time
date_time &lt;- dimnames(data)[[3]]
date_time &lt;- ymd_h(date_time)
head(date_time)</code></pre>
<pre><code>## [1] &quot;2016-01-01 00:00:00 UTC&quot; &quot;2016-01-01 06:00:00 UTC&quot;
## [3] &quot;2016-01-01 12:00:00 UTC&quot; &quot;2016-01-01 18:00:00 UTC&quot;
## [5] &quot;2016-01-02 00:00:00 UTC&quot; &quot;2016-01-02 06:00:00 UTC&quot;</code></pre>
<pre class="r"><code>#longitude and latitude
lat &lt;- dimnames(data)[[1]]
lon &lt;- dimnames(data)[[2]]
head(lon);head(lat)</code></pre>
<pre><code>## [1] &quot;-30&quot;   &quot;-27.5&quot; &quot;-25&quot;   &quot;-22.5&quot; &quot;-20&quot;   &quot;-17.5&quot;</code></pre>
<pre><code>## [1] &quot;60&quot;   &quot;57.5&quot; &quot;55&quot;   &quot;52.5&quot; &quot;50&quot;   &quot;47.5&quot;</code></pre>
</div>
<div id="monthly-average" class="section level2" number="2.3">
<h2><span class="header-section-number">2.3</span> Monthly average</h2>
<p>We see that the downloaded data is an <em>array</em> of three dimensions with [lat, lon, time]. As above mentioned, we extracted latitude, longitude and time. The temperature is given in Kelvin. The objective in the next section will be to show two maps comparing January and July.</p>
<pre class="r"><code>#create our grouping variable
group &lt;- month(date_time) 

#estimate the average temperature by month 
data_month &lt;- aperm(
  apply(
    data, #our data
    c(1,2), #apply to each time series 1:row, 2:column a the mean( ) function
    by, #group by
    group, #months
    function(x)ifelse(all(is.na(x)),NA,mean(x))),
  c(2,3,1)) #reorder to get an array like the original

dim(data_month) #850haPa temperature per month January to December</code></pre>
<pre><code>## [1] 13 33 12</code></pre>
</div>
<div id="visualization" class="section level2" number="2.4">
<h2><span class="header-section-number">2.4</span> Visualization</h2>
<p>Once we got here, we can visualize the 850hPa temperature of January and July with <em>ggplot2</em>. In this example, I use <code>geom_sf( )</code> from the library <a href="https://github.com/r-spatial/sf"><em>sf</em></a>, which makes the work easier to visualize spatial objects in <em>ggplot</em> (in the near future I will make a post about <em>sf</em> and <em>ggplot</em>). In the dimension of latitude and longitude we saw that it only indicates a value for each row and column. But we need the coordinates of all the cells in the matrix. To create all combinations between two variables we can use the <code>expand.grid( )</code> function.</p>
<pre class="r"><code>#first we create all the combinations of lon-lat
lonlat &lt;- expand.grid(lon=lon,lat=lat)

#as lonlat was a row/column name, it is character, that&#39;s why we convert it into numeric
lonlat &lt;- apply(lonlat,2,as.numeric)

#lon and lat are not in the order as we expect
#row=lon; column=lat
data_month &lt;- aperm(data_month,c(2,1,3))

#subtract 273.15K to convert K to ºC.
df &lt;- data.frame(lonlat,
                 Ta01=as.vector(data_month[,,1])-273.15,
                 Ta07=as.vector(data_month[,,7])-273.15)</code></pre>
<p>Before we can make the map with <em>ggplot2</em>, we have to adapt the table. The shapefile with the countries limits can be downloaded <a href="/files/CNTR_RG_03M_2014.zip">here</a>.</p>
<pre class="r"><code>#convert the wide table into a long one
df &lt;- gather(df,month,Ta,Ta01:Ta07)%&gt;%
             mutate(month=factor(month,unique(month),c(&quot;Jan&quot;,&quot;Jul&quot;)))

#import the countries limits
limit &lt;- st_read(&quot;CNTR_RG_03M_2014.shp&quot;)</code></pre>
<pre><code>## Reading layer `CNTR_RG_03M_2014&#39; from data source 
##   `E:\GitHub\blog_update_2021\content\en\post\2018-09-15-access-to-climate-reanalysis-data-from-r\CNTR_RG_03M_2014.shp&#39; 
##   using driver `ESRI Shapefile&#39;
## Simple feature collection with 256 features and 3 fields
## Geometry type: MULTIPOLYGON
## Dimension:     XY
## Bounding box:  xmin: -180 ymin: -90 xmax: 180 ymax: 83.66068
## Geodetic CRS:  ETRS89</code></pre>
<pre class="r"><code>#color scheme
colbr &lt;- brewer.pal(11,&quot;RdBu&quot;)

ggplot(df)+
      geom_tile(aes(lon,lat,fill=Ta))+ #temperature data
      geom_sf(data=limit,fill=NA,size=.5)+ #limits 
        scale_fill_gradientn(colours=rev(colbr))+
          coord_sf(ylim=c(30,60),xlim=c(-30,50))+
          scale_x_continuous(breaks=seq(-30,50,10),expand=c(0,0))+
          scale_y_continuous(breaks=seq(30,60,5),expand=c(0,0))+
          labs(x=&quot;&quot;,y=&quot;&quot;,fill=&quot;Ta 850hPa (ºC)&quot;)+
           facet_grid(month~.)+ #plot panels by month
             theme_bw()</code></pre>
<p><img src="https://dominicroye.github.io/en/2018/access-to-climate-reanalysis-data-from-r/index.en_files/figure-html/unnamed-chunk-5-1.png" width="672" /></p>
</div>
</div>
<div id="era-interim" class="section level1" number="3">
<h1><span class="header-section-number">3</span> ERA-Interim</h1>
<p>The <em>ECMWF</em> offers access to its public databases from a <a href="https://confluence.ecmwf.int//display/WEBAPI/Access+ECMWF+Public+Datasets"><em>pyhton-API</em></a>. It is required to be registered on the <em>ECMWF</em> website. You can register <a href="https://apps.ecmwf.int/registration/">here</a>. When dealing with another programming language, in R we have to use an interface between both which allows the library <a href="https://github.com/rstudio/reticulate"><em>reticulate</em></a>. We must also have installed a pyhton distribution (version 2.x or 3.x). In the case of Windows we can use <a href="https://www.anaconda.com/download/">anaconda</a>.</p>
<p><div class="alert alert-note">
  <div>
    Recently a new package called <code>ecmwfr</code> has been published that facilitates accessing the Copernicus and ECMWF APIs. The major advantage is that it is not necessary to install <code>python</code>. More details <a href="https://github.com/khufkens/ecmwfr">here</a>. I wrote a more updated version in 2022.
  </div>
</div>
</p>
<div id="installation" class="section level2" number="3.1">
<h2><span class="header-section-number">3.1</span> Installation</h2>
<pre class="r"><code>if(!require(&quot;reticulate&quot;)) install.packages(&quot;reticulate&quot;)
if(!require(&quot;ncdf4&quot;)) install.packages(&quot;ncdf4&quot;) #to manage netCDF format

#load packages
library(reticulate)
library(ncdf4)</code></pre>
<p>Once we have installed <em>anaconda</em> and the package <em>reticulate</em>, we can install the library <em>python ecmwfapi</em>. We can carry out the installation, or through the Windows CMD using the command <em>conda install -c conda-forge ecmwf-api-client</em>, or with the R function <code>py_install( )</code> from the <em>reticulate</em> package. The same function allows us to install any <em>python</em> library from R.</p>
<pre class="r"><code>#install the python ECMWF API
py_install(&quot;ecmwf-api-client&quot;)</code></pre>
</div>
<div id="connection-and-download-with-the-ecmwf-api" class="section level2" number="3.2">
<h2><span class="header-section-number">3.2</span> Connection and download with the ECMWF API</h2>
<p>In order to access the API, it is required to create a file with the user’s information.</p>
<p>The “.ecmwfapirc” file must contain the following information:</p>
<pre><code>{
    &quot;url&quot;   : &quot;https://api.ecmwf.int/v1&quot;,
    &quot;key&quot;   : &quot;XXXXXXXXXXXXXXXXXXXXXX&quot;,
    &quot;email&quot; : &quot;john.smith@example.com&quot;
}</code></pre>
<p>The key can be obtained with the user account <a href="https://api.ecmwf.int/v1/key/">here</a>.</p>
<p>The file can be created with the Windows notebook.</p>
<ol style="list-style-type: decimal">
<li>We create a document “ecmwfapirc.txt”.</li>
<li>Rename this file to “.ecmwfapirc.”</li>
</ol>
<p>The last point disappears automatically. Then we save this file in “C:/USERNAME/.ecmwfapirc” or “C:/USERNAME/Documents/.ecmwfapirc”.</p>
<pre class="r"><code>#import the python library ecmwfapi
ecmwf &lt;- import(&#39;ecmwfapi&#39;)

#for this step there must exist the file .ecmwfapirc
server = ecmwf$ECMWFDataServer() #start the connection</code></pre>
<p>One we get here, how do we create a query? The easiest thing is to go to the website of <a href="http://apps.ecmwf.int/datasets/data/interim-full-daily/levtype=sfc/"><em>ECMWF</em></a>, where we choose the database, in this case <em>ERA-Interim</em> surface, to create a script with all the necessary data. More details about the syntax can be found <a href="https://confluence.ecmwf.int/display/WEBAPI/Brief+request+syntax">here</a>. When we proceed on the website, we only have to click on “View MARS Request”. This step takes us to the script in <em>python</em>.</p>
<p><img src="erainterim1.png" /></p>
<p><img src="erainterim2.png" /></p>
<p>With the syntax of the script from the <em>MARS Request</em>, we can create the query in R.</p>
<pre class="r"><code>#we create the query
query &lt;-r_to_py(list(
  class=&#39;ei&#39;,
  dataset= &quot;interim&quot;, #dataset
  date= &quot;2017-01-01/to/2017-12-31&quot;, #time period
  expver= &quot;1&quot;,
  grid= &quot;0.125/0.125&quot;, #resolution
  levtype=&quot;sfc&quot;,
  param= &quot;167.128&quot;, # air temperature (2m)
  area=&quot;45/-10/30/5&quot;, #N/W/S/E
  step= &quot;0&quot;,
  stream=&quot;oper&quot;,
  time=&quot;00:00:00/06:00:00/12:00:00/18:00:00&quot;, #hours
  type=&quot;an&quot;,
  format= &quot;netcdf&quot;, #format
  target=&#39;ta2017.nc&#39; #file name
))

#query to get the ncdf
server$retrieve(query)</code></pre>
<p>The result is a netCDF file that we can process with the library <em>ncdf4</em>.</p>
</div>
<div id="processing-ncdf" class="section level2" number="3.3">
<h2><span class="header-section-number">3.3</span> Processing ncdf</h2>
<p>In the next section, the objective will be the extraction of a time serie from the closest coordinate to a given one. We will use the coordinates of Madrid (40.418889, -3.691944).</p>
<pre class="r"><code>#load packages
library(sf)
library(ncdf4)
library(tidyverse)</code></pre>
<pre class="r"><code>#open the connection with the ncdf file
nc &lt;- nc_open(&quot;ta2017.nc&quot;)

#extract lon and lat
lat &lt;- ncvar_get(nc,&#39;latitude&#39;)
lon &lt;- ncvar_get(nc,&#39;longitude&#39;)
dim(lat);dim(lon)

#extract the time
t &lt;- ncvar_get(nc, &quot;time&quot;)

#time unit: hours since 1900-01-01
ncatt_get(nc,&#39;time&#39;)

#convert the hours into date + hour
#as_datetime() function of the lubridate package needs seconds
timestamp &lt;- as_datetime(c(t*60*60),origin=&quot;1900-01-01&quot;)

#import the data
data &lt;- ncvar_get(nc,&quot;t2m&quot;)

#close the conection with the ncdf file
nc_close(nc)</code></pre>
<p>In this next section we use the <em>sf</em> package, which is replacing the well known <em>sp</em> and <em>rgdal</em> packages.</p>
<pre class="r"><code>#create all the combinations of lon-lat
lonlat &lt;- expand.grid(lon=lon,lat=lat)

#we must convert the coordinates in a spatial object sf
#we also indicate the coordinate system in EPSG code
coord &lt;- st_as_sf(lonlat,coords=c(&quot;lon&quot;,&quot;lat&quot;))%&gt;%
                    st_set_crs(4326)

#we do the same with our coordinate of Madrid
psj &lt;- st_point(c(-3.691944,40.418889))%&gt;%
                   st_sfc()%&gt;%
                     st_set_crs(4326)

#plot all points
plot(st_geometry(coord))
plot(psj,add=TRUE,pch = 3, col = &#39;red&#39;)</code></pre>
<p>In the next steps we calculate the distance of our reference point to all the grid points. Then we look for the one with less distance.</p>
<pre class="r"><code>#add the distance to the points
coord &lt;- mutate(coord,dist=st_distance(coord,psj))

#create a distance matrix with the same dimensions as our data
dist_mat &lt;- matrix(coord$dist,dim(data)[-3])

#the arrayInd function is useful to obtain the row and column indexes
mat_index &lt;- as.vector(arrayInd(which.min(dist_mat), dim(dist_mat)))

#we extract the time serie and change the unit from K to ºC
#we convert the time in date + hour
df &lt;- data.frame(ta=data[mat_index[1],mat_index[2],],time=timestamp)%&gt;%
        mutate(ta=ta-273.15,time=ymd_hms(time))</code></pre>
<p>Finally, we visualize our time series.</p>
<pre class="r"><code>ggplot(df,
       aes(time,ta))+
    geom_line()+
    labs(y=&quot;Temperature (ºC)&quot;,
             x=&quot;&quot;)+
    theme_bw()</code></pre>
</div>
</div>
<div id="update-for-accessing-era-5" class="section level1" number="4">
<h1><span class="header-section-number">4</span> Update for accessing ERA-5</h1>
<p>Recently the new reanalysis ERA-5 with <a href="https://cds.climate.copernicus.eu/cdsapp#!/dataset/reanalysis-era5-single-levels?tab=overview">single level</a> or <a href="https://cds.climate.copernicus.eu/cdsapp#!/dataset/reanalysis-era5-pressure-levels?tab=overview">pressure level</a> was made available to users. It is the fifth generation of the European Center for Medium-Range Weather Forecasts (ECMWF) and accessible through a new Copernicus API. The ERA-5 reanalysis has a temporary coverage from 1950 to the present at a horizontal resolution of 30km worldwide, with 137 levels from the surface to a height of 80km. An important difference with respect to the previous ERA-Interim is the temporal resolution with hourly data.</p>
<p>The access changes to the Climate Data Store (CDS) infrastructure with its own API. It is possible to download directly from the web or using the Python API in a similar way to the one already presented in this post. However, there are slight differences which I will explain below.</p>
<ol style="list-style-type: decimal">
<li>It is necessary to have a Copernicus CDS account <a href="https://cds.climate.copernicus.eu/user/register">link</a></li>
<li>Again, you need a account key <a href="https://cds.climate.copernicus.eu/api-how-to">link</a></li>
<li>There are changes in the Python library and in some arguments of the query.</li>
</ol>
<pre class="r"><code>#load libraries 
library(sf)
library(ncdf4)
library(tidyverse)
library(reticulate)

#install the CDS API
conda_install(&quot;r-reticulate&quot;,&quot;cdsapi&quot;, pip=TRUE)</code></pre>
<p>To be able to access the API, a requirement is to create a file with the user’s information.</p>
<p>The “.cdsapirc” file must contain the following information:</p>
<pre><code>
url: https://cds.climate.copernicus.eu/api/v2
key: {uid}:{api-key}
</code></pre>
<p>The key can be obtained with the user account in the <em>User profile</em>.</p>
<p>The file can be created in the same way as it has been explained for ERA-Interim.</p>
<pre class="r"><code>#import python CDS-API
cdsapi &lt;- import(&#39;cdsapi&#39;)

#for this step there must exist the file .cdsapirc
server = cdsapi$Client() #start the connection</code></pre>
<p>With the syntax of the script from the <em>Show API request</em> <a href="https://cds.climate.copernicus.eu/cdsapp#!/dataset/reanalysis-era5-single-levels?tab=overview">single level</a>, we can create the query in R.</p>
<pre class="r"><code>#we create the query
query &lt;- r_to_py(list(
    variable= &quot;2m_temperature&quot;,
    product_type= &quot;reanalysis&quot;,
    year= &quot;2018&quot;,
    month= &quot;07&quot;, #formato: &quot;01&quot;,&quot;01&quot;, etc.
    day= str_pad(1:31,2,&quot;left&quot;,&quot;0&quot;),   
    time= str_c(0:23,&quot;00&quot;,sep=&quot;:&quot;)%&gt;%str_pad(5,&quot;left&quot;,&quot;0&quot;),
    format= &quot;netcdf&quot;,
    area = &quot;45/-20/35/5&quot; # North, West, South, East
  ))

#query to get the ncdf
server$retrieve(&quot;reanalysis-era5-single-levels&quot;,
                  query,
                 &quot;era5_ta_2018.nc&quot;)</code></pre>
<p>It is possible that the first time an error message is received, given that the required terms and conditions have not yet been accepted. Simply, the indicated link should be followed.</p>
<pre><code>Error in py_call_impl(callable, dots$args, dots$keywords) : 
  Exception: Client has not agreed to the required terms and conditions.. To access this resource, you first need to accept the termsof &#39;Licence to Use Copernicus Products&#39; at https://cds.climate.copernicus.eu/cdsapp/#!/terms/licence-to-use-copernicus-products</code></pre>
<p>From here we can follow the same steps as with ERA-Interim.</p>
<pre class="r"><code>#open the connection with the file
nc &lt;- nc_open(&quot;era5_ta_2018.nc&quot;)

#extract lon, lat
lat &lt;- ncvar_get(nc,&#39;latitude&#39;)
lon &lt;- ncvar_get(nc,&#39;longitude&#39;)
dim(lat);dim(lon)

#extract time
t &lt;- ncvar_get(nc, &quot;time&quot;)

#time unit: hours from 1900-01-01
ncatt_get(nc,&#39;time&#39;)

#we convert the hours into date+time 
#as_datetime from lubridate needs seconds
timestamp &lt;- as_datetime(c(t*60*60),origin=&quot;1900-01-01&quot;)

#temperatures in K from july 2018
head(timestamp)

#import temperature data
data &lt;- ncvar_get(nc,&quot;t2m&quot;)

#plot 2018-07-01
filled.contour(data[,,1])

#time serie plot for a pixel
plot(data.frame(date=timestamp,
                ta=data[1,5,]),
     type=&quot;l&quot;)

#close the conection with the ncdf file
nc_close(nc)</code></pre>
<p><a href="https://www.buymeacoffee.com/drxeo" target="_blank"><img src="https://cdn.buymeacoffee.com/buttons/default-orange.png" alt="Buy Me A Coffee" height="41" width="174"></a></p>
</div>

    </div>

    






<div class="article-tags">
  
  <a class="badge badge-light" href="/en/tag/reanalisis/">reanalisis</a>
  
  <a class="badge badge-light" href="/en/tag/interim/">interim</a>
  
  <a class="badge badge-light" href="/en/tag/ncep/ncar/">NCEP/NCAR</a>
  
  <a class="badge badge-light" href="/en/tag/era/">era</a>
  
  <a class="badge badge-light" href="/en/tag/download/">download</a>
  
  <a class="badge badge-light" href="/en/tag/ncdf/">ncdf</a>
  
  <a class="badge badge-light" href="/en/tag/access/">access</a>
  
  <a class="badge badge-light" href="/en/tag/api/">api</a>
  
  <a class="badge badge-light" href="/en/tag/python/">python</a>
  
  <a class="badge badge-light" href="/en/tag/ecmwf/">ECMWF</a>
  
</div>



<div class="share-box">
  <ul class="share">
    
      
      
      
        
      
      
      
      <li>
        <a href="https://twitter.com/intent/tweet?url=https://dominicroye.github.io/en/2018/access-to-climate-reanalysis-data-from-r/&amp;text=Access%20to%20climate%20reanalysis%20data%20from%20R" target="_blank" rel="noopener" class="share-btn-twitter" aria-label="twitter">
          <i class="fab fa-twitter"></i>
        </a>
      </li>
    
      
      
      
        
      
      
      
      <li>
        <a href="https://www.facebook.com/sharer.php?u=https://dominicroye.github.io/en/2018/access-to-climate-reanalysis-data-from-r/&amp;t=Access%20to%20climate%20reanalysis%20data%20from%20R" target="_blank" rel="noopener" class="share-btn-facebook" aria-label="facebook">
          <i class="fab fa-facebook"></i>
        </a>
      </li>
    
      
      
      
        
      
      
      
      <li>
        <a href="mailto:?subject=Access%20to%20climate%20reanalysis%20data%20from%20R&amp;body=https://dominicroye.github.io/en/2018/access-to-climate-reanalysis-data-from-r/" target="_blank" rel="noopener" class="share-btn-email" aria-label="envelope">
          <i class="fas fa-envelope"></i>
        </a>
      </li>
    
      
      
      
        
      
      
      
      <li>
        <a href="https://www.linkedin.com/shareArticle?url=https://dominicroye.github.io/en/2018/access-to-climate-reanalysis-data-from-r/&amp;title=Access%20to%20climate%20reanalysis%20data%20from%20R" target="_blank" rel="noopener" class="share-btn-linkedin" aria-label="linkedin-in">
          <i class="fab fa-linkedin-in"></i>
        </a>
      </li>
    
      
      
      
        
      
      
      
      <li>
        <a href="whatsapp://send?text=Access%20to%20climate%20reanalysis%20data%20from%20R%20https://dominicroye.github.io/en/2018/access-to-climate-reanalysis-data-from-r/" target="_blank" rel="noopener" class="share-btn-whatsapp" aria-label="whatsapp">
          <i class="fab fa-whatsapp"></i>
        </a>
      </li>
    
      
      
      
        
      
      
      
      <li>
        <a href="https://service.weibo.com/share/share.php?url=https://dominicroye.github.io/en/2018/access-to-climate-reanalysis-data-from-r/&amp;title=Access%20to%20climate%20reanalysis%20data%20from%20R" target="_blank" rel="noopener" class="share-btn-weibo" aria-label="weibo">
          <i class="fab fa-weibo"></i>
        </a>
      </li>
    
  </ul>
</div>











  
  



  
  
  
    
  
  
  
  <div class="media author-card content-widget-hr">
    
      
      <a href="https://dominicroye.github.io/"><img class="avatar mr-3 avatar-circle" src="/en/author/dr.-dominic-roye/avatar_hu930bec32484cd86675af8880de95caa2_508993_270x270_fill_q75_lanczos_center.jpg" alt="Dr. Dominic Royé"></a>
    

    <div class="media-body">
      <h5 class="card-title"><a href="https://dominicroye.github.io/">Dr. Dominic Royé</a></h5>
      <h6 class="card-subtitle">Senior postdoctoral researcher</h6>
      
      <ul class="network-icon" aria-hidden="true">
  
    
    
    
      
    
    
    
    
    
      
    
    <li>
      <a href="https://twitter.com/dr_xeo" target="_blank" rel="noopener">
        <i class="fab fa-twitter"></i>
      </a>
    </li>
  
    
    
    
      
    
    
    
    
    
      
    
    <li>
      <a href="/en/#contact" >
        <i class="fas fa-envelope"></i>
      </a>
    </li>
  
    
    
    
    
    
    
    
      
    
    <li>
      <a href="https://scholar.google.es/citations?user=EoYa8jUAAAAJ&amp;hl=es" target="_blank" rel="noopener">
        <i class="ai ai-google-scholar"></i>
      </a>
    </li>
  
    
    
    
      
    
    
    
    
    
      
    
    <li>
      <a href="https://github.com/dominicroye" target="_blank" rel="noopener">
        <i class="fab fa-github"></i>
      </a>
    </li>
  
    
    
    
      
    
    
    
    
    
      
    
    <li>
      <a href="https://www.linkedin.com/in/dominicroye/" target="_blank" rel="noopener">
        <i class="fab fa-linkedin"></i>
      </a>
    </li>
  
    
    
    
    
    
    
    
      
    
    <li>
      <a href="https://www.researchgate.net/profile/Dominic_Roye" target="_blank" rel="noopener">
        <i class="ai ai-researchgate"></i>
      </a>
    </li>
  
</ul>

    </div>
  </div>
















  
  
  <div class="article-widget content-widget-hr">
    <h3>Related</h3>
    <ul>
      
      <li><a href="/en/2022/use-of-multidimensional-spatial-data/">Use of multidimensional spatial data</a></li>
      
      <li><a href="/en/2021/visualize-the-day-night-cycle-on-a-world-map/">Visualize the day-night cycle on a world map</a></li>
      
      <li><a href="/en/2021/firefly-cartography/">Firefly cartography</a></li>
      
      <li><a href="/en/2020/a-heatmap-as-calendar/">A heatmap as calendar</a></li>
      
      <li><a href="/en/2020/visualize-climate-anomalies/">Visualize climate anomalies</a></li>
      
    </ul>
  </div>
  





  </div>
</article>
  </div>

  <div class="page-footer">
    
    
    <div class="container">
      <footer class="site-footer">

  



  

  

  
  <p class="powered-by">
    © 2018-2022 Dominic Royé. All rights reserved
  </p>
  

  
  






  <p class="powered-by">
    
    
    
      
      
      
      
      
      
      Published with <a href="https://wowchemy.com/?utm_campaign=poweredby" target="_blank" rel="noopener">Wowchemy</a> — the free, <a href="https://github.com/wowchemy/wowchemy-hugo-themes" target="_blank" rel="noopener">open source</a> website builder that empowers creators.
    
  </p>
</footer>

    </div>
    
  </div>

  
<div id="modal" class="modal fade" role="dialog">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Cite</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <pre><code class="tex hljs"></code></pre>
      </div>
      <div class="modal-footer">
        <a class="btn btn-outline-primary my-1 js-copy-cite" href="#" target="_blank">
          <i class="fas fa-copy"></i> Copy
        </a>
        <a class="btn btn-outline-primary my-1 js-download-cite" href="#" target="_blank">
          <i class="fas fa-download"></i> Download
        </a>
        <div id="modal-error"></div>
      </div>
    </div>
  </div>
</div>

      

    
    <script src="/js/vendor-bundle.min.b73dfaac3b6499dc997741748a7c3fe2.js"></script>

    
    
    
      
      
        <script src="https://cdn.jsdelivr.net/gh/desandro/imagesloaded@v4.1.4/imagesloaded.pkgd.min.js" integrity="sha512-S5PZ9GxJZO16tT9r3WJp/Safn31eu8uWrzglMahDT4dsmgqWonRY9grk3j+3tfuPr9WJNsfooOR7Gi7HL5W2jw==" crossorigin="anonymous"></script>
        <script src="https://cdn.jsdelivr.net/gh/metafizzy/isotope@v3.0.6/dist/isotope.pkgd.min.js" integrity="sha512-Zq2BOxyhvnRFXu0+WE6ojpZLOU2jdnqbrM1hmVdGzyeCa1DgM3X5Q4A/Is9xA1IkbUeDd7755dNNI/PzSf2Pew==" crossorigin="anonymous"></script>
      

      
      

      

      
        
        <script src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@10.2.1/build/highlight.min.js" integrity="sha512-Ypjm0o7jOxAd4hpdoppSEN0TQOC19UtPAqD+4s5AlXmUvbmmS/YMxYqAqarQYyxTnB6/rqip9qcxlNB/3U9Wdg==" crossorigin="anonymous"></script>
        
        
        <script src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@10.2.1/build/languages/r.min.js" crossorigin="anonymous"></script>
        
      

    

    
    
    
      <script src="https://cdn.jsdelivr.net/npm/leaflet@1.7.1/dist/leaflet.min.js" integrity="" crossorigin="anonymous"></script>
    

    
    

    
    
    

    
    

    
    
    
    

    
    

    
    
    
    
    
    
    
    
    
    <script src="/en/js/wowchemy.min.50d3bf3df0c53b31631bb48a62b35f92.js"></script>

    
  <script async defer src="https://buttons.github.io/buttons.js"></script>




</body>
</html>
