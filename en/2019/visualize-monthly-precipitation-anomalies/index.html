<!DOCTYPE html>
<html lang="en-us">
<head>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="generator" content="Source Themes Academic 3.2.0">
  <meta name="generator" content="Hugo 0.55.4" />
  <meta name="author" content="Dr. Dominic Royé">

  
  
  
  
    
  
  <meta name="description" content="Normally when we visualize monthly precipitation anomalies, we simply use a bar graph indicating negative and positive values with red and blue. However, it does not explain the general context of these anomalies. For example, what was the highest or lowest anomaly in each month? In principle, we could use a *boxplot* to visualize the distribution of the anomalies, but in this particular case they would not fit aesthetically, so we should look for an alternative. Here I present a very useful graphic form.">

  
  <link rel="alternate" hreflang="en-us" href="https://dominicroye.github.io/en/2019/visualize-monthly-precipitation-anomalies/">

  


  

  

  

  

  

  

  
  
  
  <meta name="theme-color" content="#2962ff">
  

  
  
  
  
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha256-eSi1q2PG6J7g7ib17yAaWMcrr5GrtohYChqibrV7PBE=" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/academicons/1.8.6/css/academicons.min.css" integrity="sha256-uFVgMKfistnJAfoCUQigIl+JfUaP47GrRKjf6CTPVmw=" crossorigin="anonymous">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.6.0/css/all.css" integrity="sha384-aOkxzJ5uQz7WBObEZcHvV5JvRW3TUc2rNPA7pe3AwnsUohiw1Vj2Rgx2KSOkF5+h" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.2.5/jquery.fancybox.min.css" integrity="sha256-ygkqlh3CYSUri3LhQxzdcm0n1EQvH2Y+U5S2idbLtxs=" crossorigin="anonymous">

    
    
    
      
    
    
      
      
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/dracula.min.css" crossorigin="anonymous">
      
    

    

    

  

  
  

  <link rel="stylesheet" href="/en/styles.css">
  
  <link rel="stylesheet" href="/css/override.css">
  

  
  
    <script>
      window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
      ga('create', 'UA-27463794-2', 'auto');
      ga('set', 'anonymizeIp', true);
      ga('require', 'eventTracker');
      ga('require', 'outboundLinkTracker');
      ga('require', 'urlChangeTracker');
      ga('send', 'pageview');
    </script>
    <script async src="//www.google-analytics.com/analytics.js"></script>
    
    <script async src="https://cdnjs.cloudflare.com/ajax/libs/autotrack/2.4.1/autotrack.js" integrity="sha512-HUmooslVKj4m6OBu0OgzjXXr+QuFYy/k7eLI5jdeEy/F4RSgMn6XRWRGkFi5IFaFgy7uFTkegp3Z0XnJf3Jq+g==" crossorigin="anonymous"></script>
    
  
  

  
  <link rel="alternate" href="https://dominicroye.github.io/index.xml" type="application/rss+xml" title="Dr. Dominic Royé">
  <link rel="feed" href="https://dominicroye.github.io/index.xml" type="application/rss+xml" title="Dr. Dominic Royé">
  

  <link rel="manifest" href="/site.webmanifest">
  <link rel="icon" type="image/png" href="/img/icon.png">
  <link rel="apple-touch-icon" type="image/png" href="/img/icon-192.png">

  <link rel="canonical" href="https://dominicroye.github.io/en/2019/visualize-monthly-precipitation-anomalies/">

  
  
  
  
    
  
  <meta property="twitter:card" content="summary_large_image">
  
  <meta property="og:site_name" content="Dr. Dominic Royé">
  <meta property="og:url" content="https://dominicroye.github.io/en/2019/visualize-monthly-precipitation-anomalies/">
  <meta property="og:title" content="Visualize monthly precipitation anomalies | Dr. Dominic Royé">
  <meta property="og:description" content="Normally when we visualize monthly precipitation anomalies, we simply use a bar graph indicating negative and positive values with red and blue. However, it does not explain the general context of these anomalies. For example, what was the highest or lowest anomaly in each month? In principle, we could use a *boxplot* to visualize the distribution of the anomalies, but in this particular case they would not fit aesthetically, so we should look for an alternative. Here I present a very useful graphic form."><meta property="og:image" content="https://dominicroye.github.io/en/2019/visualize-monthly-precipitation-anomalies/featured.png">
  <meta property="og:locale" content="en-us">
  
  <meta property="article:published_time" content="2019-07-07T00:00:00&#43;00:00">
  
  <meta property="article:modified_time" content="2019-07-07T00:00:00&#43;00:00">
  

  

<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.0.3/cookieconsent.min.css">
<script src="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.0.3/cookieconsent.min.js"></script>
<script>
  window.addEventListener("load", function(){
    window.cookieconsent.initialise({
      "palette": {
        "popup": {
          "background": "#2962ff",
          "text": "#fff"
        },
        "button": {
          "background": "#fff",
          "text": "#2962ff"
        }
      },
      "theme": "classic",
      "content": {
        "message": "This website uses cookies to ensure you get the best experience on our website.",
        "dismiss": "Got it!",
        "link": "Learn more",
        "href": "https://cookies.insites.com"
      }
    })});
</script>


  

  <title>Visualize monthly precipitation anomalies | Dr. Dominic Royé</title>

</head>
<body id="top" data-spy="scroll" data-target="#TableOfContents" data-offset="71" >
  <aside class="search-results" id="search">
  <div class="container">
    <section class="search-header">

      <div class="row no-gutters justify-content-between mb-3">
        <div class="col-6">
          <h1>Search</h1>
        </div>
        <div class="col-6 col-search-close">
          <a class="js-search" href="#"><i class="fas fa-times-circle text-muted" aria-hidden="true"></i></a>
        </div>
      </div>

      <div id="search-box">
        
        
        
      </div>

    </section>
    <section class="section-search-results">

      <div id="search-hits">
        
      </div>

    </section>
  </div>
</aside>

<nav class="navbar navbar-light fixed-top navbar-expand-lg py-0" id="navbar-main">
  <div class="container">

    
      <a class="navbar-brand" href="/en/"><div style="position:relative;float:left">Dr. Dominic Royé<img src="/img/portrait.jpg" alt="Dr. Dominic Royé" style="float: left;"></div></a>
      
      <button type="button" class="navbar-toggler" data-toggle="collapse"
              data-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
        <span><i class="fas fa-bars"></i></span>
      </button>
      

    
    <div class="collapse navbar-collapse" id="navbar">

      
      
      <ul class="navbar-nav ml-auto">
        

        

        
        
        

        <li class="nav-item">
          <a class="nav-link" href="/en/#">
            
            <span>home</span>
            
          </a>
        </li>

        
        

        

        
        
        
          
        

        <li class="nav-item">
          <a class="nav-link" href="/en/#posts">
            
            <span>blog</span>
            
          </a>
        </li>

        
        

        

        
        
        
          
        

        <li class="nav-item">
          <a class="nav-link" href="/en/#publications_selected">
            
            <span>publications</span>
            
          </a>
        </li>

        
        

        

        
        
        
          
        

        <li class="nav-item">
          <a class="nav-link" href="/en/#graphs">
            
            <span>graphs</span>
            
          </a>
        </li>

        
        

        

        
        
        
          
        

        <li class="nav-item">
          <a class="nav-link" href="/en/#teaching">
            
            <span>more</span>
            
          </a>
        </li>

        
        

        

        
        
        
          
        

        <li class="nav-item">
          <a class="nav-link" href="/en/#about">
            
            <span>me</span>
            
          </a>
        </li>

        
        

      

        

        

        

        

      </ul>

    </div>
  </div>
</nav>


<article class="article" itemscope itemtype="http://schema.org/Article">

  













<div class="article-header d-xl-none">
  <div class="featured-image" style="background-image: url('/en/2019/visualize-monthly-precipitation-anomalies/featured_hu270b7df5c7d8474a74ad480372608501_84861_800x0_resize_box_2.png');"></div>
  
</div>


<div class="container-fluid split-header d-none d-xl-block">
  <div class="row">
    <div class="col-6">
      <div class="split-header-content">
        <h1 itemprop="name">Visualize monthly precipitation anomalies</h1>

        

        

<div class="article-metadata">

  
  
  <span itemscope itemprop="author" itemtype="http://schema.org/Person">
    <meta itemprop="name" content="Dr. Dominic Royé">
  </span>
  

  <span class="article-date">
    
    <meta content="2019-07-07 00:00:00 &#43;0000 UTC" itemprop="datePublished">
    <time datetime="2019-07-07 00:00:00 &#43;0000 UTC" itemprop="dateModified">
      2019-07-07
    </time>
  </span>
  <span itemscope itemprop="publisher" itemtype="http://schema.org/Person">
    <meta itemprop="name" content="Dr. Dominic Royé">
  </span>

  

  
  
  <span class="middot-divider"></span>
  <a href="/en/2019/visualize-monthly-precipitation-anomalies/#disqus_thread"></a>
  

  
  
  
  <span class="middot-divider"></span>
  <span class="article-categories">
    <i class="fas fa-folder"></i>
    
    <a href="/en/categories/visualization/">visualization</a>, 
    
    <a href="/en/categories/r/">R</a>, 
    
    <a href="">R:intermediate</a>
    
  </span>
  
  

  

</div>


        







  










        
<div class="share-box" aria-hidden="true">
  <ul class="share">
    <li>
      <a class="twitter"
         href="https://twitter.com/intent/tweet?text=Visualize%20monthly%20precipitation%20anomalies&amp;url=https%3a%2f%2fdominicroye.github.io%2fen%2f2019%2fvisualize-monthly-precipitation-anomalies%2f"
         target="_blank" rel="noopener">
        <i class="fab fa-twitter"></i>
      </a>
    </li>
    <li>
      <a class="facebook"
         href="https://www.facebook.com/sharer.php?u=https%3a%2f%2fdominicroye.github.io%2fen%2f2019%2fvisualize-monthly-precipitation-anomalies%2f"
         target="_blank" rel="noopener">
        <i class="fab fa-facebook-f"></i>
      </a>
    </li>
    <li>
      <a class="linkedin"
         href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fdominicroye.github.io%2fen%2f2019%2fvisualize-monthly-precipitation-anomalies%2f&amp;title=Visualize%20monthly%20precipitation%20anomalies"
         target="_blank" rel="noopener">
        <i class="fab fa-linkedin-in"></i>
      </a>
    </li>
    <li>
      <a class="weibo"
         href="http://service.weibo.com/share/share.php?url=https%3a%2f%2fdominicroye.github.io%2fen%2f2019%2fvisualize-monthly-precipitation-anomalies%2f&amp;title=Visualize%20monthly%20precipitation%20anomalies"
         target="_blank" rel="noopener">
        <i class="fab fa-weibo"></i>
      </a>
    </li>
    <li>
      <a class="email"
         href="mailto:?subject=Visualize%20monthly%20precipitation%20anomalies&amp;body=https%3a%2f%2fdominicroye.github.io%2fen%2f2019%2fvisualize-monthly-precipitation-anomalies%2f">
        <i class="fas fa-envelope"></i>
      </a>
    </li>
  </ul>
</div>


      </div>
    </div>
    <div class="col-6">
      <div class="split-header-image">
        <img src="/en/2019/visualize-monthly-precipitation-anomalies/featured_hu270b7df5c7d8474a74ad480372608501_84861_680x500_fill_q90_box_smart1_2.png" itemprop="image" alt="">
        
      </div>
    </div>
  </div>
</div>

<div class="article-container d-xl-none">
  <h1 itemprop="name">Visualize monthly precipitation anomalies</h1>

  

  

<div class="article-metadata">

  
  
  <span itemscope itemprop="author" itemtype="http://schema.org/Person">
    <meta itemprop="name" content="Dr. Dominic Royé">
  </span>
  

  <span class="article-date">
    
    <meta content="2019-07-07 00:00:00 &#43;0000 UTC" itemprop="datePublished">
    <time datetime="2019-07-07 00:00:00 &#43;0000 UTC" itemprop="dateModified">
      2019-07-07
    </time>
  </span>
  <span itemscope itemprop="publisher" itemtype="http://schema.org/Person">
    <meta itemprop="name" content="Dr. Dominic Royé">
  </span>

  

  
  
  <span class="middot-divider"></span>
  <a href="/en/2019/visualize-monthly-precipitation-anomalies/#disqus_thread"></a>
  

  
  
  
  <span class="middot-divider"></span>
  <span class="article-categories">
    <i class="fas fa-folder"></i>
    
    <a href="/en/categories/visualization/">visualization</a>, 
    
    <a href="/en/categories/r/">R</a>, 
    
    <a href="">R:intermediate</a>
    
  </span>
  
  

  
  
<div class="share-box" aria-hidden="true">
  <ul class="share">
    <li>
      <a class="twitter"
         href="https://twitter.com/intent/tweet?text=Visualize%20monthly%20precipitation%20anomalies&amp;url=https%3a%2f%2fdominicroye.github.io%2fen%2f2019%2fvisualize-monthly-precipitation-anomalies%2f"
         target="_blank" rel="noopener">
        <i class="fab fa-twitter"></i>
      </a>
    </li>
    <li>
      <a class="facebook"
         href="https://www.facebook.com/sharer.php?u=https%3a%2f%2fdominicroye.github.io%2fen%2f2019%2fvisualize-monthly-precipitation-anomalies%2f"
         target="_blank" rel="noopener">
        <i class="fab fa-facebook-f"></i>
      </a>
    </li>
    <li>
      <a class="linkedin"
         href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fdominicroye.github.io%2fen%2f2019%2fvisualize-monthly-precipitation-anomalies%2f&amp;title=Visualize%20monthly%20precipitation%20anomalies"
         target="_blank" rel="noopener">
        <i class="fab fa-linkedin-in"></i>
      </a>
    </li>
    <li>
      <a class="weibo"
         href="http://service.weibo.com/share/share.php?url=https%3a%2f%2fdominicroye.github.io%2fen%2f2019%2fvisualize-monthly-precipitation-anomalies%2f&amp;title=Visualize%20monthly%20precipitation%20anomalies"
         target="_blank" rel="noopener">
        <i class="fab fa-weibo"></i>
      </a>
    </li>
    <li>
      <a class="email"
         href="mailto:?subject=Visualize%20monthly%20precipitation%20anomalies&amp;body=https%3a%2f%2fdominicroye.github.io%2fen%2f2019%2fvisualize-monthly-precipitation-anomalies%2f">
        <i class="fas fa-envelope"></i>
      </a>
    </li>
  </ul>
</div>


  

</div>


  







  









</div>



  <div class="article-container">

    <div class="article-style" itemprop="articleBody">
      
<script src="https://dominicroye.github.io/en/2019/visualize-monthly-precipitation-anomalies/index.en_files/header-attrs/header-attrs.js"></script>


<p>Normally when we visualize monthly precipitation anomalies, we simply use a bar graph indicating negative and positive values with red and blue. However, it does not explain the general context of these anomalies. For example, what was the highest or lowest anomaly in each month? In principle, we could use a <em>boxplot</em> to visualize the distribution of the anomalies, but in this particular case they would not fit aesthetically, so we should look for an alternative. Here I present a very useful graphic form.</p>
<div id="packages" class="section level2">
<h2>Packages</h2>
<p>In this post we will use the following packages:</p>
<table>
<colgroup>
<col width="10%" />
<col width="89%" />
</colgroup>
<thead>
<tr class="header">
<th align="left">Package</th>
<th align="left">Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">tidyverse</td>
<td align="left">Collection of packages (visualization, manipulation): ggplot2, dplyr, purrr, etc.</td>
</tr>
<tr class="even">
<td align="left">readr</td>
<td align="left">Import data</td>
</tr>
<tr class="odd">
<td align="left">ggthemes</td>
<td align="left">Themes for ggplot2</td>
</tr>
<tr class="even">
<td align="left">lubridate</td>
<td align="left">Easy manipulation of dates and times</td>
</tr>
<tr class="odd">
<td align="left">cowplot</td>
<td align="left">Easy creation of multiple graphics with ggplot2</td>
</tr>
</tbody>
</table>
<pre class="r"><code>#we install the packages if necessary
if(!require(&quot;tidyverse&quot;)) install.packages(&quot;tidyverse&quot;)
if(!require(&quot;ggthemes&quot;)) install.packages(&quot;broom&quot;)
if(!require(&quot;cowplot&quot;)) install.packages(&quot;cowplot&quot;)
if(!require(&quot;lubridate&quot;)) install.packages(&quot;lubridate&quot;)

#packages
library(tidyverse) #include readr
library(ggthemes)
library(cowplot)
library(lubridate)</code></pre>
</div>
<div id="preparing-the-data" class="section level2">
<h2>Preparing the data</h2>
<p>First we import the daily precipitation of the selected weather station (<a href="/files/RR_STAID001394.txt">download</a>). We will use data from Santiago de Compostela (Spain) accessible through <a href="https://eca.knmi.nl">ECA&amp;D</a>.</p>
<div id="step-1-import-the-data" class="section level3">
<h3>Step 1: import the data</h3>
<p>We not only import the data in <em>csv</em> format, but we also make the first changes. We skip the first 21 rows that contain information about the weather station. In addition, we convert the date to the <code>date</code> class and replace missing values (-9999) with <code>NA</code>. The precipitation is given in 0.1 mm, therefore, we must divide the values by 10. Then we select the columns <em>DATE</em> and <em>RR</em>, and rename them.</p>
<pre class="r"><code>data &lt;- read_csv(&quot;RR_STAID001394.txt&quot;, skip = 21) %&gt;%
             mutate(DATE = ymd(DATE), RR = ifelse(RR == -9999, NA, RR/10)) %&gt;%
               select(DATE:RR) %&gt;% 
             rename(date = DATE, pr = RR)</code></pre>
<pre><code>## 
## -- Column specification --------------------------------------------------------
## cols(
##   STAID = col_double(),
##   SOUID = col_double(),
##   DATE = col_double(),
##   RR = col_double(),
##   Q_RR = col_double()
## )</code></pre>
<pre class="r"><code>data</code></pre>
<pre><code>## # A tibble: 27,606 x 2
##    date          pr
##    &lt;date&gt;     &lt;dbl&gt;
##  1 1943-11-01   0.6
##  2 1943-11-02   0  
##  3 1943-11-03   0  
##  4 1943-11-04   0  
##  5 1943-11-05   0  
##  6 1943-11-06   0  
##  7 1943-11-07   0  
##  8 1943-11-08   0  
##  9 1943-11-09   0  
## 10 1943-11-10   0  
## # ... with 27,596 more rows</code></pre>
</div>
<div id="step-2-creating-monthly-values" class="section level3">
<h3>Step 2: creating monthly values</h3>
<p>In the second step we calculate the monthly amounts of precipitation. To do this, a) we limit the period to the years after 1950, b) we add the month with its labels and the year as variables.</p>
<pre class="r"><code>data &lt;- mutate(data, mo = month(date, label = TRUE), yr = year(date)) %&gt;%
            filter(date &gt;= &quot;1950-01-01&quot;) %&gt;%
                group_by(yr, mo) %&gt;% 
                   summarise(prs = sum(pr, na.rm = TRUE))</code></pre>
<pre><code>## `summarise()` has grouped output by &#39;yr&#39;. You can override using the `.groups` argument.</code></pre>
<pre class="r"><code>data</code></pre>
<pre><code>## # A tibble: 833 x 3
## # Groups:   yr [70]
##       yr mo      prs
##    &lt;dbl&gt; &lt;ord&gt; &lt;dbl&gt;
##  1  1950 Jan    55.6
##  2  1950 Feb   349. 
##  3  1950 Mar    85.8
##  4  1950 Apr    33.4
##  5  1950 May   272. 
##  6  1950 Jun   111. 
##  7  1950 Jul    35.4
##  8  1950 Aug    76.4
##  9  1950 Sep    85  
## 10  1950 Oct    53  
## # ... with 823 more rows</code></pre>
</div>
<div id="step-3-estimating-anomalies" class="section level3">
<h3>Step 3: estimating anomalies</h3>
<p>Now we must estimate the normals of each month and join this table to our main data in order to calculate the monthly anomaly. We express the anomalies in percentage and subtract 100 to set the average to 0. In addition, we create a variable which indicates if the anomaly is negative or positive, and another with the date.</p>
<pre class="r"><code>pr_ref &lt;- filter(data, yr &gt; 1981, yr &lt;= 2010) %&gt;%
                   group_by(mo) %&gt;%
                      summarise(pr_ref = mean(prs))

data &lt;- left_join(data, pr_ref, by = &quot;mo&quot;)

data &lt;- mutate(data, 
               anom = (prs*100/pr_ref)-100, 
               date = str_c(yr, as.numeric(mo), 1, sep = &quot;-&quot;) %&gt;% ymd(),
               sign= ifelse(anom &gt; 0, &quot;pos&quot;, &quot;neg&quot;) %&gt;% factor(c(&quot;pos&quot;, &quot;neg&quot;)))</code></pre>
<p>We can do a first test graph of anomalies (the classic one), for that we filter the year 2018. In this case we use a bar graph, remember that by default the function <code>geom_bar()</code> applies the counting of the variable. However, in this case we know <code>y</code>, hence we indicate with the argument <code>stat = "identity"</code> that it should use the given value in <code>aes()</code>.</p>
<pre class="r"><code>filter(data, yr == 2018) %&gt;%
   ggplot(aes(date, anom, fill = sign)) + 
       geom_bar(stat = &quot;identity&quot;, show.legend = FALSE) + 
    scale_x_date(date_breaks = &quot;month&quot;, date_labels = &quot;%b&quot;) +
    scale_y_continuous(breaks = seq(-100, 100, 20)) +
    scale_fill_manual(values = c(&quot;#99000d&quot;, &quot;#034e7b&quot;)) +
         labs(y = &quot;Precipitation anomaly (%)&quot;, x = &quot;&quot;) +
          theme_hc()</code></pre>
<p><img src="https://dominicroye.github.io/en/2019/visualize-monthly-precipitation-anomalies/index.en_files/figure-html/unnamed-chunk-7-1.png" width="672" /></p>
</div>
<div id="step-4-calculating-the-statistical-metrics" class="section level3">
<h3>Step 4: calculating the statistical metrics</h3>
<p>In this last step we estimate the maximum, minimum value, the 25%/75% quantiles and the interquartile range per month of the entire time series.</p>
<pre class="r"><code>data_norm &lt;-     group_by(data, mo) %&gt;%
                     summarise(mx = max(anom),
                               min = min(anom),
                               q25 = quantile(anom, .25),
                               q75 = quantile(anom, .75),
                               iqr = q75-q25)
data_norm</code></pre>
<pre><code>## # A tibble: 12 x 6
##    mo       mx    min   q25   q75   iqr
##    &lt;ord&gt; &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
##  1 Jan    193.  -89.6 -43.6 56.3   99.9
##  2 Feb    320.  -96.5 -51.2 77.7  129. 
##  3 Mar    381. -100   -40.6 88.2  129. 
##  4 Apr    198.  -93.6 -51.2 17.1   68.3
##  5 May    141.  -90.1 -45.2 17.0   62.2
##  6 Jun    419.  -99.3 -58.2 50.0  108. 
##  7 Jul    311.  -98.2 -77.3 27.1  104. 
##  8 Aug    264. -100   -68.2 39.8  108. 
##  9 Sep    241.  -99.2 -64.9 48.6  113. 
## 10 Oct    220.  -99.0 -54.5  4.69  59.2
## 11 Nov    137.  -98.8 -44.0 39.7   83.7
## 12 Dec    245.  -91.8 -49.8 36.0   85.8</code></pre>
</div>
</div>
<div id="creating-the-graph" class="section level2">
<h2>Creating the graph</h2>
<p>To create the anomaly graph with legend it is necessary to separate the main graph from the legends.</p>
<div id="part-1" class="section level3">
<h3>Part 1</h3>
<p>In this first part we are adding layer by layer the different elements: 1) the range of anomalies maximum-minimum 2) the interquartile range and 3) the anomalies of the year 2018.</p>
<pre class="r"><code>#range of anomalies maximum-minimum
g1.1 &lt;- ggplot(data_norm)+
           geom_crossbar(aes(x = mo, y = 0, ymin = min, ymax = mx),
                        fatten = 0, fill = &quot;grey90&quot;, colour = &quot;NA&quot;)

g1.1</code></pre>
<p><img src="https://dominicroye.github.io/en/2019/visualize-monthly-precipitation-anomalies/index.en_files/figure-html/unnamed-chunk-9-1.png" width="672" /></p>
<pre class="r"><code>#adding interquartile range
g1.2 &lt;- g1.1 + geom_crossbar(aes(x = mo, y = 0, ymin = q25, ymax = q75),
                              fatten = 0, fill = &quot;grey70&quot;)

g1.2</code></pre>
<p><img src="https://dominicroye.github.io/en/2019/visualize-monthly-precipitation-anomalies/index.en_files/figure-html/unnamed-chunk-9-2.png" width="672" /></p>
<pre class="r"><code>#adding anomalies of the year 2018 

g1.3 &lt;- g1.2 + geom_crossbar(data = filter(data, yr == 2018),
                aes(x = mo, y = 0, ymin = 0, ymax = anom, fill = sign),
                fatten = 0, width = 0.7, alpha = .7, colour = &quot;NA&quot;,
                show.legend = FALSE)
g1.3</code></pre>
<p><img src="https://dominicroye.github.io/en/2019/visualize-monthly-precipitation-anomalies/index.en_files/figure-html/unnamed-chunk-9-3.png" width="672" /></p>
<p>Finally we change some last style settings.</p>
<pre class="r"><code>g1 &lt;- g1.3 + geom_hline(yintercept = 0)+
               scale_fill_manual(values=c(&quot;#99000d&quot;,&quot;#034e7b&quot;))+
               scale_y_continuous(&quot;Precipitation anomaly (%)&quot;,
                                   breaks = seq(-100, 500, 25),
                                   expand = c(0, 5))+
            labs(x = &quot;&quot;,
                 title = &quot;Precipitation anomaly in Santiago de Compostela 2018&quot;,
                 caption=&quot;Dominic Royé (@dr_xeo) | Data: eca.knmi.nl&quot;)+
            theme_hc()
g1</code></pre>
<p><img src="https://dominicroye.github.io/en/2019/visualize-monthly-precipitation-anomalies/index.en_files/figure-html/unnamed-chunk-10-1.png" width="672" /></p>
</div>
<div id="part-2" class="section level3">
<h3>Part 2</h3>
<p>We still need a legend. First we create it for the normals.</p>
<pre class="r"><code>#legend data
legend &lt;- filter(data_norm, mo == &quot;Jan&quot;)

legend_lab &lt;- gather(legend, stat, y, mx:q75) %&gt;%
                 mutate(stat = factor(stat, stat, c(&quot;maximum&quot;,
                                                   &quot;minimum&quot;,
                                                   &quot;Quantile 25%&quot;,
                                                   &quot;Quantile 75%&quot;)) %&gt;%
                                            as.character())</code></pre>
<pre><code>## Warning: attributes are not identical across measure variables;
## they will be dropped</code></pre>
<pre class="r"><code>#legend graph
g2 &lt;- legend %&gt;% ggplot()+
                  geom_crossbar(aes(x = mo, y = 0, ymin = min, ymax = mx),
                                fatten = 0, fill = &quot;grey90&quot;, colour = &quot;NA&quot;, width = 0.2) +
                  geom_crossbar(aes(x = mo, y = 0, ymin = q25, ymax = q75),
                                fatten = 0, fill = &quot;grey70&quot;, width = 0.2) +
                  geom_text(data = legend_lab, 
                            aes(x = mo, y = y+c(12,-8,-10,12), label = stat), 
                            fontface = &quot;bold&quot;, size = 2) +
                   annotate(&quot;text&quot;, x = 1.18, y = 40, 
                            label = &quot;Period 1950-2018&quot;, angle = 90, size = 3) +
              theme_void() + 
                theme(plot.margin = unit(c(0, 0, 0, 0), &quot;cm&quot;))

g2</code></pre>
<p><img src="https://dominicroye.github.io/en/2019/visualize-monthly-precipitation-anomalies/index.en_files/figure-html/unnamed-chunk-11-1.png" width="672" /></p>
<p>Second, we create another legend for the current anomalies.</p>
<pre class="r"><code>#legend data
legend2 &lt;- filter(data, yr == 1950, mo %in% c(&quot;Jan&quot;,&quot;Feb&quot;)) %&gt;% 
              ungroup() %&gt;% 
            select(mo, anom, sign)

legend2[2,1] &lt;- &quot;Jan&quot;

legend_lab2 &lt;- data.frame(mo = rep(&quot;Jan&quot;, 3), 
                          anom= c(110, 3, -70), 
                          label = c(&quot;Positive anomaly&quot;, &quot;Average&quot;, &quot;Negative anomaly&quot;))

#legend graph
g3 &lt;-  ggplot() + 
         geom_bar(data = legend2,
                aes(x = mo, y = anom, fill = sign),
                   alpha = .6, colour = &quot;NA&quot;, stat = &quot;identity&quot;, show.legend = FALSE, width = 0.2) +
         geom_segment(aes(x = .85, y = 0, xend = 1.15, yend = 0), linetype = &quot;dashed&quot;) +
         geom_text(data = legend_lab2, 
                   aes(x = mo, y = anom+c(10,5,-13), label = label), 
                   fontface = &quot;bold&quot;, size = 2) +
         annotate(&quot;text&quot;, x = 1.25, y = 20, 
                  label =&quot;Reference 1971-2010&quot;, angle = 90, size = 3) +
         scale_fill_manual(values = c(&quot;#99000d&quot;, &quot;#034e7b&quot;)) +
        theme_void() +
         theme(plot.margin = unit(c(0, 0, 0, 0), &quot;cm&quot;))

g3</code></pre>
<p><img src="https://dominicroye.github.io/en/2019/visualize-monthly-precipitation-anomalies/index.en_files/figure-html/unnamed-chunk-12-1.png" width="672" /></p>
</div>
<div id="part-3" class="section level3">
<h3>Part 3</h3>
<p>Finally, we only have to join the graph and the legends with the help of the <code>cowplot</code> package. The main function of <code>cowplot</code> is <code>plot_grid()</code> which is used for combining different graphs. However, in this case it is necessary to use more flexible functions to create less common formats. The <code>ggdraw()</code> function configures the basic layer of the graph, and the functions that are intended to operate on this layer start with <code>draw_*</code>.</p>
<pre class="r"><code>p &lt;- ggdraw() +
       draw_plot(g1, x = 0, y = .3, width = 1, height = 0.6) +
       draw_plot(g2, x = 0, y = .15, width = .2, height = .15) +
       draw_plot(g3, x = 0.08, y = .15, width = .2, height = .15)

p</code></pre>
<p><img src="https://dominicroye.github.io/en/2019/visualize-monthly-precipitation-anomalies/index.en_files/figure-html/unnamed-chunk-13-1.png" width="3729" /></p>
<pre class="r"><code>save_plot(&quot;pr_anomaly2016_scq.png&quot;, p, dpi = 300, base_width = 12.43, base_height = 8.42)</code></pre>
</div>
</div>
<div id="multiple-facets" class="section level2">
<h2>Multiple facets</h2>
<p>In this section we will make the same graph as in the previous one, but for several years.</p>
<div id="part-1-1" class="section level3">
<h3>Part 1</h3>
<p>First we need to filter again by set of years, in this case from 2016 to 2018, using the operator <code>%in%</code>, we also add the function <code>facet_grid()</code> to <code>ggplot</code>, which allows us to plot the graph according to a variable. The formula used for the facet function is similar to the use in models: <code>variable_by_row ~ variable_by_column</code>. When we do not have a variable in the column, we should use the <code>.</code>.</p>
<pre class="r"><code>#range of anomalies maximum-minimum
g1.1 &lt;- ggplot(data_norm)+
           geom_crossbar(aes(x = mo, y = 0, ymin = min, ymax = mx),
                        fatten = 0, fill = &quot;grey90&quot;, colour = &quot;NA&quot;)

g1.1</code></pre>
<p><img src="https://dominicroye.github.io/en/2019/visualize-monthly-precipitation-anomalies/index.en_files/figure-html/unnamed-chunk-14-1.png" width="672" /></p>
<pre class="r"><code>#adding the interquartile range
g1.2 &lt;- g1.1 + geom_crossbar(aes(x = mo, y = 0, ymin = q25, ymax = q75),
                              fatten = 0, fill = &quot;grey70&quot;)

g1.2</code></pre>
<p><img src="https://dominicroye.github.io/en/2019/visualize-monthly-precipitation-anomalies/index.en_files/figure-html/unnamed-chunk-14-2.png" width="672" /></p>
<pre class="r"><code>#adding the anomalies of the year 2016-2018

g1.3 &lt;- g1.2 + geom_crossbar(data = filter(data, yr %in% 2016:2018),
                aes(x = mo, y = 0, ymin = 0, ymax = anom, fill = sign),
                fatten = 0, width = 0.7, alpha = .7, colour = &quot;NA&quot;,
                show.legend = FALSE) +
               facet_grid(yr ~ .)
g1.3</code></pre>
<p><img src="https://dominicroye.github.io/en/2019/visualize-monthly-precipitation-anomalies/index.en_files/figure-html/unnamed-chunk-14-3.png" width="672" /></p>
<p>Finally we change some last style settings.</p>
<pre class="r"><code>g1 &lt;- g1.3 + geom_hline(yintercept = 0)+
               scale_fill_manual(values=c(&quot;#99000d&quot;,&quot;#034e7b&quot;))+
               scale_y_continuous(&quot;Anomalía de precipitación (%)&quot;,
                                   breaks = seq(-100, 500, 50),
                                   expand = c(0, 5))+
            labs(x = &quot;&quot;,
                 title = &quot;Anomalía de precipitación en Santiago de Compostela&quot;,
                 caption=&quot;Dominic Royé (@dr_xeo) | Datos: eca.knmi.nl&quot;)+
            theme_hc()
g1</code></pre>
<p><img src="https://dominicroye.github.io/en/2019/visualize-monthly-precipitation-anomalies/index.en_files/figure-html/unnamed-chunk-15-1.png" width="3729" /></p>
<p>We use the same legend created for the previous graph.</p>
</div>
</div>
<div id="part-2-1" class="section level2">
<h2>Part 2</h2>
<p>Finally, we join the graph and the legends with the help of the <code>cowplot</code> package. The only thing we must adjust here are the arguments in the <code>draw_plot()</code> function to correctly place the different parts.</p>
<pre class="r"><code>p &lt;- ggdraw() +
       draw_plot(g1, x = 0, y = .18, width = 1, height = 0.8) +
       draw_plot(g2, x = 0, y = .08, width = .2, height = .15) +
       draw_plot(g3, x = 0.08, y = .08, width = .2, height = .15)

p</code></pre>
<p><img src="https://dominicroye.github.io/en/2019/visualize-monthly-precipitation-anomalies/index.en_files/figure-html/unnamed-chunk-16-1.png" width="3729" /></p>
<pre class="r"><code>save_plot(&quot;pr_anomaly20162018_scq.png&quot;, p, dpi = 300, base_width = 12.43, base_height = 8.42)</code></pre>
</div>

    </div>

    


<div class="article-tags">
  
  <a class="badge badge-light" href="/en/tags/anomalies/">anomalies</a>
  
  <a class="badge badge-light" href="/en/tags/precipitation/">precipitation</a>
  
  <a class="badge badge-light" href="/en/tags/climate/">climate</a>
  
  <a class="badge badge-light" href="/en/tags/boxplot/">boxplot</a>
  
</div>



    






<div class="media author-card" itemscope itemtype="http://schema.org/Person">
  
  <img class="portrait mr-3" src="/img/potrai_domi.jpg" itemprop="image" alt="Avatar">
  
  <div class="media-body">
    <h5 class="card-title" itemprop="name"><a href="/en/">Dr. Dominic Royé</a></h5>
    
    
    <ul class="network-icon" aria-hidden="true">
      
      
      
      
      
      
      
      
      <li>
        <a itemprop="sameAs" href="mailto:dominic.roye@usc.es" >
          <i class="fa fa-envelope"></i>
        </a>
      </li>
      
      
      
      
        
      
      
      
      
      
        
      
      <li>
        <a itemprop="sameAs" href="//twitter.com/dr_xeo" >
          <i class="fab fa-twitter"></i>
        </a>
      </li>
      
      
      
      
      
      
      
      
        
      
      <li>
        <a itemprop="sameAs" href="https://www.researchgate.net/profile/Dominic_Roye" target="_blank" rel="noopener">
          <i class="ai ai-researchgate"></i>
        </a>
      </li>
      
      
      
      
        
      
      
      
      
      
        
      
      <li>
        <a itemprop="sameAs" href="//github.com/dominicroye" >
          <i class="fab fa-github"></i>
        </a>
      </li>
      
    </ul>
  </div>
</div>




    
    
    <div class="article-widget">
      <div class="hr-light"></div>
      <h3>Related</h3>
      <ul>
        
        <li><a href="/en/publication/ci_pr_2018/">Spatial Analysis of Daily Precipitation Concentration in Puerto Rico</a></li>
        
      </ul>
    </div>
    

    
    <div class="article-widget">
      <div class="post-nav">
  
  <div class="post-nav-item">
    <div class="meta-nav">Next</div>
    <a href="https://dominicroye.github.io/en/2019/visualize-urban-growth/" rel="next">Visualize urban growth</a>
  </div>
  
  
  <div class="post-nav-item">
    <div class="meta-nav">Previous</div>
    <a href="https://dominicroye.github.io/en/2019/tidy-correlation-tests-in-r/" rel="prev">Tidy correlation tests in R</a>
  </div>
  
</div>

    </div>
    

    
<section id="comments">
  <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "https-dominicroye-github-io" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</section>



  </div>
</article>

<div class="container">
  <footer class="site-footer">
  

  <p class="powered-by">
    &copy; 2018-2021 Dominic Royé. All rights reserved. &middot; 

    Powered by the
    <a href="https://sourcethemes.com/academic/" target="_blank" rel="noopener">Academic theme</a> for
    <a href="https://gohugo.io" target="_blank" rel="noopener">Hugo</a>.

    
    <span class="float-right" aria-hidden="true">
      <a href="#" id="back_to_top">
        <span class="button_icon">
          <i class="fas fa-chevron-up fa-2x"></i>
        </span>
      </a>
    </span>
    
  </p>
</footer>

</div>


<div id="modal" class="modal fade" role="dialog">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Cite</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <pre><code class="tex hljs"></code></pre>
      </div>
      <div class="modal-footer">
        <a class="btn btn-outline-primary my-1 js-copy-cite" href="#" target="_blank">
          <i class="fas fa-copy"></i> Copy
        </a>
        <a class="btn btn-outline-primary my-1 js-download-cite" href="#" target="_blank">
          <i class="fas fa-download"></i> Download
        </a>
        <div id="modal-error"></div>
      </div>
    </div>
  </div>
</div>

    

    
    

    
    
    
      <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha512-+NqPlbbtM1QqiK8ZAo4Yrj2c4lNQoGv8P79DPtKzj++l5jnN39rHA/xsqn8zE9l0uSoxaCdrOgFs6yjyfbBxSg==" crossorigin="anonymous"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.imagesloaded/4.1.3/imagesloaded.pkgd.min.js" integrity="sha512-umsR78NN0D23AzgoZ11K7raBD+R6hqKojyBZs1w8WvYlsI+QuKRGBx3LFCwhatzBunCjDuJpDHwxD13sLMbpRA==" crossorigin="anonymous"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha256-VsEqElsCHSGmnmHXGQzvoWjWwoznFSZc6hs7ARLRacQ=" crossorigin="anonymous"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.isotope/3.0.4/isotope.pkgd.min.js" integrity="sha512-VDBOIlDbuC4VWxGJNmuFRQ0Li0SKkDpmGyuhAG5LTDLd/dJ/S0WMVxriR2Y+CyPL5gzjpN4f/6iqWVBJlht0tQ==" crossorigin="anonymous"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.2.5/jquery.fancybox.min.js" integrity="sha256-X5PoE3KU5l+JcX+w09p/wHl9AzK333C4hJ2I9S5mD4M=" crossorigin="anonymous"></script>

      
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js" integrity="sha256-/BfiIkHlHoVihZdc6TFuj7MmJ0TWcWsMXkeDFwhi0zw=" crossorigin="anonymous"></script>
        
        <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/r.min.js"></script>
        
      

      
      
    

    
    

    
    
    
    <script id="dsq-count-scr" src="//https-dominicroye-github-io.disqus.com/count.js" async></script>
    

    
    
    <script>hljs.initHighlightingOnLoad();</script>
    

    

    
    

    

    
    

    
    

    
    
    
    
    
    
    
    
    <script src="/js/academic.min.d037ee5294b166a79dec317c58aea9cc.js"></script>

    

  </body>
</html>

