---
categories: ["management","R","R:intermediate"]
title: Import Excel sheets with R
date: '2019-03-10'
slug: import-Excel-sheets-with-R
tags: ["excel","sheets","import"]
header:
  caption: ''
  image: 'excel_import.png'
lang: en
summary: "We usually work with different data sources, and sometimes we can find tables distributed over several Excel sheets. In this post we are going to import the average daily temperature of Madrid and Berlin which is found in two Excel files with sheets for each year between 2000 and 2005."
---

We usually work with different data sources, and sometimes we can find tables distributed over several Excel sheets. In this post we are going to import the average daily temperature of Madrid and Berlin which is found in two Excel files with sheets for each year between 2000 and 2005: [download](/files/Data_Excel.zip). 

## Packages

In this post we will use the following packages:

```{r echo=FALSE,message=FALSE,error=FALSE,warning=FALSE}
library(knitr)

tb <- data.frame(package=c("tidyverse","fs","readxl"),
                 description=c("Collection of packages (visualization, manipulation): ggplot2, dplyr, purrr, etc.",
                               "Provides a cross-platform, uniform interface to file system operations",
                               "Import Excel files"
                               ))

kable(tb,booktabs = TRUE,col.names=c("Packages","Description"))

```

```{r,message=FALSE,error=FALSE,warning=FALSE}
#install the packages if necessary
if(!require("tidyverse")) install.packages("tidyverse")
if(!require("fs")) install.packages("fs")
if(!require("readxl")) install.packages("readxl")


#load packages
library(tidyverse)
library(fs)
library(readxl)


```

By default, the `read_excel()` function imports the first sheet. To import a different sheet it is necessary to indicate the number or name with the argument *sheet* (second argument).

```{r}

#import first sheet
read_excel("madrid_temp.xlsx")

#import third sheet
read_excel("madrid_temp.xlsx", 3)


```

The `excel_sheets()` function can extract the names of the sheets.

```{r}

path <- "madrid_temp.xlsx"

path %>%
  excel_sheets()

```

The results are the sheet names and we find the years from 2000 to 2005. The most important function to read multiple sheets is `map()` of the *{purrr}* package, which is part of the *{tidyverse]* collection. `map()` allows you to apply a function to each element of a vector or list.

```{r}

path <- "madrid_temp.xlsx"

mad <- path %>%
        excel_sheets() %>%
        set_names() %>%
       map(read_excel,
           path = path)
        
str(mad)

```

The result is a named list with the name of each sheet that contains the data.frame. Since it is the same table in all sheets, we could use the function `bind_rows()`, however, there is a variant of `map()` that directly joins all the tables by row: `map_df()`. If it were necessary to join by column, `map_dfc()` could be used.


```{r}

path <- "madrid_temp.xlsx"

mad <- path %>%
        excel_sheets() %>%
        set_names() %>%
       map_df(read_excel,
           path = path)

mad

```


In our case we have a column in each sheet (year, but also the date) that differentiates each table. If it were not the case, we should use the name of the sheets as a new column when joining all of them. In `bind_rows()` it can be done with the *.id* argument by assigning a name for the column. The same works for `map_df()`.

```{r}

path <- "madrid_temp.xlsx"

mad <- path %>%
        excel_sheets() %>%
        set_names() %>%
       map_df(read_excel,
           path = path,
           .id = "yr2")

str(mad)

```

But how do we import multiple Excel files?

To do this, first we must know the `dir_ls()` function from the [*{fs}*](https://github.com/r-lib/fs) package. Indeed, there is the `dir()` function of *R Base*, but the advantages of the recent package are several, especially the compatibility with the *{tidyverse}* collection.

```{r}

dir_ls()

#we can filter the files that we want
dir_ls(regexp = "xlsx") 

```

We import the two Excel files.

```{r}

#without joining
dir_ls(regexp = "xlsx") %>%
  map(read_excel)

#joining with a new id column
dir_ls(regexp = "xlsx") %>%
  map_df(read_excel, .id = "city")

```


However, in this case we only import the first sheet of each Excel file. To solve this problem, we must create our own function. In this function we do what we previously did individually.


```{r}

read_multiple_excel <- function(path) {
  path %>%
    excel_sheets() %>% 
    set_names() %>% 
  map_df(read_excel, path = path)
}

```

We apply our created function to import multiple sheets of several Excel files.

```{r}

#separately
data <- dir_ls(regexp = "xlsx") %>% 
           map(read_multiple_excel)

str(data)

#joining all data.frames
data_df <- dir_ls(regexp = "xlsx") %>% 
           map_df(read_multiple_excel,
                  .id = "city")

str(data_df)

```

